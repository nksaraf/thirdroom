var J=Object.defineProperty,X=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var L=(t,e,o)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,W=(t,e)=>{for(var o in e||(e={}))Z.call(e,o)&&L(t,o,e[o]);if(T)for(var o of T(e))ee.call(e,o)&&L(t,o,e[o]);return t},O=(t,e)=>X(t,Q(e));var u=(t,e,o)=>(L(t,typeof e!="symbol"?e+"":e,o),o);import{_ as te,a as oe,o as ie,b as se,c as re,V as p,R as ne,C as ae,j as C,r as R,d as E,T as le,P as ce,N as de,e as ue,f as me}from"./vendor.f8f2a9c9.js";const he=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerpolicy&&(n.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?n.credentials="include":s.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=o(s);fetch(s.href,n)}};he();var fe={downloadSandbox:te,worker:oe,olm:{wasm:ie,legacyBundle:se,wasmBundle:re}};class ge extends p{constructor(e){super(e);this._user=e.user}get userId(){return this._user.id}}function we(t){let e=0,o,i;if(t.length===0)return e;for(o=0;o<t.length;o+=1)i=t.charCodeAt(o),e=(e<<5)-e+i,e|=0;return Math.abs(e)}function I(t){return`var(--usercolor${we(t)%8})`}class ve extends p{constructor(e){super(e);this._session=e.session,this.invites=e.invites,this.rooms=e.rooms,this.track(this.navigation.observe("room").subscribe(()=>this.emitChange("activeRoomId"))),this.track(this.invites.subscribe(this._getRoomChangesHandles())),this.track(this.rooms.subscribe(this._getRoomChangesHandles()))}_getRoomChangesHandles(){const e=()=>{this.emitChange("allRooms")};return{onAdd:e,onUpdate:()=>{},onRemove:e}}getRoomColor(e){const{avatarColorId:o}=e;return I(o)}getRoomAvatarHttpUrl(e,o){const{avatarUrl:i}=e;if(i){const s=o*this.platform.devicePixelRatio;return this._session.mediaRepository.mxcUrlThumbnail(i,s,s,"crop")}return null}get allRooms(){const e=Array.from(this.invites.values()),o=Array.from(this.rooms.values());return e.concat(o)}get activeRoomId(){const e=this.navigation.path.get("room");return e?e.value:null}}class pe extends p{constructor(e){super(e);u(this,"_client");u(this,"_sidebarViewModel");u(this,"_roomListViewModel");u(this,"_panelState");this._client=e.client,this._session=e.session,this._sidebarViewModel=new ge(this.childOptions({user:this._session.user})),this.track(this._sidebarViewModel),this._roomListViewModel=new ve(this.childOptions({session:this._session,invites:this._client.session.invites,rooms:this._client.session.rooms})),this.track(this._roomListViewModel),this._panelState="initial",this.navigation.push("left-panel","initial"),this._setupNavigation()}_setupNavigation(){this.track(this.navigation.observe("left-panel").subscribe(()=>{const e=this.navigation.path.get("left-panel");this._handlePanelState(e.value)})),this.track(this.navigation.observe("room").subscribe(()=>{this._handlePanelState("initial")}))}_handlePanelState(e){e==="open"?this._panelState="open":e==="close"?this._panelState="close":this._panelState="initial",this.emitChange("panelState")}get sidebarViewModel(){return this._sidebarViewModel}get roomListViewModel(){return this._roomListViewModel}get panelState(){return this._panelState}}class _e extends p{constructor(e){super(e);u(this,"_chatViewModel");u(this,"_roomFlow");this.room=e.room,this._chatViewModel=null,this._roomFlow="preview",this.emitChange("roomFlow"),this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("left-panel"),o=e.subscribe(()=>{const i=e.get();i==="initial"&&this.setRoomFlow("preview"),this.roomFlow==="load"&&i!=="close"&&this.setRoomFlow("preview")});this.track(o)}async loadChatView(){this._chatViewModel=new ne(this.childOptions({room:this.room})),this.track(this._chatViewModel),await this._chatViewModel.load()}_disposeChatView(){this.disposeTracked(this._chatViewModel),this._chatViewModel=null}setRoomFlow(e){this._roomFlow!==e&&(e==="preview"?(this.toggleLeftPanel("initial"),this._chatViewModel&&this._disposeChatView()):e==="load"?(this.toggleLeftPanel("initial"),this.loadChatView().then(()=>this.emitChange("chatViewModel"))):this.toggleLeftPanel("close"),this._roomFlow=e,this.emitChange("roomFlow"))}toggleLeftPanel(e){var a;const o=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,i=e!=null?e:o==="close"?"open":"close",s=this.navigation.segment("left-panel",i),n=this.navigation.path.replace(s);this.navigation.applyPath(n)}getRoomColor(){const{avatarColorId:e}=this.room;return I(e)}getRoomAvatarHttpUrl(e){const{avatarUrl:o,mediaRepository:i}=this.room;if(o){if(!e)return i.mxcUrl(o);const s=e*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get roomFlow(){return this._roomFlow}get name(){return this.room.name}get chatViewModel(){return this._chatViewModel}}class Re extends p{constructor(e){super(e);this.invite=e.invite}getRoomColor(){const{avatarColorId:e}=this.invite;return I(e)}getRoomAvatarHttpUrl(e){const{avatarUrl:o,mediaRepository:i}=this.invite;if(o){if(!e)return i.mxcUrl(o);const s=e*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get name(){return this.invite.name}}class Ve extends p{constructor(e){super(e);u(this,"_client");u(this,"_session");u(this,"_leftPanelViewModel");u(this,"_roomViewModel");u(this,"_inviteViewModel");u(this,"_activeRoomId");this._client=e.client,this._session=e.client.session,this._roomViewModel=null,this._inviteViewModel=null,this._activeRoomId=null,this._leftPanelViewModel=new pe(this.childOptions({client:this._client,session:this._session})),this.track(this._leftPanelViewModel),this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("room"),o=e.subscribe(()=>{this._handleRoomView(e.get())});this.track(o),this._handleRoomView(e.get())}_handleRoomView(e){if(this._activeRoomId===e)return;this._roomViewModel=this.disposeTracked(this._roomViewModel),this._inviteViewModel=this.disposeTracked(this._inviteViewModel),this._activeRoomId=null;const{rooms:o,invites:i}=this._session,s=o.get(e)||i.get(e);if(e===void 0||s===void 0){this.emitChange("activeRoomId");return}s.isInvite?(this._inviteViewModel=new Re(this.childOptions({invite:s})),this.track(this._inviteViewModel)):(this._roomViewModel=new _e(this.childOptions({room:s})),this.track(this._roomViewModel)),this._activeRoomId=s.id,this.emitChange("activeRoomId")}get activeRoomId(){return this._activeRoomId}get isActiveRoomInvite(){return this._session.invites.get(this._activeRoomId)!==void 0}get leftPanelViewModel(){return this._leftPanelViewModel}get roomViewModel(){return this._roomViewModel}get inviteViewModel(){return this._inviteViewModel}}class ye extends p{constructor(e){super(e);u(this,"_client");this._client=e.client}async login(e,o,i){const s=await this._client.queryLogin(e).result;await this._client.startWithLogin(s.password(o,i)),this._options.ready(this._client.sessionId)}get defaultHomeserver(){return this.platform.config.defaultHomeserver}}class Me extends p{constructor(e){super(e);u(this,"_client");u(this,"_loginViewModel");u(this,"_sessionViewModel");u(this,"_error");this._loginViewModel=null,this._sessionViewModel=null,this._error=!1,this._client=new ae(e.platform),this.track(this._client)}async load(){this.track(this.navigation.observe("login").subscribe(s=>this._applyNavigation(s,"login"))),this.track(this.navigation.observe("session").subscribe(s=>this._applyNavigation(s,"session")));const e=this.navigation.path.get("login"),o=this.navigation.path.get("session"),i=e||o;i?this._applyNavigation(i.value,i.type):this._applyNavigation(void 0,void 0)}async _applyNavigation(e,o){const i=await this.platform.sessionInfoStorage.getAll();if(o==="login"&&i.length===0){this._viewLogin();return}if(o==="session"&&i.length>0){const s=i[0].id;if(e!==s){this.navigation.push("session",s);return}if(await this._client.startWithExistingSession(s),this._client.loadStatus.get()==="Error"){this._viewError();return}this._viewSession();return}i.length>0?this.navigation.push("session",i[0].id):this.navigation.push("login")}_viewLogin(){this._setSection(()=>{this._loginViewModel=new ye(this.childOptions({client:this._client,ready:e=>{this.navigation.push("session",e)}}))})}_viewSession(){this._setSection(()=>{this._sessionViewModel=new Ve(this.childOptions({client:this._client}))})}_viewError(){this._setSection(()=>{this._error=!0})}_setSection(e){this._error=!1,this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}async logout(){await this._client.startLogout(this._client.sessionId),this.navigation.push("login")}get activeSection(){return this._sessionViewModel?"session":this._loginViewModel?"login":this._error?"error":"loading"}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}}const r=C.exports.jsx,d=C.exports.jsxs,A=C.exports.Fragment;function g({className:t=void 0,style:e=void 0,variant:o="b1",weight:i="regular",type:s=void 0,children:n}){const a=[];t&&a.push(t),a.push(`Text Text-${o} Text--${i}`);const l=a.join(" ");return s==="span"?r("span",{className:l,style:e,children:n}):s==="div"?r("div",{className:l,style:e,children:n}):o==="h2"?r("h2",{className:l,style:e,children:n}):o==="s1"?r("h4",{className:l,style:e,children:n}):r("p",{className:l,style:e,children:n})}function N({color:t=void 0,size:e="normal",src:o,isImage:i=!1}){const s={};return typeof t=="string"&&(s.backgroundColor=t),i?(s.backgroundColor="transparent",s.backgroundImage=`url(${o})`):(s.WebkitMaskImage=`url(${o})`,s.maskImage=`url(${o})`),r("span",{className:`Icon Icon--${e}`,style:s})}function D({className:t=void 0,variant:e="surface",type:o="button",onClick:i,children:s,disabled:n=!1}){return r("button",{className:`${t?`${t} `:""}RawButton-${e}`,type:o,onClick:i,disabled:n,children:s})}function M({className:t=void 0,variant:e="surface",size:o="normal",iconSrc:i=void 0,iconPlacement:s="start",type:n="button",onClick:a,children:l,disabled:c=!1}){const f=i?r(N,{size:o,src:i}):null,m=[];return t&&m.push(t),m.push(`Button Button--${o}`),d(D,{className:m.join(" "),variant:e,type:n,onClick:a,disabled:c,children:[s==="start"&&f,typeof l=="string"?r(g,{variant:o==="extra-small"?"b3":"b2",children:l}):l,s==="end"&&f]})}function y({className:t=void 0,variant:e="surface",size:o="normal",isCircle:i=!1,shadedSurface:s=!1,iconSrc:n,label:a,type:l="button",onClick:c,disabled:f=!1}){const m=[];return t&&m.push(t),m.push(`IconButton IconButton--${o}`),i&&m.push("IconButton--circle"),s&&e==="surface"&&m.push("IconButton--shaded"),r(D,{className:m.join(" "),variant:e,type:l,onClick:c,disabled:f,"aria-label":a,children:r(N,{size:o,src:n})})}var be="/assets/home.831114d8.svg",H="/assets/grid.f44641b3.svg";function Se({vm:t}){return r("div",{className:"SidebarView flex flex-column",children:d("div",{className:"SidebarView__scrollable grow flex flex-column items-center",children:[r(y,{size:"small",label:"Home",shadedSurface:!0,iconSrc:be,onClick:()=>!1}),r(y,{size:"small",label:"Grid",shadedSurface:!0,iconSrc:H,onClick:()=>!1})]})})}function ke({className:t,direction:e="vertical",visibility:o="auto",onScroll:i=void 0,children:s}){const n=[`Scroll Scroll--${e} Scroll--${o}`];return t&&n.push(t),r("div",{className:n.join(" "),onScroll:i,children:s})}function Le({className:t,name:e,bgColor:o,isCircle:i=!1,imageSrc:s=void 0,size:n="normal"}){let a="s1";n==="large"&&(a="h2"),n==="small"&&(a="b1"),n==="extra-small"&&(a="b3");const l=["Avatar"];l.push(`Avatar--${n}`),i&&l.push("Avatar--circle"),l.push("noselect"),t&&l.push(t);const c={};return s||(c.backgroundColor=o),r("div",{className:l.join(" "),"aria-label":e,style:c,children:s?r("img",{draggable:"false",src:s,alt:""}):r(g,{variant:a,weight:"medium",type:"span",children:[...e][0]})})}function xe({title:t,avatar:e,isActive:o=!1,onClick:i}){return d("button",{onClick:i,className:`RoomTile${o?"--active":""} flex items-start`,children:[e,r("div",{className:"RoomTile__content grow flex flex-column",children:t})]})}var Ce="/assets/add-box.a3a974bc.svg",Ee="/assets/manage-search.4d8bfab6.svg";function V(t,e){const[o,i]=R.exports.useState(t[e]);return R.exports.useLayoutEffect(()=>{const s=t.disposableOn("change",n=>{n===e&&i(t[e])});return()=>s()},[t,e]),o}function Ie({vm:t}){const e=V(t,"allRooms"),o=V(t,"activeRoomId");return d("div",{className:"RoomListView flex flex-column",children:[r("header",{className:"flex items-center",children:r(g,{className:"truncate",variant:"s1",weight:"semi-bold",children:"Home"})}),r("div",{className:"RoomListView__container grow",children:r(ke,{children:d("div",{className:"RoomListView__content",children:[d("header",{className:"flex items-center",children:[r(g,{className:"grow",variant:"b2",weight:"semi-bold",children:"Rooms"}),r(M,{iconSrc:Ce,size:"extra-small",onClick:()=>alert("create room"),children:"Create"}),r(M,{iconSrc:Ee,size:"extra-small",onClick:()=>alert("Discover"),children:"Discover"})]}),e.map(i=>r(xe,{isActive:i.id===o,onClick:()=>t.navigation.push("room",i.id),avatar:r(Le,{name:i.name||"Empty room",size:"large",isCircle:!0,className:"shrink-0",bgColor:t.getRoomColor(i),imageSrc:t.getRoomAvatarHttpUrl(i,32)}),title:r(g,{className:"truncate",variant:"b2",weight:"semi-bold",children:i.name||"Empty room"})},i.id))]})})})]})}function Ae({vm:t}){const e=V(t,"panelState");return d("div",{className:`LeftPanelView LeftPanelView--${e} flex`,children:[r(Se,{vm:t.sidebarViewModel}),r(Ie,{vm:t.roomListViewModel})]})}var Ne="/assets/peoples.9192a047.svg";function Pe({vm:t,roomId:e}){const o=t.name||"Empty room",i=t.roomFlow==="preview";return r("div",{className:"RoomPreview grow flex flex-column justify-end items-center",children:d("div",{className:"RoomPreview__card flex items-center",children:[r("div",{className:"grow",children:r(g,{className:"truncate",variant:"s1",weight:"semi-bold",children:o})}),d("div",{className:"RoomPreview__card-memberCount flex items-center",children:[r(N,{src:Ne}),t.room.joinedMemberCount]}),r("div",{className:"shrink-0",children:r(M,{variant:i?"secondary":"primary",onClick:()=>t.setRoomFlow(i?"load":"loaded"),children:i?"Load World":"Open World"})})]})})}function $e({roomId:t,vm:e}){return E.useEffect(()=>{const o=new le(e),i=o.mount();i.querySelector(".Timeline_scroller").classList.add("Scroll","Scroll--vertical","Scroll--auto");const n=document.getElementById("TimelineView");return n==null||n.append(i),()=>{o.unmount(),n!=null&&n.hasChildNodes()&&(n==null||n.removeChild(n==null?void 0:n.childNodes[0]))}},[t,e]),r("div",{className:"TimelineView grow flex hydrogen",id:"TimelineView"})}function Be({vm:t}){return r("div",{className:"ComposerView flex items-center",children:r("form",{className:"grow",onSubmit:o=>{o.preventDefault();const i=o.target,s=i.message.value.trim();s!==""&&(i.message.value="",t.sendMessage(s))},children:r("input",{name:"message",type:"text",placeholder:"Send message"})})})}function Te({vm:t,roomId:e}){return V(t,"timelineViewModel"),d("div",{className:"ChatView flex flex-column",id:"ChatView",children:[r("header",{className:"flex items-center",children:r(g,{variant:"s1",weight:"semi-bold",children:t.name})}),t.timelineViewModel?r($e,{roomId:e,vm:t.timelineViewModel}):r("div",{className:"grow flex justify-center items-center",children:r(g,{children:"loading..."})}),r(Be,{vm:t.composerViewModel})]})}var We="/assets/mic.05083630.svg",Oe="/assets/message.a538e66d.svg",Fe="/assets/setting.e1dd037a.svg",Ke="/assets/logout.eda2bbfa.svg";function Ue({vm:t,roomId:e}){const[o,i]=E.useState(!1);return d(A,{children:[r(M,{size:"small",iconSrc:H,onClick:()=>t.toggleLeftPanel(),children:"Open Overlay [Esc]"}),r("div",{className:`RoomView__chat${o?" RoomView__chat--visible":""}`,children:r(Te,{roomId:e,vm:t.chatViewModel})}),d("div",{className:"RoomView__controls flex",children:[r(y,{shadedSurface:!0,label:"Mic",size:"small",iconSrc:We,onClick:()=>alert("mic")}),r(y,{variant:o?"secondary":"surface",shadedSurface:!o,label:"Message",size:"small",iconSrc:Oe,onClick:()=>i(!o)}),r(y,{shadedSurface:!0,label:"Settings",size:"small",iconSrc:Fe,onClick:()=>alert("Settings")}),r(y,{variant:"danger",label:"Logout",size:"small",iconSrc:Ke,onClick:()=>t.setRoomFlow("preview")})]})]})}function ze({vm:t,roomId:e}){return d("div",{className:"RoomView grow flex",children:[r("div",{className:"RoomView__3d grow"}),r(Ue,{vm:t,roomId:e})]})}const je="modulepreload",F={},De="/",K=function(e,o){return!o||o.length===0?e():Promise.all(o.map(i=>{if(i=`${De}${i}`,i in F)return;F[i]=!0;const s=i.endsWith(".css"),n=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${n}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":je,s||(a.as="script",a.crossOrigin=""),a.href=i,document.head.appendChild(a),s)return new Promise((l,c)=>{a.addEventListener("load",l),a.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>e())};function He(){return new Worker("/assets/GameWorker.2a1b9ba1.js",{type:"module"})}const G=t=>e=>Math.ceil(e/t)*t,Ge=G(4),qe=G(8),v=Symbol("cursor"),x=Symbol("byteView"),Ye=(t=new ArrayBuffer(1e7))=>(t[v]=0,t[x]=new Uint8Array(t.byteLength),Object.defineProperty(t,"cursor",{get(){return this[v]}}),Object.defineProperty(t,"byteView",{get(){return this[x]}}),t.clear=function(){this[x].fill(0,0,this[v])},t),Je=(t,e)=>{const{name:o}=e;o.includes("32")&&(t[v]=Ge(t[v])),o.includes("64")&&(t[v]=qe(t[v]))},b=(t,e,o)=>{Je(t,e);const i=new e(t,t[v],o);return t[v]+=o*i.BYTES_PER_ELEMENT,i},Xe=(t,e,o,i)=>{const s=b(t,e,i*o),n=Array(i);for(let a=0;a<i;a++)n[a]=s.subarray(a*o,a*o+o);return n},Lt=(t,e)=>Xe(t,Float32Array,16,e),q=(t=1e7,e=[new SharedArrayBuffer(t),new SharedArrayBuffer(t),new SharedArrayBuffer(t)],o=[new Uint8Array(e[0]),new Uint8Array(e[1]),new Uint8Array(e[2])],i=new Uint8Array(new SharedArrayBuffer(Uint8Array.BYTES_PER_ELEMENT)).fill(6))=>({byteLength:t,buffers:e,views:o,flags:i}),Qe=t=>(t&64)!==0,Ze=t=>t&48|(t&3)<<2|(t&12)>>2,et=t=>64|(t&12)<<2|(t&48)>>2|t&3,xt=t=>Atomics.load(t.flags,0)&3,tt=t=>(Atomics.load(t.flags,0)&48)>>4,ot=(t,e)=>t.views[tt(t)].set(new Uint8Array(e)),Ct=t=>{const e=Atomics.load(t.flags,0);do if(!Qe(e))return!1;while(Atomics.compareExchange(t.flags,0,e,Ze(e))===e);return!0},it=t=>{const e=Atomics.load(t.flags,0);for(;Atomics.compareExchange(t.flags,0,e,et(e))===e;);},st=(t,e)=>{const o=t.BYTES_PER_ELEMENT*8,i=Math.floor(e/o),s=e-o*i,n=Math.pow(2,s);t[i]|=n},rt=(t,e)=>{const o=t.BYTES_PER_ELEMENT*8,i=Math.floor(e/o),s=e-o*i,n=Math.pow(2,s);t[i]&=~n},U=(t,e,o)=>{o?st(t,e):rt(t,e)},Y=(t,e)=>{const o=t.BYTES_PER_ELEMENT*8,i=Math.floor(e/o),s=e-o*i;return(Math.pow(2,s)&t[i])!==0?1:0},P=["Unassigned","Escape","Backquote","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Minus","Equal","Backspace","Tab","KeyQ","KeyW","KeyE","KeyR","KeyT","KeyY","KeyU","KeyI","KeyO","KeyP","BracketLeft","BracketRight","Backslash","CapsLock","KeyA","KeyS","KeyD","KeyF","KeyG","KeyH","KeyJ","KeyK","KeyL","Semicolon","Quote","Enter","ShiftLeft","KeyZ","KeyX","KeyC","KeyV","KeyB","KeyN","KeyM","Comma","Period","Slash","ShiftRight","ControlLeft","AltLeft","MetaLeft","Space","MetaRight","AltRight","ArrowLeft","ArrowUp","ArrowRight","ArrowDown"],nt=Object.fromEntries(P.map((t,e)=>[t,e]));function z(t){return nt[t]||0}function at(t){const e=lt(),o=q(e.buffer.byteLength),i=ct(e,t);return{tripleBuffer:o,update(){ot(o,e.buffer),it(o),e.mouse.movement[0]=0,e.mouse.movement[1]=0},dispose(){i()}}}const lt=(t=Ye())=>({buffer:t,keyboard:b(t,Uint32Array,Math.ceil(P.length/32)),mouse:{movement:b(t,Float32Array,2),buttons:b(t,Uint32Array,1)}}),ct=(t,e)=>{function o({buttons:c}){document.pointerLockElement===e?t.mouse.buttons[0]=c:e.requestPointerLock()}function i({buttons:c}){document.pointerLockElement===e&&(t.mouse.buttons[0]=c)}function s({code:c}){document.pointerLockElement===e&&U(t.keyboard,z(c),1)}function n({code:c}){document.pointerLockElement===e&&U(t.keyboard,z(c),0)}function a({movementX:c,movementY:f}){document.pointerLockElement===e&&(t.mouse.movement[0]=c,t.mouse.movement[1]=f)}function l(){t.buffer.clear()}return e.addEventListener("mousedown",o),e.addEventListener("mouseup",i),window.addEventListener("keydown",s),window.addEventListener("keyup",n),window.addEventListener("mousemove",a),e.addEventListener("blur",l),()=>{e.removeEventListener("mousedown",o),e.removeEventListener("mouseup",i),window.removeEventListener("keydown",s),window.removeEventListener("keyup",n),window.removeEventListener("mousemove",a),e.removeEventListener("blur",l)}},dt=t=>e=>Y(e.keyboard,t),j=t=>e=>e.mouse.movement[t],ut=t=>e=>Y(e.mouse.buttons,t);Object.fromEntries([...P.map((t,e)=>[`Keyboard/${t}`,dt(e)]),["Mouse/movementX",j(0)],["Mouse/movementY",j(1)],...Array(6).fill(0).map((t,e)=>[`Mouse/button${e}`,ut(e)])]);var h=(t=>(t.InitializeGameWorker="initialize-game-worker",t.GameWorkerInitialized="game-worker-initialized",t.GameWorkerError="game-worker-error",t.InitializeRenderWorker="initialize-render-worker",t.StartGameWorker="start-game-worker",t.RenderWorkerInitialized="render-worker-initialized",t.RenderWorkerError="render-worker-error",t.StartRenderWorker="start-render-worker",t.InitializeGameWorkerRenderState="initialize-game-worker-render-state",t.RenderWorkerResize="render-worker-resize",t.LoadResource="load-resource",t.ResourceLoaded="resource-loaded",t.ResourceLoadError="resource-load-error",t.AddResourceRef="add-resource-ref",t.RemoveResourceRef="remove-resource-ref",t.ResourceDisposed="resource-disposed",t.AddRenderable="add-renderable",t.RemoveRenderable="remove-renderable",t.SetActiveCamera="set-active-camera",t.SetActiveScene="set-active-scene",t))(h||{}),mt=(t=>(t.Loading="loading",t.Loaded="loaded",t.Error="error",t))(mt||{});function ht(){return new SharedArrayBuffer(4)}function Et(t,e){return{buffer:t,view:new Uint32Array(t),store:new Map,resourceLoaders:new Map,workerMessageTarget:e}}function It(t,e){const o=e(t);t.resourceLoaders.set(o.type,o)}async function At(t,{resourceDef:e,resourceId:o}){const{type:i}=e,s=t.resourceLoaders.get(i);if(!s)throw new Error(`Resource loader ${i} not registered.`);const n=e.name||`${i}[${o}]`,a={resourceId:o,type:i,name:n,refCount:1,state:"loading",resource:void 0,promise:s.load(O(W({},e),{name:n}))};t.store.set(o,a);try{const l=await a.promise;!e.name&&l.name&&(a.name=l.name),a.resource=l.resource,a.state="loaded",t.workerMessageTarget.postMessage({type:h.ResourceLoaded,resourceId:o,remoteResource:l.remoteResource},l.transferList)}catch(l){console.error(l),a.state="error",a.error=l,t.workerMessageTarget.postMessage({type:h.ResourceLoadError,resourceId:o,error:l})}return a}function Nt(t,{resourceId:e}){const o=t.store.get(e);if(!o)return;const i=t.resourceLoaders.get(o.type);i.addRef&&i.addRef(e),o.refCount++}function Pt(t,{resourceId:e}){const o=t.store.get(e);if(!o)return;const i=t.resourceLoaders.get(o.type);o.refCount===1?(i.dispose&&i.dispose(e),t.store.delete(e),t.workerMessageTarget.postMessage({type:h.ResourceDisposed,resourceId:e})):(i.removeRef&&i.removeRef(e),o.refCount--)}async function $t(t,e){const o=t.store.get(e);if(o)return(await o.promise).resource}function Bt(t,e,o,i){const s=Atomics.add(t.view,0,1),n=i||`${e}[${s}]`,a={resourceId:s,type:e,name:n,refCount:1,state:"loaded",resource:o,promise:Promise.resolve({name:n,resource:o})};return t.store.set(s,a),s}async function ft(t,e){const o=!!window.OffscreenCanvas;let i,s,n,a;if(o){console.info("Browser supports OffscreenCanvas, rendering in WebWorker.");const{default:c}=await K(()=>import("./RenderWorker.5fa28fe8.js"),[]);i=new c,s=t.transferControlToOffscreen();const f=new MessageChannel;n=f.port1,a=f.port2}else{console.info("Browser does not support OffscreenCanvas, rendering on main thread.");const c=await K(()=>import("./RenderWorker.fca5bb79.js"),["assets/RenderWorker.fca5bb79.js","assets/vendor.f8f2a9c9.js"]);i=c.default,n=c.default,a=e,s=t}function l(){n.postMessage({type:h.RenderWorkerResize,canvasWidth:t.clientWidth,canvasHeight:t.clientHeight})}return window.addEventListener("resize",l),{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:n,gameWorkerMessageTarget:a,dispose(){window.removeEventListener("resize",l),i instanceof Worker&&i.terminate()}}}async function gt(t){const e=at(t),o=new He,{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:n,gameWorkerMessageTarget:a,dispose:l}=await ft(t,o),c=q(),f=ht(),m=n instanceof MessagePort?n:void 0;await new Promise((S,k)=>{i.postMessage({type:h.InitializeRenderWorker,renderableTripleBuffer:c,gameWorkerMessageTarget:a,canvasTarget:s,initialCanvasWidth:t.clientWidth,initialCanvasHeight:t.clientHeight,resourceManagerBuffer:f},a instanceof MessagePort&&s instanceof OffscreenCanvas?[a,s]:void 0);const _=({data:w})=>{w.type===h.RenderWorkerInitialized?(S(w),i.removeEventListener("message",_)):w.type===h.RenderWorkerError&&(k(w.error),i.removeEventListener("message",_))};i.addEventListener("message",_)}),await new Promise((S,k)=>{o.postMessage({type:h.InitializeGameWorker,renderableTripleBuffer:c,inputTripleBuffer:e.tripleBuffer,renderWorkerMessagePort:m,resourceManagerBuffer:f},m?[m]:void 0);const _=({data:w})=>{w.type===h.GameWorkerInitialized?(S(w),o.removeEventListener("message",_)):w.type===h.GameWorkerError&&(k(w.error),o.removeEventListener("message",_))};o.addEventListener("message",_)}),i.postMessage({type:h.StartRenderWorker}),o.postMessage({type:h.StartGameWorker});let $;function B(){e.update(),$=requestAnimationFrame(B)}return B(),{dispose(){cancelAnimationFrame($),e.dispose(),o.terminate(),l()}}}function wt(t){R.exports.useEffect(()=>{let e;return t.current&&gt(t.current).then(o=>e=o.dispose).catch(console.error),e},[t])}function vt({vm:t}){const e=R.exports.useRef(null);return wt(e),d(A,{children:[r("canvas",{className:"SessionView__viewport",ref:e}),d("div",{className:"SessionView flex",children:[r(Ae,{vm:t.leftPanelViewModel}),r(pt,{vm:t})]})]})}function pt({vm:t}){const e=V(t,"activeRoomId");return e?t.isActiveRoomInvite?r("p",{children:"invite"}):r(_t,{vm:t.roomViewModel,roomId:e}):r("p",{children:"select room from left panel"})}function _t({vm:t,roomId:e}){V(t,"roomFlow");const o=R.exports.useRef();return R.exports.useEffect(()=>{o.current=t.roomFlow},[t.roomFlow]),d(A,{children:[["preview","load"].includes(t.roomFlow)&&r(Pe,{vm:t,roomId:e}),t.roomFlow==="loaded"&&r(ze,{vm:t,roomId:e})]})}function Rt({vm:t}){const[e,o]=R.exports.useState(!1),i=async s=>{s.preventDefault();const n=s.target,{homeserver:a,username:l,password:c}=n;o(!0),await t.login(a.value,l.value,c.value),o(!1)};return e?r("p",{children:"Login in progress..."}):d("form",{style:{height:"100%"},className:"flex flex-column justify-center items-center",onSubmit:i,children:[r("label",{htmlFor:"homeserver",children:"Homeserver"}),r("input",{defaultValue:t.defaultHomeserver,name:"homeserver",placeholder:"homeserver",required:!0}),r("br",{}),r("label",{htmlFor:"username",children:"Username"}),r("input",{name:"username",placeholder:"username",required:!0}),r("br",{}),r("label",{htmlFor:"password",children:"Password"}),r("input",{name:"password",placeholder:"password",type:"password",required:!0}),r("br",{}),r("button",{type:"submit",children:"Login"})]})}function Vt({vm:t}){const e=V(t,"activeSection");return d("div",{className:"RootView",children:[e==="login"&&r(Rt,{vm:t.loginViewModel}),e==="session"&&r(vt,{vm:t.sessionViewModel}),e==="loading"&&r("div",{className:"flex justify-center items-center",style:{height:"100%"},children:r(g,{variant:"b1",weight:"semi-bold",children:"Loading..."})}),e==="error"&&d("div",{className:"flex flex-column justify-center items-center",style:{height:"100%"},children:[r(g,{variant:"b1",weight:"semi-bold",children:"This session is invalid"}),r("br",{}),r(M,{variant:"primary",size:"small",onClick:()=>t.logout(),children:"Delete session and login"})]})]})}function yt(t,e){me.render(r(E.StrictMode,{children:r(Vt,{vm:e})}),t)}function Mt(t,e){const o=t==null?void 0:t.type;return o===void 0?["session","login"].includes(e.type):o==="session"?["left-panel"].includes(e.type):o==="left-panel"?["room"].includes(e.type):!1}async function bt(){const t="root",e=document.getElementById(t);if(!e)throw new Error(`Can not find root element with id: ${t}`);const o={defaultHomeserver:"matrix.org"},i={development:!1},s=new ce(e,fe,o,i),n=new de(Mt);s.setNavigation(n);const a=ue({navigation:n,history:s.history});a.attach();const l=new Me({platform:s,navigation:n,urlCreator:a});l.load(),yt(e,l)}bt();export{mt as R,h as W,Bt as a,Nt as b,At as c,Ye as d,Lt as e,b as f,xt as g,Et as h,$t as l,Pt as o,It as r,Ct as s};
