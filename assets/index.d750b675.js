var ee=Object.defineProperty,te=Object.defineProperties;var ie=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var C=(e,t,i)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,U=(e,t)=>{for(var i in t||(t={}))oe.call(t,i)&&C(e,i,t[i]);if(W)for(var i of W(t))se.call(t,i)&&C(e,i,t[i]);return e},K=(e,t)=>te(e,ie(t));var m=(e,t,i)=>(C(e,typeof t!="symbol"?t+"":t,i),i);import{_ as re,a as ne,o as ae,b as le,c as ce,V as R,R as de,C as ue,j as B,r as w,d as I,T as me,P as he,N as fe,e as ge,f as we}from"./vendor.f8f2a9c9.js";const ve=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerpolicy&&(n.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?n.credentials="include":s.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}};ve();var pe={downloadSandbox:re,worker:ne,olm:{wasm:ae,legacyBundle:le,wasmBundle:ce}};class _e extends R{constructor(t){super(t);this._user=t.user}get userId(){return this._user.id}}function ye(e){let t=0,i,o;if(e.length===0)return t;for(i=0;i<e.length;i+=1)o=e.charCodeAt(i),t=(t<<5)-t+o,t|=0;return Math.abs(t)}function P(e){return`var(--usercolor${ye(e)%8+1})`}class Re extends R{constructor(t){super(t);this._session=t.session,this.invites=t.invites,this.rooms=t.rooms,this.track(this.navigation.observe("room").subscribe(()=>this.emitChange("activeRoomId"))),this.track(this.invites.subscribe(this._getRoomChangesHandles())),this.track(this.rooms.subscribe(this._getRoomChangesHandles()))}_getRoomChangesHandles(){const t=()=>{this.emitChange("allRooms")};return{onAdd:t,onUpdate:()=>{},onRemove:t}}getRoomColor(t){const{avatarColorId:i}=t;return P(i)}getRoomAvatarHttpUrl(t,i){const{avatarUrl:o}=t;if(o){const s=i*this.platform.devicePixelRatio;return this._session.mediaRepository.mxcUrlThumbnail(o,s,s,"crop")}return null}get allRooms(){const t=Array.from(this.invites.values()),i=Array.from(this.rooms.values());return t.concat(i)}get activeRoomId(){const t=this.navigation.path.get("room");return t?t.value:null}}class Ve extends R{constructor(t){super(t);m(this,"_client");m(this,"_sidebarViewModel");m(this,"_roomListViewModel");m(this,"_panelState");this._client=t.client,this._session=t.session,this._sidebarViewModel=new _e(this.childOptions({user:this._session.user})),this.track(this._sidebarViewModel),this._roomListViewModel=new Re(this.childOptions({session:this._session,invites:this._client.session.invites,rooms:this._client.session.rooms})),this.track(this._roomListViewModel),this._panelState="initial",this.navigation.push("left-panel","initial"),this._setupNavigation()}_setupNavigation(){this.track(this.navigation.observe("left-panel").subscribe(()=>{const t=this.navigation.path.get("left-panel");this._handlePanelState(t.value)})),this.track(this.navigation.observe("room").subscribe(()=>{this._handlePanelState("initial")}))}_handlePanelState(t){typeof t=="string"?this._panelState=t:this._panelState="initial",this.emitChange("panelState")}get sidebarViewModel(){return this._sidebarViewModel}get roomListViewModel(){return this._roomListViewModel}get panelState(){return this._panelState}}class be extends R{constructor(t){super(t);m(this,"_chatViewModel");m(this,"_roomFlow");this.room=t.room,this._chatViewModel=null,this._roomFlow="preview",this.emitChange("roomFlow"),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("left-panel"),i=t.subscribe(()=>{const o=t.get();o==="initial"&&this.setRoomFlow("preview"),this.roomFlow==="load"&&o!=="close"&&this.setRoomFlow("preview")});this.track(i)}async loadChatView(){this._chatViewModel=new de(this.childOptions({room:this.room})),this.track(this._chatViewModel),await this._chatViewModel.load()}_disposeChatView(){this.disposeTracked(this._chatViewModel),this._chatViewModel=null}setRoomFlow(t){this._roomFlow!==t&&(t==="preview"?(this.toggleLeftPanel("initial"),this._chatViewModel&&this._disposeChatView()):t==="load"?(this.toggleLeftPanel("initial"),this.loadChatView().then(()=>this.emitChange("chatViewModel"))):this.toggleLeftPanel("close"),this._roomFlow=t,this.emitChange("roomFlow"))}toggleLeftPanel(t){var a;const i=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,o=t!=null?t:i==="close"?"open":"close",s=this.navigation.segment("left-panel",o),n=this.navigation.path.replace(s);this.navigation.applyPath(n)}getRoomColor(){const{avatarColorId:t}=this.room;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:i,mediaRepository:o}=this.room;if(i){if(!t)return o.mxcUrl(i);const s=t*this.platform.devicePixelRatio;return o.mxcUrlThumbnail(i,s,s,"crop")}return null}get roomFlow(){return this._roomFlow}get name(){return this.room.name}get chatViewModel(){return this._chatViewModel}}class Me extends R{constructor(t){super(t);this.invite=t.invite}getRoomColor(){const{avatarColorId:t}=this.invite;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:i,mediaRepository:o}=this.invite;if(i){if(!t)return o.mxcUrl(i);const s=t*this.platform.devicePixelRatio;return o.mxcUrlThumbnail(i,s,s,"crop")}return null}get name(){return this.invite.name}}class Se extends R{constructor(t){super(t);this._rooms=t.session.rooms,this._overlayBtnVisibility=!1,this._leftPanelState="initial",this._selectedRoom=void 0,this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("left-panel"),i=t.subscribe(()=>{const n=t.get();n==="initial"?this._overlayBtnVisibility=!1:this._overlayBtnVisibility=!0,this._leftPanelState=n,this.emitChange("overlayBtnVisibility"),this.emitChange("leftPanelState")});this.track(i);const o=this.navigation.observe("room"),s=o.subscribe(()=>{const n=o.get();this._selectedRoom=this._rooms.get(n),this._overlayBtnVisibility=!1,this._leftPanelVisibility="initial",this.emitChange("overlayBtnVisibility"),this.emitChange("leftPanelState"),this.emitChange("selectedRoomName")});this.track(s)}toggleLeftPanel(t){var a;const i=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,o=t!=null?t:i==="close"?"open":"close",s=this.navigation.segment("left-panel",o),n=this.navigation.path.replace(s);this.navigation.applyPath(n)}get selectedRoomName(){if(!!this._selectedRoom)return this._selectedRoom.name||"Empty room"}get overlayBtnVisibility(){return this._overlayBtnVisibility}get leftPanelState(){return this._leftPanelState}}class xe extends R{constructor(t){super(t);m(this,"_client");m(this,"_session");m(this,"_statusBarViewModel");m(this,"_leftPanelViewModel");m(this,"_roomViewModel");m(this,"_inviteViewModel");m(this,"_activeRoomId");this._client=t.client,this._session=t.client.session,this._roomViewModel=null,this._inviteViewModel=null,this._activeRoomId=null,this._statusBarViewModel=new Se(this.childOptions({client:this._client,session:this._session})),this.track(this._statusBarViewModel),this._leftPanelViewModel=new Ve(this.childOptions({client:this._client,session:this._session})),this.track(this._leftPanelViewModel),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("room"),i=t.subscribe(()=>{this._handleRoomView(t.get())});this.track(i),this._handleRoomView(t.get())}_handleRoomView(t){if(this._activeRoomId===t)return;this._roomViewModel=this.disposeTracked(this._roomViewModel),this._inviteViewModel=this.disposeTracked(this._inviteViewModel),this._activeRoomId=null;const{rooms:i,invites:o}=this._session,s=i.get(t)||o.get(t);if(t===void 0||s===void 0){this.emitChange("activeRoomId");return}s.isInvite?(this._inviteViewModel=new Me(this.childOptions({invite:s})),this.track(this._inviteViewModel)):(this._roomViewModel=new be(this.childOptions({room:s})),this.track(this._roomViewModel)),this._activeRoomId=s.id,this.emitChange("activeRoomId")}get activeRoomId(){return this._activeRoomId}get isActiveRoomInvite(){return this._session.invites.get(this._activeRoomId)!==void 0}get statusBarViewModel(){return this._statusBarViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get roomViewModel(){return this._roomViewModel}get inviteViewModel(){return this._inviteViewModel}}class ke extends R{constructor(t){super(t);m(this,"_client");this._client=t.client}async login(t,i,o){const s=await this._client.queryLogin(t).result;await this._client.startWithLogin(s.password(i,o)),this._options.ready(this._client.sessionId)}get defaultHomeserver(){return this.platform.config.defaultHomeserver}}class Le extends R{constructor(t){super(t);m(this,"_client");m(this,"_loginViewModel");m(this,"_sessionViewModel");m(this,"_error");this._loginViewModel=null,this._sessionViewModel=null,this._error=!1,this._client=new ue(t.platform),this.track(this._client)}async load(){this.track(this.navigation.observe("login").subscribe(s=>this._applyNavigation(s,"login"))),this.track(this.navigation.observe("session").subscribe(s=>this._applyNavigation(s,"session")));const t=this.navigation.path.get("login"),i=this.navigation.path.get("session"),o=t||i;o?this._applyNavigation(o.value,o.type):this._applyNavigation(void 0,void 0)}async _applyNavigation(t,i){const o=await this.platform.sessionInfoStorage.getAll();if(i==="login"&&o.length===0){this._viewLogin();return}if(i==="session"&&o.length>0){const s=o[0].id;if(t!==s){this.navigation.push("session",s);return}if(await this._client.startWithExistingSession(s),this._client.loadStatus.get()==="Error"){this._viewError();return}this._viewSession();return}o.length>0?this.navigation.push("session",o[0].id):this.navigation.push("login")}_viewLogin(){this._setSection(()=>{this._loginViewModel=new ke(this.childOptions({client:this._client,ready:t=>{this.navigation.push("session",t)}}))})}_viewSession(){this._setSection(()=>{this._sessionViewModel=new xe(this.childOptions({client:this._client}))})}_viewError(){this._setSection(()=>{this._error=!0})}_setSection(t){this._error=!1,this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),t(),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}async logout(){await this._client.startLogout(this._client.sessionId),this.navigation.push("login")}get activeSection(){return this._sessionViewModel?"session":this._loginViewModel?"login":this._error?"error":"loading"}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}}const r=B.exports.jsx,d=B.exports.jsxs,A=B.exports.Fragment;function v({className:e=void 0,style:t=void 0,variant:i="b1",weight:o="regular",type:s=void 0,children:n}){const a=[];e&&a.push(e),a.push(`Text Text-${i} Text--${o}`);const l=a.join(" ");return s==="span"?r("span",{className:l,style:t,children:n}):s==="div"?r("div",{className:l,style:t,children:n}):i==="h2"?r("h2",{className:l,style:t,children:n}):i==="s1"?r("h4",{className:l,style:t,children:n}):r("p",{className:l,style:t,children:n})}function T({color:e=void 0,size:t="normal",src:i,isImage:o=!1}){const s={};return typeof e=="string"&&(s.backgroundColor=e),o?(s.backgroundColor="transparent",s.backgroundImage=`url(${i})`):(s.WebkitMaskImage=`url(${i})`,s.maskImage=`url(${i})`),r("span",{className:`Icon Icon--${t}`,style:s})}function q({className:e=void 0,variant:t="surface",type:i="button",onClick:o,children:s,disabled:n=!1}){return r("button",{className:`${e?`${e} `:""}RawButton-${t}`,type:i,onClick:o,disabled:n,children:s})}function E({className:e=void 0,variant:t="surface",size:i="normal",iconSrc:o=void 0,iconPlacement:s="start",type:n="button",onClick:a,children:l,disabled:c=!1}){const u=o?r(T,{size:i,src:o}):null,h=[];return e&&h.push(e),h.push(`Button Button--${i}`),d(q,{className:h.join(" "),variant:t,type:n,onClick:a,disabled:c,children:[s==="start"&&u,typeof l=="string"?r(v,{variant:i==="extra-small"?"b3":"b2",children:l}):l,s==="end"&&u]})}function S({className:e=void 0,variant:t="surface",size:i="normal",isCircle:o=!1,shadedSurface:s=!1,iconSrc:n,label:a,type:l="button",onClick:c,disabled:u=!1}){const h=[];return e&&h.push(e),h.push(`IconButton IconButton--${i}`),o&&h.push("IconButton--circle"),s&&t==="surface"&&h.push("IconButton--shaded"),r(q,{className:h.join(" "),variant:t,type:l,onClick:c,disabled:u,"aria-label":a,children:r(T,{size:i,src:n})})}var Ee="/assets/home.831114d8.svg",Ce="/assets/grid.f44641b3.svg";function Ne({vm:e}){return r("div",{className:"SidebarView flex flex-column",children:d("div",{className:"SidebarView__scrollable grow flex flex-column items-center",children:[r(S,{size:"small",label:"Home",shadedSurface:!0,iconSrc:Ee,onClick:()=>!1}),r(S,{size:"small",label:"Grid",shadedSurface:!0,iconSrc:Ce,onClick:()=>!1})]})})}function Be({className:e,direction:t="vertical",visibility:i="auto",onScroll:o=void 0,children:s}){const n=[`Scroll Scroll--${t} Scroll--${i}`];return e&&n.push(e),r("div",{className:n.join(" "),onScroll:o,children:s})}function Ie({className:e,name:t,bgColor:i,isCircle:o=!1,imageSrc:s=void 0,size:n="normal"}){const[a,l]=w.exports.useState(!1);let c="s1";n==="large"&&(c="h2"),n==="small"&&(c="b1"),n==="extra-small"&&(c="b3");const u=["Avatar"];u.push(`Avatar--${n}`),o&&u.push("Avatar--circle"),u.push("noselect"),e&&u.push(e);const h={};return(a||!s)&&(h.backgroundColor=i),r("div",{className:u.join(" "),"aria-label":t,style:h,children:!a&&s?r("img",{draggable:"false",src:s,alt:"",onError:()=>l(!0)}):r(v,{variant:c,weight:"medium",type:"span",children:[...t][0]})})}function Pe({title:e,avatar:t,isActive:i=!1,onClick:o}){return d("button",{onClick:o,className:`RoomTile${i?"--active":""} flex items-start`,children:[t,r("div",{className:"RoomTile__content grow flex flex-column",children:e})]})}var Ae="/assets/add-box.a3a974bc.svg",Te="/assets/manage-search.4d8bfab6.svg";function p(e,t){const[i,o]=w.exports.useState(e[t]);return w.exports.useLayoutEffect(()=>{const s=e.disposableOn("change",n=>{n===t&&o(e[t])});return()=>s()},[e,t]),i}function $e({vm:e}){const t=p(e,"allRooms"),i=p(e,"activeRoomId");return d("div",{className:"RoomListView flex flex-column",children:[r("header",{className:"flex items-center",children:r(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:"Home"})}),r("div",{className:"RoomListView__container grow",children:r(Be,{children:d("div",{className:"RoomListView__content",children:[d("header",{className:"flex items-center",children:[r(v,{className:"grow",variant:"b2",weight:"semi-bold",children:"Rooms"}),r(E,{iconSrc:Ae,size:"extra-small",onClick:()=>alert("create room"),children:"Create"}),r(E,{iconSrc:Te,size:"extra-small",onClick:()=>alert("Discover"),children:"Discover"})]}),t.map(o=>r(Pe,{isActive:o.id===i,onClick:()=>e.navigation.push("room",o.id),avatar:r(Ie,{name:o.name||"Empty room",size:"large",isCircle:!0,className:"shrink-0",bgColor:e.getRoomColor(o),imageSrc:e.getRoomAvatarHttpUrl(o,32)}),title:r(v,{className:"truncate",variant:"b2",weight:"semi-bold",children:o.name||"Empty room"})},o.id))]})})})]})}function Fe({vm:e}){const t=p(e,"panelState");return d("div",{className:`LeftPanelView LeftPanelView--${t} flex`,children:[r(Ne,{vm:e.sidebarViewModel}),r($e,{vm:e.roomListViewModel})]})}function Oe({text:e,onClick:t}){return r("button",{className:"OpenOverlay",onClick:t,children:d(v,{className:"flex items-center",variant:"b3",children:[r("span",{children:"ESC"}),e]})})}function We({vm:e}){const t=p(e,"overlayBtnVisibility"),i=p(e,"leftPanelState"),o=p(e,"selectedRoomName");return d("div",{className:"StatusBar shrink-0 flex items-center",children:[r("div",{className:"StatusBar__left grow basis-0",children:t&&r(Oe,{text:i==="close"?"Open Overlay":"Close Overlay",onClick:()=>e.toggleLeftPanel()})}),r("div",{className:"StatusBar__center",children:o&&r(v,{weight:"semi-bold",children:o})}),r("div",{className:"StatusBar__right grow basis-0 flex justify-end",children:r(v,{variant:"b3",children:"0 Notifications"})})]})}var Ue="/assets/peoples.9192a047.svg";function Ke({vm:e,roomId:t}){const i=e.name||"Empty room",o=e.roomFlow==="preview";return r("div",{className:"RoomPreview grow flex flex-column justify-end items-center",children:d("div",{className:"RoomPreview__card flex items-center",children:[r("div",{className:"grow",children:r(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:i})}),d("div",{className:"RoomPreview__card-memberCount flex items-center",children:[r(T,{src:Ue}),e.room.joinedMemberCount]}),r("div",{className:"shrink-0",children:r(E,{variant:o?"secondary":"primary",onClick:()=>e.setRoomFlow(o?"load":"loaded"),children:o?"Load World":"Open World"})})]})})}function je({roomId:e,vm:t}){return I.useEffect(()=>{const i=new me(t),o=i.mount();o.querySelector(".Timeline_scroller").classList.add("Scroll","Scroll--vertical","Scroll--auto");const n=document.getElementById("TimelineView");return n==null||n.append(o),()=>{i.unmount(),n!=null&&n.hasChildNodes()&&(n==null||n.removeChild(n==null?void 0:n.childNodes[0]))}},[e,t]),r("div",{className:"TimelineView grow flex hydrogen",id:"TimelineView"})}function De({vm:e}){return r("div",{className:"ComposerView flex items-center",children:r("form",{className:"grow",onSubmit:i=>{i.preventDefault();const o=i.target,s=o.message.value.trim();s!==""&&(o.message.value="",e.sendMessage(s))},children:r("input",{name:"message",type:"text",placeholder:"Send message"})})})}function ze({vm:e,roomId:t}){return p(e,"timelineViewModel"),d("div",{className:"ChatView flex flex-column",id:"ChatView",children:[r("header",{className:"flex items-center",children:r(v,{variant:"s1",weight:"semi-bold",children:e.name})}),e.timelineViewModel?r(je,{roomId:t,vm:e.timelineViewModel}):r("div",{className:"grow flex justify-center items-center",children:r(v,{children:"loading..."})}),r(De,{vm:e.composerViewModel})]})}var He="/assets/mic.05083630.svg",Ge="/assets/message.a538e66d.svg",qe="/assets/setting.e1dd037a.svg",Ye="/assets/logout.eda2bbfa.svg";function Je({vm:e,roomId:t}){const[i,o]=I.useState(!1);return d(A,{children:[r("div",{className:`RoomView__chat${i?" RoomView__chat--visible":""}`,children:r(ze,{roomId:t,vm:e.chatViewModel})}),d("div",{className:"RoomView__controls flex",children:[r(S,{shadedSurface:!0,label:"Mic",size:"small",iconSrc:He,onClick:()=>alert("mic")}),r(S,{variant:i?"secondary":"surface",shadedSurface:!i,label:"Message",size:"small",iconSrc:Ge,onClick:()=>o(!i)}),r(S,{shadedSurface:!0,label:"Settings",size:"small",iconSrc:qe,onClick:()=>alert("Settings")}),r(S,{variant:"danger",label:"Logout",size:"small",iconSrc:Ye,onClick:()=>e.setRoomFlow("preview")})]})]})}function Xe({vm:e,roomId:t}){return d("div",{className:"RoomView grow flex",children:[r("div",{className:"RoomView__3d grow"}),r(Je,{vm:e,roomId:t})]})}const Qe="modulepreload",j={},Ze="/",D=function(t,i){return!i||i.length===0?t():Promise.all(i.map(o=>{if(o=`${Ze}${o}`,o in j)return;j[o]=!0;const s=o.endsWith(".css"),n=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${n}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":Qe,s||(a.as="script",a.crossOrigin=""),a.href=o,document.head.appendChild(a),s)return new Promise((l,c)=>{a.addEventListener("load",l),a.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${o}`)))})})).then(()=>t())};function et(){return new Worker("/assets/GameWorker.22173f83.js",{type:"module"})}const Y=e=>t=>Math.ceil(t/e)*e,tt=Y(4),it=Y(8),y=Symbol("cursor"),N=Symbol("byteView"),ot=(e=new ArrayBuffer(1e7))=>(e[y]=0,e[N]=new Uint8Array(e.byteLength),Object.defineProperty(e,"cursor",{get(){return this[y]}}),Object.defineProperty(e,"byteView",{get(){return this[N]}}),e.clear=function(){this[N].fill(0,0,this[y])},e),st=(e,t)=>{const{name:i}=t;i.includes("32")&&(e[y]=tt(e[y])),i.includes("64")&&(e[y]=it(e[y]))},L=(e,t,i)=>{st(e,t);const o=new t(e,e[y],i);return e[y]+=i*o.BYTES_PER_ELEMENT,o},rt=(e,t,i,o)=>{const s=L(e,t,o*i),n=Array(o);for(let a=0;a<o;a++)n[a]=s.subarray(a*i,a*i+i);return n},Ot=(e,t)=>rt(e,Float32Array,16,t),J=(e=1e7,t=[new SharedArrayBuffer(e),new SharedArrayBuffer(e),new SharedArrayBuffer(e)],i=[new Uint8Array(t[0]),new Uint8Array(t[1]),new Uint8Array(t[2])],o=new Uint8Array(new SharedArrayBuffer(Uint8Array.BYTES_PER_ELEMENT)).fill(6))=>({byteLength:e,buffers:t,views:i,flags:o}),nt=e=>(e&64)!==0,at=e=>e&48|(e&3)<<2|(e&12)>>2,lt=e=>64|(e&12)<<2|(e&48)>>2|e&3,Wt=e=>Atomics.load(e.flags,0)&3,ct=e=>(Atomics.load(e.flags,0)&48)>>4,dt=(e,t)=>e.views[ct(e)].set(new Uint8Array(t)),Ut=e=>{const t=Atomics.load(e.flags,0);do if(!nt(t))return!1;while(Atomics.compareExchange(e.flags,0,t,at(t))===t);return!0},ut=e=>{const t=Atomics.load(e.flags,0);for(;Atomics.compareExchange(e.flags,0,t,lt(t))===t;);},mt=(e,t)=>{const i=e.BYTES_PER_ELEMENT*8,o=Math.floor(t/i),s=t-i*o,n=Math.pow(2,s);e[o]|=n},ht=(e,t)=>{const i=e.BYTES_PER_ELEMENT*8,o=Math.floor(t/i),s=t-i*o,n=Math.pow(2,s);e[o]&=~n},z=(e,t,i)=>{i?mt(e,t):ht(e,t)},X=(e,t)=>{const i=e.BYTES_PER_ELEMENT*8,o=Math.floor(t/i),s=t-i*o;return(Math.pow(2,s)&e[o])!==0?1:0},$=["Unassigned","Escape","Backquote","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Minus","Equal","Backspace","Tab","KeyQ","KeyW","KeyE","KeyR","KeyT","KeyY","KeyU","KeyI","KeyO","KeyP","BracketLeft","BracketRight","Backslash","CapsLock","KeyA","KeyS","KeyD","KeyF","KeyG","KeyH","KeyJ","KeyK","KeyL","Semicolon","Quote","Enter","ShiftLeft","KeyZ","KeyX","KeyC","KeyV","KeyB","KeyN","KeyM","Comma","Period","Slash","ShiftRight","ControlLeft","AltLeft","MetaLeft","Space","MetaRight","AltRight","ArrowLeft","ArrowUp","ArrowRight","ArrowDown"],ft=Object.fromEntries($.map((e,t)=>[e,t]));function H(e){return ft[e]||0}function gt(e){const t=wt(),i=J(t.buffer.byteLength),o=vt(t,e);return{tripleBuffer:i,update(){dt(i,t.buffer),ut(i),t.mouse.movement[0]=0,t.mouse.movement[1]=0},dispose(){o()}}}const wt=(e=ot())=>({buffer:e,keyboard:L(e,Uint32Array,Math.ceil($.length/32)),mouse:{movement:L(e,Float32Array,2),buttons:L(e,Uint32Array,1)}}),vt=(e,t)=>{function i({buttons:c}){document.pointerLockElement===t?e.mouse.buttons[0]=c:t.requestPointerLock()}function o({buttons:c}){document.pointerLockElement===t&&(e.mouse.buttons[0]=c)}function s({code:c}){document.pointerLockElement===t&&z(e.keyboard,H(c),1)}function n({code:c}){document.pointerLockElement===t&&z(e.keyboard,H(c),0)}function a({movementX:c,movementY:u}){document.pointerLockElement===t&&(e.mouse.movement[0]+=c,e.mouse.movement[1]+=u)}function l(){e.buffer.clear()}return t.addEventListener("mousedown",i),t.addEventListener("mouseup",o),window.addEventListener("keydown",s),window.addEventListener("keyup",n),window.addEventListener("mousemove",a),t.addEventListener("blur",l),()=>{t.removeEventListener("mousedown",i),t.removeEventListener("mouseup",o),window.removeEventListener("keydown",s),window.removeEventListener("keyup",n),window.removeEventListener("mousemove",a),t.removeEventListener("blur",l)}},pt=e=>t=>X(t.keyboard,e),G=e=>t=>t.mouse.movement[e],_t=e=>t=>X(t.mouse.buttons,e);Object.fromEntries([...$.map((e,t)=>[`Keyboard/${e}`,pt(t)]),["Mouse/movementX",G(0)],["Mouse/movementY",G(1)],...Array(6).fill(0).map((e,t)=>[`Mouse/button${t}`,_t(t)])]);var g=(e=>(e.InitializeGameWorker="initialize-game-worker",e.GameWorkerInitialized="game-worker-initialized",e.GameWorkerError="game-worker-error",e.InitializeRenderWorker="initialize-render-worker",e.StartGameWorker="start-game-worker",e.RenderWorkerInitialized="render-worker-initialized",e.RenderWorkerError="render-worker-error",e.StartRenderWorker="start-render-worker",e.InitializeGameWorkerRenderState="initialize-game-worker-render-state",e.RenderWorkerResize="render-worker-resize",e.LoadResource="load-resource",e.ResourceLoaded="resource-loaded",e.ResourceLoadError="resource-load-error",e.AddResourceRef="add-resource-ref",e.RemoveResourceRef="remove-resource-ref",e.ResourceDisposed="resource-disposed",e.AddRenderable="add-renderable",e.RemoveRenderable="remove-renderable",e.SetActiveCamera="set-active-camera",e.SetActiveScene="set-active-scene",e.ExportScene="export-scene",e.ExportGLTF="export-gltf",e.SaveGLTF="save-gltf",e))(g||{}),yt=(e=>(e.Loading="loading",e.Loaded="loaded",e.Error="error",e))(yt||{});function Rt(){return new SharedArrayBuffer(4)}function Kt(e,t){return{buffer:e,view:new Uint32Array(e),store:new Map,resourceLoaders:new Map,workerMessageTarget:t}}function jt(e,t){const i=t(e);e.resourceLoaders.set(i.type,i)}async function Dt(e,{resourceDef:t,resourceId:i}){const{type:o}=t,s=e.resourceLoaders.get(o);if(!s)throw new Error(`Resource loader ${o} not registered.`);const n=t.name||`${o}[${i}]`,a={resourceId:i,type:o,name:n,refCount:1,state:"loading",resource:void 0,promise:s.load(K(U({},t),{name:n}))};e.store.set(i,a);try{const l=await a.promise;!t.name&&l.name&&(a.name=l.name),a.resource=l.resource,a.state="loaded",e.workerMessageTarget.postMessage({type:g.ResourceLoaded,resourceId:i,remoteResource:l.remoteResource},l.transferList)}catch(l){console.error(l),a.state="error",a.error=l,e.workerMessageTarget.postMessage({type:g.ResourceLoadError,resourceId:i,error:l})}return a}function zt(e,{resourceId:t}){const i=e.store.get(t);if(!i)return;const o=e.resourceLoaders.get(i.type);o.addRef&&o.addRef(t),i.refCount++}function Ht(e,{resourceId:t}){const i=e.store.get(t);if(!i)return;const o=e.resourceLoaders.get(i.type);i.refCount===1?(o.dispose&&o.dispose(t),e.store.delete(t),e.workerMessageTarget.postMessage({type:g.ResourceDisposed,resourceId:t})):(o.removeRef&&o.removeRef(t),i.refCount--)}async function Gt(e,t){const i=e.store.get(t);if(i)return(await i.promise).resource}function qt(e,t,i,o){const s=Atomics.add(e.view,0,1),n=o||`${t}[${s}]`,a={resourceId:s,type:t,name:n,refCount:1,state:"loaded",resource:i,promise:Promise.resolve({name:n,resource:i})};return e.store.set(s,a),s}var Q=(e=>(e[e.fps=0]="fps",e[e.frameTime=1]="frameTime",e[e.frameDuration=2]="frameDuration",e[e.gameTime=3]="gameTime",e[e.gameDuration=4]="gameDuration",e[e.frame=5]="frame",e[e.staleFrames=6]="staleFrames",e[e.drawCalls=7]="drawCalls",e[e.programs=8]="programs",e[e.geometries=9]="geometries",e[e.textures=10]="textures",e[e.triangles=11]="triangles",e[e.points=12]="points",e[e.lines=13]="lines",e))(Q||{});const Z=Object.keys(Q).filter(e=>isNaN(+e));function Vt(e){const t=e||new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*Z.length);return{buffer:t,f32:new Float32Array(t),u32:new Uint32Array(t)}}function Yt(e,t,i,o,s){const{render:{frame:n,calls:a,triangles:l,points:c,lines:u},memory:{geometries:h,textures:x},programs:k}=o.info;e.f32[0]=1/t,e.f32[1]=t,e.f32[2]=i,e.u32[5]=n,e.u32[6]=s,e.u32[7]=a,e.u32[8]=k?k.length:0,e.u32[9]=h,e.u32[10]=x,e.u32[11]=l,e.u32[12]=c,e.u32[13]=u}const f=Object.fromEntries(Z.map(e=>[e,0]));function bt(e){return f.fps=e.f32[0].toFixed(2),f.frameTime=(e.f32[1]*1e3).toFixed(2),f.frameDuration=(e.f32[2]*1e3).toFixed(2),f.gameTime=(e.f32[3]*1e3).toFixed(2),f.gameDuration=e.f32[4].toFixed(2),f.frame=e.u32[5],f.staleFrames=e.u32[6],f.drawCalls=e.u32[7],f.programs=e.u32[8],f.geometries=e.u32[9],f.textures=e.u32[10],f.triangles=e.u32[11],f.points=e.u32[12],f.lines=e.u32[13],f}async function Mt(e,t){const i=!!window.OffscreenCanvas;let o,s,n,a;if(i){console.info("Browser supports OffscreenCanvas, rendering in WebWorker.");const{default:c}=await D(()=>import("./RenderWorker.95c0516c.js"),[]);o=new c,s=e.transferControlToOffscreen();const u=new MessageChannel;n=u.port1,a=u.port2}else{console.info("Browser does not support OffscreenCanvas, rendering on main thread.");const c=await D(()=>import("./RenderWorker.851855ae.js"),["assets/RenderWorker.851855ae.js","assets/vendor.f8f2a9c9.js"]);o=c.default,n=c.default,a=t,s=e}function l(){o.postMessage({type:g.RenderWorkerResize,canvasWidth:e.clientWidth,canvasHeight:e.clientHeight})}return window.addEventListener("resize",l),{renderWorker:o,canvasTarget:s,renderWorkerMessageTarget:n,gameWorkerMessageTarget:a,dispose(){window.removeEventListener("resize",l),o instanceof Worker&&o.terminate()}}}async function St(e){const t=gt(e),i=new et,{renderWorker:o,canvasTarget:s,renderWorkerMessageTarget:n,gameWorkerMessageTarget:a,dispose:l}=await Mt(e,i),c=J(),u=Rt(),h=n instanceof MessagePort?n:void 0,x=Vt();await new Promise((b,M)=>{o.postMessage({type:g.InitializeRenderWorker,renderableTripleBuffer:c,gameWorkerMessageTarget:a,canvasTarget:s,initialCanvasWidth:e.clientWidth,initialCanvasHeight:e.clientHeight,resourceManagerBuffer:u,statsSharedArrayBuffer:x.buffer},a instanceof MessagePort&&s instanceof OffscreenCanvas?[a,s]:void 0);const V=({data:_})=>{_.type===g.RenderWorkerInitialized?(b(_),o.removeEventListener("message",V)):_.type===g.RenderWorkerError&&(M(_.error),o.removeEventListener("message",V))};o.addEventListener("message",V)}),await new Promise((b,M)=>{i.postMessage({type:g.InitializeGameWorker,renderableTripleBuffer:c,inputTripleBuffer:t.tripleBuffer,renderWorkerMessagePort:h,resourceManagerBuffer:u,statsSharedArrayBuffer:x.buffer},h?[h]:void 0);const V=({data:_})=>{_.type===g.GameWorkerInitialized?(b(_),i.removeEventListener("message",V)):_.type===g.GameWorkerError&&(M(_.error),i.removeEventListener("message",V))};i.addEventListener("message",V)}),o.postMessage({type:g.StartRenderWorker}),i.postMessage({type:g.StartGameWorker});const k=({data:b})=>{if(typeof b!="object")return;const M=b;switch(M.type){case g.SaveGLTF:xt(M.buffer,"scene.glb")}};o.addEventListener("message",k),window.exportScene=()=>{i.postMessage({type:g.ExportScene})};let F;function O(){t.update(),F=requestAnimationFrame(O)}return O(),{getStats(){return bt(x)},dispose(){cancelAnimationFrame(F),t.dispose(),i.terminate(),l()}}}function xt(e,t){const i=new Blob([e],{type:"application/octet-stream"}),o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.href=URL.createObjectURL(i),o.download=t,o.click(),document.body.removeChild(o)}function kt(e){const t=w.exports.useRef();return w.exports.useEffect(()=>{var o;return e.current&&St(e.current).then(s=>t.current=s).catch(console.error),(o=t.current)==null?void 0:o.dispose()},[e]),{getStats:w.exports.useCallback(()=>{var o;return(o=t.current)==null?void 0:o.getStats()},[])}}function Lt({getStats:e}){const[,t]=w.exports.useState(0),i=w.exports.useRef();return w.exports.useEffect(()=>{let o;const s=()=>{const n=e();i.current=n,n&&t(n.frame),o=window.setTimeout(s,100)};return o=window.setTimeout(s),()=>{clearTimeout(o)}},[e]),r("div",{className:"Stats",children:i.current&&Object.entries(i.current).map(([o,s])=>d("div",{children:[d("b",{children:[o,":"]})," "+s]},o))})}function Et({vm:e}){const t=w.exports.useRef(null),{getStats:i}=kt(t);return d(A,{children:[r(Lt,{getStats:i}),r("canvas",{className:"SessionView__viewport",ref:t}),d("div",{className:"SessionView flex flex-column",children:[r(We,{vm:e.statusBarViewModel}),d("div",{className:"SessionView__content flex grow",children:[r(Fe,{vm:e.leftPanelViewModel}),r(Ct,{vm:e})]})]})]})}function Ct({vm:e}){const t=p(e,"activeRoomId");return t?e.isActiveRoomInvite?r("p",{children:"invite"}):r(Nt,{vm:e.roomViewModel,roomId:t}):r("p",{children:"select room from left panel"})}function Nt({vm:e,roomId:t}){p(e,"roomFlow");const i=w.exports.useRef();return w.exports.useEffect(()=>{i.current=e.roomFlow},[e.roomFlow]),d(A,{children:[["preview","load"].includes(e.roomFlow)&&r(Ke,{vm:e,roomId:t}),e.roomFlow==="loaded"&&r(Xe,{vm:e,roomId:t})]})}function Bt({vm:e}){const[t,i]=w.exports.useState(!1),o=async s=>{s.preventDefault();const n=s.target,{homeserver:a,username:l,password:c}=n;i(!0),await e.login(a.value,l.value,c.value),i(!1)};return t?r("p",{children:"Login in progress..."}):d("form",{style:{height:"100%"},className:"flex flex-column justify-center items-center",onSubmit:o,children:[r("label",{htmlFor:"homeserver",children:"Homeserver"}),r("input",{defaultValue:e.defaultHomeserver,name:"homeserver",placeholder:"homeserver",required:!0}),r("br",{}),r("label",{htmlFor:"username",children:"Username"}),r("input",{name:"username",placeholder:"username",required:!0}),r("br",{}),r("label",{htmlFor:"password",children:"Password"}),r("input",{name:"password",placeholder:"password",type:"password",required:!0}),r("br",{}),r("button",{type:"submit",children:"Login"})]})}function It({vm:e}){const t=p(e,"activeSection");return d("div",{className:"RootView",children:[t==="login"&&r(Bt,{vm:e.loginViewModel}),t==="session"&&r(Et,{vm:e.sessionViewModel}),t==="loading"&&r("div",{className:"flex justify-center items-center",style:{height:"100%"},children:r(v,{variant:"b1",weight:"semi-bold",children:"Loading..."})}),t==="error"&&d("div",{className:"flex flex-column justify-center items-center",style:{height:"100%"},children:[r(v,{variant:"b1",weight:"semi-bold",children:"This session is invalid"}),r("br",{}),r(E,{variant:"primary",size:"small",onClick:()=>e.logout(),children:"Delete session and login"})]})]})}function Pt(e,t){we.render(r(I.StrictMode,{children:r(It,{vm:t})}),e)}function At(e,t){const i=e==null?void 0:e.type;return i===void 0?["session","login"].includes(t.type):i==="session"?["left-panel"].includes(t.type):i==="left-panel"?["room"].includes(t.type):!1}async function Tt(){const e="root",t=document.getElementById(e);if(!t)throw new Error(`Can not find root element with id: ${e}`);const i={defaultHomeserver:"matrix.org"},o={development:!1},s=new he(t,pe,i,o),n=new fe(At);s.setNavigation(n);const a=ge({navigation:n,history:s.history});a.attach();const l=new Le({platform:s,navigation:n,urlCreator:a});l.load(),Pt(t,l)}Tt();export{yt as R,g as W,qt as a,zt as b,Dt as c,Vt as d,ot as e,Ot as f,L as g,Wt as h,Kt as i,Gt as l,Ht as o,jt as r,Ut as s,Yt as w};
