var ee=Object.defineProperty,te=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var C=(e,t,o)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,U=(e,t)=>{for(var o in t||(t={}))ie.call(t,o)&&C(e,o,t[o]);if(W)for(var o of W(t))se.call(t,o)&&C(e,o,t[o]);return e},K=(e,t)=>te(e,oe(t));var m=(e,t,o)=>(C(e,typeof t!="symbol"?t+"":t,o),o);import{_ as re,a as ne,o as ae,b as le,c as ce,V as R,R as de,C as ue,j as B,r as f,d as I,T as me,P as he,N as fe,e as ge,f as we}from"./vendor.f8f2a9c9.js";const ve=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}};ve();var pe={downloadSandbox:re,worker:ne,olm:{wasm:ae,legacyBundle:le,wasmBundle:ce}};class _e extends R{constructor(t){super(t);this._user=t.user}get userId(){return this._user.id}}function ye(e){let t=0,o,i;if(e.length===0)return t;for(o=0;o<e.length;o+=1)i=e.charCodeAt(o),t=(t<<5)-t+i,t|=0;return Math.abs(t)}function P(e){return`var(--usercolor${ye(e)%8+1})`}class Re extends R{constructor(t){super(t);this._session=t.session,this.invites=t.invites,this.rooms=t.rooms,this.track(this.navigation.observe("room").subscribe(()=>this.emitChange("activeRoomId"))),this.track(this.invites.subscribe(this._getRoomChangesHandles())),this.track(this.rooms.subscribe(this._getRoomChangesHandles()))}_getRoomChangesHandles(){const t=()=>{this.emitChange("allRooms")};return{onAdd:t,onUpdate:()=>{},onRemove:t}}getRoomColor(t){const{avatarColorId:o}=t;return P(o)}getRoomAvatarHttpUrl(t,o){const{avatarUrl:i}=t;if(i){const s=o*this.platform.devicePixelRatio;return this._session.mediaRepository.mxcUrlThumbnail(i,s,s,"crop")}return null}get allRooms(){const t=Array.from(this.invites.values()),o=Array.from(this.rooms.values());return t.concat(o)}get activeRoomId(){const t=this.navigation.path.get("room");return t?t.value:null}}class Ve extends R{constructor(t){super(t);m(this,"_client");m(this,"_sidebarViewModel");m(this,"_roomListViewModel");m(this,"_panelState");this._client=t.client,this._session=t.session,this._sidebarViewModel=new _e(this.childOptions({user:this._session.user})),this.track(this._sidebarViewModel),this._roomListViewModel=new Re(this.childOptions({session:this._session,invites:this._client.session.invites,rooms:this._client.session.rooms})),this.track(this._roomListViewModel),this._panelState="initial",this.navigation.push("left-panel","initial"),this._setupNavigation()}_setupNavigation(){this.track(this.navigation.observe("left-panel").subscribe(()=>{const t=this.navigation.path.get("left-panel");this._handlePanelState(t.value)})),this.track(this.navigation.observe("room").subscribe(()=>{this._handlePanelState("initial")}))}_handlePanelState(t){typeof t=="string"?this._panelState=t:this._panelState="initial",this.emitChange("panelState")}get sidebarViewModel(){return this._sidebarViewModel}get roomListViewModel(){return this._roomListViewModel}get panelState(){return this._panelState}}class be extends R{constructor(t){super(t);m(this,"_chatViewModel");m(this,"_roomFlow");this.room=t.room,this._chatViewModel=null,this._roomFlow="preview",this.emitChange("roomFlow"),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("left-panel"),o=t.subscribe(()=>{const i=t.get();i==="initial"&&this.setRoomFlow("preview"),this.roomFlow==="load"&&i!=="close"&&this.setRoomFlow("preview")});this.track(o)}async loadChatView(){this._chatViewModel=new de(this.childOptions({room:this.room})),this.track(this._chatViewModel),await this._chatViewModel.load()}_disposeChatView(){this.disposeTracked(this._chatViewModel),this._chatViewModel=null}setRoomFlow(t){this._roomFlow!==t&&(t==="preview"?(this.toggleLeftPanel("initial"),this._chatViewModel&&this._disposeChatView()):t==="load"?(this.toggleLeftPanel("initial"),this.loadChatView().then(()=>this.emitChange("chatViewModel"))):this.toggleLeftPanel("close"),this._roomFlow=t,this.emitChange("roomFlow"))}toggleLeftPanel(t){var a;const o=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,i=t!=null?t:o==="close"?"open":"close",s=this.navigation.segment("left-panel",i),r=this.navigation.path.replace(s);this.navigation.applyPath(r)}getRoomColor(){const{avatarColorId:t}=this.room;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:o,mediaRepository:i}=this.room;if(o){if(!t)return i.mxcUrl(o);const s=t*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get roomFlow(){return this._roomFlow}get name(){return this.room.name}get chatViewModel(){return this._chatViewModel}}class Me extends R{constructor(t){super(t);this.invite=t.invite}getRoomColor(){const{avatarColorId:t}=this.invite;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:o,mediaRepository:i}=this.invite;if(o){if(!t)return i.mxcUrl(o);const s=t*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get name(){return this.invite.name}}class Se extends R{constructor(t){super(t);this._rooms=t.session.rooms,this._overlayBtnVisibility=!1,this._leftPanelState="initial",this._selectedRoom=void 0,this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("left-panel"),o=t.subscribe(()=>{const r=t.get();r==="initial"?this._overlayBtnVisibility=!1:this._overlayBtnVisibility=!0,this._leftPanelState=r,this.emitChange("overlayBtnVisibility"),this.emitChange("leftPanelState")});this.track(o);const i=this.navigation.observe("room"),s=i.subscribe(()=>{const r=i.get();this._selectedRoom=this._rooms.get(r),this._overlayBtnVisibility=!1,this._leftPanelVisibility="initial",this.emitChange("overlayBtnVisibility"),this.emitChange("leftPanelState"),this.emitChange("selectedRoomName")});this.track(s)}toggleLeftPanel(t){var a;const o=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,i=t!=null?t:o==="close"?"open":"close",s=this.navigation.segment("left-panel",i),r=this.navigation.path.replace(s);this.navigation.applyPath(r)}get selectedRoomName(){if(!!this._selectedRoom)return this._selectedRoom.name||"Empty room"}get overlayBtnVisibility(){return this._overlayBtnVisibility}get leftPanelState(){return this._leftPanelState}}class xe extends R{constructor(t){super(t);m(this,"_client");m(this,"_session");m(this,"_statusBarViewModel");m(this,"_leftPanelViewModel");m(this,"_roomViewModel");m(this,"_inviteViewModel");m(this,"_activeRoomId");this._client=t.client,this._session=t.client.session,this._roomViewModel=null,this._inviteViewModel=null,this._activeRoomId=null,this._statusBarViewModel=new Se(this.childOptions({client:this._client,session:this._session})),this.track(this._statusBarViewModel),this._leftPanelViewModel=new Ve(this.childOptions({client:this._client,session:this._session})),this.track(this._leftPanelViewModel),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("room"),o=t.subscribe(()=>{this._handleRoomView(t.get())});this.track(o),this._handleRoomView(t.get())}_handleRoomView(t){if(this._activeRoomId===t)return;this._roomViewModel=this.disposeTracked(this._roomViewModel),this._inviteViewModel=this.disposeTracked(this._inviteViewModel),this._activeRoomId=null;const{rooms:o,invites:i}=this._session,s=o.get(t)||i.get(t);if(t===void 0||s===void 0){this.emitChange("activeRoomId");return}s.isInvite?(this._inviteViewModel=new Me(this.childOptions({invite:s})),this.track(this._inviteViewModel)):(this._roomViewModel=new be(this.childOptions({room:s})),this.track(this._roomViewModel)),this._activeRoomId=s.id,this.emitChange("activeRoomId")}get activeRoomId(){return this._activeRoomId}get isActiveRoomInvite(){return this._session.invites.get(this._activeRoomId)!==void 0}get statusBarViewModel(){return this._statusBarViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get roomViewModel(){return this._roomViewModel}get inviteViewModel(){return this._inviteViewModel}}class ke extends R{constructor(t){super(t);m(this,"_client");this._client=t.client}async login(t,o,i){const s=await this._client.queryLogin(t).result;await this._client.startWithLogin(s.password(o,i)),this._options.ready(this._client.sessionId)}get defaultHomeserver(){return this.platform.config.defaultHomeserver}}class Le extends R{constructor(t){super(t);m(this,"_client");m(this,"_loginViewModel");m(this,"_sessionViewModel");m(this,"_error");this._loginViewModel=null,this._sessionViewModel=null,this._error=!1,this._client=new ue(t.platform),this.track(this._client)}async load(){this.track(this.navigation.observe("login").subscribe(s=>this._applyNavigation(s,"login"))),this.track(this.navigation.observe("session").subscribe(s=>this._applyNavigation(s,"session")));const t=this.navigation.path.get("login"),o=this.navigation.path.get("session"),i=t||o;i?this._applyNavigation(i.value,i.type):this._applyNavigation(void 0,void 0)}async _applyNavigation(t,o){const i=await this.platform.sessionInfoStorage.getAll();if(o==="login"&&i.length===0){this._viewLogin();return}if(o==="session"&&i.length>0){const s=i[0].id;if(t!==s){this.navigation.push("session",s);return}if(await this._client.startWithExistingSession(s),this._client.loadStatus.get()==="Error"){this._viewError();return}this._viewSession();return}i.length>0?this.navigation.push("session",i[0].id):this.navigation.push("login")}_viewLogin(){this._setSection(()=>{this._loginViewModel=new ke(this.childOptions({client:this._client,ready:t=>{this.navigation.push("session",t)}}))})}_viewSession(){this._setSection(()=>{this._sessionViewModel=new xe(this.childOptions({client:this._client}))})}_viewError(){this._setSection(()=>{this._error=!0})}_setSection(t){this._error=!1,this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),t(),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}async logout(){await this._client.startLogout(this._client.sessionId),this.navigation.push("login")}get activeSection(){return this._sessionViewModel?"session":this._loginViewModel?"login":this._error?"error":"loading"}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}}const n=B.exports.jsx,d=B.exports.jsxs,A=B.exports.Fragment;function v({className:e=void 0,style:t=void 0,variant:o="b1",weight:i="regular",type:s=void 0,children:r}){const a=[];e&&a.push(e),a.push(`Text Text-${o} Text--${i}`);const l=a.join(" ");return s==="span"?n("span",{className:l,style:t,children:r}):s==="div"?n("div",{className:l,style:t,children:r}):o==="h2"?n("h2",{className:l,style:t,children:r}):o==="s1"?n("h4",{className:l,style:t,children:r}):n("p",{className:l,style:t,children:r})}function $({color:e=void 0,size:t="normal",src:o,isImage:i=!1}){const s={};return typeof e=="string"&&(s.backgroundColor=e),i?(s.backgroundColor="transparent",s.backgroundImage=`url(${o})`):(s.WebkitMaskImage=`url(${o})`,s.maskImage=`url(${o})`),n("span",{className:`Icon Icon--${t}`,style:s})}function q({className:e=void 0,variant:t="surface",type:o="button",onClick:i,children:s,disabled:r=!1}){return n("button",{className:`${e?`${e} `:""}RawButton-${t}`,type:o,onClick:i,disabled:r,children:s})}function E({className:e=void 0,variant:t="surface",size:o="normal",iconSrc:i=void 0,iconPlacement:s="start",type:r="button",onClick:a,children:l,disabled:c=!1}){const u=i?n($,{size:o,src:i}):null,h=[];return e&&h.push(e),h.push(`Button Button--${o}`),d(q,{className:h.join(" "),variant:t,type:r,onClick:a,disabled:c,children:[s==="start"&&u,typeof l=="string"?n(v,{variant:o==="extra-small"?"b3":"b2",children:l}):l,s==="end"&&u]})}function S({className:e=void 0,variant:t="surface",size:o="normal",isCircle:i=!1,shadedSurface:s=!1,iconSrc:r,label:a,type:l="button",onClick:c,disabled:u=!1}){const h=[];return e&&h.push(e),h.push(`IconButton IconButton--${o}`),i&&h.push("IconButton--circle"),s&&t==="surface"&&h.push("IconButton--shaded"),n(q,{className:h.join(" "),variant:t,type:l,onClick:c,disabled:u,"aria-label":a,children:n($,{size:o,src:r})})}var Ee="/assets/home.831114d8.svg",Ce="/assets/grid.f44641b3.svg";function Ne({vm:e}){return n("div",{className:"SidebarView flex flex-column",children:d("div",{className:"SidebarView__scrollable grow flex flex-column items-center",children:[n(S,{size:"small",label:"Home",shadedSurface:!0,iconSrc:Ee,onClick:()=>!1}),n(S,{size:"small",label:"Grid",shadedSurface:!0,iconSrc:Ce,onClick:()=>!1})]})})}function Be({className:e,direction:t="vertical",visibility:o="auto",onScroll:i=void 0,children:s}){const r=[`Scroll Scroll--${t} Scroll--${o}`];return e&&r.push(e),n("div",{className:r.join(" "),onScroll:i,children:s})}function Ie({className:e,name:t,bgColor:o,isCircle:i=!1,imageSrc:s=void 0,size:r="normal"}){const[a,l]=f.exports.useState(!1);let c="s1";r==="large"&&(c="h2"),r==="small"&&(c="b1"),r==="extra-small"&&(c="b3");const u=["Avatar"];u.push(`Avatar--${r}`),i&&u.push("Avatar--circle"),u.push("noselect"),e&&u.push(e);const h={};return(a||!s)&&(h.backgroundColor=o),n("div",{className:u.join(" "),"aria-label":t,style:h,children:!a&&s?n("img",{draggable:"false",src:s,alt:"",onError:()=>l(!0)}):n(v,{variant:c,weight:"medium",type:"span",children:[...t][0]})})}function Pe({title:e,avatar:t,isActive:o=!1,onClick:i}){return d("button",{onClick:i,className:`RoomTile${o?"--active":""} flex items-start`,children:[t,n("div",{className:"RoomTile__content grow flex flex-column",children:e})]})}var Ae="/assets/add-box.a3a974bc.svg",$e="/assets/manage-search.4d8bfab6.svg";function p(e,t){const[o,i]=f.exports.useState(e[t]);return f.exports.useLayoutEffect(()=>{const s=e.disposableOn("change",r=>{r===t&&i(e[t])});return()=>s()},[e,t]),o}function Te({vm:e}){const t=p(e,"allRooms"),o=p(e,"activeRoomId");return d("div",{className:"RoomListView flex flex-column",children:[n("header",{className:"flex items-center",children:n(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:"Home"})}),n("div",{className:"RoomListView__container grow",children:n(Be,{children:d("div",{className:"RoomListView__content",children:[d("header",{className:"flex items-center",children:[n(v,{className:"grow",variant:"b2",weight:"semi-bold",children:"Rooms"}),n(E,{iconSrc:Ae,size:"extra-small",onClick:()=>alert("create room"),children:"Create"}),n(E,{iconSrc:$e,size:"extra-small",onClick:()=>alert("Discover"),children:"Discover"})]}),t.map(i=>n(Pe,{isActive:i.id===o,onClick:()=>e.navigation.push("room",i.id),avatar:n(Ie,{name:i.name||"Empty room",size:"large",isCircle:!0,className:"shrink-0",bgColor:e.getRoomColor(i),imageSrc:e.getRoomAvatarHttpUrl(i,32)}),title:n(v,{className:"truncate",variant:"b2",weight:"semi-bold",children:i.name||"Empty room"})},i.id))]})})})]})}function Fe({vm:e}){const t=p(e,"panelState");return d("div",{className:`LeftPanelView LeftPanelView--${t} flex`,children:[n(Ne,{vm:e.sidebarViewModel}),n(Te,{vm:e.roomListViewModel})]})}function Oe({text:e,onClick:t}){return n("button",{className:"OpenOverlay",onClick:t,children:d(v,{className:"flex items-center",variant:"b3",children:[n("span",{children:"ESC"}),e]})})}function We({vm:e}){const t=p(e,"overlayBtnVisibility"),o=p(e,"leftPanelState"),i=p(e,"selectedRoomName");return d("div",{className:"StatusBar shrink-0 flex items-center",children:[n("div",{className:"StatusBar__left grow basis-0",children:t&&n(Oe,{text:o==="close"?"Open Overlay":"Close Overlay",onClick:()=>e.toggleLeftPanel()})}),n("div",{className:"StatusBar__center",children:i&&n(v,{weight:"semi-bold",children:i})}),n("div",{className:"StatusBar__right grow basis-0 flex justify-end",children:n(v,{variant:"b3",children:"0 Notifications"})})]})}var Ue="/assets/peoples.9192a047.svg";function Ke({vm:e,roomId:t}){const o=e.name||"Empty room",i=e.roomFlow==="preview";return n("div",{className:"RoomPreview grow flex flex-column justify-end items-center",children:d("div",{className:"RoomPreview__card flex items-center",children:[n("div",{className:"grow",children:n(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:o})}),d("div",{className:"RoomPreview__card-memberCount flex items-center",children:[n($,{src:Ue}),e.room.joinedMemberCount]}),n("div",{className:"shrink-0",children:n(E,{variant:i?"secondary":"primary",onClick:()=>e.setRoomFlow(i?"load":"loaded"),children:i?"Load World":"Open World"})})]})})}function je({roomId:e,vm:t}){return I.useEffect(()=>{const o=new me(t),i=o.mount();i.querySelector(".Timeline_scroller").classList.add("Scroll","Scroll--vertical","Scroll--auto");const r=document.getElementById("TimelineView");return r==null||r.append(i),()=>{o.unmount(),r!=null&&r.hasChildNodes()&&(r==null||r.removeChild(r==null?void 0:r.childNodes[0]))}},[e,t]),n("div",{className:"TimelineView grow flex hydrogen",id:"TimelineView"})}function De({vm:e}){return n("div",{className:"ComposerView flex items-center",children:n("form",{className:"grow",onSubmit:o=>{o.preventDefault();const i=o.target,s=i.message.value.trim();s!==""&&(i.message.value="",e.sendMessage(s))},children:n("input",{name:"message",type:"text",placeholder:"Send message"})})})}function ze({vm:e,roomId:t}){return p(e,"timelineViewModel"),d("div",{className:"ChatView flex flex-column",id:"ChatView",children:[n("header",{className:"flex items-center",children:n(v,{variant:"s1",weight:"semi-bold",children:e.name})}),e.timelineViewModel?n(je,{roomId:t,vm:e.timelineViewModel}):n("div",{className:"grow flex justify-center items-center",children:n(v,{children:"loading..."})}),n(De,{vm:e.composerViewModel})]})}var He="/assets/mic.05083630.svg",Ge="/assets/message.a538e66d.svg",qe="/assets/setting.e1dd037a.svg",Ye="/assets/logout.eda2bbfa.svg";function Je({vm:e,roomId:t}){const[o,i]=I.useState(!1);return d(A,{children:[n("div",{className:`RoomView__chat${o?" RoomView__chat--visible":""}`,children:n(ze,{roomId:t,vm:e.chatViewModel})}),d("div",{className:"RoomView__controls flex",children:[n(S,{shadedSurface:!0,label:"Mic",size:"small",iconSrc:He,onClick:()=>alert("mic")}),n(S,{variant:o?"secondary":"surface",shadedSurface:!o,label:"Message",size:"small",iconSrc:Ge,onClick:()=>i(!o)}),n(S,{shadedSurface:!0,label:"Settings",size:"small",iconSrc:qe,onClick:()=>alert("Settings")}),n(S,{variant:"danger",label:"Logout",size:"small",iconSrc:Ye,onClick:()=>e.setRoomFlow("preview")})]})]})}function Xe({vm:e,roomId:t}){return d("div",{className:"RoomView grow flex",children:[n("div",{className:"RoomView__3d grow"}),n(Je,{vm:e,roomId:t})]})}const Qe="modulepreload",j={},Ze="/",D=function(t,o){return!o||o.length===0?t():Promise.all(o.map(i=>{if(i=`${Ze}${i}`,i in j)return;j[i]=!0;const s=i.endsWith(".css"),r=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${r}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":Qe,s||(a.as="script",a.crossOrigin=""),a.href=i,document.head.appendChild(a),s)return new Promise((l,c)=>{a.addEventListener("load",l),a.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>t())};function et(){return new Worker("/assets/GameWorker.22173f83.js",{type:"module"})}const Y=e=>t=>Math.ceil(t/e)*e,tt=Y(4),ot=Y(8),y=Symbol("cursor"),N=Symbol("byteView"),it=(e=new ArrayBuffer(1e7))=>(e[y]=0,e[N]=new Uint8Array(e.byteLength),Object.defineProperty(e,"cursor",{get(){return this[y]}}),Object.defineProperty(e,"byteView",{get(){return this[N]}}),e.clear=function(){this[N].fill(0,0,this[y])},e),st=(e,t)=>{const{name:o}=t;o.includes("32")&&(e[y]=tt(e[y])),o.includes("64")&&(e[y]=ot(e[y]))},L=(e,t,o)=>{st(e,t);const i=new t(e,e[y],o);return e[y]+=o*i.BYTES_PER_ELEMENT,i},rt=(e,t,o,i)=>{const s=L(e,t,i*o),r=Array(i);for(let a=0;a<i;a++)r[a]=s.subarray(a*o,a*o+o);return r},Ot=(e,t)=>rt(e,Float32Array,16,t),J=(e=1e7,t=[new SharedArrayBuffer(e),new SharedArrayBuffer(e),new SharedArrayBuffer(e)],o=[new Uint8Array(t[0]),new Uint8Array(t[1]),new Uint8Array(t[2])],i=new Uint8Array(new SharedArrayBuffer(Uint8Array.BYTES_PER_ELEMENT)).fill(6))=>({byteLength:e,buffers:t,views:o,flags:i}),nt=e=>(e&64)!==0,at=e=>e&48|(e&3)<<2|(e&12)>>2,lt=e=>64|(e&12)<<2|(e&48)>>2|e&3,Wt=e=>Atomics.load(e.flags,0)&3,ct=e=>(Atomics.load(e.flags,0)&48)>>4,dt=(e,t)=>e.views[ct(e)].set(new Uint8Array(t)),Ut=e=>{const t=Atomics.load(e.flags,0);do if(!nt(t))return!1;while(Atomics.compareExchange(e.flags,0,t,at(t))===t);return!0},ut=e=>{const t=Atomics.load(e.flags,0);for(;Atomics.compareExchange(e.flags,0,t,lt(t))===t;);},mt=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i,r=Math.pow(2,s);e[i]|=r},ht=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i,r=Math.pow(2,s);e[i]&=~r},z=(e,t,o)=>{o?mt(e,t):ht(e,t)},X=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i;return(Math.pow(2,s)&e[i])!==0?1:0},T=["Unassigned","Escape","Backquote","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Minus","Equal","Backspace","Tab","KeyQ","KeyW","KeyE","KeyR","KeyT","KeyY","KeyU","KeyI","KeyO","KeyP","BracketLeft","BracketRight","Backslash","CapsLock","KeyA","KeyS","KeyD","KeyF","KeyG","KeyH","KeyJ","KeyK","KeyL","Semicolon","Quote","Enter","ShiftLeft","KeyZ","KeyX","KeyC","KeyV","KeyB","KeyN","KeyM","Comma","Period","Slash","ShiftRight","ControlLeft","AltLeft","MetaLeft","Space","MetaRight","AltRight","ArrowLeft","ArrowUp","ArrowRight","ArrowDown"],ft=Object.fromEntries(T.map((e,t)=>[e,t]));function H(e){return ft[e]||0}function gt(e){const t=wt(),o=J(t.buffer.byteLength),i=vt(t,e);return{tripleBuffer:o,update(){dt(o,t.buffer),ut(o),t.mouse.movement[0]=0,t.mouse.movement[1]=0},dispose(){i()}}}const wt=(e=it())=>({buffer:e,keyboard:L(e,Uint32Array,Math.ceil(T.length/32)),mouse:{movement:L(e,Float32Array,2),buttons:L(e,Uint32Array,1)}}),vt=(e,t)=>{function o({buttons:c}){document.pointerLockElement===t?e.mouse.buttons[0]=c:t.requestPointerLock()}function i({buttons:c}){document.pointerLockElement===t&&(e.mouse.buttons[0]=c)}function s({code:c}){document.pointerLockElement===t&&z(e.keyboard,H(c),1)}function r({code:c}){document.pointerLockElement===t&&z(e.keyboard,H(c),0)}function a({movementX:c,movementY:u}){document.pointerLockElement===t&&(e.mouse.movement[0]+=c,e.mouse.movement[1]+=u)}function l(){e.buffer.clear()}return t.addEventListener("mousedown",o),t.addEventListener("mouseup",i),window.addEventListener("keydown",s),window.addEventListener("keyup",r),window.addEventListener("mousemove",a),t.addEventListener("blur",l),()=>{t.removeEventListener("mousedown",o),t.removeEventListener("mouseup",i),window.removeEventListener("keydown",s),window.removeEventListener("keyup",r),window.removeEventListener("mousemove",a),t.removeEventListener("blur",l)}},pt=e=>t=>X(t.keyboard,e),G=e=>t=>t.mouse.movement[e],_t=e=>t=>X(t.mouse.buttons,e);Object.fromEntries([...T.map((e,t)=>[`Keyboard/${e}`,pt(t)]),["Mouse/movementX",G(0)],["Mouse/movementY",G(1)],...Array(6).fill(0).map((e,t)=>[`Mouse/button${t}`,_t(t)])]);var w=(e=>(e.InitializeGameWorker="initialize-game-worker",e.GameWorkerInitialized="game-worker-initialized",e.GameWorkerError="game-worker-error",e.InitializeRenderWorker="initialize-render-worker",e.StartGameWorker="start-game-worker",e.RenderWorkerInitialized="render-worker-initialized",e.RenderWorkerError="render-worker-error",e.StartRenderWorker="start-render-worker",e.InitializeGameWorkerRenderState="initialize-game-worker-render-state",e.RenderWorkerResize="render-worker-resize",e.LoadResource="load-resource",e.ResourceLoaded="resource-loaded",e.ResourceLoadError="resource-load-error",e.AddResourceRef="add-resource-ref",e.RemoveResourceRef="remove-resource-ref",e.ResourceDisposed="resource-disposed",e.AddRenderable="add-renderable",e.RemoveRenderable="remove-renderable",e.SetActiveCamera="set-active-camera",e.SetActiveScene="set-active-scene",e.ExportScene="export-scene",e.ExportGLTF="export-gltf",e.SaveGLTF="save-gltf",e))(w||{}),yt=(e=>(e.Loading="loading",e.Loaded="loaded",e.Error="error",e))(yt||{});function Rt(){return new SharedArrayBuffer(4)}function Kt(e,t){return{buffer:e,view:new Uint32Array(e),store:new Map,resourceLoaders:new Map,workerMessageTarget:t}}function jt(e,t){const o=t(e);e.resourceLoaders.set(o.type,o)}async function Dt(e,{resourceDef:t,resourceId:o}){const{type:i}=t,s=e.resourceLoaders.get(i);if(!s)throw new Error(`Resource loader ${i} not registered.`);const r=t.name||`${i}[${o}]`,a={resourceId:o,type:i,name:r,refCount:1,state:"loading",resource:void 0,promise:s.load(K(U({},t),{name:r}))};e.store.set(o,a);try{const l=await a.promise;!t.name&&l.name&&(a.name=l.name),a.resource=l.resource,a.state="loaded",e.workerMessageTarget.postMessage({type:w.ResourceLoaded,resourceId:o,remoteResource:l.remoteResource},l.transferList)}catch(l){console.error(l),a.state="error",a.error=l,e.workerMessageTarget.postMessage({type:w.ResourceLoadError,resourceId:o,error:l})}return a}function zt(e,{resourceId:t}){const o=e.store.get(t);if(!o)return;const i=e.resourceLoaders.get(o.type);i.addRef&&i.addRef(t),o.refCount++}function Ht(e,{resourceId:t}){const o=e.store.get(t);if(!o)return;const i=e.resourceLoaders.get(o.type);o.refCount===1?(i.dispose&&i.dispose(t),e.store.delete(t),e.workerMessageTarget.postMessage({type:w.ResourceDisposed,resourceId:t})):(i.removeRef&&i.removeRef(t),o.refCount--)}async function Gt(e,t){const o=e.store.get(t);if(o)return(await o.promise).resource}function qt(e,t,o,i){const s=Atomics.add(e.view,0,1),r=i||`${t}[${s}]`,a={resourceId:s,type:t,name:r,refCount:1,state:"loaded",resource:o,promise:Promise.resolve({name:r,resource:o})};return e.store.set(s,a),s}var Q=(e=>(e[e.fps=0]="fps",e[e.frameTime=1]="frameTime",e[e.frameDuration=2]="frameDuration",e[e.gameTime=3]="gameTime",e[e.gameDuration=4]="gameDuration",e[e.frame=5]="frame",e[e.staleFrames=6]="staleFrames",e[e.drawCalls=7]="drawCalls",e[e.programs=8]="programs",e[e.geometries=9]="geometries",e[e.textures=10]="textures",e[e.triangles=11]="triangles",e[e.points=12]="points",e[e.lines=13]="lines",e))(Q||{});const Z=Object.keys(Q).filter(e=>isNaN(+e));function Vt(e){const t=e||new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*Z.length);return{buffer:t,f32:new Float32Array(t),u32:new Uint32Array(t)}}function Yt(e,t,o,i,s){const{render:{frame:r,calls:a,triangles:l,points:c,lines:u},memory:{geometries:h,textures:x},programs:k}=i.info;e.f32[0]=1/t,e.f32[1]=t,e.f32[2]=o,e.u32[5]=r,e.u32[6]=s,e.u32[7]=a,e.u32[8]=k?k.length:0,e.u32[9]=h,e.u32[10]=x,e.u32[11]=l,e.u32[12]=c,e.u32[13]=u}const g=Object.fromEntries(Z.map(e=>[e,0]));function bt(e){return g.fps=e.f32[0].toFixed(2),g.frameTime=(e.f32[1]*1e3).toFixed(2),g.frameDuration=(e.f32[2]*1e3).toFixed(2),g.gameTime=(e.f32[3]*1e3).toFixed(2),g.gameDuration=e.f32[4].toFixed(2),g.frame=e.u32[5],g.staleFrames=e.u32[6],g.drawCalls=e.u32[7],g.programs=e.u32[8],g.geometries=e.u32[9],g.textures=e.u32[10],g.triangles=e.u32[11],g.points=e.u32[12],g.lines=e.u32[13],g}async function Mt(e,t){const o=!!window.OffscreenCanvas;let i,s,r,a;if(o){console.info("Browser supports OffscreenCanvas, rendering in WebWorker.");const{default:c}=await D(()=>import("./RenderWorker.95c0516c.js"),[]);i=new c,s=e.transferControlToOffscreen();const u=new MessageChannel;r=u.port1,a=u.port2}else{console.info("Browser does not support OffscreenCanvas, rendering on main thread.");const c=await D(()=>import("./RenderWorker.8eea4e14.js"),["assets/RenderWorker.8eea4e14.js","assets/vendor.f8f2a9c9.js"]);i=c.default,r=c.default,a=t,s=e}function l(){i.postMessage({type:w.RenderWorkerResize,canvasWidth:e.clientWidth,canvasHeight:e.clientHeight})}return window.addEventListener("resize",l),{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:r,gameWorkerMessageTarget:a,dispose(){window.removeEventListener("resize",l),i instanceof Worker&&i.terminate()}}}async function St(e){const t=gt(e),o=new et,{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:r,gameWorkerMessageTarget:a,dispose:l}=await Mt(e,o),c=J(),u=Rt(),h=r instanceof MessagePort?r:void 0,x=Vt();await new Promise((b,M)=>{i.postMessage({type:w.InitializeRenderWorker,renderableTripleBuffer:c,gameWorkerMessageTarget:a,canvasTarget:s,initialCanvasWidth:e.clientWidth,initialCanvasHeight:e.clientHeight,resourceManagerBuffer:u,statsSharedArrayBuffer:x.buffer},a instanceof MessagePort&&s instanceof OffscreenCanvas?[a,s]:void 0);const V=({data:_})=>{_.type===w.RenderWorkerInitialized?(b(_),i.removeEventListener("message",V)):_.type===w.RenderWorkerError&&(M(_.error),i.removeEventListener("message",V))};i.addEventListener("message",V)}),await new Promise((b,M)=>{o.postMessage({type:w.InitializeGameWorker,renderableTripleBuffer:c,inputTripleBuffer:t.tripleBuffer,renderWorkerMessagePort:h,resourceManagerBuffer:u,statsSharedArrayBuffer:x.buffer},h?[h]:void 0);const V=({data:_})=>{_.type===w.GameWorkerInitialized?(b(_),o.removeEventListener("message",V)):_.type===w.GameWorkerError&&(M(_.error),o.removeEventListener("message",V))};o.addEventListener("message",V)}),i.postMessage({type:w.StartRenderWorker}),o.postMessage({type:w.StartGameWorker});const k=({data:b})=>{if(typeof b!="object")return;const M=b;switch(M.type){case w.SaveGLTF:xt(M.buffer,"scene.glb")}};i.addEventListener("message",k);let F;function O(){t.update(),F=requestAnimationFrame(O)}return O(),{getStats(){return bt(x)},exportScene(){o.postMessage({type:w.ExportScene})},dispose(){cancelAnimationFrame(F),t.dispose(),o.terminate(),l()}}}function xt(e,t){const o=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.style.display="none",document.body.appendChild(i),i.href=URL.createObjectURL(o),i.download=t,i.click(),document.body.removeChild(i)}function kt(e){const t=f.exports.useRef();f.exports.useEffect(()=>{const s=window;return s.thirdroom||(s.thirdroom={}),s.thirdroom.exportScene=()=>{},e.current&&St(e.current).then(r=>{s.thirdroom.exportScene=()=>{r.exportScene()},t.current=r}).catch(console.error),()=>{var r;s.thirdroom&&(s.thirdroom.exportScene=()=>{}),(r=t.current)==null||r.dispose()}},[e]);const o=f.exports.useCallback(()=>{var s;return(s=t.current)==null?void 0:s.getStats()},[]),i=f.exports.useCallback(()=>{var s;return(s=t.current)==null?void 0:s.exportScene()},[]);return{getStats:o,exportScene:i}}function Lt({getStats:e}){const[t,o]=f.exports.useState(!1),[,i]=f.exports.useState(0),s=f.exports.useRef();return f.exports.useEffect(()=>{const r=window;return r.thirdroom||(r.thirdroom={}),r.thirdroom.showStats=(a=!0)=>{o(a)},()=>{r.thirdroom.showStats=()=>{}}},[]),f.exports.useEffect(()=>{let r;const a=()=>{const l=e();s.current=l,l&&i(l.frame),r=window.setTimeout(a,100)};return t&&a(),()=>{clearTimeout(r)}},[e,t]),t?n("div",{className:"Stats",children:s.current&&Object.entries(s.current).map(([r,a])=>d("div",{children:[d("b",{children:[r,":"]})," "+a]},r))}):null}function Et({vm:e}){const t=f.exports.useRef(null),{getStats:o}=kt(t);return d(A,{children:[n(Lt,{getStats:o}),n("canvas",{className:"SessionView__viewport",ref:t}),d("div",{className:"SessionView flex flex-column",children:[n(We,{vm:e.statusBarViewModel}),d("div",{className:"SessionView__content flex grow",children:[n(Fe,{vm:e.leftPanelViewModel}),n(Ct,{vm:e})]})]})]})}function Ct({vm:e}){const t=p(e,"activeRoomId");return t?e.isActiveRoomInvite?n("p",{children:"invite"}):n(Nt,{vm:e.roomViewModel,roomId:t}):n("p",{children:"select room from left panel"})}function Nt({vm:e,roomId:t}){p(e,"roomFlow");const o=f.exports.useRef();return f.exports.useEffect(()=>{o.current=e.roomFlow},[e.roomFlow]),d(A,{children:[["preview","load"].includes(e.roomFlow)&&n(Ke,{vm:e,roomId:t}),e.roomFlow==="loaded"&&n(Xe,{vm:e,roomId:t})]})}function Bt({vm:e}){const[t,o]=f.exports.useState(!1),i=async s=>{s.preventDefault();const r=s.target,{homeserver:a,username:l,password:c}=r;o(!0),await e.login(a.value,l.value,c.value),o(!1)};return t?n("p",{children:"Login in progress..."}):d("form",{style:{height:"100%"},className:"flex flex-column justify-center items-center",onSubmit:i,children:[n("label",{htmlFor:"homeserver",children:"Homeserver"}),n("input",{defaultValue:e.defaultHomeserver,name:"homeserver",placeholder:"homeserver",required:!0}),n("br",{}),n("label",{htmlFor:"username",children:"Username"}),n("input",{name:"username",placeholder:"username",required:!0}),n("br",{}),n("label",{htmlFor:"password",children:"Password"}),n("input",{name:"password",placeholder:"password",type:"password",required:!0}),n("br",{}),n("button",{type:"submit",children:"Login"})]})}function It({vm:e}){const t=p(e,"activeSection");return d("div",{className:"RootView",children:[t==="login"&&n(Bt,{vm:e.loginViewModel}),t==="session"&&n(Et,{vm:e.sessionViewModel}),t==="loading"&&n("div",{className:"flex justify-center items-center",style:{height:"100%"},children:n(v,{variant:"b1",weight:"semi-bold",children:"Loading..."})}),t==="error"&&d("div",{className:"flex flex-column justify-center items-center",style:{height:"100%"},children:[n(v,{variant:"b1",weight:"semi-bold",children:"This session is invalid"}),n("br",{}),n(E,{variant:"primary",size:"small",onClick:()=>e.logout(),children:"Delete session and login"})]})]})}function Pt(e,t){we.render(n(I.StrictMode,{children:n(It,{vm:t})}),e)}function At(e,t){const o=e==null?void 0:e.type;return o===void 0?["session","login"].includes(t.type):o==="session"?["left-panel"].includes(t.type):o==="left-panel"?["room"].includes(t.type):!1}async function $t(){const e="root",t=document.getElementById(e);if(!t)throw new Error(`Can not find root element with id: ${e}`);const o={defaultHomeserver:"matrix.org"},i={development:!1},s=new he(t,pe,o,i),r=new fe(At);s.setNavigation(r);const a=ge({navigation:r,history:s.history});a.attach();const l=new Le({platform:s,navigation:r,urlCreator:a});l.load(),Pt(t,l)}$t();export{yt as R,w as W,qt as a,zt as b,Dt as c,Vt as d,it as e,Ot as f,L as g,Wt as h,Kt as i,Gt as l,Ht as o,jt as r,Ut as s,Yt as w};
