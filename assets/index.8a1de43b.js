var ee=Object.defineProperty,te=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var C=(e,t,o)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,W=(e,t)=>{for(var o in t||(t={}))ie.call(t,o)&&C(e,o,t[o]);if(O)for(var o of O(t))se.call(t,o)&&C(e,o,t[o]);return e},U=(e,t)=>te(e,oe(t));var u=(e,t,o)=>(C(e,typeof t!="symbol"?t+"":t,o),o);import{_ as re,a as ne,o as ae,b as le,c as ce,V as R,R as de,C as ue,j as A,r as w,d as N,T as me,P as he,N as fe,e as ge,f as we}from"./vendor.f8f2a9c9.js";const ve=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}};ve();var pe={downloadSandbox:re,worker:ne,olm:{wasm:ae,legacyBundle:le,wasmBundle:ce}};class _e extends R{constructor(t){super(t);this._user=t.user}get userId(){return this._user.id}}function Re(e){let t=0,o,i;if(e.length===0)return t;for(o=0;o<e.length;o+=1)i=e.charCodeAt(o),t=(t<<5)-t+i,t|=0;return Math.abs(t)}function P(e){return`var(--usercolor${Re(e)%8})`}class Ve extends R{constructor(t){super(t);this._session=t.session,this.invites=t.invites,this.rooms=t.rooms,this.track(this.navigation.observe("room").subscribe(()=>this.emitChange("activeRoomId"))),this.track(this.invites.subscribe(this._getRoomChangesHandles())),this.track(this.rooms.subscribe(this._getRoomChangesHandles()))}_getRoomChangesHandles(){const t=()=>{this.emitChange("allRooms")};return{onAdd:t,onUpdate:()=>{},onRemove:t}}getRoomColor(t){const{avatarColorId:o}=t;return P(o)}getRoomAvatarHttpUrl(t,o){const{avatarUrl:i}=t;if(i){const s=o*this.platform.devicePixelRatio;return this._session.mediaRepository.mxcUrlThumbnail(i,s,s,"crop")}return null}get allRooms(){const t=Array.from(this.invites.values()),o=Array.from(this.rooms.values());return t.concat(o)}get activeRoomId(){const t=this.navigation.path.get("room");return t?t.value:null}}class ye extends R{constructor(t){super(t);u(this,"_client");u(this,"_sidebarViewModel");u(this,"_roomListViewModel");u(this,"_panelState");this._client=t.client,this._session=t.session,this._sidebarViewModel=new _e(this.childOptions({user:this._session.user})),this.track(this._sidebarViewModel),this._roomListViewModel=new Ve(this.childOptions({session:this._session,invites:this._client.session.invites,rooms:this._client.session.rooms})),this.track(this._roomListViewModel),this._panelState="initial",this.navigation.push("left-panel","initial"),this._setupNavigation()}_setupNavigation(){this.track(this.navigation.observe("left-panel").subscribe(()=>{const t=this.navigation.path.get("left-panel");this._handlePanelState(t.value)})),this.track(this.navigation.observe("room").subscribe(()=>{this._handlePanelState("initial")}))}_handlePanelState(t){t==="open"?this._panelState="open":t==="close"?this._panelState="close":this._panelState="initial",this.emitChange("panelState")}get sidebarViewModel(){return this._sidebarViewModel}get roomListViewModel(){return this._roomListViewModel}get panelState(){return this._panelState}}class Me extends R{constructor(t){super(t);u(this,"_chatViewModel");u(this,"_roomFlow");this.room=t.room,this._chatViewModel=null,this._roomFlow="preview",this.emitChange("roomFlow"),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("left-panel"),o=t.subscribe(()=>{const i=t.get();i==="initial"&&this.setRoomFlow("preview"),this.roomFlow==="load"&&i!=="close"&&this.setRoomFlow("preview")});this.track(o)}async loadChatView(){this._chatViewModel=new de(this.childOptions({room:this.room})),this.track(this._chatViewModel),await this._chatViewModel.load()}_disposeChatView(){this.disposeTracked(this._chatViewModel),this._chatViewModel=null}setRoomFlow(t){this._roomFlow!==t&&(t==="preview"?(this.toggleLeftPanel("initial"),this._chatViewModel&&this._disposeChatView()):t==="load"?(this.toggleLeftPanel("initial"),this.loadChatView().then(()=>this.emitChange("chatViewModel"))):this.toggleLeftPanel("close"),this._roomFlow=t,this.emitChange("roomFlow"))}toggleLeftPanel(t){var a;const o=(a=this.navigation.path.get("left-panel"))==null?void 0:a.value,i=t!=null?t:o==="close"?"open":"close",s=this.navigation.segment("left-panel",i),r=this.navigation.path.replace(s);this.navigation.applyPath(r)}getRoomColor(){const{avatarColorId:t}=this.room;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:o,mediaRepository:i}=this.room;if(o){if(!t)return i.mxcUrl(o);const s=t*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get roomFlow(){return this._roomFlow}get name(){return this.room.name}get chatViewModel(){return this._chatViewModel}}class be extends R{constructor(t){super(t);this.invite=t.invite}getRoomColor(){const{avatarColorId:t}=this.invite;return P(t)}getRoomAvatarHttpUrl(t){const{avatarUrl:o,mediaRepository:i}=this.invite;if(o){if(!t)return i.mxcUrl(o);const s=t*this.platform.devicePixelRatio;return i.mxcUrlThumbnail(o,s,s,"crop")}return null}get name(){return this.invite.name}}class ke extends R{constructor(t){super(t);u(this,"_client");u(this,"_session");u(this,"_leftPanelViewModel");u(this,"_roomViewModel");u(this,"_inviteViewModel");u(this,"_activeRoomId");this._client=t.client,this._session=t.client.session,this._roomViewModel=null,this._inviteViewModel=null,this._activeRoomId=null,this._leftPanelViewModel=new ye(this.childOptions({client:this._client,session:this._session})),this.track(this._leftPanelViewModel),this._setupNavigation()}_setupNavigation(){const t=this.navigation.observe("room"),o=t.subscribe(()=>{this._handleRoomView(t.get())});this.track(o),this._handleRoomView(t.get())}_handleRoomView(t){if(this._activeRoomId===t)return;this._roomViewModel=this.disposeTracked(this._roomViewModel),this._inviteViewModel=this.disposeTracked(this._inviteViewModel),this._activeRoomId=null;const{rooms:o,invites:i}=this._session,s=o.get(t)||i.get(t);if(t===void 0||s===void 0){this.emitChange("activeRoomId");return}s.isInvite?(this._inviteViewModel=new be(this.childOptions({invite:s})),this.track(this._inviteViewModel)):(this._roomViewModel=new Me(this.childOptions({room:s})),this.track(this._roomViewModel)),this._activeRoomId=s.id,this.emitChange("activeRoomId")}get activeRoomId(){return this._activeRoomId}get isActiveRoomInvite(){return this._session.invites.get(this._activeRoomId)!==void 0}get leftPanelViewModel(){return this._leftPanelViewModel}get roomViewModel(){return this._roomViewModel}get inviteViewModel(){return this._inviteViewModel}}class xe extends R{constructor(t){super(t);u(this,"_client");this._client=t.client}async login(t,o,i){const s=await this._client.queryLogin(t).result;await this._client.startWithLogin(s.password(o,i)),this._options.ready(this._client.sessionId)}get defaultHomeserver(){return this.platform.config.defaultHomeserver}}class Le extends R{constructor(t){super(t);u(this,"_client");u(this,"_loginViewModel");u(this,"_sessionViewModel");u(this,"_error");this._loginViewModel=null,this._sessionViewModel=null,this._error=!1,this._client=new ue(t.platform),this.track(this._client)}async load(){this.track(this.navigation.observe("login").subscribe(s=>this._applyNavigation(s,"login"))),this.track(this.navigation.observe("session").subscribe(s=>this._applyNavigation(s,"session")));const t=this.navigation.path.get("login"),o=this.navigation.path.get("session"),i=t||o;i?this._applyNavigation(i.value,i.type):this._applyNavigation(void 0,void 0)}async _applyNavigation(t,o){const i=await this.platform.sessionInfoStorage.getAll();if(o==="login"&&i.length===0){this._viewLogin();return}if(o==="session"&&i.length>0){const s=i[0].id;if(t!==s){this.navigation.push("session",s);return}if(await this._client.startWithExistingSession(s),this._client.loadStatus.get()==="Error"){this._viewError();return}this._viewSession();return}i.length>0?this.navigation.push("session",i[0].id):this.navigation.push("login")}_viewLogin(){this._setSection(()=>{this._loginViewModel=new xe(this.childOptions({client:this._client,ready:t=>{this.navigation.push("session",t)}}))})}_viewSession(){this._setSection(()=>{this._sessionViewModel=new ke(this.childOptions({client:this._client}))})}_viewError(){this._setSection(()=>{this._error=!0})}_setSection(t){this._error=!1,this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),t(),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}async logout(){await this._client.startLogout(this._client.sessionId),this.navigation.push("login")}get activeSection(){return this._sessionViewModel?"session":this._loginViewModel?"login":this._error?"error":"loading"}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}}const n=A.exports.jsx,d=A.exports.jsxs,B=A.exports.Fragment;function v({className:e=void 0,style:t=void 0,variant:o="b1",weight:i="regular",type:s=void 0,children:r}){const a=[];e&&a.push(e),a.push(`Text Text-${o} Text--${i}`);const l=a.join(" ");return s==="span"?n("span",{className:l,style:t,children:r}):s==="div"?n("div",{className:l,style:t,children:r}):o==="h2"?n("h2",{className:l,style:t,children:r}):o==="s1"?n("h4",{className:l,style:t,children:r}):n("p",{className:l,style:t,children:r})}function T({color:e=void 0,size:t="normal",src:o,isImage:i=!1}){const s={};return typeof e=="string"&&(s.backgroundColor=e),i?(s.backgroundColor="transparent",s.backgroundImage=`url(${o})`):(s.WebkitMaskImage=`url(${o})`,s.maskImage=`url(${o})`),n("span",{className:`Icon Icon--${t}`,style:s})}function G({className:e=void 0,variant:t="surface",type:o="button",onClick:i,children:s,disabled:r=!1}){return n("button",{className:`${e?`${e} `:""}RawButton-${t}`,type:o,onClick:i,disabled:r,children:s})}function x({className:e=void 0,variant:t="surface",size:o="normal",iconSrc:i=void 0,iconPlacement:s="start",type:r="button",onClick:a,children:l,disabled:c=!1}){const f=i?n(T,{size:o,src:i}):null,m=[];return e&&m.push(e),m.push(`Button Button--${o}`),d(G,{className:m.join(" "),variant:t,type:r,onClick:a,disabled:c,children:[s==="start"&&f,typeof l=="string"?n(v,{variant:o==="extra-small"?"b3":"b2",children:l}):l,s==="end"&&f]})}function M({className:e=void 0,variant:t="surface",size:o="normal",isCircle:i=!1,shadedSurface:s=!1,iconSrc:r,label:a,type:l="button",onClick:c,disabled:f=!1}){const m=[];return e&&m.push(e),m.push(`IconButton IconButton--${o}`),i&&m.push("IconButton--circle"),s&&t==="surface"&&m.push("IconButton--shaded"),n(G,{className:m.join(" "),variant:t,type:l,onClick:c,disabled:f,"aria-label":a,children:n(T,{size:o,src:r})})}var Se="/assets/home.831114d8.svg",q="/assets/grid.f44641b3.svg";function Ee({vm:e}){return n("div",{className:"SidebarView flex flex-column",children:d("div",{className:"SidebarView__scrollable grow flex flex-column items-center",children:[n(M,{size:"small",label:"Home",shadedSurface:!0,iconSrc:Se,onClick:()=>!1}),n(M,{size:"small",label:"Grid",shadedSurface:!0,iconSrc:q,onClick:()=>!1})]})})}function Ce({className:e,direction:t="vertical",visibility:o="auto",onScroll:i=void 0,children:s}){const r=[`Scroll Scroll--${t} Scroll--${o}`];return e&&r.push(e),n("div",{className:r.join(" "),onScroll:i,children:s})}function Ie({className:e,name:t,bgColor:o,isCircle:i=!1,imageSrc:s=void 0,size:r="normal"}){let a="s1";r==="large"&&(a="h2"),r==="small"&&(a="b1"),r==="extra-small"&&(a="b3");const l=["Avatar"];l.push(`Avatar--${r}`),i&&l.push("Avatar--circle"),l.push("noselect"),e&&l.push(e);const c={};return s||(c.backgroundColor=o),n("div",{className:l.join(" "),"aria-label":t,style:c,children:s?n("img",{draggable:"false",src:s,alt:""}):n(v,{variant:a,weight:"medium",type:"span",children:[...t][0]})})}function Ae({title:e,avatar:t,isActive:o=!1,onClick:i}){return d("button",{onClick:i,className:`RoomTile${o?"--active":""} flex items-start`,children:[t,n("div",{className:"RoomTile__content grow flex flex-column",children:e})]})}var Ne="/assets/add-box.a3a974bc.svg",Pe="/assets/manage-search.4d8bfab6.svg";function y(e,t){const[o,i]=w.exports.useState(e[t]);return w.exports.useLayoutEffect(()=>{const s=e.disposableOn("change",r=>{r===t&&i(e[t])});return()=>s()},[e,t]),o}function Be({vm:e}){const t=y(e,"allRooms"),o=y(e,"activeRoomId");return d("div",{className:"RoomListView flex flex-column",children:[n("header",{className:"flex items-center",children:n(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:"Home"})}),n("div",{className:"RoomListView__container grow",children:n(Ce,{children:d("div",{className:"RoomListView__content",children:[d("header",{className:"flex items-center",children:[n(v,{className:"grow",variant:"b2",weight:"semi-bold",children:"Rooms"}),n(x,{iconSrc:Ne,size:"extra-small",onClick:()=>alert("create room"),children:"Create"}),n(x,{iconSrc:Pe,size:"extra-small",onClick:()=>alert("Discover"),children:"Discover"})]}),t.map(i=>n(Ae,{isActive:i.id===o,onClick:()=>e.navigation.push("room",i.id),avatar:n(Ie,{name:i.name||"Empty room",size:"large",isCircle:!0,className:"shrink-0",bgColor:e.getRoomColor(i),imageSrc:e.getRoomAvatarHttpUrl(i,32)}),title:n(v,{className:"truncate",variant:"b2",weight:"semi-bold",children:i.name||"Empty room"})},i.id))]})})})]})}function Te({vm:e}){const t=y(e,"panelState");return d("div",{className:`LeftPanelView LeftPanelView--${t} flex`,children:[n(Ee,{vm:e.sidebarViewModel}),n(Be,{vm:e.roomListViewModel})]})}var $e="/assets/peoples.9192a047.svg";function Fe({vm:e,roomId:t}){const o=e.name||"Empty room",i=e.roomFlow==="preview";return n("div",{className:"RoomPreview grow flex flex-column justify-end items-center",children:d("div",{className:"RoomPreview__card flex items-center",children:[n("div",{className:"grow",children:n(v,{className:"truncate",variant:"s1",weight:"semi-bold",children:o})}),d("div",{className:"RoomPreview__card-memberCount flex items-center",children:[n(T,{src:$e}),e.room.joinedMemberCount]}),n("div",{className:"shrink-0",children:n(x,{variant:i?"secondary":"primary",onClick:()=>e.setRoomFlow(i?"load":"loaded"),children:i?"Load World":"Open World"})})]})})}function Oe({roomId:e,vm:t}){return N.useEffect(()=>{const o=new me(t),i=o.mount();i.querySelector(".Timeline_scroller").classList.add("Scroll","Scroll--vertical","Scroll--auto");const r=document.getElementById("TimelineView");return r==null||r.append(i),()=>{o.unmount(),r!=null&&r.hasChildNodes()&&(r==null||r.removeChild(r==null?void 0:r.childNodes[0]))}},[e,t]),n("div",{className:"TimelineView grow flex hydrogen",id:"TimelineView"})}function We({vm:e}){return n("div",{className:"ComposerView flex items-center",children:n("form",{className:"grow",onSubmit:o=>{o.preventDefault();const i=o.target,s=i.message.value.trim();s!==""&&(i.message.value="",e.sendMessage(s))},children:n("input",{name:"message",type:"text",placeholder:"Send message"})})})}function Ue({vm:e,roomId:t}){return y(e,"timelineViewModel"),d("div",{className:"ChatView flex flex-column",id:"ChatView",children:[n("header",{className:"flex items-center",children:n(v,{variant:"s1",weight:"semi-bold",children:e.name})}),e.timelineViewModel?n(Oe,{roomId:t,vm:e.timelineViewModel}):n("div",{className:"grow flex justify-center items-center",children:n(v,{children:"loading..."})}),n(We,{vm:e.composerViewModel})]})}var Ke="/assets/mic.05083630.svg",De="/assets/message.a538e66d.svg",je="/assets/setting.e1dd037a.svg",ze="/assets/logout.eda2bbfa.svg";function He({vm:e,roomId:t}){const[o,i]=N.useState(!1);return d(B,{children:[n(x,{size:"small",iconSrc:q,onClick:()=>e.toggleLeftPanel(),children:"Open Overlay [Esc]"}),n("div",{className:`RoomView__chat${o?" RoomView__chat--visible":""}`,children:n(Ue,{roomId:t,vm:e.chatViewModel})}),d("div",{className:"RoomView__controls flex",children:[n(M,{shadedSurface:!0,label:"Mic",size:"small",iconSrc:Ke,onClick:()=>alert("mic")}),n(M,{variant:o?"secondary":"surface",shadedSurface:!o,label:"Message",size:"small",iconSrc:De,onClick:()=>i(!o)}),n(M,{shadedSurface:!0,label:"Settings",size:"small",iconSrc:je,onClick:()=>alert("Settings")}),n(M,{variant:"danger",label:"Logout",size:"small",iconSrc:ze,onClick:()=>e.setRoomFlow("preview")})]})]})}function Ge({vm:e,roomId:t}){return d("div",{className:"RoomView grow flex",children:[n("div",{className:"RoomView__3d grow"}),n(He,{vm:e,roomId:t})]})}const qe="modulepreload",K={},Ye="/",D=function(t,o){return!o||o.length===0?t():Promise.all(o.map(i=>{if(i=`${Ye}${i}`,i in K)return;K[i]=!0;const s=i.endsWith(".css"),r=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${r}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":qe,s||(a.as="script",a.crossOrigin=""),a.href=i,document.head.appendChild(a),s)return new Promise((l,c)=>{a.addEventListener("load",l),a.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>t())};function Je(){return new Worker("/assets/GameWorker.285d79ff.js",{type:"module"})}const Y=e=>t=>Math.ceil(t/e)*e,Xe=Y(4),Qe=Y(8),_=Symbol("cursor"),I=Symbol("byteView"),Ze=(e=new ArrayBuffer(1e7))=>(e[_]=0,e[I]=new Uint8Array(e.byteLength),Object.defineProperty(e,"cursor",{get(){return this[_]}}),Object.defineProperty(e,"byteView",{get(){return this[I]}}),e.clear=function(){this[I].fill(0,0,this[_])},e),et=(e,t)=>{const{name:o}=t;o.includes("32")&&(e[_]=Xe(e[_])),o.includes("64")&&(e[_]=Qe(e[_]))},L=(e,t,o)=>{et(e,t);const i=new t(e,e[_],o);return e[_]+=o*i.BYTES_PER_ELEMENT,i},tt=(e,t,o,i)=>{const s=L(e,t,i*o),r=Array(i);for(let a=0;a<i;a++)r[a]=s.subarray(a*o,a*o+o);return r},Pt=(e,t)=>tt(e,Float32Array,16,t),J=(e=1e7,t=[new SharedArrayBuffer(e),new SharedArrayBuffer(e),new SharedArrayBuffer(e)],o=[new Uint8Array(t[0]),new Uint8Array(t[1]),new Uint8Array(t[2])],i=new Uint8Array(new SharedArrayBuffer(Uint8Array.BYTES_PER_ELEMENT)).fill(6))=>({byteLength:e,buffers:t,views:o,flags:i}),ot=e=>(e&64)!==0,it=e=>e&48|(e&3)<<2|(e&12)>>2,st=e=>64|(e&12)<<2|(e&48)>>2|e&3,Bt=e=>Atomics.load(e.flags,0)&3,rt=e=>(Atomics.load(e.flags,0)&48)>>4,nt=(e,t)=>e.views[rt(e)].set(new Uint8Array(t)),Tt=e=>{const t=Atomics.load(e.flags,0);do if(!ot(t))return!1;while(Atomics.compareExchange(e.flags,0,t,it(t))===t);return!0},at=e=>{const t=Atomics.load(e.flags,0);for(;Atomics.compareExchange(e.flags,0,t,st(t))===t;);},lt=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i,r=Math.pow(2,s);e[i]|=r},ct=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i,r=Math.pow(2,s);e[i]&=~r},j=(e,t,o)=>{o?lt(e,t):ct(e,t)},X=(e,t)=>{const o=e.BYTES_PER_ELEMENT*8,i=Math.floor(t/o),s=t-o*i;return(Math.pow(2,s)&e[i])!==0?1:0},$=["Unassigned","Escape","Backquote","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Minus","Equal","Backspace","Tab","KeyQ","KeyW","KeyE","KeyR","KeyT","KeyY","KeyU","KeyI","KeyO","KeyP","BracketLeft","BracketRight","Backslash","CapsLock","KeyA","KeyS","KeyD","KeyF","KeyG","KeyH","KeyJ","KeyK","KeyL","Semicolon","Quote","Enter","ShiftLeft","KeyZ","KeyX","KeyC","KeyV","KeyB","KeyN","KeyM","Comma","Period","Slash","ShiftRight","ControlLeft","AltLeft","MetaLeft","Space","MetaRight","AltRight","ArrowLeft","ArrowUp","ArrowRight","ArrowDown"],dt=Object.fromEntries($.map((e,t)=>[e,t]));function z(e){return dt[e]||0}function ut(e){const t=mt(),o=J(t.buffer.byteLength),i=ht(t,e);return{tripleBuffer:o,update(){nt(o,t.buffer),at(o),t.mouse.movement[0]=0,t.mouse.movement[1]=0},dispose(){i()}}}const mt=(e=Ze())=>({buffer:e,keyboard:L(e,Uint32Array,Math.ceil($.length/32)),mouse:{movement:L(e,Float32Array,2),buttons:L(e,Uint32Array,1)}}),ht=(e,t)=>{function o({buttons:c}){document.pointerLockElement===t?e.mouse.buttons[0]=c:t.requestPointerLock()}function i({buttons:c}){document.pointerLockElement===t&&(e.mouse.buttons[0]=c)}function s({code:c}){document.pointerLockElement===t&&j(e.keyboard,z(c),1)}function r({code:c}){document.pointerLockElement===t&&j(e.keyboard,z(c),0)}function a({movementX:c,movementY:f}){document.pointerLockElement===t&&(e.mouse.movement[0]+=c,e.mouse.movement[1]+=f)}function l(){e.buffer.clear()}return t.addEventListener("mousedown",o),t.addEventListener("mouseup",i),window.addEventListener("keydown",s),window.addEventListener("keyup",r),window.addEventListener("mousemove",a),t.addEventListener("blur",l),()=>{t.removeEventListener("mousedown",o),t.removeEventListener("mouseup",i),window.removeEventListener("keydown",s),window.removeEventListener("keyup",r),window.removeEventListener("mousemove",a),t.removeEventListener("blur",l)}},ft=e=>t=>X(t.keyboard,e),H=e=>t=>t.mouse.movement[e],gt=e=>t=>X(t.mouse.buttons,e);Object.fromEntries([...$.map((e,t)=>[`Keyboard/${e}`,ft(t)]),["Mouse/movementX",H(0)],["Mouse/movementY",H(1)],...Array(6).fill(0).map((e,t)=>[`Mouse/button${t}`,gt(t)])]);var g=(e=>(e.InitializeGameWorker="initialize-game-worker",e.GameWorkerInitialized="game-worker-initialized",e.GameWorkerError="game-worker-error",e.InitializeRenderWorker="initialize-render-worker",e.StartGameWorker="start-game-worker",e.RenderWorkerInitialized="render-worker-initialized",e.RenderWorkerError="render-worker-error",e.StartRenderWorker="start-render-worker",e.InitializeGameWorkerRenderState="initialize-game-worker-render-state",e.RenderWorkerResize="render-worker-resize",e.LoadResource="load-resource",e.ResourceLoaded="resource-loaded",e.ResourceLoadError="resource-load-error",e.AddResourceRef="add-resource-ref",e.RemoveResourceRef="remove-resource-ref",e.ResourceDisposed="resource-disposed",e.AddRenderable="add-renderable",e.RemoveRenderable="remove-renderable",e.SetActiveCamera="set-active-camera",e.SetActiveScene="set-active-scene",e))(g||{}),wt=(e=>(e.Loading="loading",e.Loaded="loaded",e.Error="error",e))(wt||{});function vt(){return new SharedArrayBuffer(4)}function $t(e,t){return{buffer:e,view:new Uint32Array(e),store:new Map,resourceLoaders:new Map,workerMessageTarget:t}}function Ft(e,t){const o=t(e);e.resourceLoaders.set(o.type,o)}async function Ot(e,{resourceDef:t,resourceId:o}){const{type:i}=t,s=e.resourceLoaders.get(i);if(!s)throw new Error(`Resource loader ${i} not registered.`);const r=t.name||`${i}[${o}]`,a={resourceId:o,type:i,name:r,refCount:1,state:"loading",resource:void 0,promise:s.load(U(W({},t),{name:r}))};e.store.set(o,a);try{const l=await a.promise;!t.name&&l.name&&(a.name=l.name),a.resource=l.resource,a.state="loaded",e.workerMessageTarget.postMessage({type:g.ResourceLoaded,resourceId:o,remoteResource:l.remoteResource},l.transferList)}catch(l){console.error(l),a.state="error",a.error=l,e.workerMessageTarget.postMessage({type:g.ResourceLoadError,resourceId:o,error:l})}return a}function Wt(e,{resourceId:t}){const o=e.store.get(t);if(!o)return;const i=e.resourceLoaders.get(o.type);i.addRef&&i.addRef(t),o.refCount++}function Ut(e,{resourceId:t}){const o=e.store.get(t);if(!o)return;const i=e.resourceLoaders.get(o.type);o.refCount===1?(i.dispose&&i.dispose(t),e.store.delete(t),e.workerMessageTarget.postMessage({type:g.ResourceDisposed,resourceId:t})):(i.removeRef&&i.removeRef(t),o.refCount--)}async function Kt(e,t){const o=e.store.get(t);if(o)return(await o.promise).resource}function Dt(e,t,o,i){const s=Atomics.add(e.view,0,1),r=i||`${t}[${s}]`,a={resourceId:s,type:t,name:r,refCount:1,state:"loaded",resource:o,promise:Promise.resolve({name:r,resource:o})};return e.store.set(s,a),s}var Q=(e=>(e[e.fps=0]="fps",e[e.frameTime=1]="frameTime",e[e.frameDuration=2]="frameDuration",e[e.gameTime=3]="gameTime",e[e.gameDuration=4]="gameDuration",e[e.frame=5]="frame",e[e.staleFrames=6]="staleFrames",e[e.drawCalls=7]="drawCalls",e[e.programs=8]="programs",e[e.geometries=9]="geometries",e[e.textures=10]="textures",e[e.triangles=11]="triangles",e[e.points=12]="points",e[e.lines=13]="lines",e))(Q||{});const Z=Object.keys(Q).filter(e=>isNaN(+e));function pt(e){const t=e||new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*Z.length);return{buffer:t,f32:new Float32Array(t),u32:new Uint32Array(t)}}function jt(e,t,o,i,s){const{render:{frame:r,calls:a,triangles:l,points:c,lines:f},memory:{geometries:m,textures:b},programs:k}=i.info;e.f32[0]=1/t,e.f32[1]=t,e.f32[2]=o,e.u32[5]=r,e.u32[6]=s,e.u32[7]=a,e.u32[8]=k?k.length:0,e.u32[9]=m,e.u32[10]=b,e.u32[11]=l,e.u32[12]=c,e.u32[13]=f}const h=Object.fromEntries(Z.map(e=>[e,0]));function _t(e){return h.fps=e.f32[0].toFixed(2),h.frameTime=(e.f32[1]*1e3).toFixed(2),h.frameDuration=(e.f32[2]*1e3).toFixed(2),h.gameTime=(e.f32[3]*1e3).toFixed(2),h.gameDuration=e.f32[4].toFixed(2),h.frame=e.u32[5],h.staleFrames=e.u32[6],h.drawCalls=e.u32[7],h.programs=e.u32[8],h.geometries=e.u32[9],h.textures=e.u32[10],h.triangles=e.u32[11],h.points=e.u32[12],h.lines=e.u32[13],h}async function Rt(e,t){const o=!!window.OffscreenCanvas;let i,s,r,a;if(o){console.info("Browser supports OffscreenCanvas, rendering in WebWorker.");const{default:c}=await D(()=>import("./RenderWorker.4bf034e6.js"),[]);i=new c,s=e.transferControlToOffscreen();const f=new MessageChannel;r=f.port1,a=f.port2}else{console.info("Browser does not support OffscreenCanvas, rendering on main thread.");const c=await D(()=>import("./RenderWorker.16a513a8.js"),["assets/RenderWorker.16a513a8.js","assets/vendor.f8f2a9c9.js"]);i=c.default,r=c.default,a=t,s=e}function l(){i.postMessage({type:g.RenderWorkerResize,canvasWidth:e.clientWidth,canvasHeight:e.clientHeight})}return window.addEventListener("resize",l),{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:r,gameWorkerMessageTarget:a,dispose(){window.removeEventListener("resize",l),i instanceof Worker&&i.terminate()}}}async function Vt(e){const t=ut(e),o=new Je,{renderWorker:i,canvasTarget:s,renderWorkerMessageTarget:r,gameWorkerMessageTarget:a,dispose:l}=await Rt(e,o),c=J(),f=vt(),m=r instanceof MessagePort?r:void 0,b=pt();await new Promise((S,E)=>{i.postMessage({type:g.InitializeRenderWorker,renderableTripleBuffer:c,gameWorkerMessageTarget:a,canvasTarget:s,initialCanvasWidth:e.clientWidth,initialCanvasHeight:e.clientHeight,resourceManagerBuffer:f,statsSharedArrayBuffer:b.buffer},a instanceof MessagePort&&s instanceof OffscreenCanvas?[a,s]:void 0);const V=({data:p})=>{p.type===g.RenderWorkerInitialized?(S(p),i.removeEventListener("message",V)):p.type===g.RenderWorkerError&&(E(p.error),i.removeEventListener("message",V))};i.addEventListener("message",V)}),await new Promise((S,E)=>{o.postMessage({type:g.InitializeGameWorker,renderableTripleBuffer:c,inputTripleBuffer:t.tripleBuffer,renderWorkerMessagePort:m,resourceManagerBuffer:f,statsSharedArrayBuffer:b.buffer},m?[m]:void 0);const V=({data:p})=>{p.type===g.GameWorkerInitialized?(S(p),o.removeEventListener("message",V)):p.type===g.GameWorkerError&&(E(p.error),o.removeEventListener("message",V))};o.addEventListener("message",V)}),i.postMessage({type:g.StartRenderWorker}),o.postMessage({type:g.StartGameWorker});let k;function F(){t.update(),k=requestAnimationFrame(F)}return F(),{getStats(){return _t(b)},dispose(){cancelAnimationFrame(k),t.dispose(),o.terminate(),l()}}}function yt(e){const t=w.exports.useRef();return w.exports.useEffect(()=>{var i;return e.current&&Vt(e.current).then(s=>t.current=s).catch(console.error),(i=t.current)==null?void 0:i.dispose()},[e]),{getStats:w.exports.useCallback(()=>{var i;return(i=t.current)==null?void 0:i.getStats()},[])}}function Mt({getStats:e}){const[,t]=w.exports.useState(0),o=w.exports.useRef();return w.exports.useEffect(()=>{let i;const s=()=>{const r=e();o.current=r,r&&t(r.frame),i=window.setTimeout(s,100)};return i=window.setTimeout(s),()=>{clearTimeout(i)}},[e]),n("div",{className:"Stats",children:o.current&&Object.entries(o.current).map(([i,s])=>d("div",{children:[d("b",{children:[i,":"]})," "+s]},i))})}function bt({vm:e}){const t=w.exports.useRef(null),{getStats:o}=yt(t);return d(B,{children:[n(Mt,{getStats:o}),n("canvas",{className:"SessionView__viewport",ref:t}),d("div",{className:"SessionView flex",children:[n(Te,{vm:e.leftPanelViewModel}),n(kt,{vm:e})]})]})}function kt({vm:e}){const t=y(e,"activeRoomId");return t?e.isActiveRoomInvite?n("p",{children:"invite"}):n(xt,{vm:e.roomViewModel,roomId:t}):n("p",{children:"select room from left panel"})}function xt({vm:e,roomId:t}){y(e,"roomFlow");const o=w.exports.useRef();return w.exports.useEffect(()=>{o.current=e.roomFlow},[e.roomFlow]),d(B,{children:[["preview","load"].includes(e.roomFlow)&&n(Fe,{vm:e,roomId:t}),e.roomFlow==="loaded"&&n(Ge,{vm:e,roomId:t})]})}function Lt({vm:e}){const[t,o]=w.exports.useState(!1),i=async s=>{s.preventDefault();const r=s.target,{homeserver:a,username:l,password:c}=r;o(!0),await e.login(a.value,l.value,c.value),o(!1)};return t?n("p",{children:"Login in progress..."}):d("form",{style:{height:"100%"},className:"flex flex-column justify-center items-center",onSubmit:i,children:[n("label",{htmlFor:"homeserver",children:"Homeserver"}),n("input",{defaultValue:e.defaultHomeserver,name:"homeserver",placeholder:"homeserver",required:!0}),n("br",{}),n("label",{htmlFor:"username",children:"Username"}),n("input",{name:"username",placeholder:"username",required:!0}),n("br",{}),n("label",{htmlFor:"password",children:"Password"}),n("input",{name:"password",placeholder:"password",type:"password",required:!0}),n("br",{}),n("button",{type:"submit",children:"Login"})]})}function St({vm:e}){const t=y(e,"activeSection");return d("div",{className:"RootView",children:[t==="login"&&n(Lt,{vm:e.loginViewModel}),t==="session"&&n(bt,{vm:e.sessionViewModel}),t==="loading"&&n("div",{className:"flex justify-center items-center",style:{height:"100%"},children:n(v,{variant:"b1",weight:"semi-bold",children:"Loading..."})}),t==="error"&&d("div",{className:"flex flex-column justify-center items-center",style:{height:"100%"},children:[n(v,{variant:"b1",weight:"semi-bold",children:"This session is invalid"}),n("br",{}),n(x,{variant:"primary",size:"small",onClick:()=>e.logout(),children:"Delete session and login"})]})]})}function Et(e,t){we.render(n(N.StrictMode,{children:n(St,{vm:t})}),e)}function Ct(e,t){const o=e==null?void 0:e.type;return o===void 0?["session","login"].includes(t.type):o==="session"?["left-panel"].includes(t.type):o==="left-panel"?["room"].includes(t.type):!1}async function It(){const e="root",t=document.getElementById(e);if(!t)throw new Error(`Can not find root element with id: ${e}`);const o={defaultHomeserver:"matrix.org"},i={development:!1},s=new he(t,pe,o,i),r=new fe(Ct);s.setNavigation(r);const a=ge({navigation:r,history:s.history});a.attach();const l=new Le({platform:s,navigation:r,urlCreator:a});l.load(),Et(t,l)}It();export{wt as R,g as W,Dt as a,Wt as b,Ot as c,pt as d,Ze as e,Pt as f,L as g,Bt as h,$t as i,Kt as l,Ut as o,Ft as r,Tt as s,jt as w};
