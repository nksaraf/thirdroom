var Vo={exports:{}},B={};/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var Pc=Object.getOwnPropertySymbols,v_=Object.prototype.hasOwnProperty,w_=Object.prototype.propertyIsEnumerable;function S_(n){if(n==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(n)}function b_(){try{if(!Object.assign)return!1;var n=new String("abc");if(n[5]="de",Object.getOwnPropertyNames(n)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var r=Object.getOwnPropertyNames(e).map(function(i){return e[i]});if(r.join("")!=="0123456789")return!1;var s={};return"abcdefghijklmnopqrst".split("").forEach(function(i){s[i]=i}),Object.keys(Object.assign({},s)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}var Jh=b_()?Object.assign:function(n,e){for(var t,r=S_(n),s,i=1;i<arguments.length;i++){t=Object(arguments[i]);for(var o in t)v_.call(t,o)&&(r[o]=t[o]);if(Pc){s=Pc(t);for(var a=0;a<s.length;a++)w_.call(t,s[a])&&(r[s[a]]=t[s[a]])}}return r};/** @license React v17.0.2
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Yl=Jh,Dr=60103,Xh=60106;B.Fragment=60107;B.StrictMode=60108;B.Profiler=60114;var Zh=60109,ep=60110,tp=60112;B.Suspense=60113;var np=60115,rp=60116;if(typeof Symbol=="function"&&Symbol.for){var Je=Symbol.for;Dr=Je("react.element"),Xh=Je("react.portal"),B.Fragment=Je("react.fragment"),B.StrictMode=Je("react.strict_mode"),B.Profiler=Je("react.profiler"),Zh=Je("react.provider"),ep=Je("react.context"),tp=Je("react.forward_ref"),B.Suspense=Je("react.suspense"),np=Je("react.memo"),rp=Je("react.lazy")}var Dc=typeof Symbol=="function"&&Symbol.iterator;function E_(n){return n===null||typeof n!="object"?null:(n=Dc&&n[Dc]||n["@@iterator"],typeof n=="function"?n:null)}function ri(n){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+n,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+n+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var sp={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},ip={};function Lr(n,e,t){this.props=n,this.context=e,this.refs=ip,this.updater=t||sp}Lr.prototype.isReactComponent={};Lr.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error(ri(85));this.updater.enqueueSetState(this,n,e,"setState")};Lr.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function op(){}op.prototype=Lr.prototype;function Ql(n,e,t){this.props=n,this.context=e,this.refs=ip,this.updater=t||sp}var Jl=Ql.prototype=new op;Jl.constructor=Ql;Yl(Jl,Lr.prototype);Jl.isPureReactComponent=!0;var Xl={current:null},ap=Object.prototype.hasOwnProperty,lp={key:!0,ref:!0,__self:!0,__source:!0};function up(n,e,t){var r,s={},i=null,o=null;if(e!=null)for(r in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(i=""+e.key),e)ap.call(e,r)&&!lp.hasOwnProperty(r)&&(s[r]=e[r]);var a=arguments.length-2;if(a===1)s.children=t;else if(1<a){for(var l=Array(a),u=0;u<a;u++)l[u]=arguments[u+2];s.children=l}if(n&&n.defaultProps)for(r in a=n.defaultProps,a)s[r]===void 0&&(s[r]=a[r]);return{$$typeof:Dr,type:n,key:i,ref:o,props:s,_owner:Xl.current}}function I_(n,e){return{$$typeof:Dr,type:n.type,key:e,ref:n.ref,props:n.props,_owner:n._owner}}function Zl(n){return typeof n=="object"&&n!==null&&n.$$typeof===Dr}function k_(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var Lc=/\/+/g;function pa(n,e){return typeof n=="object"&&n!==null&&n.key!=null?k_(""+n.key):e.toString(36)}function Hi(n,e,t,r,s){var i=typeof n;(i==="undefined"||i==="boolean")&&(n=null);var o=!1;if(n===null)o=!0;else switch(i){case"string":case"number":o=!0;break;case"object":switch(n.$$typeof){case Dr:case Xh:o=!0}}if(o)return o=n,s=s(o),n=r===""?"."+pa(o,0):r,Array.isArray(s)?(t="",n!=null&&(t=n.replace(Lc,"$&/")+"/"),Hi(s,e,t,"",function(u){return u})):s!=null&&(Zl(s)&&(s=I_(s,t+(!s.key||o&&o.key===s.key?"":(""+s.key).replace(Lc,"$&/")+"/")+n)),e.push(s)),1;if(o=0,r=r===""?".":r+":",Array.isArray(n))for(var a=0;a<n.length;a++){i=n[a];var l=r+pa(i,a);o+=Hi(i,e,t,l,s)}else if(l=E_(n),typeof l=="function")for(n=l.call(n),a=0;!(i=n.next()).done;)i=i.value,l=r+pa(i,a++),o+=Hi(i,e,t,l,s);else if(i==="object")throw e=""+n,Error(ri(31,e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e));return o}function wi(n,e,t){if(n==null)return n;var r=[],s=0;return Hi(n,r,"","",function(i){return e.call(t,i,s++)}),r}function C_(n){if(n._status===-1){var e=n._result;e=e(),n._status=0,n._result=e,e.then(function(t){n._status===0&&(t=t.default,n._status=1,n._result=t)},function(t){n._status===0&&(n._status=2,n._result=t)})}if(n._status===1)return n._result;throw n._result}var cp={current:null};function Lt(){var n=cp.current;if(n===null)throw Error(ri(321));return n}var R_={ReactCurrentDispatcher:cp,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:Xl,IsSomeRendererActing:{current:!1},assign:Yl};B.Children={map:wi,forEach:function(n,e,t){wi(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return wi(n,function(){e++}),e},toArray:function(n){return wi(n,function(e){return e})||[]},only:function(n){if(!Zl(n))throw Error(ri(143));return n}};B.Component=Lr;B.PureComponent=Ql;B.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=R_;B.cloneElement=function(n,e,t){if(n==null)throw Error(ri(267,n));var r=Yl({},n.props),s=n.key,i=n.ref,o=n._owner;if(e!=null){if(e.ref!==void 0&&(i=e.ref,o=Xl.current),e.key!==void 0&&(s=""+e.key),n.type&&n.type.defaultProps)var a=n.type.defaultProps;for(l in e)ap.call(e,l)&&!lp.hasOwnProperty(l)&&(r[l]=e[l]===void 0&&a!==void 0?a[l]:e[l])}var l=arguments.length-2;if(l===1)r.children=t;else if(1<l){a=Array(l);for(var u=0;u<l;u++)a[u]=arguments[u+2];r.children=a}return{$$typeof:Dr,type:n.type,key:s,ref:i,props:r,_owner:o}};B.createContext=function(n,e){return e===void 0&&(e=null),n={$$typeof:ep,_calculateChangedBits:e,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null},n.Provider={$$typeof:Zh,_context:n},n.Consumer=n};B.createElement=up;B.createFactory=function(n){var e=up.bind(null,n);return e.type=n,e};B.createRef=function(){return{current:null}};B.forwardRef=function(n){return{$$typeof:tp,render:n}};B.isValidElement=Zl;B.lazy=function(n){return{$$typeof:rp,_payload:{_status:-1,_result:n},_init:C_}};B.memo=function(n,e){return{$$typeof:np,type:n,compare:e===void 0?null:e}};B.useCallback=function(n,e){return Lt().useCallback(n,e)};B.useContext=function(n,e){return Lt().useContext(n,e)};B.useDebugValue=function(){};B.useEffect=function(n,e){return Lt().useEffect(n,e)};B.useImperativeHandle=function(n,e,t){return Lt().useImperativeHandle(n,e,t)};B.useLayoutEffect=function(n,e){return Lt().useLayoutEffect(n,e)};B.useMemo=function(n,e){return Lt().useMemo(n,e)};B.useReducer=function(n,e,t){return Lt().useReducer(n,e,t)};B.useRef=function(n){return Lt().useRef(n)};B.useState=function(n){return Lt().useState(n)};B.version="17.0.2";Vo.exports=B;var vk=Vo.exports,dp={exports:{}},Ge={},hp={exports:{}},pp={};/** @license React v0.20.2
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(n){var e,t,r,s;if(typeof performance=="object"&&typeof performance.now=="function"){var i=performance;n.unstable_now=function(){return i.now()}}else{var o=Date,a=o.now();n.unstable_now=function(){return o.now()-a}}if(typeof window=="undefined"||typeof MessageChannel!="function"){var l=null,u=null,c=function(){if(l!==null)try{var E=n.unstable_now();l(!0,E),l=null}catch(D){throw setTimeout(c,0),D}};e=function(E){l!==null?setTimeout(e,0,E):(l=E,setTimeout(c,0))},t=function(E,D){u=setTimeout(E,D)},r=function(){clearTimeout(u)},n.unstable_shouldYield=function(){return!1},s=n.unstable_forceFrameRate=function(){}}else{var d=window.setTimeout,h=window.clearTimeout;if(typeof console!="undefined"){var g=window.cancelAnimationFrame;typeof window.requestAnimationFrame!="function"&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills"),typeof g!="function"&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills")}var v=!1,S=null,f=-1,p=5,m=0;n.unstable_shouldYield=function(){return n.unstable_now()>=m},s=function(){},n.unstable_forceFrameRate=function(E){0>E||125<E?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):p=0<E?Math.floor(1e3/E):5};var w=new MessageChannel,y=w.port2;w.port1.onmessage=function(){if(S!==null){var E=n.unstable_now();m=E+p;try{S(!0,E)?y.postMessage(null):(v=!1,S=null)}catch(D){throw y.postMessage(null),D}}else v=!1},e=function(E){S=E,v||(v=!0,y.postMessage(null))},t=function(E,D){f=d(function(){E(n.unstable_now())},D)},r=function(){h(f),f=-1}}function T(E,D){var M=E.length;E.push(D);e:for(;;){var q=M-1>>>1,U=E[q];if(U!==void 0&&0<P(U,D))E[q]=D,E[M]=U,M=q;else break e}}function b(E){return E=E[0],E===void 0?null:E}function R(E){var D=E[0];if(D!==void 0){var M=E.pop();if(M!==D){E[0]=M;e:for(var q=0,U=E.length;q<U;){var Oe=2*(q+1)-1,Qe=E[Oe],Bt=Oe+1,st=E[Bt];if(Qe!==void 0&&0>P(Qe,M))st!==void 0&&0>P(st,Qe)?(E[q]=st,E[Bt]=M,q=Bt):(E[q]=Qe,E[Oe]=M,q=Oe);else if(st!==void 0&&0>P(st,M))E[q]=st,E[Bt]=M,q=Bt;else break e}}return D}return null}function P(E,D){var M=E.sortIndex-D.sortIndex;return M!==0?M:E.id-D.id}var N=[],ne=[],Wr=1,Ee=null,$=3,Kt=!1,Ye=!1,vn=!1;function zr(E){for(var D=b(ne);D!==null;){if(D.callback===null)R(ne);else if(D.startTime<=E)R(ne),D.sortIndex=D.expirationTime,T(N,D);else break;D=b(ne)}}function Hr(E){if(vn=!1,zr(E),!Ye)if(b(N)!==null)Ye=!0,e(Jn);else{var D=b(ne);D!==null&&t(Hr,D.startTime-E)}}function Jn(E,D){Ye=!1,vn&&(vn=!1,r()),Kt=!0;var M=$;try{for(zr(D),Ee=b(N);Ee!==null&&(!(Ee.expirationTime>D)||E&&!n.unstable_shouldYield());){var q=Ee.callback;if(typeof q=="function"){Ee.callback=null,$=Ee.priorityLevel;var U=q(Ee.expirationTime<=D);D=n.unstable_now(),typeof U=="function"?Ee.callback=U:Ee===b(N)&&R(N),zr(D)}else R(N);Ee=b(N)}if(Ee!==null)var Oe=!0;else{var Qe=b(ne);Qe!==null&&t(Hr,Qe.startTime-D),Oe=!1}return Oe}finally{Ee=null,$=M,Kt=!1}}var qr=s;n.unstable_IdlePriority=5,n.unstable_ImmediatePriority=1,n.unstable_LowPriority=4,n.unstable_NormalPriority=3,n.unstable_Profiling=null,n.unstable_UserBlockingPriority=2,n.unstable_cancelCallback=function(E){E.callback=null},n.unstable_continueExecution=function(){Ye||Kt||(Ye=!0,e(Jn))},n.unstable_getCurrentPriorityLevel=function(){return $},n.unstable_getFirstCallbackNode=function(){return b(N)},n.unstable_next=function(E){switch($){case 1:case 2:case 3:var D=3;break;default:D=$}var M=$;$=D;try{return E()}finally{$=M}},n.unstable_pauseExecution=function(){},n.unstable_requestPaint=qr,n.unstable_runWithPriority=function(E,D){switch(E){case 1:case 2:case 3:case 4:case 5:break;default:E=3}var M=$;$=E;try{return D()}finally{$=M}},n.unstable_scheduleCallback=function(E,D,M){var q=n.unstable_now();switch(typeof M=="object"&&M!==null?(M=M.delay,M=typeof M=="number"&&0<M?q+M:q):M=q,E){case 1:var U=-1;break;case 2:U=250;break;case 5:U=1073741823;break;case 4:U=1e4;break;default:U=5e3}return U=M+U,E={id:Wr++,callback:D,priorityLevel:E,startTime:M,expirationTime:U,sortIndex:-1},M>q?(E.sortIndex=M,T(ne,E),b(N)===null&&E===b(ne)&&(vn?r():vn=!0,t(Hr,M-q))):(E.sortIndex=U,T(N,E),Ye||Kt||(Ye=!0,e(Jn))),E},n.unstable_wrapCallback=function(E){var D=$;return function(){var M=$;$=D;try{return E.apply(this,arguments)}finally{$=M}}}})(pp);hp.exports=pp;/** @license React v17.0.2
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var $o=Vo.exports,Q=Jh,le=hp.exports;function k(n){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+n,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+n+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}if(!$o)throw Error(k(227));var fp=new Set,Us={};function Hn(n,e){kr(n,e),kr(n+"Capture",e)}function kr(n,e){for(Us[n]=e,n=0;n<e.length;n++)fp.add(e[n])}var Mt=!(typeof window=="undefined"||typeof window.document=="undefined"||typeof window.document.createElement=="undefined"),A_=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Oc=Object.prototype.hasOwnProperty,Uc={},Fc={};function T_(n){return Oc.call(Fc,n)?!0:Oc.call(Uc,n)?!1:A_.test(n)?Fc[n]=!0:(Uc[n]=!0,!1)}function x_(n,e,t,r){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return r?!1:t!==null?!t.acceptsBooleans:(n=n.toLowerCase().slice(0,5),n!=="data-"&&n!=="aria-");default:return!1}}function N_(n,e,t,r){if(e===null||typeof e=="undefined"||x_(n,e,t,r))return!0;if(r)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function Re(n,e,t,r,s,i,o){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=r,this.attributeNamespace=s,this.mustUseProperty=t,this.propertyName=n,this.type=e,this.sanitizeURL=i,this.removeEmptyString=o}var pe={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(n){pe[n]=new Re(n,0,!1,n,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(n){var e=n[0];pe[e]=new Re(e,1,!1,n[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(n){pe[n]=new Re(n,2,!1,n.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(n){pe[n]=new Re(n,2,!1,n,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(n){pe[n]=new Re(n,3,!1,n.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(n){pe[n]=new Re(n,3,!0,n,null,!1,!1)});["capture","download"].forEach(function(n){pe[n]=new Re(n,4,!1,n,null,!1,!1)});["cols","rows","size","span"].forEach(function(n){pe[n]=new Re(n,6,!1,n,null,!1,!1)});["rowSpan","start"].forEach(function(n){pe[n]=new Re(n,5,!1,n.toLowerCase(),null,!1,!1)});var eu=/[\-:]([a-z])/g;function tu(n){return n[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(n){var e=n.replace(eu,tu);pe[e]=new Re(e,1,!1,n,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(n){var e=n.replace(eu,tu);pe[e]=new Re(e,1,!1,n,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(n){var e=n.replace(eu,tu);pe[e]=new Re(e,1,!1,n,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(n){pe[n]=new Re(n,1,!1,n.toLowerCase(),null,!1,!1)});pe.xlinkHref=new Re("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(n){pe[n]=new Re(n,1,!1,n.toLowerCase(),null,!0,!0)});function nu(n,e,t,r){var s=pe.hasOwnProperty(e)?pe[e]:null,i=s!==null?s.type===0:r?!1:!(!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N");i||(N_(e,t,s,r)&&(t=null),r||s===null?T_(e)&&(t===null?n.removeAttribute(e):n.setAttribute(e,""+t)):s.mustUseProperty?n[s.propertyName]=t===null?s.type===3?!1:"":t:(e=s.attributeName,r=s.attributeNamespace,t===null?n.removeAttribute(e):(s=s.type,t=s===3||s===4&&t===!0?"":""+t,r?n.setAttributeNS(r,e,t):n.setAttribute(e,t))))}var qn=$o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,hs=60103,xn=60106,qt=60107,ru=60108,Ss=60114,su=60109,iu=60110,jo=60112,bs=60113,ao=60120,Wo=60115,ou=60116,au=60121,lu=60128,mp=60129,uu=60130,qa=60131;if(typeof Symbol=="function"&&Symbol.for){var ae=Symbol.for;hs=ae("react.element"),xn=ae("react.portal"),qt=ae("react.fragment"),ru=ae("react.strict_mode"),Ss=ae("react.profiler"),su=ae("react.provider"),iu=ae("react.context"),jo=ae("react.forward_ref"),bs=ae("react.suspense"),ao=ae("react.suspense_list"),Wo=ae("react.memo"),ou=ae("react.lazy"),au=ae("react.block"),ae("react.scope"),lu=ae("react.opaque.id"),mp=ae("react.debug_trace_mode"),uu=ae("react.offscreen"),qa=ae("react.legacy_hidden")}var Kc=typeof Symbol=="function"&&Symbol.iterator;function Qr(n){return n===null||typeof n!="object"?null:(n=Kc&&n[Kc]||n["@@iterator"],typeof n=="function"?n:null)}var fa;function ps(n){if(fa===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);fa=e&&e[1]||""}return`
`+fa+n}var ma=!1;function Si(n,e){if(!n||ma)return"";ma=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(l){var r=l}Reflect.construct(n,[],e)}else{try{e.call()}catch(l){r=l}n.call(e.prototype)}else{try{throw Error()}catch(l){r=l}n()}}catch(l){if(l&&r&&typeof l.stack=="string"){for(var s=l.stack.split(`
`),i=r.stack.split(`
`),o=s.length-1,a=i.length-1;1<=o&&0<=a&&s[o]!==i[a];)a--;for(;1<=o&&0<=a;o--,a--)if(s[o]!==i[a]){if(o!==1||a!==1)do if(o--,a--,0>a||s[o]!==i[a])return`
`+s[o].replace(" at new "," at ");while(1<=o&&0<=a);break}}}finally{ma=!1,Error.prepareStackTrace=t}return(n=n?n.displayName||n.name:"")?ps(n):""}function M_(n){switch(n.tag){case 5:return ps(n.type);case 16:return ps("Lazy");case 13:return ps("Suspense");case 19:return ps("SuspenseList");case 0:case 2:case 15:return n=Si(n.type,!1),n;case 11:return n=Si(n.type.render,!1),n;case 22:return n=Si(n.type._render,!1),n;case 1:return n=Si(n.type,!0),n;default:return""}}function fr(n){if(n==null)return null;if(typeof n=="function")return n.displayName||n.name||null;if(typeof n=="string")return n;switch(n){case qt:return"Fragment";case xn:return"Portal";case Ss:return"Profiler";case ru:return"StrictMode";case bs:return"Suspense";case ao:return"SuspenseList"}if(typeof n=="object")switch(n.$$typeof){case iu:return(n.displayName||"Context")+".Consumer";case su:return(n._context.displayName||"Context")+".Provider";case jo:var e=n.render;return e=e.displayName||e.name||"",n.displayName||(e!==""?"ForwardRef("+e+")":"ForwardRef");case Wo:return fr(n.type);case au:return fr(n._render);case ou:e=n._payload,n=n._init;try{return fr(n(e))}catch{}}return null}function cn(n){switch(typeof n){case"boolean":case"number":case"object":case"string":case"undefined":return n;default:return""}}function _p(n){var e=n.type;return(n=n.nodeName)&&n.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function P_(n){var e=_p(n)?"checked":"value",t=Object.getOwnPropertyDescriptor(n.constructor.prototype,e),r=""+n[e];if(!n.hasOwnProperty(e)&&typeof t!="undefined"&&typeof t.get=="function"&&typeof t.set=="function"){var s=t.get,i=t.set;return Object.defineProperty(n,e,{configurable:!0,get:function(){return s.call(this)},set:function(o){r=""+o,i.call(this,o)}}),Object.defineProperty(n,e,{enumerable:t.enumerable}),{getValue:function(){return r},setValue:function(o){r=""+o},stopTracking:function(){n._valueTracker=null,delete n[e]}}}}function bi(n){n._valueTracker||(n._valueTracker=P_(n))}function gp(n){if(!n)return!1;var e=n._valueTracker;if(!e)return!0;var t=e.getValue(),r="";return n&&(r=_p(n)?n.checked?"true":"false":n.value),n=r,n!==t?(e.setValue(n),!0):!1}function lo(n){if(n=n||(typeof document!="undefined"?document:void 0),typeof n=="undefined")return null;try{return n.activeElement||n.body}catch{return n.body}}function Ga(n,e){var t=e.checked;return Q({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t!=null?t:n._wrapperState.initialChecked})}function Bc(n,e){var t=e.defaultValue==null?"":e.defaultValue,r=e.checked!=null?e.checked:e.defaultChecked;t=cn(e.value!=null?e.value:t),n._wrapperState={initialChecked:r,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function yp(n,e){e=e.checked,e!=null&&nu(n,"checked",e,!1)}function Ya(n,e){yp(n,e);var t=cn(e.value),r=e.type;if(t!=null)r==="number"?(t===0&&n.value===""||n.value!=t)&&(n.value=""+t):n.value!==""+t&&(n.value=""+t);else if(r==="submit"||r==="reset"){n.removeAttribute("value");return}e.hasOwnProperty("value")?Qa(n,e.type,t):e.hasOwnProperty("defaultValue")&&Qa(n,e.type,cn(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(n.defaultChecked=!!e.defaultChecked)}function Vc(n,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var r=e.type;if(!(r!=="submit"&&r!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+n._wrapperState.initialValue,t||e===n.value||(n.value=e),n.defaultValue=e}t=n.name,t!==""&&(n.name=""),n.defaultChecked=!!n._wrapperState.initialChecked,t!==""&&(n.name=t)}function Qa(n,e,t){(e!=="number"||lo(n.ownerDocument)!==n)&&(t==null?n.defaultValue=""+n._wrapperState.initialValue:n.defaultValue!==""+t&&(n.defaultValue=""+t))}function D_(n){var e="";return $o.Children.forEach(n,function(t){t!=null&&(e+=t)}),e}function Ja(n,e){return n=Q({children:void 0},e),(e=D_(e.children))&&(n.children=e),n}function mr(n,e,t,r){if(n=n.options,e){e={};for(var s=0;s<t.length;s++)e["$"+t[s]]=!0;for(t=0;t<n.length;t++)s=e.hasOwnProperty("$"+n[t].value),n[t].selected!==s&&(n[t].selected=s),s&&r&&(n[t].defaultSelected=!0)}else{for(t=""+cn(t),e=null,s=0;s<n.length;s++){if(n[s].value===t){n[s].selected=!0,r&&(n[s].defaultSelected=!0);return}e!==null||n[s].disabled||(e=n[s])}e!==null&&(e.selected=!0)}}function Xa(n,e){if(e.dangerouslySetInnerHTML!=null)throw Error(k(91));return Q({},e,{value:void 0,defaultValue:void 0,children:""+n._wrapperState.initialValue})}function $c(n,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(k(92));if(Array.isArray(t)){if(!(1>=t.length))throw Error(k(93));t=t[0]}e=t}e==null&&(e=""),t=e}n._wrapperState={initialValue:cn(t)}}function vp(n,e){var t=cn(e.value),r=cn(e.defaultValue);t!=null&&(t=""+t,t!==n.value&&(n.value=t),e.defaultValue==null&&n.defaultValue!==t&&(n.defaultValue=t)),r!=null&&(n.defaultValue=""+r)}function jc(n){var e=n.textContent;e===n._wrapperState.initialValue&&e!==""&&e!==null&&(n.value=e)}var Za={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg"};function wp(n){switch(n){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function el(n,e){return n==null||n==="http://www.w3.org/1999/xhtml"?wp(e):n==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":n}var Ei,Sp=function(n){return typeof MSApp!="undefined"&&MSApp.execUnsafeLocalFunction?function(e,t,r,s){MSApp.execUnsafeLocalFunction(function(){return n(e,t,r,s)})}:n}(function(n,e){if(n.namespaceURI!==Za.svg||"innerHTML"in n)n.innerHTML=e;else{for(Ei=Ei||document.createElement("div"),Ei.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=Ei.firstChild;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)n.appendChild(e.firstChild)}});function Fs(n,e){if(e){var t=n.firstChild;if(t&&t===n.lastChild&&t.nodeType===3){t.nodeValue=e;return}}n.textContent=e}var Es={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},L_=["Webkit","ms","Moz","O"];Object.keys(Es).forEach(function(n){L_.forEach(function(e){e=e+n.charAt(0).toUpperCase()+n.substring(1),Es[e]=Es[n]})});function bp(n,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||Es.hasOwnProperty(n)&&Es[n]?(""+e).trim():e+"px"}function Ep(n,e){n=n.style;for(var t in e)if(e.hasOwnProperty(t)){var r=t.indexOf("--")===0,s=bp(t,e[t],r);t==="float"&&(t="cssFloat"),r?n.setProperty(t,s):n[t]=s}}var O_=Q({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function tl(n,e){if(e){if(O_[n]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(k(137,n));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(k(60));if(!(typeof e.dangerouslySetInnerHTML=="object"&&"__html"in e.dangerouslySetInnerHTML))throw Error(k(61))}if(e.style!=null&&typeof e.style!="object")throw Error(k(62))}}function nl(n,e){if(n.indexOf("-")===-1)return typeof e.is=="string";switch(n){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}function cu(n){return n=n.target||n.srcElement||window,n.correspondingUseElement&&(n=n.correspondingUseElement),n.nodeType===3?n.parentNode:n}var rl=null,_r=null,gr=null;function Wc(n){if(n=ii(n)){if(typeof rl!="function")throw Error(k(280));var e=n.stateNode;e&&(e=Qo(e),rl(n.stateNode,n.type,e))}}function Ip(n){_r?gr?gr.push(n):gr=[n]:_r=n}function kp(){if(_r){var n=_r,e=gr;if(gr=_r=null,Wc(n),e)for(n=0;n<e.length;n++)Wc(e[n])}}function du(n,e){return n(e)}function Cp(n,e,t,r,s){return n(e,t,r,s)}function hu(){}var Rp=du,Nn=!1,_a=!1;function pu(){(_r!==null||gr!==null)&&(hu(),kp())}function U_(n,e,t){if(_a)return n(e,t);_a=!0;try{return Rp(n,e,t)}finally{_a=!1,pu()}}function Ks(n,e){var t=n.stateNode;if(t===null)return null;var r=Qo(t);if(r===null)return null;t=r[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(n=n.type,r=!(n==="button"||n==="input"||n==="select"||n==="textarea")),n=!r;break e;default:n=!1}if(n)return null;if(t&&typeof t!="function")throw Error(k(231,e,typeof t));return t}var sl=!1;if(Mt)try{var Jr={};Object.defineProperty(Jr,"passive",{get:function(){sl=!0}}),window.addEventListener("test",Jr,Jr),window.removeEventListener("test",Jr,Jr)}catch{sl=!1}function F_(n,e,t,r,s,i,o,a,l){var u=Array.prototype.slice.call(arguments,3);try{e.apply(t,u)}catch(c){this.onError(c)}}var Is=!1,uo=null,co=!1,il=null,K_={onError:function(n){Is=!0,uo=n}};function B_(n,e,t,r,s,i,o,a,l){Is=!1,uo=null,F_.apply(K_,arguments)}function V_(n,e,t,r,s,i,o,a,l){if(B_.apply(this,arguments),Is){if(Is){var u=uo;Is=!1,uo=null}else throw Error(k(198));co||(co=!0,il=u)}}function Gn(n){var e=n,t=n;if(n.alternate)for(;e.return;)e=e.return;else{n=e;do e=n,(e.flags&1026)!==0&&(t=e.return),n=e.return;while(n)}return e.tag===3?t:null}function Ap(n){if(n.tag===13){var e=n.memoizedState;if(e===null&&(n=n.alternate,n!==null&&(e=n.memoizedState)),e!==null)return e.dehydrated}return null}function zc(n){if(Gn(n)!==n)throw Error(k(188))}function $_(n){var e=n.alternate;if(!e){if(e=Gn(n),e===null)throw Error(k(188));return e!==n?null:n}for(var t=n,r=e;;){var s=t.return;if(s===null)break;var i=s.alternate;if(i===null){if(r=s.return,r!==null){t=r;continue}break}if(s.child===i.child){for(i=s.child;i;){if(i===t)return zc(s),n;if(i===r)return zc(s),e;i=i.sibling}throw Error(k(188))}if(t.return!==r.return)t=s,r=i;else{for(var o=!1,a=s.child;a;){if(a===t){o=!0,t=s,r=i;break}if(a===r){o=!0,r=s,t=i;break}a=a.sibling}if(!o){for(a=i.child;a;){if(a===t){o=!0,t=i,r=s;break}if(a===r){o=!0,r=i,t=s;break}a=a.sibling}if(!o)throw Error(k(189))}}if(t.alternate!==r)throw Error(k(190))}if(t.tag!==3)throw Error(k(188));return t.stateNode.current===t?n:e}function Tp(n){if(n=$_(n),!n)return null;for(var e=n;;){if(e.tag===5||e.tag===6)return e;if(e.child)e.child.return=e,e=e.child;else{if(e===n)break;for(;!e.sibling;){if(!e.return||e.return===n)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}}return null}function Hc(n,e){for(var t=n.alternate;e!==null;){if(e===n||e===t)return!0;e=e.return}return!1}var xp,fu,Np,Mp,ol=!1,at=[],Jt=null,Xt=null,Zt=null,Bs=new Map,Vs=new Map,Xr=[],qc="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function al(n,e,t,r,s){return{blockedOn:n,domEventName:e,eventSystemFlags:t|16,nativeEvent:s,targetContainers:[r]}}function Gc(n,e){switch(n){case"focusin":case"focusout":Jt=null;break;case"dragenter":case"dragleave":Xt=null;break;case"mouseover":case"mouseout":Zt=null;break;case"pointerover":case"pointerout":Bs.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Vs.delete(e.pointerId)}}function Zr(n,e,t,r,s,i){return n===null||n.nativeEvent!==i?(n=al(e,t,r,s,i),e!==null&&(e=ii(e),e!==null&&fu(e)),n):(n.eventSystemFlags|=r,e=n.targetContainers,s!==null&&e.indexOf(s)===-1&&e.push(s),n)}function j_(n,e,t,r,s){switch(e){case"focusin":return Jt=Zr(Jt,n,e,t,r,s),!0;case"dragenter":return Xt=Zr(Xt,n,e,t,r,s),!0;case"mouseover":return Zt=Zr(Zt,n,e,t,r,s),!0;case"pointerover":var i=s.pointerId;return Bs.set(i,Zr(Bs.get(i)||null,n,e,t,r,s)),!0;case"gotpointercapture":return i=s.pointerId,Vs.set(i,Zr(Vs.get(i)||null,n,e,t,r,s)),!0}return!1}function W_(n){var e=Mn(n.target);if(e!==null){var t=Gn(e);if(t!==null){if(e=t.tag,e===13){if(e=Ap(t),e!==null){n.blockedOn=e,Mp(n.lanePriority,function(){le.unstable_runWithPriority(n.priority,function(){Np(t)})});return}}else if(e===3&&t.stateNode.hydrate){n.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}n.blockedOn=null}function qi(n){if(n.blockedOn!==null)return!1;for(var e=n.targetContainers;0<e.length;){var t=yu(n.domEventName,n.eventSystemFlags,e[0],n.nativeEvent);if(t!==null)return e=ii(t),e!==null&&fu(e),n.blockedOn=t,!1;e.shift()}return!0}function Yc(n,e,t){qi(n)&&t.delete(e)}function z_(){for(ol=!1;0<at.length;){var n=at[0];if(n.blockedOn!==null){n=ii(n.blockedOn),n!==null&&xp(n);break}for(var e=n.targetContainers;0<e.length;){var t=yu(n.domEventName,n.eventSystemFlags,e[0],n.nativeEvent);if(t!==null){n.blockedOn=t;break}e.shift()}n.blockedOn===null&&at.shift()}Jt!==null&&qi(Jt)&&(Jt=null),Xt!==null&&qi(Xt)&&(Xt=null),Zt!==null&&qi(Zt)&&(Zt=null),Bs.forEach(Yc),Vs.forEach(Yc)}function es(n,e){n.blockedOn===e&&(n.blockedOn=null,ol||(ol=!0,le.unstable_scheduleCallback(le.unstable_NormalPriority,z_)))}function Pp(n){function e(s){return es(s,n)}if(0<at.length){es(at[0],n);for(var t=1;t<at.length;t++){var r=at[t];r.blockedOn===n&&(r.blockedOn=null)}}for(Jt!==null&&es(Jt,n),Xt!==null&&es(Xt,n),Zt!==null&&es(Zt,n),Bs.forEach(e),Vs.forEach(e),t=0;t<Xr.length;t++)r=Xr[t],r.blockedOn===n&&(r.blockedOn=null);for(;0<Xr.length&&(t=Xr[0],t.blockedOn===null);)W_(t),t.blockedOn===null&&Xr.shift()}function Ii(n,e){var t={};return t[n.toLowerCase()]=e.toLowerCase(),t["Webkit"+n]="webkit"+e,t["Moz"+n]="moz"+e,t}var lr={animationend:Ii("Animation","AnimationEnd"),animationiteration:Ii("Animation","AnimationIteration"),animationstart:Ii("Animation","AnimationStart"),transitionend:Ii("Transition","TransitionEnd")},ga={},Dp={};Mt&&(Dp=document.createElement("div").style,"AnimationEvent"in window||(delete lr.animationend.animation,delete lr.animationiteration.animation,delete lr.animationstart.animation),"TransitionEvent"in window||delete lr.transitionend.transition);function zo(n){if(ga[n])return ga[n];if(!lr[n])return n;var e=lr[n],t;for(t in e)if(e.hasOwnProperty(t)&&t in Dp)return ga[n]=e[t];return n}var Lp=zo("animationend"),Op=zo("animationiteration"),Up=zo("animationstart"),Fp=zo("transitionend"),Kp=new Map,mu=new Map,H_=["abort","abort",Lp,"animationEnd",Op,"animationIteration",Up,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata","loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",Fp,"transitionEnd","waiting","waiting"];function _u(n,e){for(var t=0;t<n.length;t+=2){var r=n[t],s=n[t+1];s="on"+(s[0].toUpperCase()+s.slice(1)),mu.set(r,e),Kp.set(r,s),Hn(s,[r])}}var q_=le.unstable_now;q_();var j=8;function or(n){if((1&n)!==0)return j=15,1;if((2&n)!==0)return j=14,2;if((4&n)!==0)return j=13,4;var e=24&n;return e!==0?(j=12,e):(n&32)!==0?(j=11,32):(e=192&n,e!==0?(j=10,e):(n&256)!==0?(j=9,256):(e=3584&n,e!==0?(j=8,e):(n&4096)!==0?(j=7,4096):(e=4186112&n,e!==0?(j=6,e):(e=62914560&n,e!==0?(j=5,e):n&67108864?(j=4,67108864):(n&134217728)!==0?(j=3,134217728):(e=805306368&n,e!==0?(j=2,e):(1073741824&n)!==0?(j=1,1073741824):(j=8,n))))))}function G_(n){switch(n){case 99:return 15;case 98:return 10;case 97:case 96:return 8;case 95:return 2;default:return 0}}function Y_(n){switch(n){case 15:case 14:return 99;case 13:case 12:case 11:case 10:return 98;case 9:case 8:case 7:case 6:case 4:case 5:return 97;case 3:case 2:case 1:return 95;case 0:return 90;default:throw Error(k(358,n))}}function $s(n,e){var t=n.pendingLanes;if(t===0)return j=0;var r=0,s=0,i=n.expiredLanes,o=n.suspendedLanes,a=n.pingedLanes;if(i!==0)r=i,s=j=15;else if(i=t&134217727,i!==0){var l=i&~o;l!==0?(r=or(l),s=j):(a&=i,a!==0&&(r=or(a),s=j))}else i=t&~o,i!==0?(r=or(i),s=j):a!==0&&(r=or(a),s=j);if(r===0)return 0;if(r=31-dn(r),r=t&((0>r?0:1<<r)<<1)-1,e!==0&&e!==r&&(e&o)===0){if(or(e),s<=j)return e;j=s}if(e=n.entangledLanes,e!==0)for(n=n.entanglements,e&=r;0<e;)t=31-dn(e),s=1<<t,r|=n[t],e&=~s;return r}function Bp(n){return n=n.pendingLanes&-1073741825,n!==0?n:n&1073741824?1073741824:0}function ho(n,e){switch(n){case 15:return 1;case 14:return 2;case 12:return n=ar(24&~e),n===0?ho(10,e):n;case 10:return n=ar(192&~e),n===0?ho(8,e):n;case 8:return n=ar(3584&~e),n===0&&(n=ar(4186112&~e),n===0&&(n=512)),n;case 2:return e=ar(805306368&~e),e===0&&(e=268435456),e}throw Error(k(358,n))}function ar(n){return n&-n}function ya(n){for(var e=[],t=0;31>t;t++)e.push(n);return e}function Ho(n,e,t){n.pendingLanes|=e;var r=e-1;n.suspendedLanes&=r,n.pingedLanes&=r,n=n.eventTimes,e=31-dn(e),n[e]=t}var dn=Math.clz32?Math.clz32:X_,Q_=Math.log,J_=Math.LN2;function X_(n){return n===0?32:31-(Q_(n)/J_|0)|0}var Z_=le.unstable_UserBlockingPriority,eg=le.unstable_runWithPriority,Gi=!0;function tg(n,e,t,r){Nn||hu();var s=gu,i=Nn;Nn=!0;try{Cp(s,n,e,t,r)}finally{(Nn=i)||pu()}}function ng(n,e,t,r){eg(Z_,gu.bind(null,n,e,t,r))}function gu(n,e,t,r){if(Gi){var s;if((s=(e&4)===0)&&0<at.length&&-1<qc.indexOf(n))n=al(null,n,e,t,r),at.push(n);else{var i=yu(n,e,t,r);if(i===null)s&&Gc(n,r);else{if(s){if(-1<qc.indexOf(n)){n=al(i,n,e,t,r),at.push(n);return}if(j_(i,n,e,t,r))return;Gc(n,r)}Zp(n,e,r,null,t)}}}}function yu(n,e,t,r){var s=cu(r);if(s=Mn(s),s!==null){var i=Gn(s);if(i===null)s=null;else{var o=i.tag;if(o===13){if(s=Ap(i),s!==null)return s;s=null}else if(o===3){if(i.stateNode.hydrate)return i.tag===3?i.stateNode.containerInfo:null;s=null}else i!==s&&(s=null)}}return Zp(n,e,r,s,t),null}var Gt=null,vu=null,Yi=null;function Vp(){if(Yi)return Yi;var n,e=vu,t=e.length,r,s="value"in Gt?Gt.value:Gt.textContent,i=s.length;for(n=0;n<t&&e[n]===s[n];n++);var o=t-n;for(r=1;r<=o&&e[t-r]===s[i-r];r++);return Yi=s.slice(n,1<r?1-r:void 0)}function Qi(n){var e=n.keyCode;return"charCode"in n?(n=n.charCode,n===0&&e===13&&(n=13)):n=e,n===10&&(n=13),32<=n||n===13?n:0}function ki(){return!0}function Qc(){return!1}function Fe(n){function e(t,r,s,i,o){this._reactName=t,this._targetInst=s,this.type=r,this.nativeEvent=i,this.target=o,this.currentTarget=null;for(var a in n)n.hasOwnProperty(a)&&(t=n[a],this[a]=t?t(i):i[a]);return this.isDefaultPrevented=(i.defaultPrevented!=null?i.defaultPrevented:i.returnValue===!1)?ki:Qc,this.isPropagationStopped=Qc,this}return Q(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=ki)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=ki)},persist:function(){},isPersistent:ki}),e}var Or={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(n){return n.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},wu=Fe(Or),si=Q({},Or,{view:0,detail:0}),rg=Fe(si),va,wa,ts,qo=Q({},si,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Su,button:0,buttons:0,relatedTarget:function(n){return n.relatedTarget===void 0?n.fromElement===n.srcElement?n.toElement:n.fromElement:n.relatedTarget},movementX:function(n){return"movementX"in n?n.movementX:(n!==ts&&(ts&&n.type==="mousemove"?(va=n.screenX-ts.screenX,wa=n.screenY-ts.screenY):wa=va=0,ts=n),va)},movementY:function(n){return"movementY"in n?n.movementY:wa}}),Jc=Fe(qo),sg=Q({},qo,{dataTransfer:0}),ig=Fe(sg),og=Q({},si,{relatedTarget:0}),Sa=Fe(og),ag=Q({},Or,{animationName:0,elapsedTime:0,pseudoElement:0}),lg=Fe(ag),ug=Q({},Or,{clipboardData:function(n){return"clipboardData"in n?n.clipboardData:window.clipboardData}}),cg=Fe(ug),dg=Q({},Or,{data:0}),Xc=Fe(dg),hg={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},pg={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},fg={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function mg(n){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(n):(n=fg[n])?!!e[n]:!1}function Su(){return mg}var _g=Q({},si,{key:function(n){if(n.key){var e=hg[n.key]||n.key;if(e!=="Unidentified")return e}return n.type==="keypress"?(n=Qi(n),n===13?"Enter":String.fromCharCode(n)):n.type==="keydown"||n.type==="keyup"?pg[n.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Su,charCode:function(n){return n.type==="keypress"?Qi(n):0},keyCode:function(n){return n.type==="keydown"||n.type==="keyup"?n.keyCode:0},which:function(n){return n.type==="keypress"?Qi(n):n.type==="keydown"||n.type==="keyup"?n.keyCode:0}}),gg=Fe(_g),yg=Q({},qo,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Zc=Fe(yg),vg=Q({},si,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Su}),wg=Fe(vg),Sg=Q({},Or,{propertyName:0,elapsedTime:0,pseudoElement:0}),bg=Fe(Sg),Eg=Q({},qo,{deltaX:function(n){return"deltaX"in n?n.deltaX:"wheelDeltaX"in n?-n.wheelDeltaX:0},deltaY:function(n){return"deltaY"in n?n.deltaY:"wheelDeltaY"in n?-n.wheelDeltaY:"wheelDelta"in n?-n.wheelDelta:0},deltaZ:0,deltaMode:0}),Ig=Fe(Eg),kg=[9,13,27,32],bu=Mt&&"CompositionEvent"in window,ks=null;Mt&&"documentMode"in document&&(ks=document.documentMode);var Cg=Mt&&"TextEvent"in window&&!ks,$p=Mt&&(!bu||ks&&8<ks&&11>=ks),ed=String.fromCharCode(32),td=!1;function jp(n,e){switch(n){case"keyup":return kg.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Wp(n){return n=n.detail,typeof n=="object"&&"data"in n?n.data:null}var ur=!1;function Rg(n,e){switch(n){case"compositionend":return Wp(e);case"keypress":return e.which!==32?null:(td=!0,ed);case"textInput":return n=e.data,n===ed&&td?null:n;default:return null}}function Ag(n,e){if(ur)return n==="compositionend"||!bu&&jp(n,e)?(n=Vp(),Yi=vu=Gt=null,ur=!1,n):null;switch(n){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return $p&&e.locale!=="ko"?null:e.data;default:return null}}var Tg={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function nd(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e==="input"?!!Tg[n.type]:e==="textarea"}function zp(n,e,t,r){Ip(r),e=po(e,"onChange"),0<e.length&&(t=new wu("onChange","change",null,t,r),n.push({event:t,listeners:e}))}var Cs=null,js=null;function xg(n){Qp(n,0)}function Go(n){var e=dr(n);if(gp(e))return n}function Ng(n,e){if(n==="change")return e}var Hp=!1;if(Mt){var ba;if(Mt){var Ea="oninput"in document;if(!Ea){var rd=document.createElement("div");rd.setAttribute("oninput","return;"),Ea=typeof rd.oninput=="function"}ba=Ea}else ba=!1;Hp=ba&&(!document.documentMode||9<document.documentMode)}function sd(){Cs&&(Cs.detachEvent("onpropertychange",qp),js=Cs=null)}function qp(n){if(n.propertyName==="value"&&Go(js)){var e=[];if(zp(e,js,n,cu(n)),n=xg,Nn)n(e);else{Nn=!0;try{du(n,e)}finally{Nn=!1,pu()}}}}function Mg(n,e,t){n==="focusin"?(sd(),Cs=e,js=t,Cs.attachEvent("onpropertychange",qp)):n==="focusout"&&sd()}function Pg(n){if(n==="selectionchange"||n==="keyup"||n==="keydown")return Go(js)}function Dg(n,e){if(n==="click")return Go(e)}function Lg(n,e){if(n==="input"||n==="change")return Go(e)}function Og(n,e){return n===e&&(n!==0||1/n===1/e)||n!==n&&e!==e}var Be=typeof Object.is=="function"?Object.is:Og,Ug=Object.prototype.hasOwnProperty;function Ws(n,e){if(Be(n,e))return!0;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return!1;var t=Object.keys(n),r=Object.keys(e);if(t.length!==r.length)return!1;for(r=0;r<t.length;r++)if(!Ug.call(e,t[r])||!Be(n[t[r]],e[t[r]]))return!1;return!0}function id(n){for(;n&&n.firstChild;)n=n.firstChild;return n}function od(n,e){var t=id(n);n=0;for(var r;t;){if(t.nodeType===3){if(r=n+t.textContent.length,n<=e&&r>=e)return{node:t,offset:e-n};n=r}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=id(t)}}function Gp(n,e){return n&&e?n===e?!0:n&&n.nodeType===3?!1:e&&e.nodeType===3?Gp(n,e.parentNode):"contains"in n?n.contains(e):n.compareDocumentPosition?!!(n.compareDocumentPosition(e)&16):!1:!1}function ad(){for(var n=window,e=lo();e instanceof n.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)n=e.contentWindow;else break;e=lo(n.document)}return e}function ll(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e&&(e==="input"&&(n.type==="text"||n.type==="search"||n.type==="tel"||n.type==="url"||n.type==="password")||e==="textarea"||n.contentEditable==="true")}var Fg=Mt&&"documentMode"in document&&11>=document.documentMode,cr=null,ul=null,Rs=null,cl=!1;function ld(n,e,t){var r=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;cl||cr==null||cr!==lo(r)||(r=cr,"selectionStart"in r&&ll(r)?r={start:r.selectionStart,end:r.selectionEnd}:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection(),r={anchorNode:r.anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset}),Rs&&Ws(Rs,r)||(Rs=r,r=po(ul,"onSelect"),0<r.length&&(e=new wu("onSelect","select",null,e,t),n.push({event:e,listeners:r}),e.target=cr)))}_u("cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focusin focus focusout blur input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),0);_u("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);_u(H_,2);for(var ud="change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),Ia=0;Ia<ud.length;Ia++)mu.set(ud[Ia],0);kr("onMouseEnter",["mouseout","mouseover"]);kr("onMouseLeave",["mouseout","mouseover"]);kr("onPointerEnter",["pointerout","pointerover"]);kr("onPointerLeave",["pointerout","pointerover"]);Hn("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));Hn("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));Hn("onBeforeInput",["compositionend","keypress","textInput","paste"]);Hn("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));Hn("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));Hn("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var fs="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Yp=new Set("cancel close invalid load scroll toggle".split(" ").concat(fs));function cd(n,e,t){var r=n.type||"unknown-event";n.currentTarget=t,V_(r,e,void 0,n),n.currentTarget=null}function Qp(n,e){e=(e&4)!==0;for(var t=0;t<n.length;t++){var r=n[t],s=r.event;r=r.listeners;e:{var i=void 0;if(e)for(var o=r.length-1;0<=o;o--){var a=r[o],l=a.instance,u=a.currentTarget;if(a=a.listener,l!==i&&s.isPropagationStopped())break e;cd(s,a,u),i=l}else for(o=0;o<r.length;o++){if(a=r[o],l=a.instance,u=a.currentTarget,a=a.listener,l!==i&&s.isPropagationStopped())break e;cd(s,a,u),i=l}}}if(co)throw n=il,co=!1,il=null,n}function z(n,e){var t=tf(e),r=n+"__bubble";t.has(r)||(Xp(e,n,2,!1),t.add(r))}var dd="_reactListening"+Math.random().toString(36).slice(2);function Jp(n){n[dd]||(n[dd]=!0,fp.forEach(function(e){Yp.has(e)||hd(e,!1,n,null),hd(e,!0,n,null)}))}function hd(n,e,t,r){var s=4<arguments.length&&arguments[4]!==void 0?arguments[4]:0,i=t;if(n==="selectionchange"&&t.nodeType!==9&&(i=t.ownerDocument),r!==null&&!e&&Yp.has(n)){if(n!=="scroll")return;s|=2,i=r}var o=tf(i),a=n+"__"+(e?"capture":"bubble");o.has(a)||(e&&(s|=4),Xp(i,n,s,e),o.add(a))}function Xp(n,e,t,r){var s=mu.get(e);switch(s===void 0?2:s){case 0:s=tg;break;case 1:s=ng;break;default:s=gu}t=s.bind(null,e,t,n),s=void 0,!sl||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(s=!0),r?s!==void 0?n.addEventListener(e,t,{capture:!0,passive:s}):n.addEventListener(e,t,!0):s!==void 0?n.addEventListener(e,t,{passive:s}):n.addEventListener(e,t,!1)}function Zp(n,e,t,r,s){var i=r;if((e&1)===0&&(e&2)===0&&r!==null)e:for(;;){if(r===null)return;var o=r.tag;if(o===3||o===4){var a=r.stateNode.containerInfo;if(a===s||a.nodeType===8&&a.parentNode===s)break;if(o===4)for(o=r.return;o!==null;){var l=o.tag;if((l===3||l===4)&&(l=o.stateNode.containerInfo,l===s||l.nodeType===8&&l.parentNode===s))return;o=o.return}for(;a!==null;){if(o=Mn(a),o===null)return;if(l=o.tag,l===5||l===6){r=i=o;continue e}a=a.parentNode}}r=r.return}U_(function(){var u=i,c=cu(t),d=[];e:{var h=Kp.get(n);if(h!==void 0){var g=wu,v=n;switch(n){case"keypress":if(Qi(t)===0)break e;case"keydown":case"keyup":g=gg;break;case"focusin":v="focus",g=Sa;break;case"focusout":v="blur",g=Sa;break;case"beforeblur":case"afterblur":g=Sa;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":g=Jc;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":g=ig;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":g=wg;break;case Lp:case Op:case Up:g=lg;break;case Fp:g=bg;break;case"scroll":g=rg;break;case"wheel":g=Ig;break;case"copy":case"cut":case"paste":g=cg;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":g=Zc}var S=(e&4)!==0,f=!S&&n==="scroll",p=S?h!==null?h+"Capture":null:h;S=[];for(var m=u,w;m!==null;){w=m;var y=w.stateNode;if(w.tag===5&&y!==null&&(w=y,p!==null&&(y=Ks(m,p),y!=null&&S.push(zs(m,y,w)))),f)break;m=m.return}0<S.length&&(h=new g(h,v,null,t,c),d.push({event:h,listeners:S}))}}if((e&7)===0){e:{if(h=n==="mouseover"||n==="pointerover",g=n==="mouseout"||n==="pointerout",h&&(e&16)===0&&(v=t.relatedTarget||t.fromElement)&&(Mn(v)||v[Ur]))break e;if((g||h)&&(h=c.window===c?c:(h=c.ownerDocument)?h.defaultView||h.parentWindow:window,g?(v=t.relatedTarget||t.toElement,g=u,v=v?Mn(v):null,v!==null&&(f=Gn(v),v!==f||v.tag!==5&&v.tag!==6)&&(v=null)):(g=null,v=u),g!==v)){if(S=Jc,y="onMouseLeave",p="onMouseEnter",m="mouse",(n==="pointerout"||n==="pointerover")&&(S=Zc,y="onPointerLeave",p="onPointerEnter",m="pointer"),f=g==null?h:dr(g),w=v==null?h:dr(v),h=new S(y,m+"leave",g,t,c),h.target=f,h.relatedTarget=w,y=null,Mn(c)===u&&(S=new S(p,m+"enter",v,t,c),S.target=w,S.relatedTarget=f,y=S),f=y,g&&v)t:{for(S=g,p=v,m=0,w=S;w;w=sr(w))m++;for(w=0,y=p;y;y=sr(y))w++;for(;0<m-w;)S=sr(S),m--;for(;0<w-m;)p=sr(p),w--;for(;m--;){if(S===p||p!==null&&S===p.alternate)break t;S=sr(S),p=sr(p)}S=null}else S=null;g!==null&&pd(d,h,g,S,!1),v!==null&&f!==null&&pd(d,f,v,S,!0)}}e:{if(h=u?dr(u):window,g=h.nodeName&&h.nodeName.toLowerCase(),g==="select"||g==="input"&&h.type==="file")var T=Ng;else if(nd(h))if(Hp)T=Lg;else{T=Pg;var b=Mg}else(g=h.nodeName)&&g.toLowerCase()==="input"&&(h.type==="checkbox"||h.type==="radio")&&(T=Dg);if(T&&(T=T(n,u))){zp(d,T,t,c);break e}b&&b(n,h,u),n==="focusout"&&(b=h._wrapperState)&&b.controlled&&h.type==="number"&&Qa(h,"number",h.value)}switch(b=u?dr(u):window,n){case"focusin":(nd(b)||b.contentEditable==="true")&&(cr=b,ul=u,Rs=null);break;case"focusout":Rs=ul=cr=null;break;case"mousedown":cl=!0;break;case"contextmenu":case"mouseup":case"dragend":cl=!1,ld(d,t,c);break;case"selectionchange":if(Fg)break;case"keydown":case"keyup":ld(d,t,c)}var R;if(bu)e:{switch(n){case"compositionstart":var P="onCompositionStart";break e;case"compositionend":P="onCompositionEnd";break e;case"compositionupdate":P="onCompositionUpdate";break e}P=void 0}else ur?jp(n,t)&&(P="onCompositionEnd"):n==="keydown"&&t.keyCode===229&&(P="onCompositionStart");P&&($p&&t.locale!=="ko"&&(ur||P!=="onCompositionStart"?P==="onCompositionEnd"&&ur&&(R=Vp()):(Gt=c,vu="value"in Gt?Gt.value:Gt.textContent,ur=!0)),b=po(u,P),0<b.length&&(P=new Xc(P,n,null,t,c),d.push({event:P,listeners:b}),R?P.data=R:(R=Wp(t),R!==null&&(P.data=R)))),(R=Cg?Rg(n,t):Ag(n,t))&&(u=po(u,"onBeforeInput"),0<u.length&&(c=new Xc("onBeforeInput","beforeinput",null,t,c),d.push({event:c,listeners:u}),c.data=R))}Qp(d,e)})}function zs(n,e,t){return{instance:n,listener:e,currentTarget:t}}function po(n,e){for(var t=e+"Capture",r=[];n!==null;){var s=n,i=s.stateNode;s.tag===5&&i!==null&&(s=i,i=Ks(n,t),i!=null&&r.unshift(zs(n,i,s)),i=Ks(n,e),i!=null&&r.push(zs(n,i,s))),n=n.return}return r}function sr(n){if(n===null)return null;do n=n.return;while(n&&n.tag!==5);return n||null}function pd(n,e,t,r,s){for(var i=e._reactName,o=[];t!==null&&t!==r;){var a=t,l=a.alternate,u=a.stateNode;if(l!==null&&l===r)break;a.tag===5&&u!==null&&(a=u,s?(l=Ks(t,i),l!=null&&o.unshift(zs(t,l,a))):s||(l=Ks(t,i),l!=null&&o.push(zs(t,l,a)))),t=t.return}o.length!==0&&n.push({event:e,listeners:o})}function fo(){}var ka=null,Ca=null;function ef(n,e){switch(n){case"button":case"input":case"select":case"textarea":return!!e.autoFocus}return!1}function dl(n,e){return n==="textarea"||n==="option"||n==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var fd=typeof setTimeout=="function"?setTimeout:void 0,Kg=typeof clearTimeout=="function"?clearTimeout:void 0;function Eu(n){n.nodeType===1?n.textContent="":n.nodeType===9&&(n=n.body,n!=null&&(n.textContent=""))}function yr(n){for(;n!=null;n=n.nextSibling){var e=n.nodeType;if(e===1||e===3)break}return n}function md(n){n=n.previousSibling;for(var e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return n;e--}else t==="/$"&&e++}n=n.previousSibling}return null}var Ra=0;function Bg(n){return{$$typeof:lu,toString:n,valueOf:n}}var Yo=Math.random().toString(36).slice(2),Yt="__reactFiber$"+Yo,mo="__reactProps$"+Yo,Ur="__reactContainer$"+Yo,_d="__reactEvents$"+Yo;function Mn(n){var e=n[Yt];if(e)return e;for(var t=n.parentNode;t;){if(e=t[Ur]||t[Yt]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(n=md(n);n!==null;){if(t=n[Yt])return t;n=md(n)}return e}n=t,t=n.parentNode}return null}function ii(n){return n=n[Yt]||n[Ur],!n||n.tag!==5&&n.tag!==6&&n.tag!==13&&n.tag!==3?null:n}function dr(n){if(n.tag===5||n.tag===6)return n.stateNode;throw Error(k(33))}function Qo(n){return n[mo]||null}function tf(n){var e=n[_d];return e===void 0&&(e=n[_d]=new Set),e}var hl=[],hr=-1;function _n(n){return{current:n}}function H(n){0>hr||(n.current=hl[hr],hl[hr]=null,hr--)}function X(n,e){hr++,hl[hr]=n.current,n.current=e}var hn={},be=_n(hn),De=_n(!1),$n=hn;function Cr(n,e){var t=n.type.contextTypes;if(!t)return hn;var r=n.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===e)return r.__reactInternalMemoizedMaskedChildContext;var s={},i;for(i in t)s[i]=e[i];return r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=e,n.__reactInternalMemoizedMaskedChildContext=s),s}function Le(n){return n=n.childContextTypes,n!=null}function _o(){H(De),H(be)}function gd(n,e,t){if(be.current!==hn)throw Error(k(168));X(be,e),X(De,t)}function nf(n,e,t){var r=n.stateNode;if(n=e.childContextTypes,typeof r.getChildContext!="function")return t;r=r.getChildContext();for(var s in r)if(!(s in n))throw Error(k(108,fr(e)||"Unknown",s));return Q({},t,r)}function Ji(n){return n=(n=n.stateNode)&&n.__reactInternalMemoizedMergedChildContext||hn,$n=be.current,X(be,n),X(De,De.current),!0}function yd(n,e,t){var r=n.stateNode;if(!r)throw Error(k(169));t?(n=nf(n,e,$n),r.__reactInternalMemoizedMergedChildContext=n,H(De),H(be),X(be,n)):H(De),X(De,t)}var Iu=null,Un=null,Vg=le.unstable_runWithPriority,ku=le.unstable_scheduleCallback,pl=le.unstable_cancelCallback,$g=le.unstable_shouldYield,vd=le.unstable_requestPaint,fl=le.unstable_now,jg=le.unstable_getCurrentPriorityLevel,Jo=le.unstable_ImmediatePriority,rf=le.unstable_UserBlockingPriority,sf=le.unstable_NormalPriority,of=le.unstable_LowPriority,af=le.unstable_IdlePriority,Aa={},Wg=vd!==void 0?vd:function(){},Et=null,Xi=null,Ta=!1,wd=fl(),ve=1e4>wd?fl:function(){return fl()-wd};function Rr(){switch(jg()){case Jo:return 99;case rf:return 98;case sf:return 97;case of:return 96;case af:return 95;default:throw Error(k(332))}}function lf(n){switch(n){case 99:return Jo;case 98:return rf;case 97:return sf;case 96:return of;case 95:return af;default:throw Error(k(332))}}function jn(n,e){return n=lf(n),Vg(n,e)}function Hs(n,e,t){return n=lf(n),ku(n,e,t)}function vt(){if(Xi!==null){var n=Xi;Xi=null,pl(n)}uf()}function uf(){if(!Ta&&Et!==null){Ta=!0;var n=0;try{var e=Et;jn(99,function(){for(;n<e.length;n++){var t=e[n];do t=t(!0);while(t!==null)}}),Et=null}catch(t){throw Et!==null&&(Et=Et.slice(n+1)),ku(Jo,vt),t}finally{Ta=!1}}}var zg=qn.ReactCurrentBatchConfig;function Xe(n,e){if(n&&n.defaultProps){e=Q({},e),n=n.defaultProps;for(var t in n)e[t]===void 0&&(e[t]=n[t]);return e}return e}var go=_n(null),yo=null,pr=null,vo=null;function Cu(){vo=pr=yo=null}function Ru(n){var e=go.current;H(go),n.type._context._currentValue=e}function cf(n,e){for(;n!==null;){var t=n.alternate;if((n.childLanes&e)===e){if(t===null||(t.childLanes&e)===e)break;t.childLanes|=e}else n.childLanes|=e,t!==null&&(t.childLanes|=e);n=n.return}}function vr(n,e){yo=n,vo=pr=null,n=n.dependencies,n!==null&&n.firstContext!==null&&((n.lanes&e)!==0&&(et=!0),n.firstContext=null)}function He(n,e){if(vo!==n&&e!==!1&&e!==0)if((typeof e!="number"||e===1073741823)&&(vo=n,e=1073741823),e={context:n,observedBits:e,next:null},pr===null){if(yo===null)throw Error(k(308));pr=e,yo.dependencies={lanes:0,firstContext:e,responders:null}}else pr=pr.next=e;return n._currentValue}var zt=!1;function Au(n){n.updateQueue={baseState:n.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null},effects:null}}function df(n,e){n=n.updateQueue,e.updateQueue===n&&(e.updateQueue={baseState:n.baseState,firstBaseUpdate:n.firstBaseUpdate,lastBaseUpdate:n.lastBaseUpdate,shared:n.shared,effects:n.effects})}function en(n,e){return{eventTime:n,lane:e,tag:0,payload:null,callback:null,next:null}}function tn(n,e){if(n=n.updateQueue,n!==null){n=n.shared;var t=n.pending;t===null?e.next=e:(e.next=t.next,t.next=e),n.pending=e}}function Sd(n,e){var t=n.updateQueue,r=n.alternate;if(r!==null&&(r=r.updateQueue,t===r)){var s=null,i=null;if(t=t.firstBaseUpdate,t!==null){do{var o={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};i===null?s=i=o:i=i.next=o,t=t.next}while(t!==null);i===null?s=i=e:i=i.next=e}else s=i=e;t={baseState:r.baseState,firstBaseUpdate:s,lastBaseUpdate:i,shared:r.shared,effects:r.effects},n.updateQueue=t;return}n=t.lastBaseUpdate,n===null?t.firstBaseUpdate=e:n.next=e,t.lastBaseUpdate=e}function qs(n,e,t,r){var s=n.updateQueue;zt=!1;var i=s.firstBaseUpdate,o=s.lastBaseUpdate,a=s.shared.pending;if(a!==null){s.shared.pending=null;var l=a,u=l.next;l.next=null,o===null?i=u:o.next=u,o=l;var c=n.alternate;if(c!==null){c=c.updateQueue;var d=c.lastBaseUpdate;d!==o&&(d===null?c.firstBaseUpdate=u:d.next=u,c.lastBaseUpdate=l)}}if(i!==null){d=s.baseState,o=0,c=u=l=null;do{a=i.lane;var h=i.eventTime;if((r&a)===a){c!==null&&(c=c.next={eventTime:h,lane:0,tag:i.tag,payload:i.payload,callback:i.callback,next:null});e:{var g=n,v=i;switch(a=e,h=t,v.tag){case 1:if(g=v.payload,typeof g=="function"){d=g.call(h,d,a);break e}d=g;break e;case 3:g.flags=g.flags&-4097|64;case 0:if(g=v.payload,a=typeof g=="function"?g.call(h,d,a):g,a==null)break e;d=Q({},d,a);break e;case 2:zt=!0}}i.callback!==null&&(n.flags|=32,a=s.effects,a===null?s.effects=[i]:a.push(i))}else h={eventTime:h,lane:a,tag:i.tag,payload:i.payload,callback:i.callback,next:null},c===null?(u=c=h,l=d):c=c.next=h,o|=a;if(i=i.next,i===null){if(a=s.shared.pending,a===null)break;i=a.next,a.next=null,s.lastBaseUpdate=a,s.shared.pending=null}}while(1);c===null&&(l=d),s.baseState=l,s.firstBaseUpdate=u,s.lastBaseUpdate=c,ai|=o,n.lanes=o,n.memoizedState=d}}function bd(n,e,t){if(n=e.effects,e.effects=null,n!==null)for(e=0;e<n.length;e++){var r=n[e],s=r.callback;if(s!==null){if(r.callback=null,r=t,typeof s!="function")throw Error(k(191,s));s.call(r)}}}var hf=new $o.Component().refs;function wo(n,e,t,r){e=n.memoizedState,t=t(r,e),t=t==null?e:Q({},e,t),n.memoizedState=t,n.lanes===0&&(n.updateQueue.baseState=t)}var Xo={isMounted:function(n){return(n=n._reactInternals)?Gn(n)===n:!1},enqueueSetState:function(n,e,t){n=n._reactInternals;var r=Ue(),s=nn(n),i=en(r,s);i.payload=e,t!=null&&(i.callback=t),tn(n,i),rn(n,s,r)},enqueueReplaceState:function(n,e,t){n=n._reactInternals;var r=Ue(),s=nn(n),i=en(r,s);i.tag=1,i.payload=e,t!=null&&(i.callback=t),tn(n,i),rn(n,s,r)},enqueueForceUpdate:function(n,e){n=n._reactInternals;var t=Ue(),r=nn(n),s=en(t,r);s.tag=2,e!=null&&(s.callback=e),tn(n,s),rn(n,r,t)}};function Ed(n,e,t,r,s,i,o){return n=n.stateNode,typeof n.shouldComponentUpdate=="function"?n.shouldComponentUpdate(r,i,o):e.prototype&&e.prototype.isPureReactComponent?!Ws(t,r)||!Ws(s,i):!0}function pf(n,e,t){var r=!1,s=hn,i=e.contextType;return typeof i=="object"&&i!==null?i=He(i):(s=Le(e)?$n:be.current,r=e.contextTypes,i=(r=r!=null)?Cr(n,s):hn),e=new e(t,i),n.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=Xo,n.stateNode=e,e._reactInternals=n,r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=s,n.__reactInternalMemoizedMaskedChildContext=i),e}function Id(n,e,t,r){n=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,r),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,r),e.state!==n&&Xo.enqueueReplaceState(e,e.state,null)}function ml(n,e,t,r){var s=n.stateNode;s.props=t,s.state=n.memoizedState,s.refs=hf,Au(n);var i=e.contextType;typeof i=="object"&&i!==null?s.context=He(i):(i=Le(e)?$n:be.current,s.context=Cr(n,i)),qs(n,t,s,r),s.state=n.memoizedState,i=e.getDerivedStateFromProps,typeof i=="function"&&(wo(n,e,i,t),s.state=n.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof s.getSnapshotBeforeUpdate=="function"||typeof s.UNSAFE_componentWillMount!="function"&&typeof s.componentWillMount!="function"||(e=s.state,typeof s.componentWillMount=="function"&&s.componentWillMount(),typeof s.UNSAFE_componentWillMount=="function"&&s.UNSAFE_componentWillMount(),e!==s.state&&Xo.enqueueReplaceState(s,s.state,null),qs(n,t,s,r),s.state=n.memoizedState),typeof s.componentDidMount=="function"&&(n.flags|=4)}var Ci=Array.isArray;function ns(n,e,t){if(n=t.ref,n!==null&&typeof n!="function"&&typeof n!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(k(309));var r=t.stateNode}if(!r)throw Error(k(147,n));var s=""+n;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===s?e.ref:(e=function(i){var o=r.refs;o===hf&&(o=r.refs={}),i===null?delete o[s]:o[s]=i},e._stringRef=s,e)}if(typeof n!="string")throw Error(k(284));if(!t._owner)throw Error(k(290,n))}return n}function Ri(n,e){if(n.type!=="textarea")throw Error(k(31,Object.prototype.toString.call(e)==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":e))}function ff(n){function e(f,p){if(n){var m=f.lastEffect;m!==null?(m.nextEffect=p,f.lastEffect=p):f.firstEffect=f.lastEffect=p,p.nextEffect=null,p.flags=8}}function t(f,p){if(!n)return null;for(;p!==null;)e(f,p),p=p.sibling;return null}function r(f,p){for(f=new Map;p!==null;)p.key!==null?f.set(p.key,p):f.set(p.index,p),p=p.sibling;return f}function s(f,p){return f=fn(f,p),f.index=0,f.sibling=null,f}function i(f,p,m){return f.index=m,n?(m=f.alternate,m!==null?(m=m.index,m<p?(f.flags=2,p):m):(f.flags=2,p)):p}function o(f){return n&&f.alternate===null&&(f.flags=2),f}function a(f,p,m,w){return p===null||p.tag!==6?(p=Da(m,f.mode,w),p.return=f,p):(p=s(p,m),p.return=f,p)}function l(f,p,m,w){return p!==null&&p.elementType===m.type?(w=s(p,m.props),w.ref=ns(f,p,m),w.return=f,w):(w=no(m.type,m.key,m.props,null,f.mode,w),w.ref=ns(f,p,m),w.return=f,w)}function u(f,p,m,w){return p===null||p.tag!==4||p.stateNode.containerInfo!==m.containerInfo||p.stateNode.implementation!==m.implementation?(p=La(m,f.mode,w),p.return=f,p):(p=s(p,m.children||[]),p.return=f,p)}function c(f,p,m,w,y){return p===null||p.tag!==7?(p=Er(m,f.mode,w,y),p.return=f,p):(p=s(p,m),p.return=f,p)}function d(f,p,m){if(typeof p=="string"||typeof p=="number")return p=Da(""+p,f.mode,m),p.return=f,p;if(typeof p=="object"&&p!==null){switch(p.$$typeof){case hs:return m=no(p.type,p.key,p.props,null,f.mode,m),m.ref=ns(f,null,p),m.return=f,m;case xn:return p=La(p,f.mode,m),p.return=f,p}if(Ci(p)||Qr(p))return p=Er(p,f.mode,m,null),p.return=f,p;Ri(f,p)}return null}function h(f,p,m,w){var y=p!==null?p.key:null;if(typeof m=="string"||typeof m=="number")return y!==null?null:a(f,p,""+m,w);if(typeof m=="object"&&m!==null){switch(m.$$typeof){case hs:return m.key===y?m.type===qt?c(f,p,m.props.children,w,y):l(f,p,m,w):null;case xn:return m.key===y?u(f,p,m,w):null}if(Ci(m)||Qr(m))return y!==null?null:c(f,p,m,w,null);Ri(f,m)}return null}function g(f,p,m,w,y){if(typeof w=="string"||typeof w=="number")return f=f.get(m)||null,a(p,f,""+w,y);if(typeof w=="object"&&w!==null){switch(w.$$typeof){case hs:return f=f.get(w.key===null?m:w.key)||null,w.type===qt?c(p,f,w.props.children,y,w.key):l(p,f,w,y);case xn:return f=f.get(w.key===null?m:w.key)||null,u(p,f,w,y)}if(Ci(w)||Qr(w))return f=f.get(m)||null,c(p,f,w,y,null);Ri(p,w)}return null}function v(f,p,m,w){for(var y=null,T=null,b=p,R=p=0,P=null;b!==null&&R<m.length;R++){b.index>R?(P=b,b=null):P=b.sibling;var N=h(f,b,m[R],w);if(N===null){b===null&&(b=P);break}n&&b&&N.alternate===null&&e(f,b),p=i(N,p,R),T===null?y=N:T.sibling=N,T=N,b=P}if(R===m.length)return t(f,b),y;if(b===null){for(;R<m.length;R++)b=d(f,m[R],w),b!==null&&(p=i(b,p,R),T===null?y=b:T.sibling=b,T=b);return y}for(b=r(f,b);R<m.length;R++)P=g(b,f,R,m[R],w),P!==null&&(n&&P.alternate!==null&&b.delete(P.key===null?R:P.key),p=i(P,p,R),T===null?y=P:T.sibling=P,T=P);return n&&b.forEach(function(ne){return e(f,ne)}),y}function S(f,p,m,w){var y=Qr(m);if(typeof y!="function")throw Error(k(150));if(m=y.call(m),m==null)throw Error(k(151));for(var T=y=null,b=p,R=p=0,P=null,N=m.next();b!==null&&!N.done;R++,N=m.next()){b.index>R?(P=b,b=null):P=b.sibling;var ne=h(f,b,N.value,w);if(ne===null){b===null&&(b=P);break}n&&b&&ne.alternate===null&&e(f,b),p=i(ne,p,R),T===null?y=ne:T.sibling=ne,T=ne,b=P}if(N.done)return t(f,b),y;if(b===null){for(;!N.done;R++,N=m.next())N=d(f,N.value,w),N!==null&&(p=i(N,p,R),T===null?y=N:T.sibling=N,T=N);return y}for(b=r(f,b);!N.done;R++,N=m.next())N=g(b,f,R,N.value,w),N!==null&&(n&&N.alternate!==null&&b.delete(N.key===null?R:N.key),p=i(N,p,R),T===null?y=N:T.sibling=N,T=N);return n&&b.forEach(function(Wr){return e(f,Wr)}),y}return function(f,p,m,w){var y=typeof m=="object"&&m!==null&&m.type===qt&&m.key===null;y&&(m=m.props.children);var T=typeof m=="object"&&m!==null;if(T)switch(m.$$typeof){case hs:e:{for(T=m.key,y=p;y!==null;){if(y.key===T){switch(y.tag){case 7:if(m.type===qt){t(f,y.sibling),p=s(y,m.props.children),p.return=f,f=p;break e}break;default:if(y.elementType===m.type){t(f,y.sibling),p=s(y,m.props),p.ref=ns(f,y,m),p.return=f,f=p;break e}}t(f,y);break}else e(f,y);y=y.sibling}m.type===qt?(p=Er(m.props.children,f.mode,w,m.key),p.return=f,f=p):(w=no(m.type,m.key,m.props,null,f.mode,w),w.ref=ns(f,p,m),w.return=f,f=w)}return o(f);case xn:e:{for(y=m.key;p!==null;){if(p.key===y)if(p.tag===4&&p.stateNode.containerInfo===m.containerInfo&&p.stateNode.implementation===m.implementation){t(f,p.sibling),p=s(p,m.children||[]),p.return=f,f=p;break e}else{t(f,p);break}else e(f,p);p=p.sibling}p=La(m,f.mode,w),p.return=f,f=p}return o(f)}if(typeof m=="string"||typeof m=="number")return m=""+m,p!==null&&p.tag===6?(t(f,p.sibling),p=s(p,m),p.return=f,f=p):(t(f,p),p=Da(m,f.mode,w),p.return=f,f=p),o(f);if(Ci(m))return v(f,p,m,w);if(Qr(m))return S(f,p,m,w);if(T&&Ri(f,m),typeof m=="undefined"&&!y)switch(f.tag){case 1:case 22:case 0:case 11:case 15:throw Error(k(152,fr(f.type)||"Component"))}return t(f,p)}}var So=ff(!0),mf=ff(!1),oi={},dt=_n(oi),Gs=_n(oi),Ys=_n(oi);function Pn(n){if(n===oi)throw Error(k(174));return n}function _l(n,e){switch(X(Ys,e),X(Gs,n),X(dt,oi),n=e.nodeType,n){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:el(null,"");break;default:n=n===8?e.parentNode:e,e=n.namespaceURI||null,n=n.tagName,e=el(e,n)}H(dt),X(dt,e)}function Ar(){H(dt),H(Gs),H(Ys)}function kd(n){Pn(Ys.current);var e=Pn(dt.current),t=el(e,n.type);e!==t&&(X(Gs,n),X(dt,t))}function Tu(n){Gs.current===n&&(H(dt),H(Gs))}var J=_n(0);function bo(n){for(var e=n;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if((e.flags&64)!==0)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===n)break;for(;e.sibling===null;){if(e.return===null||e.return===n)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var Rt=null,Qt=null,ht=!1;function _f(n,e){var t=Ve(5,null,null,0);t.elementType="DELETED",t.type="DELETED",t.stateNode=e,t.return=n,t.flags=8,n.lastEffect!==null?(n.lastEffect.nextEffect=t,n.lastEffect=t):n.firstEffect=n.lastEffect=t}function Cd(n,e){switch(n.tag){case 5:var t=n.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(n.stateNode=e,!0):!1;case 6:return e=n.pendingProps===""||e.nodeType!==3?null:e,e!==null?(n.stateNode=e,!0):!1;case 13:return!1;default:return!1}}function gl(n){if(ht){var e=Qt;if(e){var t=e;if(!Cd(n,e)){if(e=yr(t.nextSibling),!e||!Cd(n,e)){n.flags=n.flags&-1025|2,ht=!1,Rt=n;return}_f(Rt,t)}Rt=n,Qt=yr(e.firstChild)}else n.flags=n.flags&-1025|2,ht=!1,Rt=n}}function Rd(n){for(n=n.return;n!==null&&n.tag!==5&&n.tag!==3&&n.tag!==13;)n=n.return;Rt=n}function Ai(n){if(n!==Rt)return!1;if(!ht)return Rd(n),ht=!0,!1;var e=n.type;if(n.tag!==5||e!=="head"&&e!=="body"&&!dl(e,n.memoizedProps))for(e=Qt;e;)_f(n,e),e=yr(e.nextSibling);if(Rd(n),n.tag===13){if(n=n.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(k(317));e:{for(n=n.nextSibling,e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="/$"){if(e===0){Qt=yr(n.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}n=n.nextSibling}Qt=null}}else Qt=Rt?yr(n.stateNode.nextSibling):null;return!0}function xa(){Qt=Rt=null,ht=!1}var wr=[];function xu(){for(var n=0;n<wr.length;n++)wr[n]._workInProgressVersionPrimary=null;wr.length=0}var As=qn.ReactCurrentDispatcher,je=qn.ReactCurrentBatchConfig,Qs=0,ee=null,ye=null,ce=null,Eo=!1,Ts=!1;function Te(){throw Error(k(321))}function Nu(n,e){if(e===null)return!1;for(var t=0;t<e.length&&t<n.length;t++)if(!Be(n[t],e[t]))return!1;return!0}function Mu(n,e,t,r,s,i){if(Qs=i,ee=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,As.current=n===null||n.memoizedState===null?qg:Gg,n=t(r,s),Ts){i=0;do{if(Ts=!1,!(25>i))throw Error(k(301));i+=1,ce=ye=null,e.updateQueue=null,As.current=Yg,n=t(r,s)}while(Ts)}if(As.current=Ro,e=ye!==null&&ye.next!==null,Qs=0,ce=ye=ee=null,Eo=!1,e)throw Error(k(300));return n}function Dn(){var n={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return ce===null?ee.memoizedState=ce=n:ce=ce.next=n,ce}function Yn(){if(ye===null){var n=ee.alternate;n=n!==null?n.memoizedState:null}else n=ye.next;var e=ce===null?ee.memoizedState:ce.next;if(e!==null)ce=e,ye=n;else{if(n===null)throw Error(k(310));ye=n,n={memoizedState:ye.memoizedState,baseState:ye.baseState,baseQueue:ye.baseQueue,queue:ye.queue,next:null},ce===null?ee.memoizedState=ce=n:ce=ce.next=n}return ce}function lt(n,e){return typeof e=="function"?e(n):e}function rs(n){var e=Yn(),t=e.queue;if(t===null)throw Error(k(311));t.lastRenderedReducer=n;var r=ye,s=r.baseQueue,i=t.pending;if(i!==null){if(s!==null){var o=s.next;s.next=i.next,i.next=o}r.baseQueue=s=i,t.pending=null}if(s!==null){s=s.next,r=r.baseState;var a=o=i=null,l=s;do{var u=l.lane;if((Qs&u)===u)a!==null&&(a=a.next={lane:0,action:l.action,eagerReducer:l.eagerReducer,eagerState:l.eagerState,next:null}),r=l.eagerReducer===n?l.eagerState:n(r,l.action);else{var c={lane:u,action:l.action,eagerReducer:l.eagerReducer,eagerState:l.eagerState,next:null};a===null?(o=a=c,i=r):a=a.next=c,ee.lanes|=u,ai|=u}l=l.next}while(l!==null&&l!==s);a===null?i=r:a.next=o,Be(r,e.memoizedState)||(et=!0),e.memoizedState=r,e.baseState=i,e.baseQueue=a,t.lastRenderedState=r}return[e.memoizedState,t.dispatch]}function ss(n){var e=Yn(),t=e.queue;if(t===null)throw Error(k(311));t.lastRenderedReducer=n;var r=t.dispatch,s=t.pending,i=e.memoizedState;if(s!==null){t.pending=null;var o=s=s.next;do i=n(i,o.action),o=o.next;while(o!==s);Be(i,e.memoizedState)||(et=!0),e.memoizedState=i,e.baseQueue===null&&(e.baseState=i),t.lastRenderedState=i}return[i,r]}function Ad(n,e,t){var r=e._getVersion;r=r(e._source);var s=e._workInProgressVersionPrimary;if(s!==null?n=s===r:(n=n.mutableReadLanes,(n=(Qs&n)===n)&&(e._workInProgressVersionPrimary=r,wr.push(e))),n)return t(e._source);throw wr.push(e),Error(k(350))}function gf(n,e,t,r){var s=ke;if(s===null)throw Error(k(349));var i=e._getVersion,o=i(e._source),a=As.current,l=a.useState(function(){return Ad(s,e,t)}),u=l[1],c=l[0];l=ce;var d=n.memoizedState,h=d.refs,g=h.getSnapshot,v=d.source;d=d.subscribe;var S=ee;return n.memoizedState={refs:h,source:e,subscribe:r},a.useEffect(function(){h.getSnapshot=t,h.setSnapshot=u;var f=i(e._source);if(!Be(o,f)){f=t(e._source),Be(c,f)||(u(f),f=nn(S),s.mutableReadLanes|=f&s.pendingLanes),f=s.mutableReadLanes,s.entangledLanes|=f;for(var p=s.entanglements,m=f;0<m;){var w=31-dn(m),y=1<<w;p[w]|=f,m&=~y}}},[t,e,r]),a.useEffect(function(){return r(e._source,function(){var f=h.getSnapshot,p=h.setSnapshot;try{p(f(e._source));var m=nn(S);s.mutableReadLanes|=m&s.pendingLanes}catch(w){p(function(){throw w})}})},[e,r]),Be(g,t)&&Be(v,e)&&Be(d,r)||(n={pending:null,dispatch:null,lastRenderedReducer:lt,lastRenderedState:c},n.dispatch=u=Lu.bind(null,ee,n),l.queue=n,l.baseQueue=null,c=Ad(s,e,t),l.memoizedState=l.baseState=c),c}function yf(n,e,t){var r=Yn();return gf(r,n,e,t)}function is(n){var e=Dn();return typeof n=="function"&&(n=n()),e.memoizedState=e.baseState=n,n=e.queue={pending:null,dispatch:null,lastRenderedReducer:lt,lastRenderedState:n},n=n.dispatch=Lu.bind(null,ee,n),[e.memoizedState,n]}function Io(n,e,t,r){return n={tag:n,create:e,destroy:t,deps:r,next:null},e=ee.updateQueue,e===null?(e={lastEffect:null},ee.updateQueue=e,e.lastEffect=n.next=n):(t=e.lastEffect,t===null?e.lastEffect=n.next=n:(r=t.next,t.next=n,n.next=r,e.lastEffect=n)),n}function Td(n){var e=Dn();return n={current:n},e.memoizedState=n}function ko(){return Yn().memoizedState}function yl(n,e,t,r){var s=Dn();ee.flags|=n,s.memoizedState=Io(1|e,t,void 0,r===void 0?null:r)}function Pu(n,e,t,r){var s=Yn();r=r===void 0?null:r;var i=void 0;if(ye!==null){var o=ye.memoizedState;if(i=o.destroy,r!==null&&Nu(r,o.deps)){Io(e,t,i,r);return}}ee.flags|=n,s.memoizedState=Io(1|e,t,i,r)}function xd(n,e){return yl(516,4,n,e)}function Co(n,e){return Pu(516,4,n,e)}function vf(n,e){return Pu(4,2,n,e)}function wf(n,e){if(typeof e=="function")return n=n(),e(n),function(){e(null)};if(e!=null)return n=n(),e.current=n,function(){e.current=null}}function Sf(n,e,t){return t=t!=null?t.concat([n]):null,Pu(4,2,wf.bind(null,e,n),t)}function Du(){}function bf(n,e){var t=Yn();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&Nu(e,r[1])?r[0]:(t.memoizedState=[n,e],n)}function Ef(n,e){var t=Yn();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&Nu(e,r[1])?r[0]:(n=n(),t.memoizedState=[n,e],n)}function Hg(n,e){var t=Rr();jn(98>t?98:t,function(){n(!0)}),jn(97<t?97:t,function(){var r=je.transition;je.transition=1;try{n(!1),e()}finally{je.transition=r}})}function Lu(n,e,t){var r=Ue(),s=nn(n),i={lane:s,action:t,eagerReducer:null,eagerState:null,next:null},o=e.pending;if(o===null?i.next=i:(i.next=o.next,o.next=i),e.pending=i,o=n.alternate,n===ee||o!==null&&o===ee)Ts=Eo=!0;else{if(n.lanes===0&&(o===null||o.lanes===0)&&(o=e.lastRenderedReducer,o!==null))try{var a=e.lastRenderedState,l=o(a,t);if(i.eagerReducer=o,i.eagerState=l,Be(l,a))return}catch{}finally{}rn(n,s,r)}}var Ro={readContext:He,useCallback:Te,useContext:Te,useEffect:Te,useImperativeHandle:Te,useLayoutEffect:Te,useMemo:Te,useReducer:Te,useRef:Te,useState:Te,useDebugValue:Te,useDeferredValue:Te,useTransition:Te,useMutableSource:Te,useOpaqueIdentifier:Te,unstable_isNewReconciler:!1},qg={readContext:He,useCallback:function(n,e){return Dn().memoizedState=[n,e===void 0?null:e],n},useContext:He,useEffect:xd,useImperativeHandle:function(n,e,t){return t=t!=null?t.concat([n]):null,yl(4,2,wf.bind(null,e,n),t)},useLayoutEffect:function(n,e){return yl(4,2,n,e)},useMemo:function(n,e){var t=Dn();return e=e===void 0?null:e,n=n(),t.memoizedState=[n,e],n},useReducer:function(n,e,t){var r=Dn();return e=t!==void 0?t(e):e,r.memoizedState=r.baseState=e,n=r.queue={pending:null,dispatch:null,lastRenderedReducer:n,lastRenderedState:e},n=n.dispatch=Lu.bind(null,ee,n),[r.memoizedState,n]},useRef:Td,useState:is,useDebugValue:Du,useDeferredValue:function(n){var e=is(n),t=e[0],r=e[1];return xd(function(){var s=je.transition;je.transition=1;try{r(n)}finally{je.transition=s}},[n]),t},useTransition:function(){var n=is(!1),e=n[0];return n=Hg.bind(null,n[1]),Td(n),[n,e]},useMutableSource:function(n,e,t){var r=Dn();return r.memoizedState={refs:{getSnapshot:e,setSnapshot:null},source:n,subscribe:t},gf(r,n,e,t)},useOpaqueIdentifier:function(){if(ht){var n=!1,e=Bg(function(){throw n||(n=!0,t("r:"+(Ra++).toString(36))),Error(k(355))}),t=is(e)[1];return(ee.mode&2)===0&&(ee.flags|=516,Io(5,function(){t("r:"+(Ra++).toString(36))},void 0,null)),e}return e="r:"+(Ra++).toString(36),is(e),e},unstable_isNewReconciler:!1},Gg={readContext:He,useCallback:bf,useContext:He,useEffect:Co,useImperativeHandle:Sf,useLayoutEffect:vf,useMemo:Ef,useReducer:rs,useRef:ko,useState:function(){return rs(lt)},useDebugValue:Du,useDeferredValue:function(n){var e=rs(lt),t=e[0],r=e[1];return Co(function(){var s=je.transition;je.transition=1;try{r(n)}finally{je.transition=s}},[n]),t},useTransition:function(){var n=rs(lt)[0];return[ko().current,n]},useMutableSource:yf,useOpaqueIdentifier:function(){return rs(lt)[0]},unstable_isNewReconciler:!1},Yg={readContext:He,useCallback:bf,useContext:He,useEffect:Co,useImperativeHandle:Sf,useLayoutEffect:vf,useMemo:Ef,useReducer:ss,useRef:ko,useState:function(){return ss(lt)},useDebugValue:Du,useDeferredValue:function(n){var e=ss(lt),t=e[0],r=e[1];return Co(function(){var s=je.transition;je.transition=1;try{r(n)}finally{je.transition=s}},[n]),t},useTransition:function(){var n=ss(lt)[0];return[ko().current,n]},useMutableSource:yf,useOpaqueIdentifier:function(){return ss(lt)[0]},unstable_isNewReconciler:!1},Qg=qn.ReactCurrentOwner,et=!1;function Ne(n,e,t,r){e.child=n===null?mf(e,null,t,r):So(e,n.child,t,r)}function Nd(n,e,t,r,s){t=t.render;var i=e.ref;return vr(e,s),r=Mu(n,e,t,r,i,s),n!==null&&!et?(e.updateQueue=n.updateQueue,e.flags&=-517,n.lanes&=~s,At(n,e,s)):(e.flags|=1,Ne(n,e,r,s),e.child)}function Md(n,e,t,r,s,i){if(n===null){var o=t.type;return typeof o=="function"&&!Vu(o)&&o.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=o,If(n,e,o,r,s,i)):(n=no(t.type,null,r,e,e.mode,i),n.ref=e.ref,n.return=e,e.child=n)}return o=n.child,(s&i)===0&&(s=o.memoizedProps,t=t.compare,t=t!==null?t:Ws,t(s,r)&&n.ref===e.ref)?At(n,e,i):(e.flags|=1,n=fn(o,r),n.ref=e.ref,n.return=e,e.child=n)}function If(n,e,t,r,s,i){if(n!==null&&Ws(n.memoizedProps,r)&&n.ref===e.ref)if(et=!1,(i&s)!==0)(n.flags&16384)!==0&&(et=!0);else return e.lanes=n.lanes,At(n,e,i);return vl(n,e,t,r,i)}function Na(n,e,t){var r=e.pendingProps,s=r.children,i=n!==null?n.memoizedState:null;if(r.mode==="hidden"||r.mode==="unstable-defer-without-hiding")if((e.mode&4)===0)e.memoizedState={baseLanes:0},xi(e,t);else if((t&1073741824)!==0)e.memoizedState={baseLanes:0},xi(e,i!==null?i.baseLanes:t);else return n=i!==null?i.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:n},xi(e,n),null;else i!==null?(r=i.baseLanes|t,e.memoizedState=null):r=t,xi(e,r);return Ne(n,e,s,t),e.child}function kf(n,e){var t=e.ref;(n===null&&t!==null||n!==null&&n.ref!==t)&&(e.flags|=128)}function vl(n,e,t,r,s){var i=Le(t)?$n:be.current;return i=Cr(e,i),vr(e,s),t=Mu(n,e,t,r,i,s),n!==null&&!et?(e.updateQueue=n.updateQueue,e.flags&=-517,n.lanes&=~s,At(n,e,s)):(e.flags|=1,Ne(n,e,t,s),e.child)}function Pd(n,e,t,r,s){if(Le(t)){var i=!0;Ji(e)}else i=!1;if(vr(e,s),e.stateNode===null)n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),pf(e,t,r),ml(e,t,r,s),r=!0;else if(n===null){var o=e.stateNode,a=e.memoizedProps;o.props=a;var l=o.context,u=t.contextType;typeof u=="object"&&u!==null?u=He(u):(u=Le(t)?$n:be.current,u=Cr(e,u));var c=t.getDerivedStateFromProps,d=typeof c=="function"||typeof o.getSnapshotBeforeUpdate=="function";d||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==r||l!==u)&&Id(e,o,r,u),zt=!1;var h=e.memoizedState;o.state=h,qs(e,r,o,s),l=e.memoizedState,a!==r||h!==l||De.current||zt?(typeof c=="function"&&(wo(e,t,c,r),l=e.memoizedState),(a=zt||Ed(e,t,a,r,h,l,u))?(d||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount()),typeof o.componentDidMount=="function"&&(e.flags|=4)):(typeof o.componentDidMount=="function"&&(e.flags|=4),e.memoizedProps=r,e.memoizedState=l),o.props=r,o.state=l,o.context=u,r=a):(typeof o.componentDidMount=="function"&&(e.flags|=4),r=!1)}else{o=e.stateNode,df(n,e),a=e.memoizedProps,u=e.type===e.elementType?a:Xe(e.type,a),o.props=u,d=e.pendingProps,h=o.context,l=t.contextType,typeof l=="object"&&l!==null?l=He(l):(l=Le(t)?$n:be.current,l=Cr(e,l));var g=t.getDerivedStateFromProps;(c=typeof g=="function"||typeof o.getSnapshotBeforeUpdate=="function")||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==d||h!==l)&&Id(e,o,r,l),zt=!1,h=e.memoizedState,o.state=h,qs(e,r,o,s);var v=e.memoizedState;a!==d||h!==v||De.current||zt?(typeof g=="function"&&(wo(e,t,g,r),v=e.memoizedState),(u=zt||Ed(e,t,u,r,h,v,l))?(c||typeof o.UNSAFE_componentWillUpdate!="function"&&typeof o.componentWillUpdate!="function"||(typeof o.componentWillUpdate=="function"&&o.componentWillUpdate(r,v,l),typeof o.UNSAFE_componentWillUpdate=="function"&&o.UNSAFE_componentWillUpdate(r,v,l)),typeof o.componentDidUpdate=="function"&&(e.flags|=4),typeof o.getSnapshotBeforeUpdate=="function"&&(e.flags|=256)):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&h===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&h===n.memoizedState||(e.flags|=256),e.memoizedProps=r,e.memoizedState=v),o.props=r,o.state=v,o.context=l,r=u):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&h===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&h===n.memoizedState||(e.flags|=256),r=!1)}return wl(n,e,t,r,i,s)}function wl(n,e,t,r,s,i){kf(n,e);var o=(e.flags&64)!==0;if(!r&&!o)return s&&yd(e,t,!1),At(n,e,i);r=e.stateNode,Qg.current=e;var a=o&&typeof t.getDerivedStateFromError!="function"?null:r.render();return e.flags|=1,n!==null&&o?(e.child=So(e,n.child,null,i),e.child=So(e,null,a,i)):Ne(n,e,a,i),e.memoizedState=r.state,s&&yd(e,t,!0),e.child}function Dd(n){var e=n.stateNode;e.pendingContext?gd(n,e.pendingContext,e.pendingContext!==e.context):e.context&&gd(n,e.context,!1),_l(n,e.containerInfo)}var Ti={dehydrated:null,retryLane:0};function Ld(n,e,t){var r=e.pendingProps,s=J.current,i=!1,o;return(o=(e.flags&64)!==0)||(o=n!==null&&n.memoizedState===null?!1:(s&2)!==0),o?(i=!0,e.flags&=-65):n!==null&&n.memoizedState===null||r.fallback===void 0||r.unstable_avoidThisFallback===!0||(s|=1),X(J,s&1),n===null?(r.fallback!==void 0&&gl(e),n=r.children,s=r.fallback,i?(n=Od(e,n,s,t),e.child.memoizedState={baseLanes:t},e.memoizedState=Ti,n):typeof r.unstable_expectedLoadTime=="number"?(n=Od(e,n,s,t),e.child.memoizedState={baseLanes:t},e.memoizedState=Ti,e.lanes=33554432,n):(t=$u({mode:"visible",children:n},e.mode,t,null),t.return=e,e.child=t)):n.memoizedState!==null?i?(r=Fd(n,e,r.children,r.fallback,t),i=e.child,s=n.child.memoizedState,i.memoizedState=s===null?{baseLanes:t}:{baseLanes:s.baseLanes|t},i.childLanes=n.childLanes&~t,e.memoizedState=Ti,r):(t=Ud(n,e,r.children,t),e.memoizedState=null,t):i?(r=Fd(n,e,r.children,r.fallback,t),i=e.child,s=n.child.memoizedState,i.memoizedState=s===null?{baseLanes:t}:{baseLanes:s.baseLanes|t},i.childLanes=n.childLanes&~t,e.memoizedState=Ti,r):(t=Ud(n,e,r.children,t),e.memoizedState=null,t)}function Od(n,e,t,r){var s=n.mode,i=n.child;return e={mode:"hidden",children:e},(s&2)===0&&i!==null?(i.childLanes=0,i.pendingProps=e):i=$u(e,s,0,null),t=Er(t,s,r,null),i.return=n,t.return=n,i.sibling=t,n.child=i,t}function Ud(n,e,t,r){var s=n.child;return n=s.sibling,t=fn(s,{mode:"visible",children:t}),(e.mode&2)===0&&(t.lanes=r),t.return=e,t.sibling=null,n!==null&&(n.nextEffect=null,n.flags=8,e.firstEffect=e.lastEffect=n),e.child=t}function Fd(n,e,t,r,s){var i=e.mode,o=n.child;n=o.sibling;var a={mode:"hidden",children:t};return(i&2)===0&&e.child!==o?(t=e.child,t.childLanes=0,t.pendingProps=a,o=t.lastEffect,o!==null?(e.firstEffect=t.firstEffect,e.lastEffect=o,o.nextEffect=null):e.firstEffect=e.lastEffect=null):t=fn(o,a),n!==null?r=fn(n,r):(r=Er(r,i,s,null),r.flags|=2),r.return=e,t.return=e,t.sibling=r,e.child=t,r}function Kd(n,e){n.lanes|=e;var t=n.alternate;t!==null&&(t.lanes|=e),cf(n.return,e)}function Ma(n,e,t,r,s,i){var o=n.memoizedState;o===null?n.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:r,tail:t,tailMode:s,lastEffect:i}:(o.isBackwards=e,o.rendering=null,o.renderingStartTime=0,o.last=r,o.tail=t,o.tailMode=s,o.lastEffect=i)}function Bd(n,e,t){var r=e.pendingProps,s=r.revealOrder,i=r.tail;if(Ne(n,e,r.children,t),r=J.current,(r&2)!==0)r=r&1|2,e.flags|=64;else{if(n!==null&&(n.flags&64)!==0)e:for(n=e.child;n!==null;){if(n.tag===13)n.memoizedState!==null&&Kd(n,t);else if(n.tag===19)Kd(n,t);else if(n.child!==null){n.child.return=n,n=n.child;continue}if(n===e)break e;for(;n.sibling===null;){if(n.return===null||n.return===e)break e;n=n.return}n.sibling.return=n.return,n=n.sibling}r&=1}if(X(J,r),(e.mode&2)===0)e.memoizedState=null;else switch(s){case"forwards":for(t=e.child,s=null;t!==null;)n=t.alternate,n!==null&&bo(n)===null&&(s=t),t=t.sibling;t=s,t===null?(s=e.child,e.child=null):(s=t.sibling,t.sibling=null),Ma(e,!1,s,t,i,e.lastEffect);break;case"backwards":for(t=null,s=e.child,e.child=null;s!==null;){if(n=s.alternate,n!==null&&bo(n)===null){e.child=s;break}n=s.sibling,s.sibling=t,t=s,s=n}Ma(e,!0,t,null,i,e.lastEffect);break;case"together":Ma(e,!1,null,null,void 0,e.lastEffect);break;default:e.memoizedState=null}return e.child}function At(n,e,t){if(n!==null&&(e.dependencies=n.dependencies),ai|=e.lanes,(t&e.childLanes)!==0){if(n!==null&&e.child!==n.child)throw Error(k(153));if(e.child!==null){for(n=e.child,t=fn(n,n.pendingProps),e.child=t,t.return=e;n.sibling!==null;)n=n.sibling,t=t.sibling=fn(n,n.pendingProps),t.return=e;t.sibling=null}return e.child}return null}var Cf,Sl,Rf,Af;Cf=function(n,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)n.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};Sl=function(){};Rf=function(n,e,t,r){var s=n.memoizedProps;if(s!==r){n=e.stateNode,Pn(dt.current);var i=null;switch(t){case"input":s=Ga(n,s),r=Ga(n,r),i=[];break;case"option":s=Ja(n,s),r=Ja(n,r),i=[];break;case"select":s=Q({},s,{value:void 0}),r=Q({},r,{value:void 0}),i=[];break;case"textarea":s=Xa(n,s),r=Xa(n,r),i=[];break;default:typeof s.onClick!="function"&&typeof r.onClick=="function"&&(n.onclick=fo)}tl(t,r);var o;t=null;for(u in s)if(!r.hasOwnProperty(u)&&s.hasOwnProperty(u)&&s[u]!=null)if(u==="style"){var a=s[u];for(o in a)a.hasOwnProperty(o)&&(t||(t={}),t[o]="")}else u!=="dangerouslySetInnerHTML"&&u!=="children"&&u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&u!=="autoFocus"&&(Us.hasOwnProperty(u)?i||(i=[]):(i=i||[]).push(u,null));for(u in r){var l=r[u];if(a=s!=null?s[u]:void 0,r.hasOwnProperty(u)&&l!==a&&(l!=null||a!=null))if(u==="style")if(a){for(o in a)!a.hasOwnProperty(o)||l&&l.hasOwnProperty(o)||(t||(t={}),t[o]="");for(o in l)l.hasOwnProperty(o)&&a[o]!==l[o]&&(t||(t={}),t[o]=l[o])}else t||(i||(i=[]),i.push(u,t)),t=l;else u==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,a=a?a.__html:void 0,l!=null&&a!==l&&(i=i||[]).push(u,l)):u==="children"?typeof l!="string"&&typeof l!="number"||(i=i||[]).push(u,""+l):u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&(Us.hasOwnProperty(u)?(l!=null&&u==="onScroll"&&z("scroll",n),i||a===l||(i=[])):typeof l=="object"&&l!==null&&l.$$typeof===lu?l.toString():(i=i||[]).push(u,l))}t&&(i=i||[]).push("style",t);var u=i;(e.updateQueue=u)&&(e.flags|=4)}};Af=function(n,e,t,r){t!==r&&(e.flags|=4)};function os(n,e){if(!ht)switch(n.tailMode){case"hidden":e=n.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?n.tail=null:t.sibling=null;break;case"collapsed":t=n.tail;for(var r=null;t!==null;)t.alternate!==null&&(r=t),t=t.sibling;r===null?e||n.tail===null?n.tail=null:n.tail.sibling=null:r.sibling=null}}function Jg(n,e,t){var r=e.pendingProps;switch(e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return Le(e.type)&&_o(),null;case 3:return Ar(),H(De),H(be),xu(),r=e.stateNode,r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(n===null||n.child===null)&&(Ai(e)?e.flags|=4:r.hydrate||(e.flags|=256)),Sl(e),null;case 5:Tu(e);var s=Pn(Ys.current);if(t=e.type,n!==null&&e.stateNode!=null)Rf(n,e,t,r,s),n.ref!==e.ref&&(e.flags|=128);else{if(!r){if(e.stateNode===null)throw Error(k(166));return null}if(n=Pn(dt.current),Ai(e)){r=e.stateNode,t=e.type;var i=e.memoizedProps;switch(r[Yt]=e,r[mo]=i,t){case"dialog":z("cancel",r),z("close",r);break;case"iframe":case"object":case"embed":z("load",r);break;case"video":case"audio":for(n=0;n<fs.length;n++)z(fs[n],r);break;case"source":z("error",r);break;case"img":case"image":case"link":z("error",r),z("load",r);break;case"details":z("toggle",r);break;case"input":Bc(r,i),z("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!i.multiple},z("invalid",r);break;case"textarea":$c(r,i),z("invalid",r)}tl(t,i),n=null;for(var o in i)i.hasOwnProperty(o)&&(s=i[o],o==="children"?typeof s=="string"?r.textContent!==s&&(n=["children",s]):typeof s=="number"&&r.textContent!==""+s&&(n=["children",""+s]):Us.hasOwnProperty(o)&&s!=null&&o==="onScroll"&&z("scroll",r));switch(t){case"input":bi(r),Vc(r,i,!0);break;case"textarea":bi(r),jc(r);break;case"select":case"option":break;default:typeof i.onClick=="function"&&(r.onclick=fo)}r=n,e.updateQueue=r,r!==null&&(e.flags|=4)}else{switch(o=s.nodeType===9?s:s.ownerDocument,n===Za.html&&(n=wp(t)),n===Za.html?t==="script"?(n=o.createElement("div"),n.innerHTML="<script><\/script>",n=n.removeChild(n.firstChild)):typeof r.is=="string"?n=o.createElement(t,{is:r.is}):(n=o.createElement(t),t==="select"&&(o=n,r.multiple?o.multiple=!0:r.size&&(o.size=r.size))):n=o.createElementNS(n,t),n[Yt]=e,n[mo]=r,Cf(n,e,!1,!1),e.stateNode=n,o=nl(t,r),t){case"dialog":z("cancel",n),z("close",n),s=r;break;case"iframe":case"object":case"embed":z("load",n),s=r;break;case"video":case"audio":for(s=0;s<fs.length;s++)z(fs[s],n);s=r;break;case"source":z("error",n),s=r;break;case"img":case"image":case"link":z("error",n),z("load",n),s=r;break;case"details":z("toggle",n),s=r;break;case"input":Bc(n,r),s=Ga(n,r),z("invalid",n);break;case"option":s=Ja(n,r);break;case"select":n._wrapperState={wasMultiple:!!r.multiple},s=Q({},r,{value:void 0}),z("invalid",n);break;case"textarea":$c(n,r),s=Xa(n,r),z("invalid",n);break;default:s=r}tl(t,s);var a=s;for(i in a)if(a.hasOwnProperty(i)){var l=a[i];i==="style"?Ep(n,l):i==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,l!=null&&Sp(n,l)):i==="children"?typeof l=="string"?(t!=="textarea"||l!=="")&&Fs(n,l):typeof l=="number"&&Fs(n,""+l):i!=="suppressContentEditableWarning"&&i!=="suppressHydrationWarning"&&i!=="autoFocus"&&(Us.hasOwnProperty(i)?l!=null&&i==="onScroll"&&z("scroll",n):l!=null&&nu(n,i,l,o))}switch(t){case"input":bi(n),Vc(n,r,!1);break;case"textarea":bi(n),jc(n);break;case"option":r.value!=null&&n.setAttribute("value",""+cn(r.value));break;case"select":n.multiple=!!r.multiple,i=r.value,i!=null?mr(n,!!r.multiple,i,!1):r.defaultValue!=null&&mr(n,!!r.multiple,r.defaultValue,!0);break;default:typeof s.onClick=="function"&&(n.onclick=fo)}ef(t,r)&&(e.flags|=4)}e.ref!==null&&(e.flags|=128)}return null;case 6:if(n&&e.stateNode!=null)Af(n,e,n.memoizedProps,r);else{if(typeof r!="string"&&e.stateNode===null)throw Error(k(166));t=Pn(Ys.current),Pn(dt.current),Ai(e)?(r=e.stateNode,t=e.memoizedProps,r[Yt]=e,r.nodeValue!==t&&(e.flags|=4)):(r=(t.nodeType===9?t:t.ownerDocument).createTextNode(r),r[Yt]=e,e.stateNode=r)}return null;case 13:return H(J),r=e.memoizedState,(e.flags&64)!==0?(e.lanes=t,e):(r=r!==null,t=!1,n===null?e.memoizedProps.fallback!==void 0&&Ai(e):t=n.memoizedState!==null,r&&!t&&(e.mode&2)!==0&&(n===null&&e.memoizedProps.unstable_avoidThisFallback!==!0||(J.current&1)!==0?he===0&&(he=3):((he===0||he===3)&&(he=4),ke===null||(ai&134217727)===0&&(Kr&134217727)===0||Sr(ke,Se))),(r||t)&&(e.flags|=4),null);case 4:return Ar(),Sl(e),n===null&&Jp(e.stateNode.containerInfo),null;case 10:return Ru(e),null;case 17:return Le(e.type)&&_o(),null;case 19:if(H(J),r=e.memoizedState,r===null)return null;if(i=(e.flags&64)!==0,o=r.rendering,o===null)if(i)os(r,!1);else{if(he!==0||n!==null&&(n.flags&64)!==0)for(n=e.child;n!==null;){if(o=bo(n),o!==null){for(e.flags|=64,os(r,!1),i=o.updateQueue,i!==null&&(e.updateQueue=i,e.flags|=4),r.lastEffect===null&&(e.firstEffect=null),e.lastEffect=r.lastEffect,r=t,t=e.child;t!==null;)i=t,n=r,i.flags&=2,i.nextEffect=null,i.firstEffect=null,i.lastEffect=null,o=i.alternate,o===null?(i.childLanes=0,i.lanes=n,i.child=null,i.memoizedProps=null,i.memoizedState=null,i.updateQueue=null,i.dependencies=null,i.stateNode=null):(i.childLanes=o.childLanes,i.lanes=o.lanes,i.child=o.child,i.memoizedProps=o.memoizedProps,i.memoizedState=o.memoizedState,i.updateQueue=o.updateQueue,i.type=o.type,n=o.dependencies,i.dependencies=n===null?null:{lanes:n.lanes,firstContext:n.firstContext}),t=t.sibling;return X(J,J.current&1|2),e.child}n=n.sibling}r.tail!==null&&ve()>Rl&&(e.flags|=64,i=!0,os(r,!1),e.lanes=33554432)}else{if(!i)if(n=bo(o),n!==null){if(e.flags|=64,i=!0,t=n.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),os(r,!0),r.tail===null&&r.tailMode==="hidden"&&!o.alternate&&!ht)return e=e.lastEffect=r.lastEffect,e!==null&&(e.nextEffect=null),null}else 2*ve()-r.renderingStartTime>Rl&&t!==1073741824&&(e.flags|=64,i=!0,os(r,!1),e.lanes=33554432);r.isBackwards?(o.sibling=e.child,e.child=o):(t=r.last,t!==null?t.sibling=o:e.child=o,r.last=o)}return r.tail!==null?(t=r.tail,r.rendering=t,r.tail=t.sibling,r.lastEffect=e.lastEffect,r.renderingStartTime=ve(),t.sibling=null,e=J.current,X(J,i?e&1|2:e&1),t):null;case 23:case 24:return Bu(),n!==null&&n.memoizedState!==null!=(e.memoizedState!==null)&&r.mode!=="unstable-defer-without-hiding"&&(e.flags|=4),null}throw Error(k(156,e.tag))}function Xg(n){switch(n.tag){case 1:Le(n.type)&&_o();var e=n.flags;return e&4096?(n.flags=e&-4097|64,n):null;case 3:if(Ar(),H(De),H(be),xu(),e=n.flags,(e&64)!==0)throw Error(k(285));return n.flags=e&-4097|64,n;case 5:return Tu(n),null;case 13:return H(J),e=n.flags,e&4096?(n.flags=e&-4097|64,n):null;case 19:return H(J),null;case 4:return Ar(),null;case 10:return Ru(n),null;case 23:case 24:return Bu(),null;default:return null}}function Ou(n,e){try{var t="",r=e;do t+=M_(r),r=r.return;while(r);var s=t}catch(i){s=`
Error generating stack: `+i.message+`
`+i.stack}return{value:n,source:e,stack:s}}function bl(n,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var Zg=typeof WeakMap=="function"?WeakMap:Map;function Tf(n,e,t){t=en(-1,t),t.tag=3,t.payload={element:null};var r=e.value;return t.callback=function(){To||(To=!0,Al=r),bl(n,e)},t}function xf(n,e,t){t=en(-1,t),t.tag=3;var r=n.type.getDerivedStateFromError;if(typeof r=="function"){var s=e.value;t.payload=function(){return bl(n,e),r(s)}}var i=n.stateNode;return i!==null&&typeof i.componentDidCatch=="function"&&(t.callback=function(){typeof r!="function"&&(ut===null?ut=new Set([this]):ut.add(this),bl(n,e));var o=e.stack;this.componentDidCatch(e.value,{componentStack:o!==null?o:""})}),t}var ey=typeof WeakSet=="function"?WeakSet:Set;function Vd(n){var e=n.ref;if(e!==null)if(typeof e=="function")try{e(null)}catch(t){sn(n,t)}else e.current=null}function ty(n,e){switch(e.tag){case 0:case 11:case 15:case 22:return;case 1:if(e.flags&256&&n!==null){var t=n.memoizedProps,r=n.memoizedState;n=e.stateNode,e=n.getSnapshotBeforeUpdate(e.elementType===e.type?t:Xe(e.type,t),r),n.__reactInternalSnapshotBeforeUpdate=e}return;case 3:e.flags&256&&Eu(e.stateNode.containerInfo);return;case 5:case 6:case 4:case 17:return}throw Error(k(163))}function ny(n,e,t){switch(t.tag){case 0:case 11:case 15:case 22:if(e=t.updateQueue,e=e!==null?e.lastEffect:null,e!==null){n=e=e.next;do{if((n.tag&3)===3){var r=n.create;n.destroy=r()}n=n.next}while(n!==e)}if(e=t.updateQueue,e=e!==null?e.lastEffect:null,e!==null){n=e=e.next;do{var s=n;r=s.next,s=s.tag,(s&4)!==0&&(s&1)!==0&&(Kf(t,n),cy(t,n)),n=r}while(n!==e)}return;case 1:n=t.stateNode,t.flags&4&&(e===null?n.componentDidMount():(r=t.elementType===t.type?e.memoizedProps:Xe(t.type,e.memoizedProps),n.componentDidUpdate(r,e.memoizedState,n.__reactInternalSnapshotBeforeUpdate))),e=t.updateQueue,e!==null&&bd(t,e,n);return;case 3:if(e=t.updateQueue,e!==null){if(n=null,t.child!==null)switch(t.child.tag){case 5:n=t.child.stateNode;break;case 1:n=t.child.stateNode}bd(t,e,n)}return;case 5:n=t.stateNode,e===null&&t.flags&4&&ef(t.type,t.memoizedProps)&&n.focus();return;case 6:return;case 4:return;case 12:return;case 13:t.memoizedState===null&&(t=t.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&Pp(t))));return;case 19:case 17:case 20:case 21:case 23:case 24:return}throw Error(k(163))}function $d(n,e){for(var t=n;;){if(t.tag===5){var r=t.stateNode;if(e)r=r.style,typeof r.setProperty=="function"?r.setProperty("display","none","important"):r.display="none";else{r=t.stateNode;var s=t.memoizedProps.style;s=s!=null&&s.hasOwnProperty("display")?s.display:null,r.style.display=bp("display",s)}}else if(t.tag===6)t.stateNode.nodeValue=e?"":t.memoizedProps;else if((t.tag!==23&&t.tag!==24||t.memoizedState===null||t===n)&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===n)break;for(;t.sibling===null;){if(t.return===null||t.return===n)return;t=t.return}t.sibling.return=t.return,t=t.sibling}}function jd(n,e){if(Un&&typeof Un.onCommitFiberUnmount=="function")try{Un.onCommitFiberUnmount(Iu,e)}catch{}switch(e.tag){case 0:case 11:case 14:case 15:case 22:if(n=e.updateQueue,n!==null&&(n=n.lastEffect,n!==null)){var t=n=n.next;do{var r=t,s=r.destroy;if(r=r.tag,s!==void 0)if((r&4)!==0)Kf(e,t);else{r=e;try{s()}catch(i){sn(r,i)}}t=t.next}while(t!==n)}break;case 1:if(Vd(e),n=e.stateNode,typeof n.componentWillUnmount=="function")try{n.props=e.memoizedProps,n.state=e.memoizedState,n.componentWillUnmount()}catch(i){sn(e,i)}break;case 5:Vd(e);break;case 4:Nf(n,e)}}function Wd(n){n.alternate=null,n.child=null,n.dependencies=null,n.firstEffect=null,n.lastEffect=null,n.memoizedProps=null,n.memoizedState=null,n.pendingProps=null,n.return=null,n.updateQueue=null}function zd(n){return n.tag===5||n.tag===3||n.tag===4}function Hd(n){e:{for(var e=n.return;e!==null;){if(zd(e))break e;e=e.return}throw Error(k(160))}var t=e;switch(e=t.stateNode,t.tag){case 5:var r=!1;break;case 3:e=e.containerInfo,r=!0;break;case 4:e=e.containerInfo,r=!0;break;default:throw Error(k(161))}t.flags&16&&(Fs(e,""),t.flags&=-17);e:t:for(t=n;;){for(;t.sibling===null;){if(t.return===null||zd(t.return)){t=null;break e}t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.flags&2||t.child===null||t.tag===4)continue t;t.child.return=t,t=t.child}if(!(t.flags&2)){t=t.stateNode;break e}}r?El(n,t,e):Il(n,t,e)}function El(n,e,t){var r=n.tag,s=r===5||r===6;if(s)n=s?n.stateNode:n.stateNode.instance,e?t.nodeType===8?t.parentNode.insertBefore(n,e):t.insertBefore(n,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(n,t)):(e=t,e.appendChild(n)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=fo));else if(r!==4&&(n=n.child,n!==null))for(El(n,e,t),n=n.sibling;n!==null;)El(n,e,t),n=n.sibling}function Il(n,e,t){var r=n.tag,s=r===5||r===6;if(s)n=s?n.stateNode:n.stateNode.instance,e?t.insertBefore(n,e):t.appendChild(n);else if(r!==4&&(n=n.child,n!==null))for(Il(n,e,t),n=n.sibling;n!==null;)Il(n,e,t),n=n.sibling}function Nf(n,e){for(var t=e,r=!1,s,i;;){if(!r){r=t.return;e:for(;;){if(r===null)throw Error(k(160));switch(s=r.stateNode,r.tag){case 5:i=!1;break e;case 3:s=s.containerInfo,i=!0;break e;case 4:s=s.containerInfo,i=!0;break e}r=r.return}r=!0}if(t.tag===5||t.tag===6){e:for(var o=n,a=t,l=a;;)if(jd(o,l),l.child!==null&&l.tag!==4)l.child.return=l,l=l.child;else{if(l===a)break e;for(;l.sibling===null;){if(l.return===null||l.return===a)break e;l=l.return}l.sibling.return=l.return,l=l.sibling}i?(o=s,a=t.stateNode,o.nodeType===8?o.parentNode.removeChild(a):o.removeChild(a)):s.removeChild(t.stateNode)}else if(t.tag===4){if(t.child!==null){s=t.stateNode.containerInfo,i=!0,t.child.return=t,t=t.child;continue}}else if(jd(n,t),t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return,t.tag===4&&(r=!1)}t.sibling.return=t.return,t=t.sibling}}function Pa(n,e){switch(e.tag){case 0:case 11:case 14:case 15:case 22:var t=e.updateQueue;if(t=t!==null?t.lastEffect:null,t!==null){var r=t=t.next;do(r.tag&3)===3&&(n=r.destroy,r.destroy=void 0,n!==void 0&&n()),r=r.next;while(r!==t)}return;case 1:return;case 5:if(t=e.stateNode,t!=null){r=e.memoizedProps;var s=n!==null?n.memoizedProps:r;n=e.type;var i=e.updateQueue;if(e.updateQueue=null,i!==null){for(t[mo]=r,n==="input"&&r.type==="radio"&&r.name!=null&&yp(t,r),nl(n,s),e=nl(n,r),s=0;s<i.length;s+=2){var o=i[s],a=i[s+1];o==="style"?Ep(t,a):o==="dangerouslySetInnerHTML"?Sp(t,a):o==="children"?Fs(t,a):nu(t,o,a,e)}switch(n){case"input":Ya(t,r);break;case"textarea":vp(t,r);break;case"select":n=t._wrapperState.wasMultiple,t._wrapperState.wasMultiple=!!r.multiple,i=r.value,i!=null?mr(t,!!r.multiple,i,!1):n!==!!r.multiple&&(r.defaultValue!=null?mr(t,!!r.multiple,r.defaultValue,!0):mr(t,!!r.multiple,r.multiple?[]:"",!1))}}}return;case 6:if(e.stateNode===null)throw Error(k(162));e.stateNode.nodeValue=e.memoizedProps;return;case 3:t=e.stateNode,t.hydrate&&(t.hydrate=!1,Pp(t.containerInfo));return;case 12:return;case 13:e.memoizedState!==null&&(Ku=ve(),$d(e.child,!0)),qd(e);return;case 19:qd(e);return;case 17:return;case 23:case 24:$d(e,e.memoizedState!==null);return}throw Error(k(163))}function qd(n){var e=n.updateQueue;if(e!==null){n.updateQueue=null;var t=n.stateNode;t===null&&(t=n.stateNode=new ey),e.forEach(function(r){var s=py.bind(null,n,r);t.has(r)||(t.add(r),r.then(s,s))})}}function ry(n,e){return n!==null&&(n=n.memoizedState,n===null||n.dehydrated!==null)?(e=e.memoizedState,e!==null&&e.dehydrated===null):!1}var sy=Math.ceil,Ao=qn.ReactCurrentDispatcher,Uu=qn.ReactCurrentOwner,L=0,ke=null,oe=null,Se=0,Wn=0,kl=_n(0),he=0,Zo=null,Fr=0,ai=0,Kr=0,Fu=0,Cl=null,Ku=0,Rl=1/0;function Br(){Rl=ve()+500}var C=null,To=!1,Al=null,ut=null,pn=!1,xs=null,ms=90,Tl=[],xl=[],Tt=null,Ns=0,Nl=null,Zi=-1,It=0,eo=0,Ms=null,to=!1;function Ue(){return(L&48)!==0?ve():Zi!==-1?Zi:Zi=ve()}function nn(n){if(n=n.mode,(n&2)===0)return 1;if((n&4)===0)return Rr()===99?1:2;if(It===0&&(It=Fr),zg.transition!==0){eo!==0&&(eo=Cl!==null?Cl.pendingLanes:0),n=It;var e=4186112&~eo;return e&=-e,e===0&&(n=4186112&~n,e=n&-n,e===0&&(e=8192)),e}return n=Rr(),(L&4)!==0&&n===98?n=ho(12,It):(n=G_(n),n=ho(n,It)),n}function rn(n,e,t){if(50<Ns)throw Ns=0,Nl=null,Error(k(185));if(n=ea(n,e),n===null)return null;Ho(n,e,t),n===ke&&(Kr|=e,he===4&&Sr(n,Se));var r=Rr();e===1?(L&8)!==0&&(L&48)===0?Ml(n):(qe(n,t),L===0&&(Br(),vt())):((L&4)===0||r!==98&&r!==99||(Tt===null?Tt=new Set([n]):Tt.add(n)),qe(n,t)),Cl=n}function ea(n,e){n.lanes|=e;var t=n.alternate;for(t!==null&&(t.lanes|=e),t=n,n=n.return;n!==null;)n.childLanes|=e,t=n.alternate,t!==null&&(t.childLanes|=e),t=n,n=n.return;return t.tag===3?t.stateNode:null}function qe(n,e){for(var t=n.callbackNode,r=n.suspendedLanes,s=n.pingedLanes,i=n.expirationTimes,o=n.pendingLanes;0<o;){var a=31-dn(o),l=1<<a,u=i[a];if(u===-1){if((l&r)===0||(l&s)!==0){u=e,or(l);var c=j;i[a]=10<=c?u+250:6<=c?u+5e3:-1}}else u<=e&&(n.expiredLanes|=l);o&=~l}if(r=$s(n,n===ke?Se:0),e=j,r===0)t!==null&&(t!==Aa&&pl(t),n.callbackNode=null,n.callbackPriority=0);else{if(t!==null){if(n.callbackPriority===e)return;t!==Aa&&pl(t)}e===15?(t=Ml.bind(null,n),Et===null?(Et=[t],Xi=ku(Jo,uf)):Et.push(t),t=Aa):e===14?t=Hs(99,Ml.bind(null,n)):(t=Y_(e),t=Hs(t,Mf.bind(null,n))),n.callbackPriority=e,n.callbackNode=t}}function Mf(n){if(Zi=-1,eo=It=0,(L&48)!==0)throw Error(k(327));var e=n.callbackNode;if(gn()&&n.callbackNode!==e)return null;var t=$s(n,n===ke?Se:0);if(t===0)return null;var r=t,s=L;L|=16;var i=Of();(ke!==n||Se!==r)&&(Br(),br(n,r));do try{ay();break}catch(a){Lf(n,a)}while(1);if(Cu(),Ao.current=i,L=s,oe!==null?r=0:(ke=null,Se=0,r=he),(Fr&Kr)!==0)br(n,0);else if(r!==0){if(r===2&&(L|=64,n.hydrate&&(n.hydrate=!1,Eu(n.containerInfo)),t=Bp(n),t!==0&&(r=_s(n,t))),r===1)throw e=Zo,br(n,0),Sr(n,t),qe(n,ve()),e;switch(n.finishedWork=n.current.alternate,n.finishedLanes=t,r){case 0:case 1:throw Error(k(345));case 2:Cn(n);break;case 3:if(Sr(n,t),(t&62914560)===t&&(r=Ku+500-ve(),10<r)){if($s(n,0)!==0)break;if(s=n.suspendedLanes,(s&t)!==t){Ue(),n.pingedLanes|=n.suspendedLanes&s;break}n.timeoutHandle=fd(Cn.bind(null,n),r);break}Cn(n);break;case 4:if(Sr(n,t),(t&4186112)===t)break;for(r=n.eventTimes,s=-1;0<t;){var o=31-dn(t);i=1<<o,o=r[o],o>s&&(s=o),t&=~i}if(t=s,t=ve()-t,t=(120>t?120:480>t?480:1080>t?1080:1920>t?1920:3e3>t?3e3:4320>t?4320:1960*sy(t/1960))-t,10<t){n.timeoutHandle=fd(Cn.bind(null,n),t);break}Cn(n);break;case 5:Cn(n);break;default:throw Error(k(329))}}return qe(n,ve()),n.callbackNode===e?Mf.bind(null,n):null}function Sr(n,e){for(e&=~Fu,e&=~Kr,n.suspendedLanes|=e,n.pingedLanes&=~e,n=n.expirationTimes;0<e;){var t=31-dn(e),r=1<<t;n[t]=-1,e&=~r}}function Ml(n){if((L&48)!==0)throw Error(k(327));if(gn(),n===ke&&(n.expiredLanes&Se)!==0){var e=Se,t=_s(n,e);(Fr&Kr)!==0&&(e=$s(n,e),t=_s(n,e))}else e=$s(n,0),t=_s(n,e);if(n.tag!==0&&t===2&&(L|=64,n.hydrate&&(n.hydrate=!1,Eu(n.containerInfo)),e=Bp(n),e!==0&&(t=_s(n,e))),t===1)throw t=Zo,br(n,0),Sr(n,e),qe(n,ve()),t;return n.finishedWork=n.current.alternate,n.finishedLanes=e,Cn(n),qe(n,ve()),null}function iy(){if(Tt!==null){var n=Tt;Tt=null,n.forEach(function(e){e.expiredLanes|=24&e.pendingLanes,qe(e,ve())})}vt()}function Pf(n,e){var t=L;L|=1;try{return n(e)}finally{L=t,L===0&&(Br(),vt())}}function Df(n,e){var t=L;L&=-2,L|=8;try{return n(e)}finally{L=t,L===0&&(Br(),vt())}}function xi(n,e){X(kl,Wn),Wn|=e,Fr|=e}function Bu(){Wn=kl.current,H(kl)}function br(n,e){n.finishedWork=null,n.finishedLanes=0;var t=n.timeoutHandle;if(t!==-1&&(n.timeoutHandle=-1,Kg(t)),oe!==null)for(t=oe.return;t!==null;){var r=t;switch(r.tag){case 1:r=r.type.childContextTypes,r!=null&&_o();break;case 3:Ar(),H(De),H(be),xu();break;case 5:Tu(r);break;case 4:Ar();break;case 13:H(J);break;case 19:H(J);break;case 10:Ru(r);break;case 23:case 24:Bu()}t=t.return}ke=n,oe=fn(n.current,null),Se=Wn=Fr=e,he=0,Zo=null,Fu=Kr=ai=0}function Lf(n,e){do{var t=oe;try{if(Cu(),As.current=Ro,Eo){for(var r=ee.memoizedState;r!==null;){var s=r.queue;s!==null&&(s.pending=null),r=r.next}Eo=!1}if(Qs=0,ce=ye=ee=null,Ts=!1,Uu.current=null,t===null||t.return===null){he=1,Zo=e,oe=null;break}e:{var i=n,o=t.return,a=t,l=e;if(e=Se,a.flags|=2048,a.firstEffect=a.lastEffect=null,l!==null&&typeof l=="object"&&typeof l.then=="function"){var u=l;if((a.mode&2)===0){var c=a.alternate;c?(a.updateQueue=c.updateQueue,a.memoizedState=c.memoizedState,a.lanes=c.lanes):(a.updateQueue=null,a.memoizedState=null)}var d=(J.current&1)!==0,h=o;do{var g;if(g=h.tag===13){var v=h.memoizedState;if(v!==null)g=v.dehydrated!==null;else{var S=h.memoizedProps;g=S.fallback===void 0?!1:S.unstable_avoidThisFallback!==!0?!0:!d}}if(g){var f=h.updateQueue;if(f===null){var p=new Set;p.add(u),h.updateQueue=p}else f.add(u);if((h.mode&2)===0){if(h.flags|=64,a.flags|=16384,a.flags&=-2981,a.tag===1)if(a.alternate===null)a.tag=17;else{var m=en(-1,1);m.tag=2,tn(a,m)}a.lanes|=1;break e}l=void 0,a=e;var w=i.pingCache;if(w===null?(w=i.pingCache=new Zg,l=new Set,w.set(u,l)):(l=w.get(u),l===void 0&&(l=new Set,w.set(u,l))),!l.has(a)){l.add(a);var y=hy.bind(null,i,u,a);u.then(y,y)}h.flags|=4096,h.lanes=e;break e}h=h.return}while(h!==null);l=Error((fr(a.type)||"A React component")+` suspended while rendering, but no fallback UI was specified.

Add a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display.`)}he!==5&&(he=2),l=Ou(l,a),h=o;do{switch(h.tag){case 3:i=l,h.flags|=4096,e&=-e,h.lanes|=e;var T=Tf(h,i,e);Sd(h,T);break e;case 1:i=l;var b=h.type,R=h.stateNode;if((h.flags&64)===0&&(typeof b.getDerivedStateFromError=="function"||R!==null&&typeof R.componentDidCatch=="function"&&(ut===null||!ut.has(R)))){h.flags|=4096,e&=-e,h.lanes|=e;var P=xf(h,i,e);Sd(h,P);break e}}h=h.return}while(h!==null)}Ff(t)}catch(N){e=N,oe===t&&t!==null&&(oe=t=t.return);continue}break}while(1)}function Of(){var n=Ao.current;return Ao.current=Ro,n===null?Ro:n}function _s(n,e){var t=L;L|=16;var r=Of();ke===n&&Se===e||br(n,e);do try{oy();break}catch(s){Lf(n,s)}while(1);if(Cu(),L=t,Ao.current=r,oe!==null)throw Error(k(261));return ke=null,Se=0,he}function oy(){for(;oe!==null;)Uf(oe)}function ay(){for(;oe!==null&&!$g();)Uf(oe)}function Uf(n){var e=Bf(n.alternate,n,Wn);n.memoizedProps=n.pendingProps,e===null?Ff(n):oe=e,Uu.current=null}function Ff(n){var e=n;do{var t=e.alternate;if(n=e.return,(e.flags&2048)===0){if(t=Jg(t,e,Wn),t!==null){oe=t;return}if(t=e,t.tag!==24&&t.tag!==23||t.memoizedState===null||(Wn&1073741824)!==0||(t.mode&4)===0){for(var r=0,s=t.child;s!==null;)r|=s.lanes|s.childLanes,s=s.sibling;t.childLanes=r}n!==null&&(n.flags&2048)===0&&(n.firstEffect===null&&(n.firstEffect=e.firstEffect),e.lastEffect!==null&&(n.lastEffect!==null&&(n.lastEffect.nextEffect=e.firstEffect),n.lastEffect=e.lastEffect),1<e.flags&&(n.lastEffect!==null?n.lastEffect.nextEffect=e:n.firstEffect=e,n.lastEffect=e))}else{if(t=Xg(e),t!==null){t.flags&=2047,oe=t;return}n!==null&&(n.firstEffect=n.lastEffect=null,n.flags|=2048)}if(e=e.sibling,e!==null){oe=e;return}oe=e=n}while(e!==null);he===0&&(he=5)}function Cn(n){var e=Rr();return jn(99,ly.bind(null,n,e)),null}function ly(n,e){do gn();while(xs!==null);if((L&48)!==0)throw Error(k(327));var t=n.finishedWork;if(t===null)return null;if(n.finishedWork=null,n.finishedLanes=0,t===n.current)throw Error(k(177));n.callbackNode=null;var r=t.lanes|t.childLanes,s=r,i=n.pendingLanes&~s;n.pendingLanes=s,n.suspendedLanes=0,n.pingedLanes=0,n.expiredLanes&=s,n.mutableReadLanes&=s,n.entangledLanes&=s,s=n.entanglements;for(var o=n.eventTimes,a=n.expirationTimes;0<i;){var l=31-dn(i),u=1<<l;s[l]=0,o[l]=-1,a[l]=-1,i&=~u}if(Tt!==null&&(r&24)===0&&Tt.has(n)&&Tt.delete(n),n===ke&&(oe=ke=null,Se=0),1<t.flags?t.lastEffect!==null?(t.lastEffect.nextEffect=t,r=t.firstEffect):r=t:r=t.firstEffect,r!==null){if(s=L,L|=32,Uu.current=null,ka=Gi,o=ad(),ll(o)){if("selectionStart"in o)a={start:o.selectionStart,end:o.selectionEnd};else e:if(a=(a=o.ownerDocument)&&a.defaultView||window,(u=a.getSelection&&a.getSelection())&&u.rangeCount!==0){a=u.anchorNode,i=u.anchorOffset,l=u.focusNode,u=u.focusOffset;try{a.nodeType,l.nodeType}catch{a=null;break e}var c=0,d=-1,h=-1,g=0,v=0,S=o,f=null;t:for(;;){for(var p;S!==a||i!==0&&S.nodeType!==3||(d=c+i),S!==l||u!==0&&S.nodeType!==3||(h=c+u),S.nodeType===3&&(c+=S.nodeValue.length),(p=S.firstChild)!==null;)f=S,S=p;for(;;){if(S===o)break t;if(f===a&&++g===i&&(d=c),f===l&&++v===u&&(h=c),(p=S.nextSibling)!==null)break;S=f,f=S.parentNode}S=p}a=d===-1||h===-1?null:{start:d,end:h}}else a=null;a=a||{start:0,end:0}}else a=null;Ca={focusedElem:o,selectionRange:a},Gi=!1,Ms=null,to=!1,C=r;do try{uy()}catch(N){if(C===null)throw Error(k(330));sn(C,N),C=C.nextEffect}while(C!==null);Ms=null,C=r;do try{for(o=n;C!==null;){var m=C.flags;if(m&16&&Fs(C.stateNode,""),m&128){var w=C.alternate;if(w!==null){var y=w.ref;y!==null&&(typeof y=="function"?y(null):y.current=null)}}switch(m&1038){case 2:Hd(C),C.flags&=-3;break;case 6:Hd(C),C.flags&=-3,Pa(C.alternate,C);break;case 1024:C.flags&=-1025;break;case 1028:C.flags&=-1025,Pa(C.alternate,C);break;case 4:Pa(C.alternate,C);break;case 8:a=C,Nf(o,a);var T=a.alternate;Wd(a),T!==null&&Wd(T)}C=C.nextEffect}}catch(N){if(C===null)throw Error(k(330));sn(C,N),C=C.nextEffect}while(C!==null);if(y=Ca,w=ad(),m=y.focusedElem,o=y.selectionRange,w!==m&&m&&m.ownerDocument&&Gp(m.ownerDocument.documentElement,m)){for(o!==null&&ll(m)&&(w=o.start,y=o.end,y===void 0&&(y=w),"selectionStart"in m?(m.selectionStart=w,m.selectionEnd=Math.min(y,m.value.length)):(y=(w=m.ownerDocument||document)&&w.defaultView||window,y.getSelection&&(y=y.getSelection(),a=m.textContent.length,T=Math.min(o.start,a),o=o.end===void 0?T:Math.min(o.end,a),!y.extend&&T>o&&(a=o,o=T,T=a),a=od(m,T),i=od(m,o),a&&i&&(y.rangeCount!==1||y.anchorNode!==a.node||y.anchorOffset!==a.offset||y.focusNode!==i.node||y.focusOffset!==i.offset)&&(w=w.createRange(),w.setStart(a.node,a.offset),y.removeAllRanges(),T>o?(y.addRange(w),y.extend(i.node,i.offset)):(w.setEnd(i.node,i.offset),y.addRange(w)))))),w=[],y=m;y=y.parentNode;)y.nodeType===1&&w.push({element:y,left:y.scrollLeft,top:y.scrollTop});for(typeof m.focus=="function"&&m.focus(),m=0;m<w.length;m++)y=w[m],y.element.scrollLeft=y.left,y.element.scrollTop=y.top}Gi=!!ka,Ca=ka=null,n.current=t,C=r;do try{for(m=n;C!==null;){var b=C.flags;if(b&36&&ny(m,C.alternate,C),b&128){w=void 0;var R=C.ref;if(R!==null){var P=C.stateNode;switch(C.tag){case 5:w=P;break;default:w=P}typeof R=="function"?R(w):R.current=w}}C=C.nextEffect}}catch(N){if(C===null)throw Error(k(330));sn(C,N),C=C.nextEffect}while(C!==null);C=null,Wg(),L=s}else n.current=t;if(pn)pn=!1,xs=n,ms=e;else for(C=r;C!==null;)e=C.nextEffect,C.nextEffect=null,C.flags&8&&(b=C,b.sibling=null,b.stateNode=null),C=e;if(r=n.pendingLanes,r===0&&(ut=null),r===1?n===Nl?Ns++:(Ns=0,Nl=n):Ns=0,t=t.stateNode,Un&&typeof Un.onCommitFiberRoot=="function")try{Un.onCommitFiberRoot(Iu,t,void 0,(t.current.flags&64)===64)}catch{}if(qe(n,ve()),To)throw To=!1,n=Al,Al=null,n;return(L&8)!==0||vt(),null}function uy(){for(;C!==null;){var n=C.alternate;to||Ms===null||((C.flags&8)!==0?Hc(C,Ms)&&(to=!0):C.tag===13&&ry(n,C)&&Hc(C,Ms)&&(to=!0));var e=C.flags;(e&256)!==0&&ty(n,C),(e&512)===0||pn||(pn=!0,Hs(97,function(){return gn(),null})),C=C.nextEffect}}function gn(){if(ms!==90){var n=97<ms?97:ms;return ms=90,jn(n,dy)}return!1}function cy(n,e){Tl.push(e,n),pn||(pn=!0,Hs(97,function(){return gn(),null}))}function Kf(n,e){xl.push(e,n),pn||(pn=!0,Hs(97,function(){return gn(),null}))}function dy(){if(xs===null)return!1;var n=xs;if(xs=null,(L&48)!==0)throw Error(k(331));var e=L;L|=32;var t=xl;xl=[];for(var r=0;r<t.length;r+=2){var s=t[r],i=t[r+1],o=s.destroy;if(s.destroy=void 0,typeof o=="function")try{o()}catch(l){if(i===null)throw Error(k(330));sn(i,l)}}for(t=Tl,Tl=[],r=0;r<t.length;r+=2){s=t[r],i=t[r+1];try{var a=s.create;s.destroy=a()}catch(l){if(i===null)throw Error(k(330));sn(i,l)}}for(a=n.current.firstEffect;a!==null;)n=a.nextEffect,a.nextEffect=null,a.flags&8&&(a.sibling=null,a.stateNode=null),a=n;return L=e,vt(),!0}function Gd(n,e,t){e=Ou(t,e),e=Tf(n,e,1),tn(n,e),e=Ue(),n=ea(n,1),n!==null&&(Ho(n,1,e),qe(n,e))}function sn(n,e){if(n.tag===3)Gd(n,n,e);else for(var t=n.return;t!==null;){if(t.tag===3){Gd(t,n,e);break}else if(t.tag===1){var r=t.stateNode;if(typeof t.type.getDerivedStateFromError=="function"||typeof r.componentDidCatch=="function"&&(ut===null||!ut.has(r))){n=Ou(e,n);var s=xf(t,n,1);if(tn(t,s),s=Ue(),t=ea(t,1),t!==null)Ho(t,1,s),qe(t,s);else if(typeof r.componentDidCatch=="function"&&(ut===null||!ut.has(r)))try{r.componentDidCatch(e,n)}catch{}break}}t=t.return}}function hy(n,e,t){var r=n.pingCache;r!==null&&r.delete(e),e=Ue(),n.pingedLanes|=n.suspendedLanes&t,ke===n&&(Se&t)===t&&(he===4||he===3&&(Se&62914560)===Se&&500>ve()-Ku?br(n,0):Fu|=t),qe(n,e)}function py(n,e){var t=n.stateNode;t!==null&&t.delete(e),e=0,e===0&&(e=n.mode,(e&2)===0?e=1:(e&4)===0?e=Rr()===99?1:2:(It===0&&(It=Fr),e=ar(62914560&~It),e===0&&(e=4194304))),t=Ue(),n=ea(n,e),n!==null&&(Ho(n,e,t),qe(n,t))}var Bf;Bf=function(n,e,t){var r=e.lanes;if(n!==null)if(n.memoizedProps!==e.pendingProps||De.current)et=!0;else if((t&r)!==0)et=(n.flags&16384)!==0;else{switch(et=!1,e.tag){case 3:Dd(e),xa();break;case 5:kd(e);break;case 1:Le(e.type)&&Ji(e);break;case 4:_l(e,e.stateNode.containerInfo);break;case 10:r=e.memoizedProps.value;var s=e.type._context;X(go,s._currentValue),s._currentValue=r;break;case 13:if(e.memoizedState!==null)return(t&e.child.childLanes)!==0?Ld(n,e,t):(X(J,J.current&1),e=At(n,e,t),e!==null?e.sibling:null);X(J,J.current&1);break;case 19:if(r=(t&e.childLanes)!==0,(n.flags&64)!==0){if(r)return Bd(n,e,t);e.flags|=64}if(s=e.memoizedState,s!==null&&(s.rendering=null,s.tail=null,s.lastEffect=null),X(J,J.current),r)break;return null;case 23:case 24:return e.lanes=0,Na(n,e,t)}return At(n,e,t)}else et=!1;switch(e.lanes=0,e.tag){case 2:if(r=e.type,n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),n=e.pendingProps,s=Cr(e,be.current),vr(e,t),s=Mu(null,e,r,n,s,t),e.flags|=1,typeof s=="object"&&s!==null&&typeof s.render=="function"&&s.$$typeof===void 0){if(e.tag=1,e.memoizedState=null,e.updateQueue=null,Le(r)){var i=!0;Ji(e)}else i=!1;e.memoizedState=s.state!==null&&s.state!==void 0?s.state:null,Au(e);var o=r.getDerivedStateFromProps;typeof o=="function"&&wo(e,r,o,n),s.updater=Xo,e.stateNode=s,s._reactInternals=e,ml(e,r,n,t),e=wl(null,e,r,!0,i,t)}else e.tag=0,Ne(null,e,s,t),e=e.child;return e;case 16:s=e.elementType;e:{switch(n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),n=e.pendingProps,i=s._init,s=i(s._payload),e.type=s,i=e.tag=my(s),n=Xe(s,n),i){case 0:e=vl(null,e,s,n,t);break e;case 1:e=Pd(null,e,s,n,t);break e;case 11:e=Nd(null,e,s,n,t);break e;case 14:e=Md(null,e,s,Xe(s.type,n),r,t);break e}throw Error(k(306,s,""))}return e;case 0:return r=e.type,s=e.pendingProps,s=e.elementType===r?s:Xe(r,s),vl(n,e,r,s,t);case 1:return r=e.type,s=e.pendingProps,s=e.elementType===r?s:Xe(r,s),Pd(n,e,r,s,t);case 3:if(Dd(e),r=e.updateQueue,n===null||r===null)throw Error(k(282));if(r=e.pendingProps,s=e.memoizedState,s=s!==null?s.element:null,df(n,e),qs(e,r,null,t),r=e.memoizedState.element,r===s)xa(),e=At(n,e,t);else{if(s=e.stateNode,(i=s.hydrate)&&(Qt=yr(e.stateNode.containerInfo.firstChild),Rt=e,i=ht=!0),i){if(n=s.mutableSourceEagerHydrationData,n!=null)for(s=0;s<n.length;s+=2)i=n[s],i._workInProgressVersionPrimary=n[s+1],wr.push(i);for(t=mf(e,null,r,t),e.child=t;t;)t.flags=t.flags&-3|1024,t=t.sibling}else Ne(n,e,r,t),xa();e=e.child}return e;case 5:return kd(e),n===null&&gl(e),r=e.type,s=e.pendingProps,i=n!==null?n.memoizedProps:null,o=s.children,dl(r,s)?o=null:i!==null&&dl(r,i)&&(e.flags|=16),kf(n,e),Ne(n,e,o,t),e.child;case 6:return n===null&&gl(e),null;case 13:return Ld(n,e,t);case 4:return _l(e,e.stateNode.containerInfo),r=e.pendingProps,n===null?e.child=So(e,null,r,t):Ne(n,e,r,t),e.child;case 11:return r=e.type,s=e.pendingProps,s=e.elementType===r?s:Xe(r,s),Nd(n,e,r,s,t);case 7:return Ne(n,e,e.pendingProps,t),e.child;case 8:return Ne(n,e,e.pendingProps.children,t),e.child;case 12:return Ne(n,e,e.pendingProps.children,t),e.child;case 10:e:{r=e.type._context,s=e.pendingProps,o=e.memoizedProps,i=s.value;var a=e.type._context;if(X(go,a._currentValue),a._currentValue=i,o!==null)if(a=o.value,i=Be(a,i)?0:(typeof r._calculateChangedBits=="function"?r._calculateChangedBits(a,i):1073741823)|0,i===0){if(o.children===s.children&&!De.current){e=At(n,e,t);break e}}else for(a=e.child,a!==null&&(a.return=e);a!==null;){var l=a.dependencies;if(l!==null){o=a.child;for(var u=l.firstContext;u!==null;){if(u.context===r&&(u.observedBits&i)!==0){a.tag===1&&(u=en(-1,t&-t),u.tag=2,tn(a,u)),a.lanes|=t,u=a.alternate,u!==null&&(u.lanes|=t),cf(a.return,t),l.lanes|=t;break}u=u.next}}else o=a.tag===10&&a.type===e.type?null:a.child;if(o!==null)o.return=a;else for(o=a;o!==null;){if(o===e){o=null;break}if(a=o.sibling,a!==null){a.return=o.return,o=a;break}o=o.return}a=o}Ne(n,e,s.children,t),e=e.child}return e;case 9:return s=e.type,i=e.pendingProps,r=i.children,vr(e,t),s=He(s,i.unstable_observedBits),r=r(s),e.flags|=1,Ne(n,e,r,t),e.child;case 14:return s=e.type,i=Xe(s,e.pendingProps),i=Xe(s.type,i),Md(n,e,s,i,r,t);case 15:return If(n,e,e.type,e.pendingProps,r,t);case 17:return r=e.type,s=e.pendingProps,s=e.elementType===r?s:Xe(r,s),n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),e.tag=1,Le(r)?(n=!0,Ji(e)):n=!1,vr(e,t),pf(e,r,s),ml(e,r,s,t),wl(null,e,r,!0,n,t);case 19:return Bd(n,e,t);case 23:return Na(n,e,t);case 24:return Na(n,e,t)}throw Error(k(156,e.tag))};function fy(n,e,t,r){this.tag=n,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.flags=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.childLanes=this.lanes=0,this.alternate=null}function Ve(n,e,t,r){return new fy(n,e,t,r)}function Vu(n){return n=n.prototype,!(!n||!n.isReactComponent)}function my(n){if(typeof n=="function")return Vu(n)?1:0;if(n!=null){if(n=n.$$typeof,n===jo)return 11;if(n===Wo)return 14}return 2}function fn(n,e){var t=n.alternate;return t===null?(t=Ve(n.tag,e,n.key,n.mode),t.elementType=n.elementType,t.type=n.type,t.stateNode=n.stateNode,t.alternate=n,n.alternate=t):(t.pendingProps=e,t.type=n.type,t.flags=0,t.nextEffect=null,t.firstEffect=null,t.lastEffect=null),t.childLanes=n.childLanes,t.lanes=n.lanes,t.child=n.child,t.memoizedProps=n.memoizedProps,t.memoizedState=n.memoizedState,t.updateQueue=n.updateQueue,e=n.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=n.sibling,t.index=n.index,t.ref=n.ref,t}function no(n,e,t,r,s,i){var o=2;if(r=n,typeof n=="function")Vu(n)&&(o=1);else if(typeof n=="string")o=5;else e:switch(n){case qt:return Er(t.children,s,i,e);case mp:o=8,s|=16;break;case ru:o=8,s|=1;break;case Ss:return n=Ve(12,t,e,s|8),n.elementType=Ss,n.type=Ss,n.lanes=i,n;case bs:return n=Ve(13,t,e,s),n.type=bs,n.elementType=bs,n.lanes=i,n;case ao:return n=Ve(19,t,e,s),n.elementType=ao,n.lanes=i,n;case uu:return $u(t,s,i,e);case qa:return n=Ve(24,t,e,s),n.elementType=qa,n.lanes=i,n;default:if(typeof n=="object"&&n!==null)switch(n.$$typeof){case su:o=10;break e;case iu:o=9;break e;case jo:o=11;break e;case Wo:o=14;break e;case ou:o=16,r=null;break e;case au:o=22;break e}throw Error(k(130,n==null?n:typeof n,""))}return e=Ve(o,t,e,s),e.elementType=n,e.type=r,e.lanes=i,e}function Er(n,e,t,r){return n=Ve(7,n,r,e),n.lanes=t,n}function $u(n,e,t,r){return n=Ve(23,n,r,e),n.elementType=uu,n.lanes=t,n}function Da(n,e,t){return n=Ve(6,n,null,e),n.lanes=t,n}function La(n,e,t){return e=Ve(4,n.children!==null?n.children:[],n.key,e),e.lanes=t,e.stateNode={containerInfo:n.containerInfo,pendingChildren:null,implementation:n.implementation},e}function _y(n,e,t){this.tag=e,this.containerInfo=n,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.pendingContext=this.context=null,this.hydrate=t,this.callbackNode=null,this.callbackPriority=0,this.eventTimes=ya(0),this.expirationTimes=ya(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=ya(0),this.mutableSourceEagerHydrationData=null}function gy(n,e,t){var r=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:xn,key:r==null?null:""+r,children:n,containerInfo:e,implementation:t}}function xo(n,e,t,r){var s=e.current,i=Ue(),o=nn(s);e:if(t){t=t._reactInternals;t:{if(Gn(t)!==t||t.tag!==1)throw Error(k(170));var a=t;do{switch(a.tag){case 3:a=a.stateNode.context;break t;case 1:if(Le(a.type)){a=a.stateNode.__reactInternalMemoizedMergedChildContext;break t}}a=a.return}while(a!==null);throw Error(k(171))}if(t.tag===1){var l=t.type;if(Le(l)){t=nf(t,l,a);break e}}t=a}else t=hn;return e.context===null?e.context=t:e.pendingContext=t,e=en(i,o),e.payload={element:n},r=r===void 0?null:r,r!==null&&(e.callback=r),tn(s,e),rn(s,o,i),o}function Oa(n){if(n=n.current,!n.child)return null;switch(n.child.tag){case 5:return n.child.stateNode;default:return n.child.stateNode}}function Yd(n,e){if(n=n.memoizedState,n!==null&&n.dehydrated!==null){var t=n.retryLane;n.retryLane=t!==0&&t<e?t:e}}function ju(n,e){Yd(n,e),(n=n.alternate)&&Yd(n,e)}function yy(){return null}function Wu(n,e,t){var r=t!=null&&t.hydrationOptions!=null&&t.hydrationOptions.mutableSources||null;if(t=new _y(n,e,t!=null&&t.hydrate===!0),e=Ve(3,null,null,e===2?7:e===1?3:0),t.current=e,e.stateNode=t,Au(e),n[Ur]=t.current,Jp(n.nodeType===8?n.parentNode:n),r)for(n=0;n<r.length;n++){e=r[n];var s=e._getVersion;s=s(e._source),t.mutableSourceEagerHydrationData==null?t.mutableSourceEagerHydrationData=[e,s]:t.mutableSourceEagerHydrationData.push(e,s)}this._internalRoot=t}Wu.prototype.render=function(n){xo(n,this._internalRoot,null,null)};Wu.prototype.unmount=function(){var n=this._internalRoot,e=n.containerInfo;xo(null,n,null,function(){e[Ur]=null})};function li(n){return!(!n||n.nodeType!==1&&n.nodeType!==9&&n.nodeType!==11&&(n.nodeType!==8||n.nodeValue!==" react-mount-point-unstable "))}function vy(n,e){if(e||(e=n?n.nodeType===9?n.documentElement:n.firstChild:null,e=!(!e||e.nodeType!==1||!e.hasAttribute("data-reactroot"))),!e)for(var t;t=n.lastChild;)n.removeChild(t);return new Wu(n,0,e?{hydrate:!0}:void 0)}function ta(n,e,t,r,s){var i=t._reactRootContainer;if(i){var o=i._internalRoot;if(typeof s=="function"){var a=s;s=function(){var u=Oa(o);a.call(u)}}xo(e,o,n,s)}else{if(i=t._reactRootContainer=vy(t,r),o=i._internalRoot,typeof s=="function"){var l=s;s=function(){var u=Oa(o);l.call(u)}}Df(function(){xo(e,o,n,s)})}return Oa(o)}xp=function(n){if(n.tag===13){var e=Ue();rn(n,4,e),ju(n,4)}};fu=function(n){if(n.tag===13){var e=Ue();rn(n,67108864,e),ju(n,67108864)}};Np=function(n){if(n.tag===13){var e=Ue(),t=nn(n);rn(n,t,e),ju(n,t)}};Mp=function(n,e){return e()};rl=function(n,e,t){switch(e){case"input":if(Ya(n,t),e=t.name,t.type==="radio"&&e!=null){for(t=n;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var r=t[e];if(r!==n&&r.form===n.form){var s=Qo(r);if(!s)throw Error(k(90));gp(r),Ya(r,s)}}}break;case"textarea":vp(n,t);break;case"select":e=t.value,e!=null&&mr(n,!!t.multiple,e,!1)}};du=Pf;Cp=function(n,e,t,r,s){var i=L;L|=4;try{return jn(98,n.bind(null,e,t,r,s))}finally{L=i,L===0&&(Br(),vt())}};hu=function(){(L&49)===0&&(iy(),gn())};Rp=function(n,e){var t=L;L|=2;try{return n(e)}finally{L=t,L===0&&(Br(),vt())}};function Vf(n,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!li(e))throw Error(k(200));return gy(n,e,null,t)}var wy={Events:[ii,dr,Qo,Ip,kp,gn,{current:!1}]},as={findFiberByHostInstance:Mn,bundleType:0,version:"17.0.2",rendererPackageName:"react-dom"},Sy={bundleType:as.bundleType,version:as.version,rendererPackageName:as.rendererPackageName,rendererConfig:as.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:qn.ReactCurrentDispatcher,findHostInstanceByFiber:function(n){return n=Tp(n),n===null?null:n.stateNode},findFiberByHostInstance:as.findFiberByHostInstance||yy,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__!="undefined"){var Ni=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Ni.isDisabled&&Ni.supportsFiber)try{Iu=Ni.inject(Sy),Un=Ni}catch{}}Ge.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=wy;Ge.createPortal=Vf;Ge.findDOMNode=function(n){if(n==null)return null;if(n.nodeType===1)return n;var e=n._reactInternals;if(e===void 0)throw typeof n.render=="function"?Error(k(188)):Error(k(268,Object.keys(n)));return n=Tp(e),n=n===null?null:n.stateNode,n};Ge.flushSync=function(n,e){var t=L;if((t&48)!==0)return n(e);L|=1;try{if(n)return jn(99,n.bind(null,e))}finally{L=t,vt()}};Ge.hydrate=function(n,e,t){if(!li(e))throw Error(k(200));return ta(null,n,e,!0,t)};Ge.render=function(n,e,t){if(!li(e))throw Error(k(200));return ta(null,n,e,!1,t)};Ge.unmountComponentAtNode=function(n){if(!li(n))throw Error(k(40));return n._reactRootContainer?(Df(function(){ta(null,null,n,!1,function(){n._reactRootContainer=null,n[Ur]=null})}),!0):!1};Ge.unstable_batchedUpdates=Pf;Ge.unstable_createPortal=function(n,e){return Vf(n,e,2<arguments.length&&arguments[2]!==void 0?arguments[2]:null)};Ge.unstable_renderSubtreeIntoContainer=function(n,e,t,r){if(!li(t))throw Error(k(200));if(n==null||n._reactInternals===void 0)throw Error(k(38));return ta(n,e,t,!1,r)};Ge.version="17.0.2";function $f(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__=="undefined"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE($f)}catch(n){console.error(n)}}$f(),dp.exports=Ge;var wk=dp.exports,Qd=/[\\\"\x00-\x1F]/g,Ot={};for(var Mi=0;Mi<32;++Mi)Ot[String.fromCharCode(Mi)]="\\U"+("0000"+Mi.toString(16)).slice(-4).toUpperCase();Ot["\b"]="\\b";Ot["	"]="\\t";Ot[`
`]="\\n";Ot["\f"]="\\f";Ot["\r"]="\\r";Ot['"']='\\"';Ot["\\"]="\\\\";function jf(n){return Qd.lastIndex=0,n.replace(Qd,function(e){return Ot[e]})}function zu(n){switch(typeof n){case"string":return'"'+jf(n)+'"';case"number":return isFinite(n)?n:"null";case"boolean":return n;case"object":return n===null?"null":Array.isArray(n)?by(n):Ey(n);default:throw new Error("Cannot stringify: "+typeof n)}}function by(n){for(var e="[",t="",r=0;r<n.length;++r)t+=e,e=",",t+=zu(n[r]);return e!=","?"[]":t+"]"}function Ey(n){var e="{",t="",r=Object.keys(n);r.sort();for(var s=0;s<r.length;++s){var i=r[s];t+=e+'"'+jf(i)+'":',e=",",t+=zu(n[i])}return e!=","?"{}":t+"}"}var Wf={stringify:zu},Fn={};(function(){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<n.length;t++)e[n.charCodeAt(t)]=t;Fn.encode=function(r){var s=new Uint8Array(r),i,o=s.length,a="";for(i=0;i<o;i+=3)a+=n[s[i]>>2],a+=n[(s[i]&3)<<4|s[i+1]>>4],a+=n[(s[i+1]&15)<<2|s[i+2]>>6],a+=n[s[i+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},Fn.decode=function(r){var s=r.length*.75,i=r.length,o,a=0,l,u,c,d;r[r.length-1]==="="&&(s--,r[r.length-2]==="="&&s--);var h=new ArrayBuffer(s),g=new Uint8Array(h);for(o=0;o<i;o+=4)l=e[r.charCodeAt(o)],u=e[r.charCodeAt(o+1)],c=e[r.charCodeAt(o+2)],d=e[r.charCodeAt(o+3)],g[a++]=l<<2|u>>4,g[a++]=(u&15)<<4|c>>2,g[a++]=(c&3)<<6|d&63;return h}})();/*! @license DOMPurify 2.3.6 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.6/LICENSE */function Iy(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}else return Array.from(n)}var ky=Object.hasOwnProperty,Jd=Object.setPrototypeOf,Cy=Object.isFrozen,Ry=Object.getPrototypeOf,Ay=Object.getOwnPropertyDescriptor,Ce=Object.freeze,mt=Object.seal,Ty=Object.create,zf=typeof Reflect!="undefined"&&Reflect,No=zf.apply,Pl=zf.construct;No||(No=function(e,t,r){return e.apply(t,r)});Ce||(Ce=function(e){return e});mt||(mt=function(e){return e});Pl||(Pl=function(e,t){return new(Function.prototype.bind.apply(e,[null].concat(Iy(t))))});var xy=rt(Array.prototype.forEach),Xd=rt(Array.prototype.pop),ls=rt(Array.prototype.push),ro=rt(String.prototype.toLowerCase),Zd=rt(String.prototype.match),$t=rt(String.prototype.replace),Ny=rt(String.prototype.indexOf),My=rt(String.prototype.trim),xe=rt(RegExp.prototype.test),Ua=Py(TypeError);function rt(n){return function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];return No(n,e,r)}}function Py(n){return function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return Pl(n,t)}}function F(n,e){Jd&&Jd(n,null);for(var t=e.length;t--;){var r=e[t];if(typeof r=="string"){var s=ro(r);s!==r&&(Cy(e)||(e[t]=s),r=s)}n[r]=!0}return n}function bn(n){var e=Ty(null),t=void 0;for(t in n)No(ky,n,[t])&&(e[t]=n[t]);return e}function Pi(n,e){for(;n!==null;){var t=Ay(n,e);if(t){if(t.get)return rt(t.get);if(typeof t.value=="function")return rt(t.value)}n=Ry(n)}function r(s){return console.warn("fallback value for",s),null}return r}var eh=Ce(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Fa=Ce(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ka=Ce(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Dy=Ce(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Ba=Ce(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),Ly=Ce(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),th=Ce(["#text"]),nh=Ce(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),Va=Ce(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),rh=Ce(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Di=Ce(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Oy=mt(/\{\{[\s\S]*|[\s\S]*\}\}/gm),Uy=mt(/<%[\s\S]*|[\s\S]*%>/gm),Fy=mt(/^data-[\-\w.\u00B7-\uFFFF]/),Ky=mt(/^aria-[\-\w]+$/),By=mt(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Vy=mt(/^(?:\w+script|data):/i),$y=mt(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),jy=mt(/^html$/i),gs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};function it(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}else return Array.from(n)}var Wy=function(){return typeof window=="undefined"?null:window},zy=function(e,t){if((typeof e=="undefined"?"undefined":gs(e))!=="object"||typeof e.createPolicy!="function")return null;var r=null,s="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(s)&&(r=t.currentScript.getAttribute(s));var i="dompurify"+(r?"#"+r:"");try{return e.createPolicy(i,{createHTML:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}};function Hf(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Wy(),e=function(_){return Hf(_)};if(e.version="2.3.6",e.removed=[],!n||!n.document||n.document.nodeType!==9)return e.isSupported=!1,e;var t=n.document,r=n.document,s=n.DocumentFragment,i=n.HTMLTemplateElement,o=n.Node,a=n.Element,l=n.NodeFilter,u=n.NamedNodeMap,c=u===void 0?n.NamedNodeMap||n.MozNamedAttrMap:u,d=n.HTMLFormElement,h=n.DOMParser,g=n.trustedTypes,v=a.prototype,S=Pi(v,"cloneNode"),f=Pi(v,"nextSibling"),p=Pi(v,"childNodes"),m=Pi(v,"parentNode");if(typeof i=="function"){var w=r.createElement("template");w.content&&w.content.ownerDocument&&(r=w.content.ownerDocument)}var y=zy(g,t),T=y?y.createHTML(""):"",b=r,R=b.implementation,P=b.createNodeIterator,N=b.createDocumentFragment,ne=b.getElementsByTagName,Wr=t.importNode,Ee={};try{Ee=bn(r).documentMode?r.documentMode:{}}catch{}var $={};e.isSupported=typeof m=="function"&&R&&typeof R.createHTMLDocument!="undefined"&&Ee!==9;var Kt=Oy,Ye=Uy,vn=Fy,zr=Ky,Hr=Vy,Jn=$y,qr=By,E=null,D=F({},[].concat(it(eh),it(Fa),it(Ka),it(Ba),it(th))),M=null,q=F({},[].concat(it(nh),it(Va),it(rh),it(Di))),U=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Oe=null,Qe=null,Bt=!0,st=!0,_c=!1,Xn=!1,wn=!1,sa=!1,ia=!1,Zn=!1,mi=!1,_i=!1,gc=!0,oa=!0,Gr=!1,er={},tr=null,yc=F({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),vc=null,wc=F({},["audio","video","img","source","image","track"]),aa=null,Sc=F({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),la="http://www.w3.org/1998/Math/MathML",ua="http://www.w3.org/2000/svg",Vt="http://www.w3.org/1999/xhtml",gi=Vt,ca=!1,nr=void 0,h_=["application/xhtml+xml","text/html"],p_="text/html",Sn=void 0,rr=null,f_=r.createElement("form"),bc=function(_){return _ instanceof RegExp||_ instanceof Function},da=function(_){rr&&rr===_||((!_||(typeof _=="undefined"?"undefined":gs(_))!=="object")&&(_={}),_=bn(_),E="ALLOWED_TAGS"in _?F({},_.ALLOWED_TAGS):D,M="ALLOWED_ATTR"in _?F({},_.ALLOWED_ATTR):q,aa="ADD_URI_SAFE_ATTR"in _?F(bn(Sc),_.ADD_URI_SAFE_ATTR):Sc,vc="ADD_DATA_URI_TAGS"in _?F(bn(wc),_.ADD_DATA_URI_TAGS):wc,tr="FORBID_CONTENTS"in _?F({},_.FORBID_CONTENTS):yc,Oe="FORBID_TAGS"in _?F({},_.FORBID_TAGS):{},Qe="FORBID_ATTR"in _?F({},_.FORBID_ATTR):{},er="USE_PROFILES"in _?_.USE_PROFILES:!1,Bt=_.ALLOW_ARIA_ATTR!==!1,st=_.ALLOW_DATA_ATTR!==!1,_c=_.ALLOW_UNKNOWN_PROTOCOLS||!1,Xn=_.SAFE_FOR_TEMPLATES||!1,wn=_.WHOLE_DOCUMENT||!1,Zn=_.RETURN_DOM||!1,mi=_.RETURN_DOM_FRAGMENT||!1,_i=_.RETURN_TRUSTED_TYPE||!1,ia=_.FORCE_BODY||!1,gc=_.SANITIZE_DOM!==!1,oa=_.KEEP_CONTENT!==!1,Gr=_.IN_PLACE||!1,qr=_.ALLOWED_URI_REGEXP||qr,gi=_.NAMESPACE||Vt,_.CUSTOM_ELEMENT_HANDLING&&bc(_.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(U.tagNameCheck=_.CUSTOM_ELEMENT_HANDLING.tagNameCheck),_.CUSTOM_ELEMENT_HANDLING&&bc(_.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(U.attributeNameCheck=_.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),_.CUSTOM_ELEMENT_HANDLING&&typeof _.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(U.allowCustomizedBuiltInElements=_.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),nr=h_.indexOf(_.PARSER_MEDIA_TYPE)===-1?nr=p_:nr=_.PARSER_MEDIA_TYPE,Sn=nr==="application/xhtml+xml"?function(I){return I}:ro,Xn&&(st=!1),mi&&(Zn=!0),er&&(E=F({},[].concat(it(th))),M=[],er.html===!0&&(F(E,eh),F(M,nh)),er.svg===!0&&(F(E,Fa),F(M,Va),F(M,Di)),er.svgFilters===!0&&(F(E,Ka),F(M,Va),F(M,Di)),er.mathMl===!0&&(F(E,Ba),F(M,rh),F(M,Di))),_.ADD_TAGS&&(E===D&&(E=bn(E)),F(E,_.ADD_TAGS)),_.ADD_ATTR&&(M===q&&(M=bn(M)),F(M,_.ADD_ATTR)),_.ADD_URI_SAFE_ATTR&&F(aa,_.ADD_URI_SAFE_ATTR),_.FORBID_CONTENTS&&(tr===yc&&(tr=bn(tr)),F(tr,_.FORBID_CONTENTS)),oa&&(E["#text"]=!0),wn&&F(E,["html","head","body"]),E.table&&(F(E,["tbody"]),delete Oe.tbody),Ce&&Ce(_),rr=_)},Ec=F({},["mi","mo","mn","ms","mtext"]),Ic=F({},["foreignobject","desc","title","annotation-xml"]),yi=F({},Fa);F(yi,Ka),F(yi,Dy);var ha=F({},Ba);F(ha,Ly);var m_=function(_){var I=m(_);(!I||!I.tagName)&&(I={namespaceURI:Vt,tagName:"template"});var A=ro(_.tagName),V=ro(I.tagName);if(_.namespaceURI===ua)return I.namespaceURI===Vt?A==="svg":I.namespaceURI===la?A==="svg"&&(V==="annotation-xml"||Ec[V]):Boolean(yi[A]);if(_.namespaceURI===la)return I.namespaceURI===Vt?A==="math":I.namespaceURI===ua?A==="math"&&Ic[V]:Boolean(ha[A]);if(_.namespaceURI===Vt){if(I.namespaceURI===ua&&!Ic[V]||I.namespaceURI===la&&!Ec[V])return!1;var fe=F({},["title","style","font","a","script"]);return!ha[A]&&(fe[A]||!yi[A])}return!1},wt=function(_){ls(e.removed,{element:_});try{_.parentNode.removeChild(_)}catch{try{_.outerHTML=T}catch{_.remove()}}},kc=function(_,I){try{ls(e.removed,{attribute:I.getAttributeNode(_),from:I})}catch{ls(e.removed,{attribute:null,from:I})}if(I.removeAttribute(_),_==="is"&&!M[_])if(Zn||mi)try{wt(I)}catch{}else try{I.setAttribute(_,"")}catch{}},Cc=function(_){var I=void 0,A=void 0;if(ia)_="<remove></remove>"+_;else{var V=Zd(_,/^[\r\n\t ]+/);A=V&&V[0]}nr==="application/xhtml+xml"&&(_='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+_+"</body></html>");var fe=y?y.createHTML(_):_;if(gi===Vt)try{I=new h().parseFromString(fe,nr)}catch{}if(!I||!I.documentElement){I=R.createDocument(gi,"template",null);try{I.documentElement.innerHTML=ca?"":fe}catch{}}var me=I.body||I.documentElement;return _&&A&&me.insertBefore(r.createTextNode(A),me.childNodes[0]||null),gi===Vt?ne.call(I,wn?"html":"body")[0]:wn?I.documentElement:me},Rc=function(_){return P.call(_.ownerDocument||_,_,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT,null,!1)},__=function(_){return _ instanceof d&&(typeof _.nodeName!="string"||typeof _.textContent!="string"||typeof _.removeChild!="function"||!(_.attributes instanceof c)||typeof _.removeAttribute!="function"||typeof _.setAttribute!="function"||typeof _.namespaceURI!="string"||typeof _.insertBefore!="function")},Yr=function(_){return(typeof o=="undefined"?"undefined":gs(o))==="object"?_ instanceof o:_&&(typeof _=="undefined"?"undefined":gs(_))==="object"&&typeof _.nodeType=="number"&&typeof _.nodeName=="string"},St=function(_,I,A){!$[_]||xy($[_],function(V){V.call(e,I,A,rr)})},Ac=function(_){var I=void 0;if(St("beforeSanitizeElements",_,null),__(_)||Zd(_.nodeName,/[\u0080-\uFFFF]/))return wt(_),!0;var A=Sn(_.nodeName);if(St("uponSanitizeElement",_,{tagName:A,allowedTags:E}),!Yr(_.firstElementChild)&&(!Yr(_.content)||!Yr(_.content.firstElementChild))&&xe(/<[/\w]/g,_.innerHTML)&&xe(/<[/\w]/g,_.textContent)||A==="select"&&xe(/<template/i,_.innerHTML))return wt(_),!0;if(!E[A]||Oe[A]){if(!Oe[A]&&xc(A)&&(U.tagNameCheck instanceof RegExp&&xe(U.tagNameCheck,A)||U.tagNameCheck instanceof Function&&U.tagNameCheck(A)))return!1;if(oa&&!tr[A]){var V=m(_)||_.parentNode,fe=p(_)||_.childNodes;if(fe&&V)for(var me=fe.length,ue=me-1;ue>=0;--ue)V.insertBefore(S(fe[ue],!0),f(_))}return wt(_),!0}return _ instanceof a&&!m_(_)||(A==="noscript"||A==="noembed")&&xe(/<\/no(script|embed)/i,_.innerHTML)?(wt(_),!0):(Xn&&_.nodeType===3&&(I=_.textContent,I=$t(I,Kt," "),I=$t(I,Ye," "),_.textContent!==I&&(ls(e.removed,{element:_.cloneNode()}),_.textContent=I)),St("afterSanitizeElements",_,null),!1)},Tc=function(_,I,A){if(gc&&(I==="id"||I==="name")&&(A in r||A in f_))return!1;if(!(st&&!Qe[I]&&xe(vn,I))){if(!(Bt&&xe(zr,I))){if(!M[I]||Qe[I]){if(!(xc(_)&&(U.tagNameCheck instanceof RegExp&&xe(U.tagNameCheck,_)||U.tagNameCheck instanceof Function&&U.tagNameCheck(_))&&(U.attributeNameCheck instanceof RegExp&&xe(U.attributeNameCheck,I)||U.attributeNameCheck instanceof Function&&U.attributeNameCheck(I))||I==="is"&&U.allowCustomizedBuiltInElements&&(U.tagNameCheck instanceof RegExp&&xe(U.tagNameCheck,A)||U.tagNameCheck instanceof Function&&U.tagNameCheck(A))))return!1}else if(!aa[I]){if(!xe(qr,$t(A,Jn,""))){if(!((I==="src"||I==="xlink:href"||I==="href")&&_!=="script"&&Ny(A,"data:")===0&&vc[_])){if(!(_c&&!xe(Hr,$t(A,Jn,"")))){if(A)return!1}}}}}}return!0},xc=function(_){return _.indexOf("-")>0},Nc=function(_){var I=void 0,A=void 0,V=void 0,fe=void 0;St("beforeSanitizeAttributes",_,null);var me=_.attributes;if(!!me){var ue={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:M};for(fe=me.length;fe--;){I=me[fe];var vi=I,Ae=vi.name,Mc=vi.namespaceURI;if(A=My(I.value),V=Sn(Ae),ue.attrName=V,ue.attrValue=A,ue.keepAttr=!0,ue.forceKeepAttr=void 0,St("uponSanitizeAttribute",_,ue),A=ue.attrValue,!ue.forceKeepAttr&&(kc(Ae,_),!!ue.keepAttr)){if(xe(/\/>/i,A)){kc(Ae,_);continue}Xn&&(A=$t(A,Kt," "),A=$t(A,Ye," "));var y_=Sn(_.nodeName);if(!!Tc(y_,V,A))try{Mc?_.setAttributeNS(Mc,Ae,A):_.setAttribute(Ae,A),Xd(e.removed)}catch{}}}St("afterSanitizeAttributes",_,null)}},g_=function x(_){var I=void 0,A=Rc(_);for(St("beforeSanitizeShadowDOM",_,null);I=A.nextNode();)St("uponSanitizeShadowNode",I,null),!Ac(I)&&(I.content instanceof s&&x(I.content),Nc(I));St("afterSanitizeShadowDOM",_,null)};return e.sanitize=function(x,_){var I=void 0,A=void 0,V=void 0,fe=void 0,me=void 0;if(ca=!x,ca&&(x="<!-->"),typeof x!="string"&&!Yr(x)){if(typeof x.toString!="function")throw Ua("toString is not a function");if(x=x.toString(),typeof x!="string")throw Ua("dirty is not a string, aborting")}if(!e.isSupported){if(gs(n.toStaticHTML)==="object"||typeof n.toStaticHTML=="function"){if(typeof x=="string")return n.toStaticHTML(x);if(Yr(x))return n.toStaticHTML(x.outerHTML)}return x}if(sa||da(_),e.removed=[],typeof x=="string"&&(Gr=!1),Gr){if(x.nodeName){var ue=Sn(x.nodeName);if(!E[ue]||Oe[ue])throw Ua("root node is forbidden and cannot be sanitized in-place")}}else if(x instanceof o)I=Cc("<!---->"),A=I.ownerDocument.importNode(x,!0),A.nodeType===1&&A.nodeName==="BODY"||A.nodeName==="HTML"?I=A:I.appendChild(A);else{if(!Zn&&!Xn&&!wn&&x.indexOf("<")===-1)return y&&_i?y.createHTML(x):x;if(I=Cc(x),!I)return Zn?null:_i?T:""}I&&ia&&wt(I.firstChild);for(var vi=Rc(Gr?x:I);V=vi.nextNode();)V.nodeType===3&&V===fe||Ac(V)||(V.content instanceof s&&g_(V.content),Nc(V),fe=V);if(fe=null,Gr)return x;if(Zn){if(mi)for(me=N.call(I.ownerDocument);I.firstChild;)me.appendChild(I.firstChild);else me=I;return M.shadowroot&&(me=Wr.call(t,me,!0)),me}var Ae=wn?I.outerHTML:I.innerHTML;return wn&&E["!doctype"]&&I.ownerDocument&&I.ownerDocument.doctype&&I.ownerDocument.doctype.name&&xe(jy,I.ownerDocument.doctype.name)&&(Ae="<!DOCTYPE "+I.ownerDocument.doctype.name+`>
`+Ae),Xn&&(Ae=$t(Ae,Kt," "),Ae=$t(Ae,Ye," ")),y&&_i?y.createHTML(Ae):Ae},e.setConfig=function(x){da(x),sa=!0},e.clearConfig=function(){rr=null,sa=!1},e.isValidAttribute=function(x,_,I){rr||da({});var A=Sn(x),V=Sn(_);return Tc(A,V,I)},e.addHook=function(x,_){typeof _=="function"&&($[x]=$[x]||[],ls($[x],_))},e.removeHook=function(x){$[x]&&Xd($[x])},e.removeHooks=function(x){$[x]&&($[x]=[])},e.removeAllHooks=function(){$={}},e}var Hy=Hf(),qy=Object.defineProperty,Gy=Object.defineProperties,Yy=Object.getOwnPropertyDescriptors,Mo=Object.getOwnPropertySymbols,qf=Object.prototype.hasOwnProperty,Gf=Object.prototype.propertyIsEnumerable,sh=(n,e,t)=>e in n?qy(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Dl=(n,e)=>{for(var t in e||(e={}))qf.call(e,t)&&sh(n,t,e[t]);if(Mo)for(var t of Mo(e))Gf.call(e,t)&&sh(n,t,e[t]);return n},Qy=(n,e)=>Gy(n,Yy(e)),Jy=(n,e)=>{var t={};for(var r in n)qf.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&Mo)for(var r of Mo(n))e.indexOf(r)<0&&Gf.call(n,r)&&(t[r]=n[r]);return t};class _t extends Error{get name(){return"AbortError"}}class Yf extends Error{constructor(e,t){super(`${e}: ${t.message}`);this.cause=t}get name(){return"WrappedError"}}class Qf extends Error{constructor(e,t,r,s){super(`${r?r.error:s} on ${e} ${t}`);this.errcode=r?r.errcode:null,this.retry_after_ms=r?r.retry_after_ms:0,this.statusCode=s}get name(){return"HomeServerError"}}class on extends Error{constructor(e,t){super(e||"ConnectionError");this.isTimeout=t}get name(){return"ConnectionError"}}class Hu{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class Vr extends Hu{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new Zy(Promise.resolve(this.get())):new Xy(this,e)}flatMap(e){return new ev(this,e)}}class Xy{constructor(e,t){this._promise=new Promise((r,s)=>{this._reject=s,this._subscription=e.subscribe(i=>{t(i)&&(this._reject=null,r(i),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new _t),this._reject=null)}}class Zy{constructor(e){this.promise=e}dispose(){}}class Pt extends Vr{constructor(e){super();this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class Ll extends Pt{constructor(e,t){super(e);this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}}class ev extends Vr{constructor(e,t){super();this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}function tv(n,e,t,r){const s=n(e);let i=!1;return s.elapsed().then(()=>{i=!0,t.abort()},()=>{}),r.then(o=>(s.abort(),o),o=>{throw s.abort(),o.name==="AbortError"&&i?new on(`Request timed out after ${e}ms`,!0):o})}function Jf(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}class nv{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function rv(n,{method:e,headers:t,timeout:r,format:s,uploadProgress:i}){const o=new XMLHttpRequest;if(i&&o.upload.addEventListener("progress",a=>i(a.loaded)),o.open(e,n),s==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,l]of t.entries())try{o.setRequestHeader(a,l)}catch(u){console.info(`Could not set ${a} header: ${u.message}`)}return r&&(o.timeout=r),o}function sv(n,e,t){return new Promise((r,s)=>{n.addEventListener("load",()=>r(n)),n.addEventListener("abort",()=>s(new _t)),n.addEventListener("error",()=>s(new on(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>s(new on(`Timeout ${e} ${t}`,!0)))})}function Xf(n,e){let{cache:t,format:r,body:s,method:i}=e;t||(n=Jf(n));const o=rv(n,e),a=sv(o,i,n).then(l=>{const{status:u}=l;let c=null;return r==="buffer"?c=l.response:l.getResponseHeader("Content-Type")==="application/json"&&(c=JSON.parse(l.responseText)),{status:u,body:c}});return s!=null&&s.nativeBlob&&(s=s.nativeBlob),o.send(s||null),new nv(a,o)}class ih{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const r=new Promise((s,i)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",i(o)}}});this.promise=Promise.race([e,r])}}abort(){this._controller.abort()}response(){return this.promise}}function iv(n,e){return function(r,s){if(e!=null&&e.haltRequests)return new ih(new Promise(()=>{}),{});if(s!=null&&s.uploadProgress)return Xf(r,s);let{method:i,headers:o,body:a,timeout:l,format:u,cache:c=!1}=s;const d=typeof AbortController=="function"?new AbortController:null;a!=null&&a.nativeBlob&&(a=a.nativeBlob);let h={method:i,body:a};if(d&&(h=Object.assign(h,{signal:d.signal})),c||(r=Jf(r)),h=Object.assign(h,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const S=new Headers;for(const[f,p]of o.entries())S.append(f,p);h.headers=S}const g=fetch(r,h).then(async S=>{const{status:f}=S;let p;try{u==="json"?p=await S.json():u==="buffer"&&(p=await S.arrayBuffer())}catch(m){if(!(m.name==="SyntaxError"&&f>=400))throw m}return{status:f,body:p}},S=>{throw S.name==="AbortError"?new _t:S instanceof TypeError?new on(`${i} ${r}: ${S.message}`):S}),v=new ih(g,d);return l&&(v.promise=tv(n,l,v,v.promise)),v}}var G;(function(n){n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceIdentities="deviceIdentities",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData"})(G||(G={}));const Js=Object.values(G);class xt extends Error{constructor(e,t=null){super(e);t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const Z={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};function ov(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function av(n){var e,t,r,s,i;return"objectStore"in n?(r=(t=(e=n.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:r.name:(i=(s=n.transaction)==null?void 0:s.db)==null?void 0:i.name}class Zf extends xt{constructor(e,t,r=null){const s=t&&"source"in t?t.source:t,i=s?ov(s):"",o=s?av(s):"";let a=`${e} on ${o}.${i}`;r&&(a+=": ",typeof r.name=="string"&&(a+=`(name: ${r.name}) `),typeof r.code=="number"&&(a+=`(code: ${r.code}) `)),r&&(a+=r.message);super(a,r);this.storeName=i,this.databaseName=o}}class qu extends Zf{constructor(e){const t=e.target,r=t.source,s=t.error;super("IDBRequest failed",r,s);this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class bt extends Zf{constructor(e,t,r,s){super(`${e}(${s.map(i=>JSON.stringify(i)).join(", ")}) failed`,t,r)}}const oh={done:!0},gt={done:!1};function Po(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function Ol(n){return parseInt(n,16)}function Gu(n,e,t,r=window.indexedDB){const s=r.open(n,t);return s.onupgradeneeded=async i=>{const o=i.target,a=o.result,l=o.transaction,u=i.oldVersion;try{await e(a,l,u,t)}catch{try{l.abort()}catch{}}},we(s)}function we(n){return new Promise((e,t)=>{n.addEventListener("success",r=>{e(r.target.result)}),n.addEventListener("error",r=>{const s=new qu(r);t(s)})})}function Xs(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",r=>{t(new _t)})})}function te(n,e){return new Promise((t,r)=>{n.onerror=s=>{r(new qu(s))},n.onsuccess=s=>{const i=s.target.result;if(!i){t(!1);return}const o=e(i.value,i.key,i),a=o==null?void 0:o.done,l=o==null?void 0:o.jumpTo;a?t(!0):l?i.continue(l):i.continue()}}).catch(t=>{throw new xt("iterateCursor failed",t)})}async function lv(n,e){const t=[];return await te(n,r=>(t.push(r),{done:e(t)})),t}var tt;(function(n){n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off"})(tt||(tt={}));class Ul{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function Do(){}class uv{constructor(){this.item=new cv(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,r){return e?e.wrap(t,r):this.run(t,r)}runDetached(e,t){return new Promise(r=>r(t(this.item))).then(Do,Do),this.item}async export(){}get level(){return tt}}class cv{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){return this}runDetached(e,t){return new Promise(r=>r(t(this))).then(Do,Do),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return tt}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}}const dv=new uv;class ah{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return we(this._target.count(e))}get(e){return we(this._target.get(e))}getKey(e){return this._target.supports("getKey")?we(this._target.getKey(e)):we(this._target.get(e)).then(t=>{if(t){let r=this._target.keyPath;return typeof r=="string"&&(r=[r]),r.reduce((s,i)=>s[i],t)}})}reduce(e,t,r){return this._reduce(e,t,r,"next")}reduceReverse(e,t,r){return this._reduce(e,t,r,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const r=this._openCursor(e,t),s=[];return await te(r,i=>(s.push(i),gt)),s}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let r;return await te(t,(s,i)=>(r=i,oh)),r}async iterateValues(e,t){const r=this._target.openCursor(e,"next");await te(r,(s,i,o)=>({done:t(s,i,o)}))}async iterateKeys(e,t){const r=this._target.openKeyCursor(e,"next");await te(r,(s,i,o)=>({done:t(i,o)}))}async findExistingKeys(e,t,r){const s=(d,h)=>t?-this.idbFactory.cmp(d,h):this.idbFactory.cmp(d,h),i=e.slice().sort(s),o=i[0],a=i[i.length-1],l=t?"prev":"next",u=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),l);let c=0;await te(u,(d,h,g)=>{for(;c<i.length&&s(i[c],h)<0;)c+=1;let v=!1;if(i[c]===h){const S=g.primaryKey;v=r(h,S),c+=1}return v||c>=i.length?oh:{done:!1,jumpTo:i[c]}})}_reduce(e,t,r,s){let i=r;const o=this._openCursor(e,s);return te(o,a=>(i=t(i,a),gt))}_selectLimit(e,t,r){return this._selectUntil(e,s=>s.length===t,r)}async _selectUntil(e,t,r){const s=this._openCursor(e,r),i=[];return await te(s,o=>(i.push(o),{done:t(i,o)})),i}async _selectWhile(e,t,r){const s=this._openCursor(e,r),i=[];return await te(s,o=>{const a=t(o);return a&&i.push(o),{done:!a}}),i}async iterateWhile(e,t){const r=this._openCursor(e,"next");await te(r,s=>({done:!t(s)}))}async _find(e,t,r){const s=this._openCursor(e,r);let i;if(await te(s,a=>{const l=t(a);return l&&(i=a),{done:l}}))return i}}const jt=!1;function Wt(n,e,t){var r,s;const i=t==null?void 0:t.name,o=(s=(r=t==null?void 0:t.transaction)==null?void 0:r.db)==null?void 0:s.name;console.info(`${o}.${i}.${n}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class lh{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(jt&&Wt("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(jt&&Wt("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(r){throw new bt("openKeyCursor",this._qt,r,[e,t])}}openCursor(e,t){try{return jt&&Wt("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(r){throw new bt("openCursor",this._qt,r,[e,t])}}put(e,t){try{return jt&&Wt("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(r){throw new bt("put",this._qt,r,[e,t])}}add(e,t){try{return jt&&Wt("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(r){throw new bt("add",this._qt,r,[e,t])}}get(e){try{return jt&&Wt("get",[e],this._qt),this._qt.get(e)}catch(t){throw new bt("get",this._qt,t,[e])}}getKey(e){try{return jt&&Wt("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new bt("getKey",this._qt,t,[e])}}delete(e){try{return jt&&Wt("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new bt("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new bt("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new bt("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class em extends ah{constructor(e,t){super(new lh(e),t)}get _idbStore(){return this._target}index(e){return new ah(new lh(this._idbStore.index(e)),this._transaction)}put(e,t){const r=this._idbStore.put(e);this._prepareErrorLog(r,t,"put",void 0,e)}add(e,t){const r=this._idbStore.add(e);this._prepareErrorLog(r,t,"add",void 0,e)}async tryAdd(e,t){try{return await we(this._idbStore.add(e)),!0}catch(r){if(r instanceof qu)return t.log({l:"could not write",id:this._getKeys(e),e:r},t.level.Warn),r.preventTransactionAbort(),!1;throw r}}delete(e,t){const r=this._idbStore.delete(e);this._prepareErrorLog(r,t,"delete",e,void 0)}_prepareErrorLog(e,t,r,s,i){t&&t.ensureRefId(),we(e).catch(o=>{let a;i?a=this._getKeys(i):s&&(a=[s]),this._transaction.addWriteError(o,t,r,a)})}_getKeys(e){const t=[],{keyPath:r}=this._idbStore;try{t.push(this._readKeyPath(e,r))}catch{console.warn("could not read keyPath",r)}for(const s of this._idbStore.indexNames)try{const i=this._idbStore.index(s);t.push(this._readKeyPath(e,i.keyPath))}catch{console.warn("could not read index",s)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let r=e;for(const s of t)if(typeof r=="object")r=r[s];else break;return r}else return e[t]}}function Ut(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}const Ln=Ut("Sync","Timeline","Retry"),$e="e2ee:",Yu="m.olm.v1.curve25519-aes-sha2",yt="m.megolm.v1.aes-sha2";class ge extends Error{constructor(e,t,r=null){super(`Decryption error ${e}${r?": "+JSON.stringify(r):""}`);this.code=e,this.event=t,this.details=r}}const tm="ed25519";function nm(n,e,t,r,s,i=void 0){var o,a;const l=Object.assign({},s);delete l.unsigned,delete l.signatures;const u=Wf.stringify(l),c=(a=(o=s==null?void 0:s.signatures)==null?void 0:o[e])==null?void 0:a[`${tm}:${t}`];try{if(!c)throw new Error("no signature");return n.ed25519_verify(r,u,c),!0}catch(d){if(i){const h=i.log({l:"Invalid signature, ignoring.",ed25519Key:r,canonicalJson:u,signature:c});h.error=d,h.logLevel=i.level.Warn}return!1}}function hv(){return{type:"m.room.encryption",state_key:"",content:{algorithm:yt,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function pv(n){return JSON.stringify(rm(n))}function fv(n){return sm(JSON.parse(n))}function rm(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=rm(n[t]));return e}else return n}function sm(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=sm(n[t]));return e}else return n}class Qu{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const r=this._localStorageKeyPrefix+e,s=pv(t);this._localStorage.setItem(r,s)}catch(r){console.error("could not write to localStorage",r)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith($e)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const r=this._localStorageKeyPrefix,s=r+$e;for(let i=0;i<this._localStorage.length;i+=1){const o=this._localStorage.key(i);if(o.startsWith(s)){const a=fv(this._localStorage.getItem(o)),l=o.substr(r.length),u=await this._sessionStore.getKey(l)===l;e.set(l,!u),u||(this._sessionStore.put({key:l,value:a}),t=!0)}}return t}set(e,t){e.startsWith($e)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith($e)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith($e)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class uh{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class mv{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}class ie{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new ie(this.fragmentId+1,Z.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new ie(this.fragmentId,this.eventIndex-1)}nextKey(){return new ie(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new ie(Z.maxStorageKey,Z.maxStorageKey)}static get minKey(){return new ie(Z.minStorageKey,Z.minStorageKey)}static get defaultLiveKey(){return ie.defaultFragmentKey(Z.minStorageKey)}static defaultFragmentKey(e){return new ie(e,Z.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===(e==null?void 0:e.fragmentId)&&this.eventIndex===(e==null?void 0:e.eventIndex)}}function im(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function Ps(n,e,t){t.isForward?n.push(e):n.unshift(e)}function _v(n,e,t){return t.isForward?n.concat(e):e.concat(n)}function Ze(n,e,t){return`${n}|${Po(e)}|${Po(t)}`}function gv(n){const[e,t,r]=n.split("|");return{roomId:e,eventKey:new ie(Ol(t),Ol(r))}}function Li(n,e){return`${n}|${e}`}function ch(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class Oi{constructor(e,t,r,s,i=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=r,this._upper=s,this._lowerOpen=i,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(Ze(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(Ze(e,this._lower.fragmentId,this._lower.eventIndex),Ze(e,this._lower.fragmentId,Z.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(Ze(e,this._upper.fragmentId,Z.minStorageKey),Ze(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(Ze(e,this._lower.fragmentId,this._lower.eventIndex),Ze(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new xt("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class yv{constructor(e){this._timelineStore=e}onlyRange(e){return new Oi(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new Oi(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new Oi(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,r=!1,s=!1){return new Oi(this._timelineStore.IDBKeyRange,void 0,e,t,r,s)}async lastEvents(e,t,r){const s=ie.maxKey;return s.fragmentId=t,this.eventsBefore(e,s,r)}async firstEvents(e,t,r){const s=ie.minKey;return s.fragmentId=t,this.eventsAfter(e,s,r)}eventsAfter(e,t,r){const s=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(s,r)}async eventsBefore(e,t,r){const s=this.upperBoundRange(t,!0).asIDBKeyRange(e),i=await this._timelineStore.selectLimitReverse(s,r);return i.reverse(),i}async getEventKeysForIds(e,t){const r=this._timelineStore.index("byEventId"),s=t.map(o=>Li(e,o)),i=new Map;return await r.findExistingKeys(s,!1,(o,a)=>{const{eventId:l}=ch(o),{eventKey:u}=gv(a);return i.set(l,u),!1}),i}async findFirstOccurringEventId(e,t){const r=this._timelineStore.index("byEventId"),s=t.map(l=>Li(e,l)),i=new Array(s.length);let o;function a(){for(let l=0;l<i.length;++l){if(i[l]===void 0)return;if(i[l]===!0)return s[l]}}return await r.findExistingKeys(s,!1,(l,u)=>{const c=s.indexOf(l);return i[c]=u,o=a(),!!o}),o&&ch(o).eventId}tryInsert(e,t){return e.key=Ze(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=Li(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(Ze(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(Li(e,t))}removeAllForRoom(e){const t=Ze(e,Z.minStorageKey,Z.minStorageKey),r=Ze(e,Z.maxStorageKey,Z.maxStorageKey),s=this._timelineStore.IDBKeyRange.bound(t,r);this._timelineStore.delete(s)}}const Me="\0",de="\u{10FFFF}";function ot(n,e,t,r){return`${n}|${e}|${t}|${r}`}function dh(n){const[e,t,r,s]=n.split("|");return{roomId:e,targetEventId:t,relType:r,sourceEventId:s}}class vv{constructor(e){this._store=e}add(e,t,r,s){this._store.add({key:ot(e,t,r,s)})}remove(e,t,r,s){this._store.delete(ot(e,t,r,s))}removeAllForTarget(e,t){const r=this._store.IDBKeyRange.bound(ot(e,t,Me,Me),ot(e,t,de,de),!0,!0);this._store.delete(r)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ot(e,Me,Me,Me),ot(e,de,de,de),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,r){const s=this._store.IDBKeyRange.bound(ot(e,t,r,Me),ot(e,t,r,de),!0,!0);return(await this._store.selectAll(s)).map(o=>dh(o.key))}async getAllForTarget(e,t){const r=this._store.IDBKeyRange.bound(ot(e,t,Me,Me),ot(e,t,de,de),!0,!0);return(await this._store.selectAll(r)).map(i=>dh(i.key))}}function hh(n,e,t){return`${n}|${e}|${t}`}class wv{constructor(e){this._roomStateStore=e}get(e,t,r){const s=hh(e,t,r);return this._roomStateStore.get(s)}set(e,t){const r=hh(e,t.type,t.state_key),s={roomId:e,event:t,key:r};this._roomStateStore.put(s)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${de}`,!0,!0);this._roomStateStore.delete(t)}}function Ui(n,e){return`${n}|${e}`}function Sv(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class om{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(Ui(e,t))}set(e){e.key=Ui(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(Ui(e,""));return this._roomMembersStore.selectWhile(t,r=>r.roomId===e)}async getAllUserIds(e){const t=[],r=this._roomMembersStore.IDBKeyRange.lowerBound(Ui(e,""));return await this._roomMembersStore.iterateKeys(r,s=>{const i=Sv(s);return i.roomId===e?(t.push(i.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${de}`,!0,!0);this._roomMembersStore.delete(t)}}function Fi(n,e){return`${n}|${Po(e)}`}class bv{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(Fi(e,Z.minStorageKey),Fi(e,Z.maxStorageKey))}catch(t){throw new xt(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=Fi(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(Fi(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function En(n,e){return`${n}|${Po(e)}`}function Ev(n){const[e,t]=n.split("|"),r=Ol(t);return{roomId:e,queueIndex:r}}class Iv{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(En(e,Z.minStorageKey),En(e,Z.maxStorageKey),!1,!1),r=await this._eventStore.findMaxKey(t);if(r)return Ev(r).queueIndex}remove(e,t){const r=this._eventStore.IDBKeyRange.only(En(e,t));this._eventStore.delete(r)}async exists(e,t){const r=this._eventStore.IDBKeyRange.only(En(e,t));return!!await this._eventStore.getKey(r)}add(e){e.key=En(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=En(e,Z.minStorageKey),r=En(e,Z.maxStorageKey),s=this._eventStore.IDBKeyRange.bound(t,r);this._eventStore.delete(s)}}class kv{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function In(n,e){return`${n}|${e}`}function Cv(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class Rv{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(In(e,""));return this._store.selectWhile(t,r=>r.userId===e)}async getAllDeviceIds(e){const t=[],r=this._store.IDBKeyRange.lowerBound(In(e,""));return await this._store.iterateKeys(r,s=>{const i=Cv(s);return i.userId===e?(t.push(i.deviceId),!1):!0}),t}get(e,t){return this._store.get(In(e,t))}set(e){e.key=In(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(In(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(In(e,Me),In(e,de),!0,!0);this._store.delete(t)}}function us(n,e){return`${n}|${e}`}function Av(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class Tv{constructor(e){this._store=e}async getSessionIds(e){const t=[],r=this._store.IDBKeyRange.lowerBound(us(e,""));return await this._store.iterateKeys(r,s=>{const i=Av(s);return i.senderKey===e?(t.push(i.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(us(e,""));return this._store.selectWhile(t,r=>r.senderKey===e)}get(e,t){return this._store.get(us(e,t))}set(e){e.key=us(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(us(e,t))}}var Zs;(function(n){n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp"})(Zs||(Zs={}));var Tr;(function(n){n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound"})(Tr||(Tr={}));function ir(n,e,t){return`${n}|${e}|${t}`}class xv{constructor(e){this._store=e}async has(e,t,r){const s=ir(e,t,r),i=await this._store.getKey(s);return s===i}get(e,t,r){return this._store.get(ir(e,t,r))}set(e){const t=e;t.key=ir(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ir(e,Me,Me),ir(e,de,de));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,r){const s=await this._store.get(ir(e,t,r));s&&(s.backup=1,this._store.put(s))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(r,s,i)=>(r.backup=0,i.update(r),t+=1,!1)),t}}class Nv{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function Ki(n,e,t){return`${n}|${e}|${t}`}class Mv{constructor(e){this._store=e}get(e,t,r){return this._store.get(Ki(e,t,r))}set(e,t,r,s){s.key=Ki(e,t,r),this._store.put(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(Ki(e,Me,Me),Ki(e,de,de));this._store.delete(t)}}function ys(n,e){return`${n}|${e}`}class Pv{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const r=ys(t,e),s=[];return await this._store.index("byScopeAndType").iterateWhile(r,i=>i.scopeTypeKey!==r?!1:(s.push(i),!0)),s}add(e){e.scopeTypeKey=ys(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(ys(e,Me),ys(e,de));await this._store.index("byScopeAndType").iterateValues(t,(s,i,o)=>(o.delete(),!0))}}class Dv{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}class Lv{constructor(e,t,r,s){this.error=e,this.refItem=t,this.operationName=r,this.keys=s}}class ph{constructor(e,t,r){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=r,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new xt(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new em(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const r=this._idbStore(e);this._stores[e]=t(r)}return this._stores[e]}get session(){return this._store(G.session,e=>new Qu(e,this._storage.localStorage))}get roomSummary(){return this._store(G.roomSummary,e=>new uh(e))}get archivedRoomSummary(){return this._store(G.archivedRoomSummary,e=>new uh(e))}get invites(){return this._store(G.invites,e=>new mv(e))}get timelineFragments(){return this._store(G.timelineFragments,e=>new bv(e))}get timelineEvents(){return this._store(G.timelineEvents,e=>new yv(e))}get timelineRelations(){return this._store(G.timelineRelations,e=>new vv(e))}get roomState(){return this._store(G.roomState,e=>new wv(e))}get roomMembers(){return this._store(G.roomMembers,e=>new om(e))}get pendingEvents(){return this._store(G.pendingEvents,e=>new Iv(e))}get userIdentities(){return this._store(G.userIdentities,e=>new kv(e))}get deviceIdentities(){return this._store(G.deviceIdentities,e=>new Rv(e))}get olmSessions(){return this._store(G.olmSessions,e=>new Tv(e))}get inboundGroupSessions(){return this._store(G.inboundGroupSessions,e=>new xv(e))}get outboundGroupSessions(){return this._store(G.outboundGroupSessions,e=>new Nv(e))}get groupSessionDecryptions(){return this._store(G.groupSessionDecryptions,e=>new Mv(e))}get operations(){return this._store(G.operations,e=>new Pv(e))}get accountData(){return this._store(G.accountData,e=>new Dv(e))}async complete(e){try{await Xs(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof xt&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e==null||e.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,r,s){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new Lv(e,t,r,s))}_logWriteErrors(e){const t=s=>{e||s.set("allowedStoreNames",this._allowedStoreNames);for(const i of this._writeErrors)s.wrap({l:i.operationName,id:i.keys},o=>{i.refItem&&o.refDetached(i.refItem),o.catch(i.error)})},r=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(r,t):this.logger.run(r,t)}}const fh="782rh281re38-boguskey";class Ov{constructor(e,t,r,s,i,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=r,this._hasWebkitEarlyCloseTxnBug=s,this.storeNames=G,this.localStorage=i,this.logger=o}_validateStoreNames(e){const t=e.findIndex(r=>!Js.includes(r));if(t!==-1)throw new xt(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await we(t.objectStore(e[0]).get(fh)),new ph(t,e,this)}catch(t){throw new xt("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await we(t.objectStore(e[0]).get(fh)),new ph(t,e,this)}catch(t){throw new xt("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function Uv(n){const e=n.transaction(Js,"readonly"),t={};return await Promise.all(Js.map(async r=>{const s=t[r]=[],i=e.objectStore(r);await te(i.openCursor(),o=>(s.push(o),gt))})),t}async function Fv(n,e){const t=n.transaction(Js,"readwrite");for(const r of Js){const s=t.objectStore(r);for(const i of e[r])s.add(i)}await Xs(t)}function Fl(n){var e;return((e=n.unsigned)==null?void 0:e.prev_content)||n.prev_content}const pt="m.room.redaction";function Kl(n){var e;return!!((e=n==null?void 0:n.unsigned)!=null&&e.redacted_because)}var _e;(function(n){n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived"})(_e||(_e={}));var ft;(function(n){n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public"})(ft||(ft={}));const We="m.room.member";class Y{constructor(e){this._data=e}static fromUserId(e,t,r){return new Y({roomId:e,userId:t,membership:r})}static fromMemberEvent(e,t){const r=t==null?void 0:t.state_key;if(typeof r!="string")return;const s=t.content,i=Fl(t),o=s==null?void 0:s.membership,a=(s==null?void 0:s.displayname)||(i==null?void 0:i.displayname),l=(s==null?void 0:s.avatar_url)||(i==null?void 0:i.avatar_url);return this._validateAndCreateMember(e,r,o,a,l)}static fromReplacingMemberEvent(e,t){const r=t&&t.state_key;if(typeof r!="string")return;const s=Fl(t);return this._validateAndCreateMember(e,r,s==null?void 0:s.membership,s==null?void 0:s.displayname,s==null?void 0:s.avatar_url)}static _validateAndCreateMember(e,t,r,s,i){if(typeof r=="string")return new Y({roomId:e,userId:t,membership:r,avatarUrl:i,displayName:s})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,r=e._data;return t.roomId===r.roomId&&t.userId===r.userId&&t.membership===r.membership&&t.displayName===r.displayName&&t.avatarUrl===r.avatarUrl}}class am{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}const Bl=0,mh=1;function lm(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n={userId:e,roomIds:[t],deviceTrackingStatus:Bl},n}function Kv(n){var e;const t=n.device_id;return{userId:n.user_id,deviceId:t,ed25519Key:n.keys[`ed25519:${t}`],curve25519Key:n.keys[`curve25519:${t}`],algorithms:n.algorithms,displayName:(e=n.unsigned)==null?void 0:e.device_display_name}}class Bv{constructor({storage:e,getSyncToken:t,olmUtil:r,ownUserId:s,ownDeviceId:i}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=r,this._ownUserId=s,this._ownDeviceId=i}async writeDeviceChanges(e,t,r){const{userIdentities:s}=t;r.set("changed",e.length),await Promise.all(e.map(async i=>{const o=await s.get(i);o&&(r.log({l:"outdated",id:i}),o.deviceTrackingStatus=Bl,s.set(o))}))}writeMemberChanges(e,t,r){return Promise.all(Array.from(t.values()).map(async s=>this._applyMemberChange(s,r)))}async trackRoom(e,t){if(e.isTrackingMembers||!e.isEncrypted)return;const r=await e.loadMemberList(t);try{const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]);let i;try{i=e.writeIsTrackingMembers(!0,s);const o=Array.from(r.members.values());t.set("members",o.length),await this._writeJoinedMembers(o,s)}catch(o){throw s.abort(),o}await s.complete(),e.applyIsTrackingMembersChanges(i)}finally{r.release()}}async _writeJoinedMembers(e,t){await Promise.all(e.map(async r=>{r.membership==="join"&&await this._writeMember(r,t)}))}async _writeMember(e,t){const{userIdentities:r}=t,s=await r.get(e.userId),i=lm(s,e.userId,e.roomId);i&&r.set(i)}async _removeRoomFromUserIdentity(e,t,r){const{userIdentities:s,deviceIdentities:i}=r,o=await s.get(t);o&&(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(s.remove(t),i.removeAllForUser(t)):s.set(o))}async _applyMemberChange(e,t){if(e.hasJoined)await this._writeMember(e.member,t);else if(e.hasLeft){const{roomId:r}=e;if(e.userId===this._ownUserId){const s=await t.roomMembers.getAllUserIds(r);await Promise.all(s.map(i=>this._removeRoomFromUserIdentity(r,i,t)))}else await this._removeRoomFromUserIdentity(r,e.userId,t)}}async _queryKeys(e,t,r){const s=await t.queryKeys({timeout:1e4,device_keys:e.reduce((l,u)=>(l[u]=[],l),{}),token:this._getSyncToken()},{log:r}).response(),i=r.wrap("verify",l=>this._filterVerifiedDeviceKeys(s.device_keys,l)),o=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let a;try{a=(await Promise.all(i.map(async({userId:u,verifiedKeys:c})=>{const d=c.map(Kv);return await this._storeQueriedDevicesForUserId(u,d,o)}))).reduce((u,c)=>u.concat(c),[]),r.set("devices",a.length)}catch(l){throw o.abort(),l}return await o.complete(),a}async _storeQueriedDevicesForUserId(e,t,r){const s=await r.deviceIdentities.getAllDeviceIds(e);for(const l of s)t.every(u=>u.deviceId!==l)&&r.deviceIdentities.remove(e,l);const i=[],o=[];t=await Promise.all(t.map(async l=>{if(s.includes(l.deviceId)){const u=await r.deviceIdentities.get(l.userId,l.deviceId);u.ed25519Key!==l.ed25519Key&&i.push(u)}i.push(l),o.push(l)}));for(const l of o)r.deviceIdentities.set(l);const a=await r.userIdentities.get(e);return a.deviceTrackingStatus=mh,r.userIdentities.set(a),i}_filterVerifiedDeviceKeys(e,t){const r=new Set;return Object.entries(e).map(([i,o])=>{const l=Object.entries(o).filter(([u,c])=>{var d,h;const g=c.device_id;if(c.user_id!==i||g!==u)return!1;const S=(d=c.keys)==null?void 0:d[`ed25519:${u}`],f=(h=c.keys)==null?void 0:h[`curve25519:${u}`];if(typeof S!="string"||typeof f!="string")return!1;if(r.has(f))return t.log({l:"ignore device with duplicate curve25519 key",keys:c},t.level.Warn),!1;r.add(f);const p=this._hasValidSignature(c,t);return p||t.log({l:"ignore device with invalid signature",keys:c},t.level.Warn),p}).map(([,u])=>u);return{userId:i,verifiedKeys:l}})}_hasValidSignature(e,t){var r;const s=e.device_id,i=e.user_id,o=(r=e==null?void 0:e.keys)==null?void 0:r[`${tm}:${s}`];return nm(this._olmUtil,i,s,o,e,t)}async devicesForTrackedRoom(e,t,r){const s=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),i=await s.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,i,s,t,r)}async devicesForRoomMembers(e,t,r,s){const i=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,i,r,s)}async _devicesForUserIds(e,t,r,s,i){const a=(await Promise.all(t.map(S=>r.userIdentities.get(S)))).filter(S=>S&&S.roomIds.includes(e)),l=a.filter(S=>S.deviceTrackingStatus===mh),u=a.filter(S=>S.deviceTrackingStatus===Bl);i.set("uptodate",l.length),i.set("outdated",u.length);let c;u.length&&(c=await this._queryKeys(u.map(S=>S.userId),s,i));const d=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let g=(await Promise.all(l.map(S=>d.deviceIdentities.getAllForUserId(S.userId)))).reduce((S,f)=>S.concat(f),[]);return c&&c.length&&(g=g.concat(c)),g.filter(S=>!(S.userId===this._ownUserId&&S.deviceId===this._ownDeviceId))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}const um=[$v,jv,Wv,zv,Hv,qv,Gv,Yv,Qv,Jv,Xv,Zv,ew,tw,nw,rw];function Vv(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function $v(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function jv(n,e){const t=new om(n.createObjectStore("roomMembers",{keyPath:"key"})),r=e.objectStore("roomState");await te(r.openCursor(),s=>{if(s.event.type===We){r.delete(s.key);const i=Y.fromMemberEvent(s.roomId,s.event);i&&t.set(i.serialize())}return gt})}async function Wv(n,e,t){const r=e.objectStore("session");try{const i=await we(r.get(1));if(i){r.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:l}=i.value,u=new Qu(r,t);u.set("sync",{token:o,filterId:a}),u.set("serverVersions",l)}}catch(s){e.abort(),console.error("could not migrate session",s.stack)}}function zv(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function Hv(n,e){var t;const r=e.objectStore("roomSummary"),s=e.objectStore("roomState"),i=[];await te(r.openCursor(),o=>(i.push(o),gt));for(const o of i){const a=await we(s.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(t=a==null?void 0:a.event)==null?void 0:t.content,delete o.isEncrypted,r.put(o))}}function qv(n){n.createObjectStore("accountData",{keyPath:"type"})}function Gv(n){n.createObjectStore("invites",{keyPath:"roomId"})}function Yv(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function Qv(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await te(t.openCursor(),(r,s,i)=>{const{typeScopeKey:o}=r;delete r.typeScopeKey;const[a,l]=o.split("|");return r.scopeTypeKey=ys(l,a),i.update(r),gt}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function Jv(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}async function Xv(n,e,t,r){const s=e.objectStore("roomSummary"),i=[];await te(s.openCursor(),u=>(u.isTrackingMembers&&i.push(u.roomId),gt));const o=e.objectStore("outboundGroupSessions"),a=e.objectStore("userIdentities"),l=e.objectStore("roomMembers");for(const u of i){let c=!1;const d=[],h=IDBKeyRange.bound(u,`${u}|${de}`,!0,!0);await r.wrap({l:"room",id:u},async g=>{var v;await te(l.openCursor(h),S=>(S.membership==="join"&&d.push(S.userId),gt)),g.set("joinedUserIds",d.length);for(const S of d){const f=await we(a.get(S)),p=(v=f==null?void 0:f.roomIds)==null?void 0:v.length,m=lm(f,S,u);m&&(g.log({l:"fixing up",id:S,roomsBefore:p,roomsAfter:m.roomIds.length}),a.put(m),c=!0)}g.set("foundMissing",c),c&&o.delete(u)})}}async function Zv(n,e){const t=e.objectStore("session"),r=await we(t.get("ssssKey"));r&&t.put({key:`${$e}ssssKey`,value:r.value})}async function ew(n,e,t,r){const s=e.objectStore("session"),i=new Qu(new em(s,Vv(n)),t);i.writeE2EEIdentityToLocalStorage();const o=await i.tryRestoreE2EEIdentityFromLocalStorage(r);r.set("restored",o)}async function tw(n,e){for(const t of n.objectStoreNames){const r=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await te(r.openCursor(),(s,i,o)=>(i.startsWith($e)||o.delete(),gt));break}default:{r.clear();break}}}}async function nw(n,e,t,r){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function rw(n,e,t,r){const s=e.objectStore("inboundGroupSessions");let i=0,o=0;await te(s.openCursor(),(a,l,u)=>(a.session?(a.backup=Zs.NotBackedUp,a.source=Tr.DeviceMessage,u.update(a),i+=1):o+=1,gt)),r.set("countWithoutSession",o),r.set("countWithSession",i)}async function sw(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await Gu(e,i=>{i.createObjectStore("test",{keyPath:"key"})},1,n),r=t.transaction(["test"],"readonly");await we(r.objectStore("test").get("somekey")),await new Promise(i=>setTimeout(i,0));const s=t.transaction(["test"],"readwrite");await Promise.resolve(),s.objectStore("test").add({key:"somekey",value:"foo"}),await Xs(s),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const cm=n=>`hydrogen_session_${n}`,$a=function(n,e,t,r){const s=(i,o,a,l)=>aw(i,o,a,l,t,r);return Gu(cm(n),s,um.length,e)};async function iw(){var n,e;const t=this;if((e=(n=t==null?void 0:t.navigator)==null?void 0:n.storage)!=null&&e.persist)return await t.navigator.storage.persist();if(t!=null&&t.document.requestStorageAccess)try{return await t.document.requestStorageAccess(),!0}catch{return!1}else return!1}class ow{constructor(e,t=window.indexedDB,r=window.IDBKeyRange,s=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=r,this._localStorage=s}async create(e,t){var r;await((r=this._serviceWorkerHandler)==null?void 0:r.preventConcurrentSessionAccess(e)),iw().then(o=>{o||console.warn("no persisted storage, database can be evicted by browser")});const s=await sw(this._idbFactory),i=await $a(e,this._idbFactory,this._localStorage,t);return new Ov(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}delete(e){const t=cm(e),r=this._idbFactory.deleteDatabase(t);return we(r)}async export(e,t){const r=await $a(e,this._idbFactory,this._localStorage,t);return await Uv(r)}async import(e,t,r){const s=await $a(e,this._idbFactory,this._localStorage,r);return await Fv(s,t)}}async function aw(n,e,t,r,s,i){const o=t||0;return i.wrap({l:"storage migration",oldVersion:t,version:r},async a=>{for(let l=o;l<r;++l){const u=um[l];await a.wrap(`v${l+1}`,c=>u(n,e,s,c))}})}class lw{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const r=await this.getAll();if(r){const s=r.find(i=>i.id===e);s&&(s.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(r)))}}async get(e){const t=await this.getAll();if(t)return t.find(r=>r.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(r=>r.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class uw{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const r=window.localStorage.getItem(`${this._prefix}${e}`);return typeof r=="string"?parseInt(r,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const r=window.localStorage.getItem(`${this._prefix}${e}`);return typeof r=="string"?r==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class cw{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class dw{encodeUnpadded(e){const t=Fn.encode(e),r=t.indexOf("=");return r!==-1?t.substr(0,r):t}encode(e){return Fn.encode(e)}decode(e){return Fn.decode(e)}}function hw(n){if(n.__esModule)return n;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(t){var r=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:function(){return n[t]}})}),e}var dm={isBuffer:function(n){return n instanceof Uint8Array},from:function(n){return n},allocUnsafe:function(n){return dm.alloc(n)},alloc:function(n){return new Uint8Array(n)}},pw=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",Buffer:dm}),fw=hw(pw),Bi=fw.Buffer;function mw(n){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var r=0;r<n.length;r++){var s=n.charAt(r),i=s.charCodeAt(0);if(e[i]!==255)throw new TypeError(s+" is ambiguous");e[i]=r}var o=n.length,a=n.charAt(0),l=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function c(g){if((Array.isArray(g)||g instanceof Uint8Array)&&(g=Bi.from(g)),!Bi.isBuffer(g))throw new TypeError("Expected Buffer");if(g.length===0)return"";for(var v=0,S=0,f=0,p=g.length;f!==p&&g[f]===0;)f++,v++;for(var m=(p-f)*u+1>>>0,w=new Uint8Array(m);f!==p;){for(var y=g[f],T=0,b=m-1;(y!==0||T<S)&&b!==-1;b--,T++)y+=256*w[b]>>>0,w[b]=y%o>>>0,y=y/o>>>0;if(y!==0)throw new Error("Non-zero carry");S=T,f++}for(var R=m-S;R!==m&&w[R]===0;)R++;for(var P=a.repeat(v);R<m;++R)P+=n.charAt(w[R]);return P}function d(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return Bi.alloc(0);var v=0;if(g[v]!==" "){for(var S=0,f=0;g[v]===a;)S++,v++;for(var p=(g.length-v)*l+1>>>0,m=new Uint8Array(p);g[v];){var w=e[g.charCodeAt(v)];if(w===255)return;for(var y=0,T=p-1;(w!==0||y<f)&&T!==-1;T--,y++)w+=o*m[T]>>>0,m[T]=w%256>>>0,w=w/256>>>0;if(w!==0)throw new Error("Non-zero carry");f=y,v++}if(g[v]!==" "){for(var b=p-f;b!==p&&m[b]===0;)b++;var R=Bi.allocUnsafe(S+(p-b));R.fill(0,0,S);for(var P=S;b!==p;)R[P++]=m[b++];return R}}}function h(g){var v=d(g);if(v)return v;throw new Error("Non-base"+o+" character")}return{encode:c,decodeUnsafe:d,decode:h}}var _w=mw,gw=_w,yw="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",_h=gw(yw);class vw{encode(e){return _h.encode(e)}decode(e){return _h.decode(e)}}class ww{constructor(){this.utf8=new cw,this.base64=new dw,this.base58=new vw}}class Sw{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const r=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:r})}async createAccountAndOTKs(e,t){let r;window.msCrypto&&(r=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const s=await this._workerPool.send({type:"olm_create_account_otks",randomValues:r,otkAmount:t}).response();e.unpickle("",s)}async createOutboundOlmSession(e,t,r,s){const i=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:i,theirIdentityKey:r,theirOneTimeKey:s,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class Ds{constructor(e,t,r,s){this._logger=r,this.start=r._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=s}runDetached(e,t,r,s){return this._logger.runDetached(e,t,r,s)}wrapDetached(e,t,r,s){this.refDetached(this.runDetached(e,t,r,s))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,r,s){return this.child(e,r,s).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,r)=>{const s=r.durationOfType(e);return t+(s!=null?s:0)},0):0}log(e,t){const r=this.child(e,t);return r.end=r.start,r}set(e,t){if(typeof e=="object"){const r=e;Object.assign(this._values,r)}else this._values[e]=t;return this}serialize(e,t,r){if(this._filterCreator)try{e=this._filterCreator(new Ul(e),this)}catch(o){console.error("Error creating log filter",o)}let s=null;if(this._children&&(s=this._children.reduce((o,a)=>{const l=a.serialize(e,this.start,!1);return l&&(o===null&&(o=[]),o.push(l)),o},null)),e&&!e.filter(this,s))return;const i={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(i.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),r&&(i.f=!0),s&&(i.c=s),i}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(r=>(this.finish(),r),r=>{throw this.catch(r)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}get level(){return tt}catch(e){return this.error=e,this.logLevel=tt.Error,this.finish(),e}child(e,t,r){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||tt.Info);const s=new Ds(e,t,this._logger,r);return this._children||(this._children=[]),this._children.push(s),s}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class hm{constructor({platform:e,serializedTransformer:t=r=>r}){this._openItems=new Set,this._platform=e,this._serializedTransformer=t}log(e,t=tt.Info){const r=new Ds(e,t,this);r.end=r.start,this._persistItem(r,void 0,!1)}wrapOrRun(e,t,r,s,i){return e?e.wrap(t,r,s,i):this.run(t,r,s,i)}runDetached(e,t,r,s){r||(r=tt.Info);const i=new Ds(e,r,this);return this._run(i,t,r,!1,s),i}run(e,t,r,s){r===void 0&&(r=tt.Info);const i=new Ds(e,r,this);return this._run(i,t,r,!0,s)}_run(e,t,r,s,i){this._openItems.add(e);const o=()=>{let a=new Ul;if(i)try{a=i(a,e)}catch(l){console.error("Error while creating log filter",l)}else a=a.minLevel(r);try{this._persistItem(e,a,!1)}catch(l){console.error("Could not persist log item",l)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(l=>(o(),l),l=>{if(o(),s)throw l}),s)return a}else if(o(),s)return a}catch(a){if(o(),s)throw a}}_finishOpenItems(){for(const e of this._openItems){e.finish();try{this._persistItem(e,new Ul,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}get level(){return tt}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class bw extends hm{constructor(e){super(e);const{name:t,flushInterval:r=60*1e3,limit:s=3e3}=e;this._name=t,this._limit=s,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval(()=>this._tryFlush(),r)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),r=t.objectStore("logs"),s=this._queuedItems.length;for(const o of this._queuedItems)r.add(o);const i=await we(r.count());if(i>this._limit){let o=i-this._limit+Math.round(.1*this._limit);await te(r.openCursor(),(a,l,u)=>(u.delete(),o-=1,{done:o===0}))}await Xs(t),this._queuedItems.splice(0,s)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this._name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return Gu(this._name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}_persistItem(e,t,r){const s=e.serialize(t,void 0,r);if(s){const i=this._serializedTransformer(s);this._queuedItems.push({json:JSON.stringify(i)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async export(){const e=await this._openDB();try{const r=e.transaction(["logs"],"readonly").objectStore("logs"),i=(await lv(r.openCursor(),()=>!1)).concat(this._queuedItems);return new Ew(i,this,this._platform)}finally{try{e.close()}catch{}}}async _removeItems(e){const t=await this._openDB();try{const r=t.transaction(["logs"],"readwrite"),s=r.objectStore("logs");for(const i of e)if(typeof i.id=="number")s.delete(i.id);else{const o=this._queuedItems.indexOf(i);o===-1&&this._queuedItems.splice(o,1)}await Xs(r)}finally{try{t.close()}catch{}}}}class Ew{constructor(e,t,r){this._items=e,this._logger=t,this._platform=r}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){var e;const t={formatVersion:1,appVersion:(e=this._platform.updateService)==null?void 0:e.version,items:this._items.map(o=>JSON.parse(o.json))},r=JSON.stringify(t),s=this._platform.encoding.utf8.encode(r);return this._platform.createBlob(s,"application/json")}}class Iw extends hm{_persistItem(e){pm(e)}async export(){}}const kw=["l","id"];function Cw(n){return Object.entries(n).filter(([e])=>!kw.includes(e)).reduce((e,[t,r])=>(e=e||{},e[t]=r,e),null)}function pm(n){const e=`${Rw(n)} (${n.duration}ms)`,t=Cw(n.values),r=n.children||t;if(r?(n.error?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const s of n.children)pm(s);r&&console.groupEnd()}function Rw(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id!="undefined"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status!="undefined"?`${n.values.l} (${n.values.status})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref!="undefined"?`ref ${n.values.ref}`:n.values.l||n.values.type}function fm(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function xr(n,e){return Object.entries(n).reduce((t,[r,s])=>(typeof s=="function"&&(s=s(e)),s?t+(t.length?" ":"")+r:t),"")}function Ir(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function Aw(n,e,t){return mm(Ju,n,e,t)}function mm(n,e,t,r){t&&fm(t)&&(r=t,t=void 0);const s=document.createElementNS(n,e);if(t)for(let[i,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&i==="className"?xr(o,void 0):!1),Ir(s,i,o);if(r){Array.isArray(r)||(r=[r]);for(let i of r)typeof i=="string"&&(i=Nt(i)),s.appendChild(i)}return s}function Nt(n){return document.createTextNode(n)}const Ju="http://www.w3.org/1999/xhtml",Tw="http://www.w3.org/2000/svg",_m={[Ju]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","label","form","progress","output","video"],[Tw]:["svg","circle"]},K={};for(const[n,e]of Object.entries(_m))for(const t of e)K[t]=function(r,s){return mm(n,t,r,s)};function ei(n,e){let t;try{t=n.mount(e)}catch(r){t=xw(r)}return t}function xw(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),K.div([K.h2("Something went wrong\u2026"),K.h3(n.message),K.p(`This occurred while running ${t}.`),K.pre(n.stack)])}function gh(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const s=n.children[e];n.insertBefore(t,s)}}function Nw(n){n.innerHTML=""}class ui{constructor({list:e,onItemClick:t,className:r,tagName:s="ul",parentProvidesUpdates:i=!0},o){this._onItemClick=t,this._list=e,this._className=r,this._tagName=s,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:i}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=Aw(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const r=Array.prototype.indexOf.call(this._root.childNodes,t),s=this._childInstances[r];s&&this._onItemClick(s,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const r=this._childCreator(t);this._childInstances.push(r),e.appendChild(ei(r,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,r){this.moveChild(e,t)}onUpdate(e,t,r){this.updateChild(e,t,r)}addChild(e,t){const r=this._childCreator(t);this._childInstances.splice(e,0,r),gh(this._root,e,ei(r,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[r]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,r),r.root().remove(),gh(this._root,t,r.root())}updateChild(e,t,r){if(this._childInstances){const s=this._childInstances[e];s&&s.update(t,r)}}recreateItem(e,t){if(this._childInstances){const r=this._childCreator(t);if(!r)this.onRemove(e,t);else{const[s]=this._childInstances.splice(e,1,r);this._root.replaceChild(r.mount(this._mountArgs),s.root()),s.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class gm{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function Mw(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class O extends gm{constructor(){super(...arguments);this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:r,useCapture:s}of this._eventListeners)e.addEventListener(t,r,s)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:r,useCapture:s}of this._eventListeners)e.removeEventListener(t,r,s)}mount(e){const t=new ym(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const r of this._bindings)r()}_addEventListener(e,t,r,s=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:r,useCapture:s})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const r of this._subViews)r.update(e,t)}}class ym{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,r,s=!1){this._templateView._addEventListener(e,t,r,s)}_addAttributeBinding(e,t,r){let s;const i=()=>{const o=r(this._value);s!==o&&(s=o,Ir(e,t,o))};this._addBinding(i),i()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",r=>xr(t,r))}_addTextBinding(e){const t=e(this._value),r=Nt(t);let s=t;const i=()=>{const o=e(this._value);s!==o&&(s=o,r.textContent=o+"")};return this._addBinding(i),r}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[r,s]of Object.entries(t))if(typeof s=="object"){if(r!=="className"||s===null)continue;Mw(s)?this._addClassNamesBinding(e,s):Ir(e,r,xr(s,this._value))}else if(this._isEventHandler(r,s)){const i=r.substr(2,1).toLowerCase()+r.substr(3),o=s;this._templateView._addEventListener(e,i,o)}else typeof s=="function"?this._addAttributeBinding(e,r,s):Ir(e,r,s)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let r of t)typeof r=="function"?r=this._addTextBinding(r):typeof r=="string"&&(r=Nt(r)),e.appendChild(r)}_addReplaceNodeBinding(e,t){let r=e(this._value),s=t(null);const i=()=>{const o=e(this._value);if(r!==o){r=o;const a=t(s);s.parentNode&&s.parentNode.replaceChild(a,s),s=a}};return this._addBinding(i),s}el(e,t,r){return this.elNS(Ju,e,t,r)}elNS(e,t,r,s){r!==void 0&&fm(r)&&(s=r,r=void 0);const i=document.createElementNS(e,t);return r&&this._setNodeAttributes(i,r),s&&this._setNodeChildren(i,s),i}view(e,t){return this._templateView.addSubView(e),ei(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,r=>{if(r&&r.nodeType!==Node.COMMENT_NODE){const i=this._templateView._subViews;if(i){const o=i.findIndex(a=>a.root()===r);if(o!==-1){const[a]=i.splice(o,1);a.unmount()}}}const s=t(e(this._value));return s?this.view(s):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,r=>new Lo(this._value,(s,i)=>{const o=t(r,s,i);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(r=>!!e(r),r=>r?t(this._value):null)}if(e,t){return this.ifView(e,r=>new Lo(r,t))}mapSideEffect(e,t){let r=e(this._value);const s=()=>{const i=e(this._value);r!==i&&(t(i,r),r=i)};this._addBinding(s),t(r,void 0)}}for(const[n,e]of Object.entries(_m))for(const t of e)ym.prototype[t]=function(r,s){return this.elNS(n,t,r,s)};class Lo extends O{constructor(e,t){super(e);this._render=t}render(e,t){return this._render(e,t)}}function On(n,e,t=void 0){const r=!!n.avatarUrl(e);let s=xr({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!r});t&&(s+=` ${t}`);const i=r?vm(n,e):Nt(n.avatarLetter),o=K.div({className:s},[i]);return r&&(Ir(o,"data-avatar-letter",n.avatarLetter),Ir(o,"data-avatar-color",n.avatarColorNumber)),o}function vm(n,e){const t=e.toString();return K.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function Pw(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function yh(n){if(!Pw(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const r=e.getAttribute("data-avatar-letter");e.textContent=r}class Qn extends gm{constructor(e,t){super(e);this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=On(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const r=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(vm(e,this._size),this._root.firstChild),this._root.classList.remove(r)):(this._root.textContent=e.avatarLetter,this._root.classList.add(r))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const r=this._root.firstChild;r.tagName==="IMG"&&r.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let Vi;function Ft(n,e=void 0){Vi===void 0&&(Vi=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return Vi!=null&&Vi.classList.contains("legacy")?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class Dw extends O{render(e,t){const r={active:s=>s.isOpen,hidden:s=>s.hidden};return e.li({className:r},[e.a({href:t.url},[e.view(new Qn(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:s=>s.isUnread}},s=>s.name),e.map(s=>s.busy,s=>s?Ft(e):e.div({className:{badge:!0,highlighted:i=>i.isHighlighted,hidden:i=>!i.badgeCount}},i=>i.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class Lw extends O{render(e,t){const r=()=>{s.value="",s.blur(),i.blur(),t.clear()},s=e.input({type:"text",placeholder:t==null?void 0:t.label,"aria-label":t==null?void 0:t.label,autocomplete:t==null?void 0:t.autocomplete,enterkeyhint:"search",name:t==null?void 0:t.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&r()},onFocus:()=>s.select()}),i=e.button({onClick:r,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[s,i])}}class Ow extends O{render(e,t){const r=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,s=e.view(new ui({className:"RoomList",list:t.tileViewModels},o=>new Dw(o))),i=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new Lw({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(s.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:r,"aria-label":r}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.a({className:"button-utility create",href:t.createRoomUrl,"aria-label":t.i18n`Create room`,title:t.i18n`Create room`})]);return e.div({className:"LeftPanel"},[i,s])}}class Xu{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=K.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=Uw(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,r=this._popup.clientHeight,s=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>s.bottom||e.left>s.right||e.bottom<s.top||e.right<s.left)return!1;if(s.bottom>=e.bottom+r)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(s.top<=e.top-r)this._popup.style.top=`${e.top-r-this._verticalPadding}px`;else return!1;if(s.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(s.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function Uw(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const r=window.getComputedStyle(e).getPropertyValue("overflow-y");if(r==="auto"||r==="scroll")return e}while(e!==document.body)}class Pe extends O{static option(e,t){return new Fw(e,t)}constructor(e){super();this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class Fw{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class Kw extends ui{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:r=>r.onClick()};super(t,r=>new Bw(r))}}class Bw extends O{render(e,t){return e.button({className:{active:r=>r.isActive,pending:r=>r.isPending}},[t.key," ",r=>`${r.count}`])}onClick(){this.value.toggle()}}class $r extends O{constructor(e,t,r="li"){super(e);this._menuPopup=null,this._tagName=r,this._renderFlags=t}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const r=[this.renderMessageBody(e,t)];this._interactive&&r.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const s=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation}},r);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)s.removeChild(s.querySelector(".Timeline_messageAvatar")),s.removeChild(s.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const l=K.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[On(t,30)]),u=K.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);s.insertBefore(l,s.firstChild),s.insertBefore(u,s.firstChild)}});let i=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!i?(i=new Kw(o),this.addSubView(i),s.appendChild(ei(i))):!o&&i&&(s.removeChild(i.root()),i.unmount(),this.removeSubView(i),i=null)}),s}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const r=()=>this.root().classList.remove("menuOpen");this._menuPopup=new Xu(new Pe(t),r),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new Vw(e)),t.push(Pe.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(Pe.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(Pe.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}}class Vw{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(s=>e.button({onClick:()=>this._vm.react(s)},s)),r=e.button({onClick:()=>{const s=prompt("Enter your reaction (emoji)");s&&this._vm.react(s)}},"\u2026");return e.li({className:"quick-reactions"},[...t,r])}}class $w extends O{render(e,t){const r=Uo(t);if(!r)throw new Error(`Shape ${t.shape} is unrecognized.`);const s=new r(t,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[On(t,12,void 0),t.displayName]),e.br(),e.view(s)]))}}class jw extends O{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class Ww extends $r{renderMessageBody(e,t){const r=e.time({className:{hidden:!t.date}},t.date+" "+t.time),s=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new jw:o?new $w(o):null)),i=o=>(o==null?void 0:o.nodeType)!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;i(s.lastChild);)s.removeChild(s.lastChild);for(const a of o.parts)s.appendChild(wm(a));s.appendChild(r)}),s}}function zw(n){const e=n.items.map(r=>K.li(Kn(r))),t=n.startOffset;return t?K.ol({start:t},e):K.ul(e)}function Hw(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),K.img(e)}function qw(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=K.div({class:e},Nt(n.avatarInitials)),r=Kn(n.children);return r.unshift(t),K.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},r)}function Gw(n){const e=[];if(n.head){const r=n.head.map(s=>K.th(Kn(s)));e.push(K.thead(K.tr(r)))}const t=[];for(const r of n.body){const s=r.map(i=>K.td(Kn(i)));t.push(K.tr(s))}return e.push(K.tbody(t)),K.table(e)}const Yw={header:n=>K["h"+Math.min(6,n.level)](Kn(n.inlines)),codeblock:n=>K.pre(K.code(Nt(n.text))),table:n=>Gw(n),code:n=>K.code(Nt(n.text)),text:n=>Nt(n.text),link:n=>K.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},Kn(n.inlines)),pill:qw,format:n=>K[n.format](Kn(n.children)),rule:()=>K.hr(),list:zw,image:Hw,newline:()=>K.br()};function wm(n){const e=Yw[n.type];return e?e(n):Nt(`[unknown part type ${n.type}]`)}function Kn(n){return Array.from(n,wm)}class Sm extends $r{renderMessageBody(e,t){let s=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(s=`height: ${t.height}px`);const i=[e.div({className:"spacer",style:s}),this.renderMedia(e,t),e.time(t.date+" "+t.time)];if(t.isPending){const o=e.div({className:{sendStatus:!0,hidden:l=>!l.sendStatus}},l=>l.sendStatus),a=e.progress({min:0,max:100,value:l=>l.uploadPercentage,className:{hidden:l=>!l.isUploading}});i.push(o,a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`},i),e.if(o=>o.error,o=>o.p({className:"error"},t.error))])}}class Qw extends Sm{renderMedia(e,t){const r=e.img({src:s=>s.thumbnailUrl,alt:s=>s.label,title:s=>s.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending?r:e.a({href:t.lightboxUrl},r)}}function Oo(n,e){return new Promise((t,r)=>{let s;const i=a=>{s(),r(a.target.error)},o=()=>{s(),t()};s=()=>{n.removeEventListener(e,o),n.removeEventListener("error",i)},n.addEventListener(e,o),n.addEventListener("error",i)})}class Jw extends Sm{renderMedia(e){const t=e.video({src:r=>r.videoUrl||`data:${r.mimeType},`,title:r=>r.label,controls:!0,preload:"none",poster:r=>r.thumbnailUrl,onPlay:this._onPlay.bind(this),style:r=>`max-width: ${r.width}px; max-height: ${r.height}px;${r.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const r=e.target;await t.loadVideo();const s=Oo(r,"loadeddata");r.load(),await s,r.play()}catch{}}_onError(e){const t=this.value,r=e.target,s=r.error;if(s instanceof window.MediaError&&s.code===4)if(!r.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(s)}}class Xw extends $r{renderMessageBody(e,t){const r=[];return t.isPending?r.push(s=>s.label):r.push(e.button({className:"link",onClick:()=>t.download()},s=>s.label),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},r)}}class Zw extends $r{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.date+" "+t.time)])}}class eS extends $r{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class tS extends O{render(e){return e.li({className:"AnnouncementView"},e.div(t=>t.announcement))}onClick(){}}class nS extends $r{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(Pe.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}class rS extends O{render(e){const t={GapView:!0,isLoading:r=>r.isLoading,isAtTop:r=>r.isAtTop};return e.li({className:t},[Ft(e),e.div(r=>r.isLoading?r.i18n`Loading more messages …`:r.i18n`Not loading!`),e.if(r=>r.error,r=>r.strong(s=>s.error))])}onClick(){}}function Uo(n){switch(n.shape){case"gap":return rS;case"announcement":return tS;case"message":case"message-status":return Ww;case"image":return Qw;case"video":return Jw;case"file":return Xw;case"location":return Zw;case"missing-attachment":return eS;case"redacted":return nS}}function vh(n){return n.offsetTop+n.clientHeight}function wh(n,e,t=n.children.length-1){for(var r=t;r>=0;r--)if(n.children[r].offsetTop<e)return r;return 0}class sS extends O{constructor(){super(...arguments);this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new iS(t.tiles,()=>this.restoreScrollPosition());const r=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:s=>!s.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(r)),r}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,r=e.clientHeight-t.clientHeight;if(r>0){t.style.setProperty("margin-top",`${r}px`);const s=this.value.tiles.length;this.updateVisibleRange(0,s-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const s=vh(this.anchoredNode);if(s!==this.anchoredBottom){const i=s-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,i):e.scrollTop=e.scrollTop+i,this.anchoredBottom=s}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:r,scrollTop:s,clientHeight:i}=e;let o;if(this.stickToBottom=Math.abs(r-(s+i))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const l=s+i,u=wh(t,l);this.anchoredNode=t.childNodes[u],this.anchoredBottom=vh(this.anchoredNode),o=u}let a=wh(t,s,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const r=this.tilesView.getChildInstanceByIndex(e),s=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(r==null?void 0:r.value,s==null?void 0:s.value)}}class iS extends ui{constructor(e,t){const r={list:e,onItemClick:(s,i)=>s.onClick(i)};super(r,s=>{const i=Uo(s);if(i)return new i(s)});this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,r){if(r==="shape"){const s=Uo(t),i=this.getChildInstanceByIndex(e);if(!s||!(i instanceof s)){super.recreateItem(e,t);return}}super.onUpdate(e,t,r),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,r){super.onMove(e,t,r),this.onChanged()}}class oS extends O{render(e,t){return e.div({className:"TimelineLoadingView"},[Ft(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class aS extends O{constructor(e){super(e);this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:i=>this._onKeyDown(i),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:i=>i.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const r=e.map(i=>i.replyViewModel,(i,o)=>{const a=i&&Uo(i);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(i,{interactive:!1},"div"))]):null}),s=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:i=>this._toggleAttachmentMenu(i)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:i=>i.canSend}},[r,s])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(r){t(),console.error(r)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new Xu(new Pe([Pe.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),Pe.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),Pe.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class lS extends O{render(e){return e.div({className:"RoomArchivedView"},e.h3(t=>t.description))}}class bm extends O{constructor(e){super(e);this._optionsPopup=null}render(e,t){let r;return t.composerViewModel.kind==="composer"?r=new aS(t.composerViewModel):t.composerViewModel.kind==="archived"&&(r=new lS(t.composerViewModel)),e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new Qn(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:s=>this._toggleOptionsMenu(s)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},s=>s.error),e.mapView(s=>s.timelineViewModel,s=>s?new sS(s):new oS(t)),e.view(r)])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,r=[];if(r.push(Pe.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&r.push(Pe.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&r.push(Pe.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&r.push(Pe.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!r.length)return;this._optionsPopup=new Xu(new Pe(r)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class uS extends O{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:r=>r.busy},t.i18n`Join room`),e.if(r=>r.error,r=>r.p({className:"error"},t.error))]))}}class Nr{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(K,e):this.render(K,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class Em extends Nr{constructor(e="Loading"){super(e,(t,r)=>t.div({className:"LoadingView"},[Ft(t),r]))}}class Im extends O{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new Qn(t,32)),e.div({className:"room-description"},[e.h2(r=>r.name)])]),e.div({className:"RoomView_body"},[e.mapView(r=>r.error,r=>r?new cS(t):new Em(t.i18n`Setting up the room…`))])])}}class cS extends O{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class km extends O{render(e,t){var r;let s=[];t.isDirectMessage&&s.push(On(t,128,"InviteView_dmAvatar"));let i;return t.isDirectMessage?i=[e.strong(t.name),` (${(r=t.inviter)==null?void 0:r.id}) wants to chat with you.`]:t.inviter?i=[On(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:i="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},i)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[On(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),On(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class dS extends O{render(e,t){const r=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),s=e.div({role:"img","aria-label":l=>l.name,title:l=>l.name,className:{picture:!0,hidden:l=>!l.imageUrl},style:l=>`background-image: url('${l.imageUrl}'); max-width: ${l.imageWidth}px; max-height: ${l.imageHeight}px;`}),i=e.div({className:{loading:!0,hidden:l=>!!l.imageUrl}},[Ft(e),e.div(t.i18n`Loading image…`)]),o=e.div({className:"details"},[e.strong(l=>l.name),e.br(),"uploaded by ",e.strong(l=>l.sender),l=>` at ${l.time} on ${l.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:l=>this.clickToClose(l),onKeydown:l=>this.closeOnEscKey(l)},[s,i,o,r]);return hS(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function hS(n,e){const t=pS(e),r=t[0],s=t[t.length-1];n.addEventListener(e,"keydown",i=>{i.key==="Tab"&&(i.shiftKey?document.activeElement===r&&(s.focus(),i.preventDefault()):document.activeElement===s&&(r.focus(),i.preventDefault()))},!0),Promise.resolve().then(()=>{r.focus()})}function pS(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class fS extends O{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:r=>!r.isShown}},[Ft(e,{hidden:r=>!r.isWaiting}),e.p(r=>r.statusLabel),e.if(r=>r.isConnectNowShown,r=>r.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(r=>r.isSecretStorageShown,r=>r.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(r=>r.canDismiss,r=>r.div({className:"end"},r.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class mS extends O{render(e,t){const r=[];for(let s=0;s<t.height*t.width;s+=1)r.push(e.div({onClick:()=>t.focusTile(s),onFocusin:()=>t.focusTile(s),className:{container:!0,[`tile${s}`]:!0,focused:i=>i.focusIndex===s}},e.mapView(i=>i.roomViewModelAt(s),i=>i?i.kind==="roomBeingCreated"?new Im(i):i.kind==="invite"?new km(i):new bm(i):new Nr(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return r.push(e.div({className:s=>`focus-ring tile${s.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},r)}}class Cm extends O{render(e){return e.div([e.map(t=>t.status,(t,r,s)=>{switch(t){case"Enabled":return _S(r,s);case"NewVersionAvailable":return gS(r,s);case"SetupKey":return yS(r,s);case"SetupPhrase":return vS(r,s);case"Pending":return r.p(s.i18n`Waiting to go online…`)}}),e.map(t=>t.backupWriteStatus,(t,r,s)=>{switch(t){case"Writing":{const i=r.progress({min:0,max:100,value:o=>o.backupPercentage});return r.div(["Backup in progress ",i," ",o=>o.backupInProgressLabel])}case"Stopped":{let i;return s.backupError?i=`Backup has stopped because of an error: ${s.backupError}`:i="Backup has stopped",r.p(i," ",r.button({onClick:()=>s.startBackup()},"Backup now"))}case"Done":return r.p("All keys are backed up.");default:return null}})])}}function _S(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function gS(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function yS(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Am(n),Rm(n,e,e.i18n`Security key`,(r,s)=>e.enterSecurityKey(r,s)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function vS(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Am(n),Rm(n,e,e.i18n`Security phrase`,(r,s)=>e.enterSecurityPhrase(r,s)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function Rm(n,e,t,r){let s;const i=()=>r(o.value,(s==null?void 0:s.checked)||!1),o=n.input({type:"password",disabled:l=>l.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:l=>l.isBusy,onClick:i},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){s=n.input({type:"checkbox",id:"enable-dehydrated-device"});const l=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([s,n.label({for:s.id},[e.i18n`Back up my device as well (`,l,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function Am(n){return n.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},r=>r.i18n`Could not enable key backup: ${r.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class wS extends O{render(e,t){let r=t.version;t.showUpdateButton&&(r=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const s=(o,a,l,u="")=>o.div({className:`row ${u}`},[o.div({className:"label"},a),o.div({className:"content"},l)]),i=[];return i.push(e.h3("Session"),s(e,t.i18n`User ID`,t.userId),s(e,t.i18n`Session ID`,t.deviceId,"code"),s(e,t.i18n`Session key`,t.fingerprintKey,"code"),s(e,"",e.button({onClick:()=>t.logout(),disabled:o=>o.isLoggingOut},t.i18n`Log out`))),i.push(e.h3("Key backup"),e.view(new Cm(t.keyBackupViewModel))),i.push(e.h3("Notifications"),e.map(o=>o.pushNotifications.supported,(o,a)=>{if(o===null)return a.p(t.i18n`Loading…`);if(o){const l=c=>c.pushNotifications.enabled?c.i18n`Push notifications are enabled`:c.i18n`Push notifications are disabled`,u=c=>c.pushNotifications.enabled?c.i18n`Disable`:c.i18n`Enable`;return s(a,l,a.button({onClick:()=>t.togglePushNotifications(),disabled:c=>c.pushNotifications.updating},u))}else return a.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(o=>o.pushNotifications.supported&&o.pushNotifications.enabled,o=>o.div([o.p(["If you think push notifications are not being delivered, ",o.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),o.map(a=>a.pushNotifications.enabledOnServer,(a,l)=>{if(a===!0)return l.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(a===!1)return l.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),o.map(a=>a.pushNotifications.serverError,(a,l)=>{if(a)return l.p("Couldn't not check on server: "+a.message)})]))),i.push(e.h3("Preferences"),s(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t))),i.push(e.h3("Application"),s(e,t.i18n`Version`,r),s(e,t.i18n`Storage usage`,o=>`${o.storageUsage} / ${o.storageQuota}`),s(e,t.i18n`Debug logs`,e.button({onClick:()=>t.exportLogs()},"Export")),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},i)])}_imageCompressionRange(e,t){const s=Math.ceil(t.minSentImageSizeLimit/32)*32,i=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:s,max:i,value:a=>a.sentImageSizeLimit||i,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}}class SS extends O{render(e,t){return e.main({className:"middle"},e.div({className:"CreateRoomView centered-column"},[e.h2("Create room"),e.form({className:"CreateRoomView_detailsForm form",onChange:r=>this.onFormChange(r),onSubmit:r=>this.onSubmit(r)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(r=>r.hasAvatar,r=>r?new Qn(t,64):new Nr(void 0,s=>s.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:r=>t.setName(r.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:r=>t.setTopic(r.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:r=>r.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:r=>!r.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:r=>t.setRoomAlias(r.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},r=>r.isAdvancedShown?r.i18n`Hide advanced settings`:r.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:r=>!r.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:r=>!r.canCreate},t.i18n`Create room`)])])]))}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class bS extends O{render(e,t){const r=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new Qn(t,52)),e.mapView(s=>s.isEncrypted,s=>new ES(s))]),e.div({className:"RoomDetailsView_name"},[e.h2(s=>s.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},s=>s.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},r)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?K.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,r,s){const i=xr(Dl({RoomDetailsView_label:!0},r));return e.div({className:"RoomDetailsView_row"},[e.div({className:i},[t]),e.div({className:"RoomDetailsView_value"},s)])}_createRightPanelButtonRow(e,t,r,s,i){const o=xr(Dl({RoomDetailsView_label:!0},r));return e.button({className:"RoomDetailsView_row",onClick:i},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},s)])}}class ES extends O{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class IS{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let r=0;for(r=0;r<this.start;r+=1)e.next();for(r=0;r<this.length;r+=1){const s=e.next();if(s.done)break;t(s.value,this.start+r)}}[Symbol.iterator](){return new kS(this)}reverseIterable(){return new CS(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?an.Before:e<this.end?an.Inside:an.After}}var an;(function(n){n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After"})(an||(an={}));class kS{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class CS{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class jr extends Hu{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let r of this._handlers)r.onAdd(e,t,this)}emitUpdate(e,t,r){for(let s of this._handlers)s.onUpdate(e,t,r,this)}emitRemove(e,t){for(let r of this._handlers)r.onRemove(e,t,this)}emitMove(e,t,r){for(let s of this._handlers)s.onMove(e,t,r,this)}}class RS extends jr{constructor(e=[]){super();this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let r of t)this.insert(e,r),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[r]=this._items.splice(e,1);this._items.splice(t,0,r),this.emitMove(e,t,r)}}update(e,t,r=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,r))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function AS(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function $i(n,e){if(AS(n,e)){const t=n.next();if(!t.done)return t.value}}var An;(function(n){n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange"})(An||(An={}));class Ls extends IS{constructor(e,t,r,s=t-e){super(e,t);this._totalLength=r,this._viewportItemCount=s}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),r=Math.min(this.totalLength,this.end+e);return new Ls(t,r,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,r,s){const i=Math.min(Math.max(0,Math.floor(s/t)),e),o=e-i,a=r!==0?Math.ceil(r/t):0,l=Math.min(a,o);return new Ls(i,i+l,e,a)}queryAdd(e,t,r){const s=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=s){const i=this.clampIndex(e,s),o=i===e?t:$i(r[Symbol.iterator](),i);return this.createAddResult(i,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const r=this.clampIndex(e);return this.createRemoveResult(r,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,r,s){const i=this.getIndexZone(e),o=this.getIndexZone(t);if(i===o){if(i===an.Before||i===an.After)return;if(i===an.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),l=this.clampIndex(e),u=a===t?r:$i(s[Symbol.iterator](),a);return{type:3,removeIdx:l,addIdx:a,value:u}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const r=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:r,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const r=this.clampIndex(Number.MAX_SAFE_INTEGER),s=$i(t[Symbol.iterator](),r);return{type:3,removeIdx:e,value:s,addIdx:r,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const r=this.deriveRange(-1,0,1),s=r.start,i=$i(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:r}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,r=0){const s=this.start-r,i=this.totalLength+e,o=Math.min(Math.max(s,this.end-r+t),i);return new Ls(s,o,i,this.viewportItemCount)}}class TS extends ui{constructor(e,t){var r=e,{itemHeight:s,overflowItems:i=20}=r,o=Jy(r,["itemHeight","overflowItems"]);super(o,t);this.itemHeight=s,this.overflowItems=i}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return Ls.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){Nw(this._listElement);const t=document.createDocumentFragment(),r=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(r,s=>{const i=this._childCreator(s);this._childInstances.push(i),t.appendChild(ei(i,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const r of e.reverseIterable())if(!t.containsIndex(r)){const s=r-e.start;this.removeChild(s)}t.forEachInIterator(this._list[Symbol.iterator](),(r,s)=>{if(!e.containsIndex(s)){const i=s-t.start;this.addChild(i,r)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,r=(e.totalLength-e.end)*this.itemHeight,s=this._listElement.style;s.paddingTop=`${t}px`,s.paddingBottom=`${r}px`}mount(){const e=super.mount();return this.scrollContainer=K.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const r=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(r)}onRemove(e,t){const r=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(r)}onMove(e,t,r){const s=this.renderRange.queryMove(e,t,r,this._list);s&&(s.type===An.Move?this.moveChild(this.renderRange.toLocalIndex(s.fromIdx),this.renderRange.toLocalIndex(s.toIdx)):this.applyRemoveAddResult(s))}onUpdate(e,t,r){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,r)}applyRemoveAddResult(e){(e.type===An.Remove||e.type===An.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===An.Add||e.type===An.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class xS extends O{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new Qn(t,32)),e.div({className:"MemberTileView_name"},r=>r.name)]))}}class NS extends TS{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new xS(t))}}class MS extends O{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new Qn(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(r=>r.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,r=>r.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,r){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},r)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)])])}}class PS extends O{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new DS(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e==null?void 0:e.type){case"room-details":return new bS(e);case"member-list":return new NS(e);case"member-details":return new MS(e);default:return new Em}}}class DS extends O{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class LS extends O{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":r=>!!r.activeMiddleViewModel,"right-shown":r=>!!r.rightPanelViewModel}},[e.view(new fS(t.sessionStatusViewModel)),e.view(new Ow(t.leftPanelViewModel)),e.mapView(r=>r.activeMiddleViewModel,()=>t.roomGridViewModel?new mS(t.roomGridViewModel):t.settingsViewModel?new wS(t.settingsViewModel):t.createRoomViewModel?new SS(t.createRoomViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new km(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new bm(t.currentRoomViewModel):t.currentRoomViewModel.kind==="roomBeingCreated"?new Im(t.currentRoomViewModel):new uS(t.currentRoomViewModel):new Nr(r=>r.div({className:"room-placeholder"},r.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(r=>r.lightboxViewModel,r=>r?new dS(r):null),e.mapView(r=>r.rightPanelViewModel,r=>r?new PS(r):null)])}}function Tm(n){return n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class OS extends O{render(e,t){const r=o=>!!o.isBusy,s=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:r}),i=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:r});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(s.value,i.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),s]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),i]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:r},t.i18n`Log In`)])])])}}class US extends O{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(r=>r.decryptDehydratedDeviceViewModel,r=>new Cm(r.decryptDehydratedDeviceViewModel)),e.map(r=>r.deviceDecrypted,(r,s)=>r?s.p(t.i18n`That worked out, you're good to go!`):s.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},r=>r.deviceDecrypted?r.i18n`Continue`:r.i18n`Continue without restoring`)])])}}class na extends O{render(e){const t=e.if(s=>s.hasError,(s,i)=>s.button({onClick:()=>i.exportLogs()},i.i18n`Export logs`)),r=e.if(s=>s.hasError,(s,i)=>s.button({onClick:()=>i.logout()},i.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Ft(e,{hidden:s=>!s.loading}),e.p(s=>s.loadLabel),t,r]),e.ifView(s=>s.accountSetupViewModel,s=>new US(s.accountSetupViewModel))])}}class FS extends O{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,r)=>t.p({className:"error"},r.i18n(r.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new na(t):null)])}}class KS extends O{render(e,t){const r=s=>s.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:r}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(s=>s.completeSSOLoginViewModel,s=>s?new FS(s):null),e.if(s=>s.showHomeserver,(s,i)=>s.div({className:"LoginView_sso form-row text"},[s.label({for:"homeserver"},i.i18n`Homeserver`),s.input({id:"homeserver",type:"text",placeholder:i.i18n`Your matrix homeserver`,value:i.homeserver,disabled:r,onInput:o=>i.setHomeserver(o.target.value),onChange:()=>i.queryHomeserver()}),s.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),s.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(s=>s.isFetchingLoginOptions,s=>s.div({className:"LoginView_query-spinner"},[Ft(s),s.p("Fetching available login options...")])),e.mapView(s=>s.passwordLoginViewModel,s=>s?new OS(s):null),e.if(s=>s.passwordLoginViewModel&&s.startSSOLoginViewModel,s=>s.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(s=>s.startSSOLoginViewModel,s=>s?new BS(s):null),e.mapView(s=>s.loadViewModel,s=>s?new na(s):null),e.p(Tm(e))])}}class BS extends O{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:r=>r.isBusy},t.i18n`Log in with SSO`))}}class VS extends O{render(e,t){const r=new Lo(t,i=>i.div([i.p("Are you sure you want to log out?"),i.div({className:"button-row"},[i.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),i.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),s=new Lo(t,i=>i.p({className:"status",hidden:o=>!o.showStatus},[Ft(i,{hidden:o=>!o.busy}),i.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(i=>i.showConfirm,i=>i?r:s)])])}}class $S extends O{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new na(t))]),e.div({className:{"button-row":!0,hidden:r=>r.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class jS extends O{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},r=>r.avatarInitials),e.div({className:"user-id"},r=>r.label)])])}}class WS extends O{render(e,t){const r=new ui({list:t.sessions,parentProvidesUpdates:!1},s=>new jS(s));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(r),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(s=>s.loadViewModel,()=>new na(t.loadViewModel)),e.p(Tm(e))])])}}class zS extends O{render(e,t){return e.mapView(r=>r.activeSection,r=>{switch(r){case"error":return new Nr(s=>s.div({className:"StatusView"},[s.h1("Something went wrong"),s.p(t.errorText)]));case"session":return new LS(t.sessionViewModel);case"login":return new KS(t.loginViewModel);case"logout":return new VS(t.logoutViewModel);case"picker":return new WS(t.sessionPickerViewModel);case"redirecting":return new Nr(s=>s.p("Redirecting..."));case"loading":return new $S(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class HS{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,r)=>{this._reject=r,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new _t),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class qS{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class GS{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class YS{createMeasure(){return new GS}createTimeout(e){return new HS(e)}createInterval(e,t){return new qS(t,e)}now(){return Date.now()}}class QS{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,r=t.replyTo;if(r){const s=this._waitingForReply.get(r);s&&(this._waitingForReply.delete(r),s(t.payload))}if(t.type==="hasSessionOpen"){const s=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:s})}else if(t.type==="hasRoomOpen"){const s=this._navigation.observe("session").get()===t.payload.sessionId,i=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:s&&i})}else if(t.type==="closeSession"){const{sessionId:s}=t.payload;this._closeSessionIfNeeded(s).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var t;const r=(t=this._navigation)==null?void 0:t.path.get("session");return e&&(r==null?void 0:r.value)===e?new Promise(s=>{const i=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(i(),s())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,r=void 0){this._registrationPromise&&await this._registrationPromise,r||(r=this._registration.active),r.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,r=void 0){this._registrationPromise&&await this._registrationPromise,r||(r=this._registration.active),this._messageIdCounter+=1;const s=this._messageIdCounter,i=new Promise(o=>{this._waitingForReply.set(s,o)});return r.postMessage({type:e,id:s,payload:t}),await i}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.2.26"}get buildHash(){return null}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class JS{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var r;const s=await((r=this._serviceWorkerHandler)==null?void 0:r.getRegistration());if(s!=null&&s.pushManager){const o=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,l={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,l)}}async disablePush(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());if(t!=null&&t.pushManager){const r=await t.pushManager.getSubscription();r&&await r.unsubscribe()}}async isPushEnabled(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t!=null&&t.pushManager?!!await t.pushManager.getSubscription():!1}async supportsPush(){var e;if(!this._pushConfig)return!1;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t&&"pushManager"in t}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var r;if("Notification"in window){new Notification(e,{body:t});return}const s=await((r=this._serviceWorkerHandler)==null?void 0:r.getRegistration());s==null||s.showNotification(e,{body:t})}}class XS extends Vr{handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastUrl(){var e;return(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash")}}class ZS extends Vr{constructor(){super();this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function Ie(n,e){return n instanceof Promise?n:new Promise((t,r)=>{n.oncomplete=s=>t(s.target.result),n.onerror=()=>r(new Error("Crypto error on "+e))})}class eb{constructor(e){this._subtleCrypto=e}async verify(e,t,r,s){const i={name:"HMAC",hash:{name:Bn(s)}},o=await Ie(this._subtleCrypto.importKey("raw",e,i,!1,["verify"]),"importKey");return await Ie(this._subtleCrypto.verify(i,o,t,r),"verify")}async compute(e,t,r){const s={name:"HMAC",hash:{name:Bn(r)}},i=await Ie(this._subtleCrypto.importKey("raw",e,s,!1,["sign"]),"importKey"),o=await Ie(this._subtleCrypto.sign(s,i,t),"sign");return new Uint8Array(o)}}class tb{constructor(e,t,r){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=r}async pbkdf2(e,t,r,s,i){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await Ie(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await Ie(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:r,iterations:t,hash:Bn(s)},o,i),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,r,s,i){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,r,s,i);const o=await Ie(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await Ie(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:r,hash:Bn(s)},o,i),"deriveBits");return new Uint8Array(a)}}class nb{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:r,data:s,counterLength:i=64}){const o={name:"AES-CTR",counter:r,length:i};let a;try{const l=e||t,u=t?"jwk":"raw";a=await Ie(this._subtleCrypto.importKey(u,l,o,!1,["decrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR decryption: ${l.message}`)}try{const l=await Ie(this._subtleCrypto.decrypt(o,a,s),"decrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not decrypt with AES-CTR: ${l.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:r,data:s}){const i={name:"AES-CTR",counter:r,length:64};let o;const a=e||t,l=t?"jwk":"raw";try{o=await Ie(this._subtleCrypto.importKey(l,a,i,!1,["encrypt"]),"importKey")}catch(u){throw new Error(`Could not import key for AES-CTR encryption: ${u.message}`)}try{const u=await Ie(this._subtleCrypto.encrypt(i,o,s),"encrypt");return new Uint8Array(u)}catch(u){throw new Error(`Could not encrypt with AES-CTR: ${u.message}`)}}async generateKey(e,t=256){const r=await Ie(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return Ie(this._subtleCrypto.exportKey(e,r))}async generateIV(){return xm(this._crypto)}}function xm(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let r=0;r<e.length;r+=1)t[r]=e[r];return t}function Sh(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return Fn.decode(t)}function rb(n){const e=Fn.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function sb(n){return rb(n).replace(/\+/g,"-").replace(/\//g,"_")}function ib(n){return{alg:"A256CTR",ext:!0,k:sb(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class ob{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:r,data:s,counterLength:i=64}){if(i!==64)throw new Error(`Unsupported counter length: ${i}`);t&&(e=Sh(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(r)));return a.decrypt(new Uint8Array(s))}async encryptCTR({key:e,jwkKey:t,iv:r,data:s}){t&&(e=Sh(t));const i=this._aesjs;var o=new i.ModeOfOperation.ctr(new Uint8Array(e),new i.Counter(new Uint8Array(r)));return o.encrypt(new Uint8Array(s))}async generateKey(e,t=256){let r=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(r=ib(r)),r}async generateIV(){return xm(this._crypto)}}function Bn(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class ab{constructor(e){const t=window.crypto||window.msCrypto,r=t.subtle||t.webkitSubtle;this._subtleCrypto=r,!r.deriveBits&&(e==null?void 0:e.aesjs)?this.aes=new ob(e.aesjs,t):this.aes=new nb(r,t),this.hmac=new eb(r),this.derive=new tb(r,this,e)}async digest(e,t){return await Ie(this._subtleCrypto.digest(Bn(e),t))}digestSize(e){switch(Bn(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${Bn(e)}`)}}}async function lb(){var n;if((n=navigator==null?void 0:navigator.storage)!=null&&n.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class ub{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class cb{constructor(e,t){this._promise=new Promise((r,s)=>{this._resolve=r,this._reject=s}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class db{constructor(e,t){this._workers=[];for(let r=0;r<t;++r){const s=new ub(new Worker(e));s.attach(this),this._workers[r]=s}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,r)=>{this._init={resolve:t,reject:r}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,r=this._requests.get(t.replyToId);if(r){if(r._worker.busy=!1,r._isNotDisposed){if(t.type==="success")r._resolve(t.payload);else if(t.type==="error"){const s=new Error(t.message);s.stack=t.stack,r._reject(s)}r._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const r=this._getFreeWorker();r&&(this._sendWith(t,r),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new cb(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),r=this._getFreeWorker();return r&&this._sendWith(t,r),t}sendAll(e){const t=this._workers.map(r=>{const s=this._enqueueRequest(Object.assign({},e));return this._sendWith(s,r),s.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new _t),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}const hb={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},bh="application/octet-stream";class zn{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",hb[t]||(t=bh),new zn(new Blob([e],{type:t}),e)}static fromBlob(e){return new zn(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((r,s)=>{e.addEventListener("load",i=>r(i.target.result)),e.addEventListener("error",i=>s(i.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||bh}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}class ti{static async fromBlob(e){const t=await Eh(e),{width:r,height:s}=t;return new ti(e,r,s,t)}constructor(e,t,r,s){this.blob=e,this.width=t,this.height=r,this._domElement=s}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await Eh(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,r=Math.min(1,e/(t>=1?this.width:this.height)),s=Math.round(this.width*r),i=Math.round(this.height*r),o=document.createElement("canvas");o.width=s,o.height=i;const a=o.getContext("2d"),l=await this._getDomElement();a.drawImage(l,0,0,s,i);let u=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",c;if(o.toBlob)c=await new Promise(h=>o.toBlob(h,u));else if(o.msToBlob)u="image/png",c=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=zn.fromBlob(c);return new ti(d,s,i,null)}dispose(){this.blob.dispose()}}class Zu extends ti{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await fb(e),{videoWidth:r,videoHeight:s}=t;return new Zu(e,r,s,t)}}function pb(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const r=e.getImageData(0,0,1,1).data;return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]}async function Eh(n){const e=document.createElement("img"),t=Oo(e,"load");return e.src=n.url,await t,e}async function fb(n){const e=document.createElement("video");e.muted=!0;const t=Oo(e,"loadedmetadata");e.src=n.url,e.load(),await t;const r=Oo(e,"seeked");return await new Promise(s=>setTimeout(s,200)),e.currentTime=.1,await r,e}async function mb(n,e,t,r,s){let i=n.querySelector("iframe.downloadSandbox");if(!i){i=document.createElement("iframe"),i.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),i.setAttribute("src",e),i.className="hidden downloadSandbox",n.appendChild(i);let o;await new Promise((a,l)=>{o=()=>{i.removeEventListener("load",a),i.removeEventListener("error",l)},i.addEventListener("load",a),i.addEventListener("error",l)}),o()}if(s){const o=await t.readAsBuffer();i.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:r},"*")}else i.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:r},"*")}function ja(n){typeof n=="function"?n():n.dispose()}function _b(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class ec{constructor(){this._disposables=[]}track(e){if(!_b(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),ja(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed){console.warn("Disposables already disposed, cannot untrack");return}const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)ja(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[r]=this._disposables.splice(t,1);ja(r)}else console.warn("disposable not found, did it leak?",e)}}class gb{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const yb={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function vb(n){const e=Hy.sanitize(n,yb),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new gb(t)}function Ih(n){return new Promise(function(e,t){var r=document.createElement("script");r.setAttribute("src",n),r.onload=e,r.onerror=t,document.body.appendChild(r)})}async function wb(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await Ih(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await Ih(n.legacyBundle),await window.Olm.init()),window.Olm):null}function Sb(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function bb(n){const e=new db(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:Sb(n.olm.legacyBundle)}),new Sw(e)}function Eb(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const r=n.querySelector(".bottom-aligned-scroll");let s,i,o;r&&(s=r.scrollTop,i=r.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),r&&(o=r.offsetHeight,r.scrollTop=s+i-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class Sk{constructor(e,t,r,s=null,i=null){this._container=e,this._assetPaths=t,this._config=r,this.settingsStorage=new uw("hydrogen_setting_v1_"),this.clock=new YS,this.encoding=new ww,this.random=Math.random,this._createLogger(s==null?void 0:s.development),this.history=new XS,this.onlineStatus=new ZS,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new QS,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=new JS(this._serviceWorkerHandler,r.push),this.crypto=new ab(i),this.storageFactory=new ow(this._serviceWorkerHandler),this.sessionInfoStorage=new lw("hydrogen_sessions_v1"),this.estimateStorageUsage=lb,typeof fetch=="function"?this.request=iv(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Xf;const o=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=o;const a=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=a,this._disposables=new ec,this._olmPromise=void 0,this._workerPromise=void 0}_createLogger(e){const t=r=>{var s;return(s=r.e)!=null&&s.stack&&(r.e.stack=r.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),r};e?this.logger=new Iw({platform:this}):this.logger=new bw({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=wb(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=bb(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const r=Eb(this._container);r&&this._disposables.track(r)}this._container.addEventListener("error",yh,!0),this._disposables.track(()=>this._container.removeEventListener("error",yh,!0)),window.__hydrogenViewModel=e;const t=new zS(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return zn.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):mb(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const r=new Promise(s=>{const i=()=>{t.removeEventListener("change",i,!0);const o=t.files[0];this._container.removeChild(t),o?s({name:o.name,blob:zn.fromBlob(o)}):s()};t.addEventListener("change",i,!0)});return this._container.appendChild(t),t.click(),r}openUrl(e){location.href=e}parseHTML(e){return vb(e)}async loadImage(e){return ti.fromBlob(e)}async loadVideo(e){return Zu.fromBlob(e)}hasReadPixelPermission(){return pb()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.2.26"}dispose(){this._disposables.dispose()}}function kh(n){try{return new URL(n).origin}catch{return new URL(`https://${n}`).origin}}async function Ib(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const r=`${n}/.well-known/matrix/client`;return await e(r,t).response()}catch(r){if(r.name==="ConnectionError")return null;throw r}}async function kb(n,e){var t;n=kh(n);const r=await Ib(n,e);if(r&&r.status===200){const{body:s}=r,i=(t=s["m.homeserver"])==null?void 0:t.base_url;typeof i=="string"&&(n=kh(i))}return n}class Nm{constructor(e){this._abortable=void 0;const t=s=>(this._abortable=s,s);this._progress=new Pt(void 0);const r=s=>{this._progress.set(s)};this.result=e(t,r)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}function Mm(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function Cb(n){if(n instanceof zn){const e=n;return{mimeType:e.mimeType,body:e}}else if(typeof n=="object"){const e=JSON.stringify(n);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+n)}class Rb{constructor(e,t,r,s){let i;if(s!=null&&s.log){const o=s==null?void 0:s.log;i=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=i,this._sourceRequest=r,this._promise=r.response().then(o=>{var a,l;if(i==null||i.set("status",o.status),o.status>=200&&o.status<300||((a=s==null?void 0:s.allowedStatusCodes)==null?void 0:a.includes(o.status)))return i==null||i.finish(),o.body;if(o.status>=500){const u=new on("Internal Server Error");throw i==null||i.catch(u),u}else if(o.status>=400&&!((l=o.body)!=null&&l.errcode)){const u=new on(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw i==null||i.catch(u),u}else{const u=new Qf(e,t,o.body,o.status);throw i==null||i.set("errcode",u.errcode),i==null||i.catch(u),u}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new on("Service worker aborted, either updating or hit #187.");throw i==null||i.catch(a),a}else throw o.name==="ConnectionError"&&(i==null||i.set("timeout",o.isTimeout)),i==null||i.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const ji="/_matrix/client/r0",Ab="/_matrix/client/v3",Wa="/_matrix/client/unstable/org.matrix.msc2697.v2";class Rn{constructor({homeserver:e,accessToken:t,request:r,reconnector:s}){this._homeserver=e,this._accessToken=t,this._requestFn=r,this._reconnector=s}_url(e,t=ji){return this._homeserver+t+e}_baseRequest(e,t,r,s,i,o){const a=Mm(r);t=`${t}?${a}`;let l;const u=new Map;if(o&&u.set("Authorization",`Bearer ${o}`),u.set("Accept","application/json"),s){const h=Cb(s);u.set("Content-Type",h.mimeType),l=h.body}const c=this._requestFn(t,{method:e,headers:u,body:l,timeout:i==null?void 0:i.timeout,uploadProgress:i==null?void 0:i.uploadProgress,format:"json",cache:e!=="GET"}),d=new Rb(e,t,c,i);return this._reconnector&&d.response().catch(h=>{h.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,r,s,i){return this._baseRequest(e,t,r,s,i)}_authedRequest(e,t,r,s,i){return this._baseRequest(e,t,r,s,i,this._accessToken)}_post(e,t,r,s){return this._authedRequest("POST",this._url(e,(s==null?void 0:s.prefix)||ji),t,r,s)}_put(e,t,r,s){return this._authedRequest("PUT",this._url(e,(s==null?void 0:s.prefix)||ji),t,r,s)}_get(e,t,r,s){return this._authedRequest("GET",this._url(e,(s==null?void 0:s.prefix)||ji),t,r,s)}sync(e,t,r,s){return this._get("/sync",{since:e,timeout:r,filter:t},void 0,s)}context(e,t,r,s){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:s,limit:r})}messages(e,t,r){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,r)}members(e,t,r){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,r)}send(e,t,r,s,i){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},s,i)}redact(e,t,r,s,i){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},s,i)}receipt(e,t,r,s){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},{},s)}state(e,t,r,s){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},void 0,s)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,r,s,i=!0,o={}){o.allowedStatusCodes=[401];const a={auth:s,password:t,initial_device_displayname:r,inhibit_login:i};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",Ab),void 0,a,o)}passwordLogin(e,t,r,s){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:r},s)}tokenLogin(e,t,r,s){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:r},s)}createFilter(e,t,r){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,r)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,r){let s="/keys/upload";return e&&(s=s+`/${encodeURIComponent(e)}`),this._post(s,{},t,r)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,r,s){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(r)}`,{},t,s)}roomKeysVersion(e,t){let r="";return e&&(r=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${r}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,r,s){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{version:e},void 0,s)}uploadRoomKeysToBackup(e,t,r){return this._put("/room_keys/keys",{version:e},t,r)}uploadAttachment(e,t,r){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,r)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=Wa,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=Wa,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=Wa,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,r,s){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},r,s)}}var Ch;(function(n){n[n.start=2e3]="start"})(Ch||(Ch={}));class Pm{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof _t))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var Vl;(function(n){n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online"})(Vl||(Vl={}));class Tb{constructor({retryDelay:e,createMeasure:t,onlineStatus:r}){this._onlineStatus=r,this._retryDelay=e,this._createTimeMeasure=t,this._state=new Pt(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(r=>{r&&this.tryNow()});try{await this._reconnectLoop(e)}catch(r){console.error(r)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function xb(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:r}=n,{base64:s}=n.encoding;var i=s.decode(t.iv),o=s.encode(s.decode(t.hashes.sha256));const a=await r.digest("SHA-256",e);if(s.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var l;return t.v=="v1"||t.v=="v2"?l=64:l=128,await r.aes.decryptCTR({jwkKey:t.key,iv:i,data:e,counterLength:l})}async function Nb(n,e){const{crypto:t}=n,{base64:r}=n.encoding,s=await t.aes.generateIV(),i=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:i,iv:s,data:o}),l=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:i,iv:r.encodeUnpadded(s),hashes:{sha256:r.encodeUnpadded(l)}}}}class Mb{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,r,s){const i=this._parseMxcUrl(e);if(i){const[o,a]=i;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Mm({width:Math.round(t),height:Math.round(r),method:s})}return null}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[r,s]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(r)}/${encodeURIComponent(s)}`}else return null}_parseMxcUrl(e){const t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){const r=this.mxcUrl(e.url),{body:s}=await this._platform.request(r,{method:"GET",format:"buffer",cache:t}).response(),i=await xb(this._platform,s,e);return this._platform.createBlob(i,e.mimetype)}async downloadPlaintextFile(e,t,r=!1){const s=this.mxcUrl(e),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:r}).response();return this._platform.createBlob(i,t)}async downloadAttachment(e,t=!1){var r;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(r=e.info)==null?void 0:r.mimetype,t)}}class Pb{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((r,s)=>{this.responseResolve=r,this.responseReject=s})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new _t),(e=this.responseCodeReject)==null||e.call(this,new _t))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var t,r;this._requestResult=e;const s=await((t=this._requestResult)==null?void 0:t.response());this.responseResolve(s);const i=await((r=this._requestResult)==null?void 0:r.responseCode());this.responseCodeResolve(i)}get requestResult(){return this._requestResult}}class Dm{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames(Rn.prototype))n!=="constructor"&&!n.startsWith("_")&&(Dm.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class Db{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new Dm(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const r=new Pb(e,t);return this._doSend(r),r}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const r=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(r);return}catch(r){if(r instanceof Qf&&r.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(r.retry_after_ms)?await this._clock.createTimeout(r.retry_after_ms).elapsed():(t||(t=new Pm(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(r);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const Lb=3e4,se=Ut("InitialSync","CatchupSync","Syncing","Stopped");function Ob(n){var e;try{const t=(e=n==null?void 0:n.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class Ub{constructor({hsApi:e,session:t,storage:r,logger:s}){this._hsApi=e,this._logger=s,this._session=t,this._storage=r,this._currentRequest=null,this._status=new Pt(se.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==se.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(se.CatchupSync):this._status.set(se.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==se.Stopped;){let t,r,s=this._status.get()===se.CatchupSync||this._status.get()===se.InitialSync;await this._logger.run("sync",async i=>{i.set("token",e),i.set("status",this._status.get());try{const o=this._status.get()===se.Syncing?Lb:0,a=await this._syncRequest(e,o,i);e=a.syncToken,t=a.roomStates,r=a.sessionChanges,this._status.get()!==se.Syncing&&a.hadToDeviceMessages?this._status.set(se.CatchupSync):this._status.set(se.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(i.error=o,i.logLevel=i.level.Fatal),i.set("stopping",!0),this._status.set(se.Stopped)}this._status.get()!==se.Stopped&&await i.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(r,t,o))},this._logger.level.Info,(i,o)=>o.durationWithoutType("network")>=2e3||o.error||s?i.minLevel(o.level.Detail):i.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,r){const s=this._status.get()===se.CatchupSync,i=(async()=>{try{await r.wrap("session",l=>this._session.afterSyncCompleted(e,s,l),r.level.Detail)}catch{}})(),a=t.filter(l=>l.room.needsAfterSyncCompleted(l.changes)).map(async l=>{try{await r.wrap("room",u=>l.room.afterSyncCompleted(l.changes,u),r.level.Detail)}catch{}});await Promise.all(a.concat(i))}async _syncRequest(e,t,r){var s;let{syncFilterId:i}=this._session;typeof i!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:r}),i=(await this._currentRequest.response()).filter_id);const o=t+80*1e3;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:o,log:r});const a=await this._currentRequest.response(),l=!e,u=new Fb,c=this._parseInvites(a.rooms),{roomStates:d,archivedRoomStates:h}=await this._parseRoomsResponse(a.rooms,c,l,r);try{u.lock=await r.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(a)),await r.wrap("prepare",v=>this._prepareSync(u,d,a,v)),await r.wrap("afterPrepareSync",v=>Promise.all(d.map(S=>S.room.afterPrepareSync(S.preparation,v)))),await r.wrap("write",async v=>this._writeSync(u,c,d,h,a,i,l,v))}finally{u.dispose()}r.wrap("after",v=>this._afterSync(u,c,d,h,v));const g=(s=a.to_device)==null?void 0:s.events;return{syncToken:a.next_batch,roomStates:d,sessionChanges:u.changes,hadToDeviceMessages:Array.isArray(g)&&g.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,r,s){var i,o;const a=await this._openPrepareSyncTxn();e.preparation=await s.wrap("session",u=>this._session.prepareSync(r,e.lock,a,u));const l=(i=e.preparation)==null?void 0:i.newKeysByRoom;if(l){const{hasOwnProperty:u}=Object.prototype;for(const c of l.keys())if(!(((o=r.rooms)==null?void 0:o.join)&&u.call(r.rooms.join,c))){let h=this._session.rooms.get(c);h&&t.push(new Rh(h,!1,{},h.membership))}}await Promise.all(t.map(async u=>{const c=l==null?void 0:l.get(u.room.id);u.preparation=await s.wrap("room",async d=>(u.isNewRoom&&await u.room.load(null,a,d),u.room.prepareSync(u.roomResponse,u.membership,c,a,d)),s.level.Detail)})),await a.complete()}async _writeSync(e,t,r,s,i,o,a,l){const u=await this._openSyncTxn();try{e.changes=await l.wrap("session",c=>this._session.writeSync(i,o,e.preparation,u,c)),await Promise.all(t.map(async c=>{c.changes=await l.wrap("invite",d=>c.invite.writeSync(c.membership,c.roomResponse,u,d))})),await Promise.all(r.map(async c=>{c.changes=await l.wrap("room",d=>c.room.writeSync(c.roomResponse,a,c.preparation,u,d))})),await Promise.all(s.map(async c=>{var d;const h=(d=c.roomState)==null?void 0:d.summaryChanges;c.changes=await l.wrap("archivedRoom",g=>c.archivedRoom.writeSync(h,c.roomResponse,c.membership,u,g))}))}catch(c){throw u.abort(l),u.getCause(c)}await u.complete(l)}_afterSync(e,t,r,s,i){i.wrap("session",o=>this._session.afterSync(e.changes,o),i.level.Detail);for(let o of s)i.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},i.level.Detail);for(let o of r)i.wrap("room",a=>o.room.afterSync(o.changes,a),i.level.Detail);for(let o of t)i.wrap("invite",a=>o.invite.afterSync(o.changes,a),i.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,r,s,i)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,r,s){const i=[],o=[];if(e){const a=["join","leave"];for(const l of a){const u=e[l];if(u)for(const[c,d]of Object.entries(u)){if(r&&Ob(d))continue;const h=this._session.invites.get(c);h&&t.push(new Ah(h,!1,null,l));const g=this._createRoomSyncState(c,d,l,r);g&&i.push(g);const v=await this._createArchivedRoomSyncState(c,g,d,l,r,s);v&&o.push(v)}}}return{roomStates:i,archivedRoomStates:o}}_createRoomSyncState(e,t,r,s){let i=!1,o=this._session.rooms.get(e);if(!o&&(r==="join"||s&&r==="leave")&&(o=this._session.createJoinedRoom(e),i=!0),o)return new Rh(o,i,t,r)}async _createArchivedRoomSyncState(e,t,r,s,i,o){let a;if((t==null?void 0:t.shouldAdd)&&!i?a=this._session.createOrGetArchivedRoomForSync(e):s==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new Kb(a,t,r,s)}_parseInvites(e){const t=[];if(e!=null&&e.invite)for(const[r,s]of Object.entries(e.invite)){let i=this._session.invites.get(r),o=!1;i||(i=this._session.createInvite(r),o=!0),t.push(new Ah(i,o,s,"invite"))}return t}stop(){this._status.get()!==se.Stopped&&(this._status.set(se.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class Fb{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class Rh{constructor(e,t,r,s){this.room=e,this.isNewRoom=t,this.roomResponse=r,this.membership=s,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class Kb{constructor(e,t,r,s,i){this.archivedRoom=e,this.roomState=t,this.roomResponse=r,this.membership=s,this.isInitialSync=i,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class Ah{constructor(e,t,r,s){this.invite=e,this.isNewInvite=t,this.membership=s,this.roomResponse=r,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}class ra{constructor(){this._handlersByName={}}emit(e,t){const r=this._handlersByName[e];r&&r.forEach(s=>s(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let r=this._handlersByName[e];r||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=r=new Set),r.add(t)}off(e,t){const r=this._handlersByName[e];r&&(r.delete(t),r.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}function Bb(n,e,t,r,s){return e.length&&(n=e.reduce((i,o)=>Wb(i,o,t,r,s),n)),n}function Lm(n,e,t){var r,s;const i=(r=n==null?void 0:n.state)==null?void 0:r.events;Array.isArray(i)&&(t=i.reduce(e,t));const o=(s=n==null?void 0:n.timeline)==null?void 0:s.events;return Array.isArray(o)&&(t=o.reduce((a,l)=>(typeof l.state_key=="string"&&(t=e(t,l)),t),t)),t}function Vb(n,e,t,r){e.summary&&(n=zb(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(jb,n)),n=Lm(e,(i,o)=>Om(i,o,r),n);const s=e.unread_notifications;return s&&(n=$b(n,s)),n}function $b(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const r=e.notification_count;return r!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=r),n}function jb(n,e){var t;if((e==null?void 0:e.type)==="m.tag"){let r=(t=e==null?void 0:e.content)==null?void 0:t.tags;(!r||Array.isArray(r)||typeof r!="object")&&(r=null),n=n.cloneIfNeeded(),n.tags=r}return n}function Om(n,e,t){var r,s,i;if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(r=e.content)==null?void 0:r.algorithm;!n.encryption&&o===yt&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const o=(s=e.content)==null?void 0:s.name;o!==n.name&&(n=n.cloneIfNeeded(),n.name=o)}else if(e.type==="m.room.avatar"){const o=(i=e.content)==null?void 0:i.url;o!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!n.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=a)}else o.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function Wb(n,e,t,r,s){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==s&&r&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function zb(n,e){const t=e["m.heroes"],r=e["m.joined_member_count"],s=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(s)&&(n=n.cloneIfNeeded(),n.inviteCount=s),Number.isInteger(r)&&(n=n.cloneIfNeeded(),n.joinCount=r),n}class kt{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(r=>r!=="cloned"&&this[r]!==e[r])}cloneIfNeeded(){return this.cloned?this:new kt(this)}serialize(){return Object.entries(this).reduce((e,[t,r])=>(t!=="cloned"&&r!==null&&(e[t]=r),e),{})}applyTimelineEntries(e,t,r,s){return Bb(this,e,t,r,s)}applySyncResponse(e,t,r){return Vb(this,e,t,r)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class Hb{constructor(e){this._data=null,this.applyChanges(new kt(null,e))}get data(){return this._data}writeClearUnread(e){const t=new kt(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const r=new kt(this._data);return r.hasFetchedMembers=e,t.roomSummary.set(r.serialize()),r}writeIsTrackingMembers(e,t){const r=new kt(this._data);return r.isTrackingMembers=e,t.roomSummary.set(r.serialize()),r}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const r=await t.readWriteTxn([t.storeNames.roomSummary]);try{r.roomSummary.set(e.serialize())}catch(s){throw r.abort(),s}return await r.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new kt(e))}}const $l=Number.MAX_SAFE_INTEGER;class Um{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===$l?1:e.fragmentId===$l?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new ie(this.fragmentId,this.entryIndex)}}const qb="m.reaction",ln="m.annotation";function Gb(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:ln}}}function tc(n){var e;return n.event_id||((e=n["m.in_reply_to"])==null?void 0:e.event_id)}function Fm(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function Yb(n){if(n.type===pt)return n.redacts;{const e=Ht(n);if(e)return tc(e)}return null}function mn(n){return n==null?void 0:n["m.relates_to"]}function Ht(n){return mn(n.content)}class Qb{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,r)=>!t||r.pendingEvent.queueIndex>t.pendingEvent.queueIndex?r:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function Th(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Jb(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function Xb(n){return n==="m.emote"?"* ":""}function Zb(n,e,t,r){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:r,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function eE(n,e,t){const r=Jb(n.content.msgtype),s=Xb(n.content.msgtype),i=n.sender,o=n.displayName||i,a=r||n.content.formatted_body||n.content.body&&Th(n.content.body)||"",l=`<mx-reply><blockquote>In reply to ${s}<a href="https://matrix.to/#/${i}">${o}</a><br />${a}</blockquote></mx-reply>`,c=(r||n.content.body||"").split(`
`);c[0]=`> ${s}<${i}> ${c[0]}`;const h=c.join(`
> `)+`

`+t,g=l+Th(t);return Zb(n.id,e,h,g)}class Km extends Um{constructor(e){super(e);this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===pt}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===pt&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===ln&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===pt&&e.isRelatedToId(this.id)&&this._pendingRedactions){const r=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(s=>s!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,r!==0))return"isRedacted"}else{const r=e.redactingEntry||e;if(r.isRelatedToId(this.id)&&((t=r.relation)==null?void 0:t.rel_type)===ln&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let r=this._pendingAnnotations.get(t);return r||(r=new Qb,this._pendingAnnotations.set(t,r)),r.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let r=this._pendingAnnotations.get(t);return r.remove(e)&&r.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Gb(this.id,e)}reply(e,t){return eE(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var t,r,s;const i=((r=(t=this.annotations)==null?void 0:t[e])==null?void 0:r.me)||!1,o=(s=this.pendingAnnotations)==null?void 0:s.get(e),a=(o==null?void 0:o.willAnnotate)||!1;return i&&(!o||a)||!i&&a}get relation(){return mn(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class tE extends Km{constructor({pendingEvent:e,member:t,clock:r,redactingEntry:s}){super(null);this._pendingEvent=e,this._member=t,this._timestamp=r.now()-(100-e.queueIndex),this._redactingEntry=s}get fragmentId(){return $l}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}const W=Ut("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),xh=["m.relates_to"];class nE{constructor({data:e,remove:t,emitUpdate:r,attachments:s}){this._data=e,this._attachments=s,this._emitUpdate=r,this._removeFromQueueCallback=t,this._aborted=!1,this._status=W.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((i,o)=>i+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=mn(this.content);return e?tc(e):this._data.relatedEventId}setRelatedEventId(e){const t=mn(this.content);t?Fm(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=W.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of xh)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const r of xh)t[r]!==void 0&&(e[r]=t[r])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=W.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=W.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===W.Sending||this._status===W.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=W.EncryptingAttachments,this._emitUpdate("status");for(const s of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",s.size),s.encrypt())),this.aborted)throw new _t}this._status=W.UploadingAttachments,this._emitUpdate("status");const r=Object.entries(this._attachments);r.sort(([,s],[,i])=>s.size-i.size);for(const[s,i]of r)await t.wrap("upload",o=>(o.set("size",i.size),i.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),i.applyToContent(s,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=W.Sending,this._emitUpdate("status");const r=this._data.encryptedEventType||this._data.eventType,s=this._data.encryptedContent||this._data.content;r===pt?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,s,{log:t}):this._sendRequest=e.send(this.roomId,r,this.txnId,s,{log:t});const i=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=i.event_id,t.set("id",this._data.remoteId),this._status=W.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class ze extends Km{constructor(e,t){super(t);this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new ze(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return Fl(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return Yb(this.event)}get isRedacted(){return super.isRedacted||Kl(this._eventEntry.event)}get redactionReason(){var e,t;const r=(e=this._eventEntry.event.unsigned)==null?void 0:e.redacted_because;return r?(t=r.content)==null?void 0:t.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&mn(e)||mn(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function nc(n){return typeof n=="number"}const rE=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),sE={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function iE(n,e){for(const s of Object.keys(e))rE[s]||delete e[s];const{content:t}=e,r=sE[e.type];for(const s of Object.keys(t))r!=null&&r[s]||delete t[s];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function oE(n,e){const t=[];for(;nc(n.previousId);){const r=e.get(n.previousId);if(!r)break;if(r.nextId!==n.id)throw new Error(`Previous fragment ${r.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(r),n=r}return t}function aE(n,e){const t=[];for(;nc(n.nextId);){const r=e.get(n.nextId);if(!r)break;if(r.previousId!==n.id)throw new Error(`Next fragment ${r.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(r),n=r}return t}function lE(n){const e=new Map;for(let r of n)e.set(r.id,r);const t=[];for(;e.size;){const r=e.values().next().value;e.delete(r.id);const s=oE(r,e),i=aE(r,e),o=s.concat(r,i);t.push(o)}return t.map(r=>new uE(r))}class za{constructor(e,t,r){this.id=e,this.previousId=t,this.nextId=r}}class uE{constructor(e){this._idToSortIndex=new Map,e.forEach((t,r)=>{this._idToSortIndex.set(t.id,r)})}compare(e,t){const r=this._idToSortIndex.get(e);if(r===void 0)throw new Error(`first id ${e} isn't part of this island`);const s=this._idToSortIndex.get(t);if(s===void 0)throw new Error(`second id ${t} isn't part of this island`);return r-s}get fragmentIds(){return this._idToSortIndex.keys()}}class Nh extends Error{get name(){return"CompareError"}}class cE{constructor(e){this._fragmentsById=e.reduce((t,r)=>(t.set(r.id,r),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new Nh(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const r=this._getIsland(e),s=this._getIsland(t);if(r!==s)throw new Nh(`${e} and ${t} are on different islands, can't tell order`);return r.compare(e,t)}rebuild(e){const t=lE(e);this._idToIsland=new Map;for(let r of t)for(let s of r.fragmentIds)this._idToIsland.set(s,r)}add(e){const t=new za(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const r=new za(e,t,null),s=this._fragmentsById.get(t);s&&(s.nextId=e),this._fragmentsById.set(e,r),this.rebuild(this._fragmentsById.values())}prepend(e,t){const r=new za(e,null,t),s=this._fragmentsById.get(t);s&&(s.previousId=e),this._fragmentsById.set(e,r),this.rebuild(this._fragmentsById.values())}}class Bm{constructor({roomId:e,ownUserId:t,fragmentIdComparer:r}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=r}async writeRelation(e,t,r){const{relatedEventId:s}=e;if(s){const i=Ht(e.event);i&&i.rel_type&&t.timelineRelations.add(this._roomId,i.event_id,i.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,s);if(o){const a=await this._applyRelation(e,o,t,r);if(a)return a.map(l=>(t.timelineEvents.update(l),new ze(l,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,r,s){const i=new ze(e,this._fragmentIdComparer),o=await this.writeRelation(i,r,s);if(t.isBackward&&!Kl(e.event)){const a=await r.timelineRelations.getAllForTarget(this._roomId,i.id);if(a.length)for(const l of a){const u=await r.timelineEvents.getByEventId(this._roomId,l.sourceEventId);if(u){const c=new ze(u,this._fragmentIdComparer);await this._applyRelation(c,e,r,s)}}}return o}async _applyRelation(e,t,r,s){if(e.eventType===pt)return s.wrap("redact",async i=>{const o=t.event,a=Ht(o);if(this._applyRedaction(e.event,t,r,i)){const u=[t];if(a){const c=await this._reaggregateRelation(o,a,r,i);c&&u.push(c)}return u}return null});{const i=Ht(e.event);if(i&&!Kl(t.event)&&i.rel_type===ln&&s.wrap("react",l=>this._aggregateAnnotation(e.event,t,l)))return[t]}return null}_applyRedaction(e,t,r,s){const i=t.event;s.set("redactionId",e.event_id),s.set("id",i.event_id);const o=Ht(i);return o&&o.rel_type&&r.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,i.event_id),r.timelineRelations.removeAllForTarget(this._roomId,i.event_id),iE(e,i),delete t.annotations,!0}_aggregateAnnotation(e,t){const r=Ht(e);if(!r)return!1;let{annotations:s}=t;s||(t.annotations=s={});let i=s[r.key];i||(s[r.key]=i={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return i.me=i.me||o,i.count+=1,i.firstTimestamp=Math.min(i.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,r,s){return t.rel_type===ln?s.wrap("reaggregate annotations",i=>this._reaggregateAnnotation(t.event_id,t.key,r,i)):null}async _reaggregateAnnotation(e,t,r,s){const i=await r.timelineEvents.getByEventId(this._roomId,e);if(!i||!i.annotations)return null;s.set("id",e);const o=await r.timelineRelations.getForTargetAndType(this._roomId,e,ln);return s.set("relations",o.length),delete i.annotations[t],dE(i.annotations)&&delete i.annotations,await Promise.all(o.map(async a=>{const l=await r.timelineEvents.getByEventId(this._roomId,a.sourceEventId);l||s.log({l:"missing annotation",id:a.sourceEventId}),Ht(l.event).key===t&&this._aggregateAnnotation(l.event,i,s)})),i}}function dE(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class Dt{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Dt.Backward:Dt.Forward}static get Forward(){return hE}static get Backward(){return pE}}const hE=new Dt(!0),pE=new Dt(!1);class nt extends Um{constructor(e,t,r){super(r);this._fragment=e,this._isFragmentStart=t}static start(e,t){return new nt(e,!0,t)}static end(e,t){return new nt(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?Z.minStorageKey:Z.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return nc(this.linkedFragmentId)}get direction(){return this.started?Dt.Backward:Dt.Forward}withUpdatedFragment(e){return new nt(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new nt(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function fE(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class mE{constructor({roomId:e,fragmentIdComparer:t,memberWriter:r,relationWriter:s}){this._roomId=e,this._memberWriter=r,this._relationWriter=s,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const r=await e.timelineFragments.liveFragment(this._roomId);if(r){const[s]=await e.timelineEvents.lastEvents(this._roomId,r.id,1),i=s?s.eventIndex:ie.defaultLiveKey.eventIndex;this._lastLiveKey=new ie(r.id,i)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const r=await e.timelineFragments.liveFragment(this._roomId);if(r)return r;{t||(t=null);const s={roomId:this._roomId,id:ie.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(s),this._fragmentIdComparer.add(s),s}}async _replaceLiveFragment(e,t,r,s){const i=await s.timelineFragments.get(this._roomId,e);if(!i)throw new Error(`old live fragment doesn't exist: ${e}`);i.nextId=t,s.timelineFragments.update(i);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:r,nextToken:null};return s.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:i,newFragment:o}}async _ensureLiveFragment(e,t,r,s,i){if(e){if(r.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:l}=await this._replaceLiveFragment(o,e.fragmentId,r.prev_batch,s);t.push(nt.end(a,this._fragmentIdComparer)),t.push(nt.start(l,this._fragmentIdComparer)),i.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(s,r.prev_batch);e=new ie(o.id,ie.defaultLiveKey.eventIndex),t.push(nt.start(o,this._fragmentIdComparer)),i.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,r){let s=0;for(const i of e)i.type!==We&&(t.roomState.set(this._roomId,i),s+=1);r.set("stateEvents",s)}async _writeTimeline(e,t,r,s,i,o){const a=[],l=[];if(e!=null&&e.length){s=await this._ensureLiveFragment(s,a,t,i,o),o.set("timelineEvents",e.length);let u=0;for(const c of e){s=s.nextKey();const d=im(s,this._roomId,c);let h=await r.lookupMemberAtEvent(c.sender,c,i);if(h&&(d.displayName=h.displayName,d.avatarUrl=h.avatarUrl),!await i.timelineEvents.tryInsert(d,o))continue;const v=new ze(d,this._fragmentIdComparer);a.push(v);const S=await this._relationWriter.writeRelation(v,i,o);S&&l.push(...S),typeof c.state_key=="string"&&c.type!==We&&(u+=1,i.roomState.set(this._roomId,c))}o.set("timelineStateEventCount",u)}return{currentKey:s,entries:a,updatedEntries:l}}async _handleRejoinOverlap(e,t,r){if(this._lastLiveKey){const{fragmentId:s}=this._lastLiveKey,[i]=await t.timelineEvents.lastEvents(this._roomId,s,1);if(i){const o=i.event.event_id,{events:a}=e,l=a.findIndex(u=>u.event_id===o);if(l!==-1)return r.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(l+1)})}}return e.limited?e:(r.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,r,s,i){let{timeline:o}=e;i.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,s,i));let a;Array.isArray(o==null?void 0:o.events)&&(a=fE(o.events));const{state:l}=e;let u;Array.isArray(l==null?void 0:l.events)&&(u=l.events);const c=this._memberWriter.prepareMemberSync(u,a,r);u&&await this._writeStateEvents(u,s,i);const{currentKey:d,entries:h,updatedEntries:g}=await this._writeTimeline(a,o,c,this._lastLiveKey,s,i),v=await c.write(s);return{entries:h,updatedEntries:g,newLiveKey:d,memberChanges:v}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class Vm{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let r=t?this._entries.findIndex(t):-1;this._entries.unshift(e),r===-1?this._entries.length>this.limit&&(r=this._entries.length-1):r+=1,r!==-1&&(this.onEvictEntry(this._entries[r]),this._entries.splice(r,1))}onEvictEntry(e){}}class _E extends Vm{constructor(e,t){super(e);this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,r=>this._keyFn(r)===t)}}class gE{constructor(e){this._roomId=e,this._cache=new _E(5,t=>t.userId)}prepareMemberSync(e,t,r){return new yE(this,e,t,r)}async _writeMember(e,t){let r=this._cache.get(e.userId);if(!r){const s=await t.roomMembers.get(this._roomId,e.userId);s&&(r=new Y(s))}if(!r||!r.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new am(e,r==null?void 0:r.membership)}async lookupMember(e,t){let r=this._cache.get(e);if(!r){const s=await t.roomMembers.get(this._roomId,e);s&&(r=new Y(s),this._cache.set(r))}return r}}class yE{constructor(e,t,r,s){this._memberWriter=e,this._timelineEvents=r,this._hasFetchedMembers=s,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const r of e)if(r.type===We){const s=Y.fromMemberEvent(this._roomId,r);s&&(t||(t=new Map),t.set(s.userId,s))}return t}_timelineEventsToMembers(e){let t;for(let r=e.length-1;r>=0;r--){const s=e[r],i=s.state_key;if(s.type===We&&!(t!=null&&t.has(i))){const o=Y.fromMemberEvent(this._roomId,s);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,r){var s;let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)||(i=(s=this._newStateMembers)==null?void 0:s.get(e),i)?i:await this._memberWriter.lookupMember(e,r)}async write(e){const t=new Map;let r;if(this._timelineEvents&&(r=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const s of this._newStateMembers.values())if(!(r!=null&&r.has(s.userId))){const i=await this._memberWriter._writeMember(s,e);i&&(!this._hasFetchedMembers&&!i.previousMembership&&(i.previousMembership=s.membership),t.set(i.userId,i))}}if(r)for(const s of r.values()){const i=await this._memberWriter._writeMember(s,e);i&&t.set(i.userId,i)}return t}_findPrecedingMemberEventInTimeline(e,t){let r=-1;for(let s=this._timelineEvents.length-1;s>=0;s--)if(this._timelineEvents[s].event_id===t.event_id){r=s;break}for(let s=r-1;s>=0;s--){const i=this._timelineEvents[s];if(i.type===We&&i.state_key===e){const o=Y.fromMemberEvent(this._roomId,i);if(o)return o}}}}class vE{constructor({roomId:e,storage:t,fragmentIdComparer:r,relationWriter:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=r,this._relationWriter=s}async _findOverlappingEvents(e,t,r,s){const i=t.map(u=>u.event_id),o=await r.timelineEvents.getEventKeysForIds(this._roomId,i);s.set("existingEvents",o.size);const a=t.filter(u=>!o.has(u.event_id));s.set("nonOverlappingEvents",a.length);let l;if(e.hasLinkedFragment){s.set("linkedFragmentId",e.linkedFragmentId);for(const u of o.values())if(u.fragmentId===e.linkedFragmentId){s.set("foundLinkedFragment",!0);const c=await r.timelineFragments.get(this._roomId,e.linkedFragmentId);l=e.createNeighbourEntry(c);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:l}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:r,direction:s}=e,i=await this._findFragmentEdgeEvent(r,s,t);return i?new ie(i.fragmentId,i.eventIndex):ie.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,r){if(t.isBackward){const[s]=await r.timelineEvents.firstEvents(this._roomId,e,1);return s}else{const[s]=await r.timelineEvents.lastEvents(this._roomId,e,1);return s}}async _storeEvents(e,t,r,s,i,o){const a=[],l=[];let u=t;for(let c=0;c<e.length;++c){const d=e[c];u=u.nextKeyForDirection(r);const h=im(u,this._roomId,d),g=this._findMember(d.sender,s,e,c,r);g&&(h.displayName=g.displayName,h.avatarUrl=g.avatarUrl);const v=await this._relationWriter.writeGapRelation(h,r,i,o);if(v&&l.push(...v),await i.timelineEvents.tryInsert(h,o)){const S=new ze(h,this._fragmentIdComparer);Ps(a,S,r)}}return{entries:a,updatedEntries:l}}_findMember(e,t,r,s,i){function o(u){return u.type===We&&u.state_key===e}const a=i.isBackward?1:-1;for(let u=s+a;u>=0&&u<r.length;u+=a){const c=r[u];if(o(c))return Y.fromMemberEvent(this._roomId,c)}for(let u=s;u>=0&&u<r.length;u-=a){const c=r[u];if(o(c))return Y.fromReplacingMemberEvent(this._roomId,c)}const l=t==null?void 0:t.find(o);if(l)return Y.fromMemberEvent(this._roomId,l)}async _updateFragments(e,t,r,s,i,o){const{direction:a}=e,l=[];return Ps(s,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,i.timelineFragments.update(t.fragment),Ps(s,t,a),l.push(e.fragment),l.push(t.fragment)):e.token=r,i.timelineFragments.update(e.fragment),l}async writeFragmentFill(e,t,r,s){const{fragmentId:i,direction:o}=e,{chunk:a,start:l,state:u}=t;let{end:c}=t;if(!Array.isArray(a))throw new Error("Invalid chunk in response");if(typeof c!="string")throw new Error("Invalid end token in response");const d=await r.timelineFragments.get(this._roomId,i);if(!d)throw new Error(`Unknown fragment: ${i}`);if(e=e.withUpdatedFragment(d),e.token!==l)throw new Error("start is not equal to prev_batch or next_batch");if(a.length===0)return e.edgeReached=!0,await r.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let h=await this._findFragmentEdgeEventKey(e,r);s.set("lastKey",h.toString());const{nonOverlappingEvents:g,neighbourFragmentEntry:v}=await this._findOverlappingEvents(e,a,r,s),{entries:S,updatedEntries:f}=await this._storeEvents(g,h,o,u,r,s),p=await this._updateFragments(e,v,c,S,r,s);return{entries:S,updatedEntries:f,fragments:p}}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function un(n,e,t){let r=0,s=n.length;for(;r<s;){let i=r+s>>>1,o=t(e,n[i]);o>0?r=i+1:o<0?s=i:r=s=i}return s}class ci extends Hu{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let r of this._handlers)r.onAdd(e,t)}emitUpdate(e,t,...r){for(let s of this._handlers)s.onUpdate(e,t,...r)}emitRemove(e,t){for(let r of this._handlers)r.onRemove(e,t)}[Symbol.iterator](){throw new Error("unimplemented")}get size(){throw new Error("unimplemented")}get(e){throw new Error("unimplemented")}}class Os extends ci{constructor(e){super();this._values=new Map(e)}update(e,t){const r=this._values.get(e);return r!==void 0?(this._values.set(e,r),this.emitUpdate(e,r,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class wE extends jr{constructor(e,t){super();this._sourceMap=e,this._comparator=(r,s)=>t(r.value,s.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const r={key:e,value:t},s=un(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(s,0,r),this.emitAdd(s,t)}onRemove(e,t){const r={key:e,value:t},s=un(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(s,1),this.emitRemove(s,t)}onUpdate(e,t,r){if(!this._sortedPairs)return;const s=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(s,1);const i={key:e,value:t},o=un(this._sortedPairs,i,this._comparator);this._sortedPairs.splice(o,0,i),s!==o&&this.emitMove(s,o,t),this.emitUpdate(o,t,r)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,r]of this._sourceMap)this._sortedPairs[e]={key:t,value:r},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class SE extends ci{constructor(e,t){super();this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[r,s]of this._source){const i=this._filter(s,r);if(this._included.set(r,i),!e){const o=t?t.get(r):!0;this._emitForUpdate(o,i,r,s)}}}else{if(this._included&&!e)for(const[t,r]of this._source)this._included.get(t)||this.emitAdd(t,r);this._included=null}}onAdd(e,t){if(this._filter){const r=this._filter(t,e);if(this._included.set(e,r),!r)return}this.emitAdd(e,t)}onRemove(e,t){const r=!this._filter||this._included.get(e);this._included.delete(e),r&&this.emitRemove(e,t)}onUpdate(e,t,r){if(!!this._included)if(this._filter){const s=this._included.get(e),i=this._filter(t,e);this._included.set(e,i),this._emitForUpdate(s,i,e,t,r)}else this.emitUpdate(e,t,r)}_emitForUpdate(e,t,r,s,i=null){e&&!t?this.emitRemove(r,s):!e&&t?this.emitAdd(r,s):e&&t&&this.emitUpdate(r,s,i)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new bE(this._source,this._included)}get size(){let e=0;return this._included.forEach(t=>{t&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class bE{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included.get(t))return e}}}class EE extends ci{constructor(e,t,r){super();this._source=e,this._mapper=t,this._updater=r,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const r=this._mappedValues.get(e);r&&this.emitUpdate(e,r,t)}onAdd(e,t){const r=this._emitSpontaneousUpdate.bind(this,e),s=this._mapper(t,r);this._mappedValues.set(e,s),this.emitAdd(e,s)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,r){var s;if(!this._mappedValues)return;const i=this._mappedValues.get(e);i!==void 0&&((s=this._updater)==null||s.call(this,i,r,t),this.emitUpdate(e,i,r))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const r=this._emitSpontaneousUpdate.bind(this,e),s=this._mapper(t,r);this._mappedValues.set(e,s)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class IE extends ci{constructor(e){super();this._sources=e,this._subscriptions=null}onAdd(e,t,r){if(!this._isKeyAtSourceOccluded(e,t)){const s=this._getValueFromOccludedSources(e,t);s!==void 0&&this.emitRemove(t,s),this.emitAdd(t,r)}}onRemove(e,t,r){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,r);const s=this._getValueFromOccludedSources(e,t);s!==void 0&&this.emitAdd(t,s)}}onUpdate(e,t,r,s){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,r,s)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new CE(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const r=this._sources.indexOf(e);for(let s=0;s<r;s+=1)if(this._sources[s].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const r=this._sources.indexOf(e);for(let s=r+1;s<this._sources.length;s+=1){const o=this._sources[s].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){super.onUnsubscribeLast();for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new kE(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const r=t.get(e);if(r)return r}return null}}class kE{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator.next();if(t.done){this._currentIterator=null;continue}else{const r=t.value[0];this._encounteredKeys.has(r)||(this._encounteredKeys.add(r),e=t)}}return e}}class CE{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,r){this._joinedMap.onUpdate(this._source,e,t,r)}onReset(){this._joinedMap.onReset(this._source)}}function $m(n,e,t,r){const s=e.findIndex(n);if(s!==-1){const i=e[s],o=r(i);return o!==!1&&t.emitUpdate(s,i,o),!0}return!1}class jm extends jr{constructor(e){super();this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return $m(e,this._items,this,t)}getAndUpdate(e,t,r=null){const s=this.indexOf(e);if(s!==-1){const i=this._items[s],o=t(i,e);this._items[s]=o,this.emitUpdate(s,o,r)}}update(e,t=null){const r=this.indexOf(e);r!==-1&&(this._items[r]=e,this.emitUpdate(r,e,t))}indexOf(e){const t=un(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=un(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const r=un(this._items,e,this._comparator);r>=this._items.length||this._comparator(this._items[r],e)!==0?(this._items.splice(r,0,e),this.emitAdd(r,e)):(this._items[r]=e,this.emitUpdate(r,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new RE(this)}}class RE{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}}class AE extends jr{constructor(e,t,r,s){super();this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=r,this._removeCallback=s}findAndUpdate(e,t){return $m(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function TE(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function xE(n,e,t,r){const s=n._mappedValues[e];n._updater&&n._updater(s,r,t),n.emitUpdate(e,s,r)}function NE(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function ME(n,e,t){const r=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,r),n.emitMove(e,t,r)}function PE(n){n._mappedValues=[],n.emitReset()}class DE extends AE{constructor(){super(...arguments);this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new Mh(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new FE),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new Mh(e,t)),this._flush())}onUpdate(e,t,r){this._eventQueue&&(this._eventQueue.push(new LE(e,t,r)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new OE(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new UE(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class Mh{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);TE(e,this.index,t)}}class LE{constructor(e,t,r){this.index=e,this.value=t,this.params=r}async run(e){xE(e,this.index,this.value,this.params)}}class OE{constructor(e){this.index=e}async run(e){NE(e,this.index)}}class UE{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){ME(e,this.fromIdx,this.toIdx)}}class FE{async run(e){PE(e)}}class KE extends jr{constructor(...e){super();this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let r=0;for(let s=0;s<t;++s)r+=this._sourceLists[s].length;return r}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,r){this.emitAdd(this._offsetForSource(r)+e,t)}onUpdate(e,t,r,s){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(s)+e,t,r)}onRemove(e,t,r){this.emitRemove(this._offsetForSource(r)+e,t)}onMove(e,t,r,s){const i=this._offsetForSource(s);this.emitMove(i+e,i+t,r)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let r=t.next();for(;r.done;){if(e+=1,e>=this._sourceLists.length)return r;t=this._sourceLists[e][Symbol.iterator](),r=t.next()}return r}}}}Object.assign(ci.prototype,{sortValues(n){return new wE(this,n)},mapValues(n,e){return new EE(this,n,e)},filterValues(n){return new SE(this,n)},join(...n){return new IE([this].concat(n))}});class Ph{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function BE(n,e,t,r,s,i){let o=[];const a=i.timelineEvents,l=i.timelineFragments;for(;o.length<r&&e;){let u;t.isForward?u=await a.eventsAfter(n,e,r):u=await a.eventsBefore(n,e,r);let c=u.map(d=>new ze(d,s));if(o=_v(o,c,t),o.length<r){const d=await l.get(n,e.fragmentId);let h=new nt(d,t.isBackward,s);if(Ps(o,h,t),!h.token&&h.hasLinkedFragment){const g=await l.get(n,h.linkedFragmentId);s.add(g);const v=new nt(g,t.isForward,s);Ps(o,v,t),e=v.asEventKey()}else e=null}}return o}class Wm{constructor({roomId:e,storage:t,fragmentIdComparer:r}){this._roomId=e,this._storage=t,this._fragmentIdComparer=r,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,r,s){return new Ph(async(i,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,r,i,a,o)},s)}readFromEnd(e,t=null,r){return new Ph(async(s,i)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let l;if(!a)l=[];else{this._fragmentIdComparer.add(a);const u=nt.end(a,this._fragmentIdComparer),c=u.asEventKey();l=await this._readFrom(c,Dt.Backward,e,s,o,i),l.unshift(u)}return l},r)}async readById(e,t){let r=[this._storage.storeNames.timelineEvents];this._decryptEntries&&r.push(this._storage.storeNames.inboundGroupSessions);const s=await this._storage.readTxn(r),i=await s.timelineEvents.getByEventId(this._roomId,e);if(i){const o=new ze(i,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],s,t).complete(),o}}async _readFrom(e,t,r,s,i,o){const a=await BE(this._roomId,e,t,r,this._fragmentIdComparer,i);if(this._decryptEntries){s.decryptRequest=this._decryptEntries(a,i,o);try{await s.decryptRequest.complete()}finally{s.decryptRequest=null}}return a}}class VE extends ze{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class $E{constructor(e){this._userId=e}get id(){return this._userId}}class Fo{constructor({roomId:e,storage:t,closeCallback:r,fragmentIdComparer:s,pendingEvents:i,clock:o,powerLevelsObservable:a,hsApi:l}){this._roomId=e,this._storage=t,this._closeCallback=r,this._fragmentIdComparer=s,this._disposables=new ec,this._pendingEvents=i,this._clock=o,this._remoteEntries=new jm((u,c)=>u.compare(c)),this._ownMember=null,this._timelineReader=new Wm({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=l,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,r){const s=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),i=await s.roomMembers.get(this._roomId,e.id);i?this._ownMember=new Y(i):this._ownMember=Y.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,s,r));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new DE(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,r)=>{t.notifyUpdate(r)},t=>this._applyAndEmitLocalRelationChange(t,r=>r.removeLocalRelation(t))):this._localEntries=new RS,this._allEntries=new KE(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===pt&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const r=new tE({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([r]),this._applyAndEmitLocalRelationChange(r,s=>s.addLocalRelation(r)),r}_applyAndEmitLocalRelationChange(e,t){var r,s;const i=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,i),e.redactingEntry){const o=(r=e.redactingEntry.pendingEvent)==null?void 0:r.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,i),(s=e.redactingEntry.contextForEntries)==null||s.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,r){let s=!1;e&&(s=this._localEntries.findAndUpdate(i=>i.id===e,r)),!s&&t&&this._remoteEntries.findAndUpdate(i=>i.id===t,r)}async getOwnAnnotationEntry(e,t){const r=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),s=await r.timelineRelations.getForTargetAndType(this._roomId,e,ln);for(const i of s){const o=await r.timelineEvents.getByEventId(this._roomId,i.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&Ht(o.event).key===t){const a=new ze(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)!=null&&t.hasSubscriptions))for(const r of this._localEntries){if(r.relatedEventId){const s=e.find(i=>i.id===r.relatedEventId);s==null||s.addLocalRelation(r)}if(r.redactingEntry){const s=r.redactingEntry.relatedEventId,i=e.find(o=>o.id===s);i==null||i.addLocalRelation(r)}}}static _entryUpdater(e,t){var r;return(r=e.contextForEntries)==null||r.forEach(s=>s.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const r of e)try{this._remoteEntries.getAndUpdate(r,Fo._entryUpdater);const s=this._contextEntriesNotInTimeline.get(r.id);s&&(Fo._entryUpdater(s,r),this._contextEntriesNotInTimeline.set(r.id,r)),(t=r.contextForEntries)==null||t.forEach(i=>this._emitUpdateForEntry(i,"contextEntry"))}catch(s){if(s.name==="CompareError")continue;throw s}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const r of e){const s=this._contextEntriesNotInTimeline.get(r.relatedEventId);(s==null?void 0:s.isNonPersisted)&&(s==null?void 0:s.addLocalRelation(r))&&((t=s.contextForEntries)==null||t.forEach(i=>this._emitUpdateForEntry(i,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const r=this._contextEntriesNotInTimeline.get(t.id);r&&(r.contextForEntries.forEach(s=>{s.setContextEntry(t),this._emitUpdateForEntry(s,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const r=e.isPending?e.id:null,s=e.isPending?null:e.id;this._findAndUpdateEntryById(r,s,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const r=t.contextEventId;let s=e.find(i=>i.id===r);s||(s=this._findLoadedEventById(r)),s?t.setContextEntry(s):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let r=await this._getEventFromStorage(t);r||(r=await this._getEventFromHomeserver(t)),r&&(this._contextEntriesNotInTimeline.set(t,r),e.setContextEntry(r),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),r=t.event.sender,s=t.state.find(a=>a.type===We&&a.user_id===r),i={event:t.event,displayName:s.content.displayname,avatarUrl:s.content.avatar_url},o=new VE(i,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(s=>!!s.eventType);if(!t)return!0;const r=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Dt.Backward,e));try{const s=await r.complete();return this.addEntries(s),s.length<e}finally{this._disposables.disposeTracked(r)}}async _getOrLoadEntry(e,t){var r;if(e){for(const s of this._localEntries)if(s.id===e)return s}return t?(r=this.getByEventId(t))!=null?r:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const r=this._remoteEntries.get(t);if(r.id===e)return r}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function jE({roomId:n,storage:e}){return(await(await e.readTxn([e.storeNames.roomMembers])).roomMembers.getAll(n)).map(s=>new Y(s))}async function WE({summary:n,syncToken:e,roomId:t,hsApi:r,storage:s,setChangedMembersMap:i},o){const a=new Map;i(a);const l=await r.members(t,{at:e},{log:o}).response(),u=await s.readWriteTxn([s.storeNames.roomSummary,s.storeNames.roomMembers]);let c,d;try{c=n.writeHasFetchedMembers(!0,u);const{roomMembers:h}=u,g=l.chunk;if(!Array.isArray(g))throw new Error("malformed");o.set("members",g.length),d=await Promise.all(g.map(async v=>{const S=v==null?void 0:v.state_key;if(!S)throw new Error("malformed");const f=a.get(S);if(f)return f;{const p=Y.fromMemberEvent(t,v);return p&&h.set(p.serialize()),p}}))}catch(h){throw u.abort(),h}finally{i(null)}return await u.complete(),n.applyChanges(c),d}async function zE(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?jE(n):e.wrapOrRun(n.log,"fetchMembers",r=>WE(n,r))}async function HE(n,e){const t=await qE(n),{summary:r}=n;return!r.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",s=>GE(n,s)):t}async function qE({roomId:n,userId:e,storage:t}){const s=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return s?new Y(s):null}async function GE({roomId:n,userId:e,hsApi:t,storage:r},s){let i;try{i=await t.state(n,"m.room.member",e,{log:s}).response()}catch(l){if(l.name==="HomeServerError"&&l.errcode==="M_NOT_FOUND")return null;throw l}const o=new Y({roomId:n,userId:e,membership:i.membership,avatarUrl:i.avatar_url,displayName:i.displayname}),a=await r.readWriteTxn([r.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(l){throw a.abort(),l}return await a.complete(),o}class YE{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class QE extends YE{constructor({members:e,closeCallback:t}){super(t);this._members=new Os;for(const r of e)this._members.add(r.userId,r)}afterSync(e){for(const[t,r]of e.entries())this._members.set(t,r.member)}get members(){return this._members}}function jl(n,e,t){const r=e.joinCount+e.inviteCount-1;if(n.length>=r)if(n.length>1){const s=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+s.name}else{const s=n[0];return s?s.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!s,otherMemberMembership:s==null?void 0:s.membership}),"Unknown DM Name")}else return n.length<r?n.map(s=>s.name).join(", ")+` and ${r} others`:null}class rc{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,r){const s=new Map,i=[];for(const o of this._members.keys())e.indexOf(o)===-1&&i.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&s.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!s.has(o)){const a=await r.roomMembers.get(this._roomId,o);if(a){const l=new Y(a);s.set(l.userId,l)}}return{updatedHeroMembers:s.values(),removedUserIds:i}}applyChanges({updatedHeroMembers:e,removedUserIds:t},r,s){for(const o of t)this._members.delete(o);for(const o of e)this._members.set(o.userId,o);const i=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=jl(i,r,s)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class JE{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let r=this._map.get(e);return r||(r=new XE(this,t,e),this._map.set(e,r)),r}updateEvents(e){for(let t=0;t<e.length;t+=1){const r=e[t],s=this._map.get(r.id);s==null||s.update(r)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class XE extends Vr{constructor(e,t,r){super();this._eventMap=e,this._entry=t,this._id=r,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function ZE(n){return n||dv.item}const eI="m.room.power_levels";class so{constructor({powerLevelEvent:e,createEvent:t,ownUserId:r,membership:s}){this._plEvent=e,this._createEvent=t,this._ownUserId=r,this._membership=s}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,r,s,i;if(this._plEvent){let o=(r=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:r[e];if(typeof o!="number"&&(o=(s=this._plEvent.content)==null?void 0:s.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((i=this._createEvent.content)==null?void 0:i.creator))return 100;return 0}_getActionLevel(e){var t;const r=(t=this._plEvent)==null?void 0:t.content[e];return typeof r=="number"?r:50}_getEventTypeLevel(e){var t,r,s;const i=(r=(t=this._plEvent)==null?void 0:t.content.events)==null?void 0:r[e];if(typeof i=="number")return i;{const o=(s=this._plEvent)==null?void 0:s.content.events_default;return typeof o=="number"?o:0}}}const tI="m.room.encrypted";class zm extends ra{constructor({roomId:e,storage:t,hsApi:r,mediaRepository:s,emitCollectionChange:i,user:o,createRoomEncryption:a,getSyncToken:l,platform:u}){super();this._roomId=e,this._storage=t,this._hsApi=r,this._mediaRepository=s,this._summary=new Hb(e),this._fragmentIdComparer=new cE([]),this._emitCollectionChange=i,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=l,this._platform=u,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){const r=[];return await Promise.all(e.map(async s=>{const i=await t.timelineEvents.getByEventId(this._roomId,s);i&&r.push(new ze(i,this._fragmentIdComparer))})),r}_getAdditionalTimelineRetryEntries(e,t){let r=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const s=e.reduce((i,o)=>(i.add(o.id),i),new Set);return r=r.filter(i=>!s.has(i.id)),r}async notifyRoomKey(e,t,r){var s;if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let o=await this._eventIdsToEntries(t,i);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(o,[e]);o=o.concat(a)}if(o.length){await this._decryptEntries(Ln.Retry,o,i,r).complete(),(s=this._timeline)==null||s.replaceEntries(o);const l=this._summary.data.applyTimelineEntries(o,!1,!1);await this._summary.writeAndApplyData(l,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Ln.Timeline)),!0):!1}_decryptEntries(e,t,r,s=null){return new nI(async(o,a)=>{if(r||(r=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const l=t.filter(v=>v.eventType===tI).map(v=>v.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(l,null,e,r),o.cancelled)return;const u=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const c=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&c.push(this._storage.storeNames.deviceIdentities);const h=await this._storage.readWriteTxn(c);let g;try{g=await u.write(h,a),d&&await g.verifySenders(h)}catch(v){throw h.abort(),v}await h.complete(),g.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)},ZE(s))}async _getSyncRetryDecryptEntries(e,t,r){let i=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,r);if(a)return this._eventIdsToEntries(a,r)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(i,e).map(l=>l.clone());i=i.concat(a)}return i}async load(e,t,r){r.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const s=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(s)}if(this._summary.data.needsHeroes){this._heroes=new rc(this._roomId);const s=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(s,this._summary.data,r)}}catch(s){throw new Yf(`Could not load room ${this._roomId}`,s)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const r=await HE({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!r)return null;const s=new Ll(r,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,s),s}async loadMemberList(e=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const t=await zE({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,syncToken:this._getSyncToken(),setChangedMembersMap:r=>this._changedMembersDuringSync=r,log:e},this._platform.logger);return this._memberList=new QE({members:t,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,r=null){return this._platform.logger.wrapOrRun(r,"fillGap",async s=>{if(s.set("id",this.id),s.set("fragment",e.fragmentId),s.set("dir",e.direction.asApiString()),e.edgeReached){s.set("edgeReached",!0);return}const i=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:s}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,l;try{a=await this._writeGapFill(i.chunk,o,s);const u=new Bm({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});l=await new vE({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:u}).writeFragmentFill(e,i,o,s)}catch(u){throw o.abort(),u}await o.complete(),this._roomEncryption&&await this._decryptEntries(Ln.Timeline,l.entries,null,s).complete();for(const u of l.fragments)this._fragmentIdComparer.add(u);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(l.updatedEntries),this._timeline.addEntries(l.entries))})}async _writeGapFill(e,t,r){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:r,inviteCount:s}=this._summary.data;if(t&&t.includes(e)&&r+s===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new so({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const r=await e.roomState.get(this._roomId,"m.room.create","");if(r)return new so({createEvent:r.event,ownUserId:this._user.id,membership:this.membership});{const s=this.membership;return new so({ownUserId:this._user.id,membership:s})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new Ll(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",r=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,r))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new Fo({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Ln.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(r){throw this._timeline.dispose(),r}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new JE(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const r=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(s=>{r.update(s)}).catch(s=>{console.warn(`could not load event ${e} from storage`,s)}),r}async _readEventById(e){return await new Wm({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e,t;(e=this._roomEncryption)==null||e.dispose(),(t=this._timeline)==null||t.dispose()}}class nI{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",r=>e(this,r))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function Ko(){const e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function Dh(n){return n.startsWith("t")&&n.length===15}class rI{constructor({roomId:e,storage:t,hsApi:r,pendingEvents:s}){s=s||[],this._roomId=e,this._storage=t,this._hsApi=r,this._pendingEvents=new jm((i,o)=>i.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(s.map(i=>this._createPendingEvent(i))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const r=new nE({data:e,remove:()=>this._removeEvent(r),emitUpdate:s=>this._pendingEvents.update(r,s),attachments:t});return r}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const r of this._pendingEvents)await t.wrap("send event",async s=>{s.set("queueIndex",r.queueIndex);try{this._currentQueueIndex=r.queueIndex,await this._sendEvent(r,s)}catch(i){i instanceof on?(this._offline=!0,s.set("offline",!0),r.setWaiting()):(s.catch(i),i.name==="HomeServerError"&&(i.statusCode===400||i.statusCode===403||i.statusCode===404)?(s.set("remove",!0),await r.abort()):r.setError(i))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",r=>e.uploadAttachments(this._hsApi,r)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const r=e.contentForEncryption,{type:s,content:i}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,r,this._hsApi,o));e.setEncrypted(s,i),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const r=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,r),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,r)}catch(s){throw r.abort(),s}await r.complete()}}async _resolveRemoteIdInPendingRelations(e,t,r){const s=this._pendingEvents.array.filter(i=>i.relatedTxnId===e&&i.relatedEventId!==t);for(const i of s)i.setRelatedEventId(t),await this._tryUpdateEventWithTxn(i,r);return s}async removeRemoteEchos(e,t,r){const s=[];for(const i of e){const o=i.unsigned&&i.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(l=>l.txnId===o):a=this._pendingEvents.array.findIndex(l=>l.remoteId===i.event_id),a!==-1){const l=this._pendingEvents.get(a),u=i.event_id;r.log({l:"removeRemoteEcho",queueIndex:l.queueIndex,remoteId:u,txnId:o}),t.pendingEvents.remove(l.roomId,l.queueIndex),s.push(l),await this._resolveRemoteIdInPendingRelations(o,u,t)}}return s}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const r=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{r.pendingEvents.remove(e.roomId,e.queueIndex)}catch{r.abort()}await r.complete();const s=this._pendingEvents.array.indexOf(e);s!==-1&&this._pendingEvents.remove(s)}e.dispose()}emitRemovals(e){for(const t of e){const r=this._pendingEvents.array.indexOf(t);r!==-1&&this._pendingEvents.remove(r),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,r,s){const i=mn(t);let o=null;if(i){const a=tc(i);if(Dh(a)&&(o=a,Fm(i,null)),i.rel_type===ln&&this._pendingEvents.array.some(u=>{const c=mn(u.content);return u.eventType===e&&c&&c.key===i.key&&(u.relatedTxnId===o||c.event_id===i.event_id)})){s.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,r,o,null,s)}async _enqueueEvent(e,t,r,s,i,o){const a=await this._createAndStoreEvent(e,t,s,i,r);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,r){if(this._pendingEvents.array.some(a=>a.eventType===pt&&(a.relatedTxnId===e||a.relatedEventId===e))){r.set("already_redacting",!0);return}let i,o;if(Dh(e)){i=e;const a=e,l=this._pendingEvents.array.find(u=>u.txnId===a);if(l&&!l.remoteId&&l.status!==W.Sending){r.set("remove",i),await l.abort();return}else if(l)o=l.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(l=>l.remoteId===o);a&&(i=a.txnId)}r.set("relatedTxnId",i),r.set("relatedEventId",o),await this._enqueueEvent(pt,{reason:t},null,i,o,r)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(r){throw t.abort(),r}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,r,s,i){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const l=o.pendingEvents,u=await l.getMaxQueueIndex(this._roomId)||0,d=Math.max(u,this._currentQueueIndex)+1,h=e!==pt&&e!==qb&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:r,relatedEventId:s,txnId:Ko(),needsEncryption:h,needsUpload:!!i},i),l.add(a.data)}catch(l){throw o.abort(),l}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class Hm{constructor({filename:e,blob:t,platform:r}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=r,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await Nb(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,r){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:i=>{this._sentBytes=i,t()},log:r});const{content_uri:s}=await this._uploadRequest.response();this._mxcUrl=s}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let r=e.substr(0,e.lastIndexOf("url"));Wi(`${r}info.size`,t,this._transferredBlob.size),Wi(`${r}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?Wi(`${r}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):Wi(`${r}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function Wi(n,e,t){const r=n.split(".");let s=e;for(let o=0;o<r.length-1;o+=1){const a=r[o];s[a]||(s[a]={}),s=s[a]}const i=r[r.length-1];s[i]=t}const sI="m.room.encrypted";class iI extends zm{constructor(e){super(e);const{pendingEvents:t}=e,r=new Bm({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new mE({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:r,memberWriter:new gE(this.id)}),this._sendQueue=new rI({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,r,s,i){var o;i.set("id",this.id),r&&i.set("newKeys",r.length);let a=this._summary.data.applySyncResponse(e,t,this._user.id),l=this._roomEncryption;!l&&a.encryption&&(i.set("enableEncryption",!0),l=this._createRoomEncryption(this,a.encryption));let u,c;if(l){let d=((o=e==null?void 0:e.timeline)==null?void 0:o.events)||[];r&&(u=await this._getSyncRetryDecryptEntries(r,l,s),u.length&&(i.set("retry",u.length),d=d.concat(u.map(h=>h.event)))),d=d.filter(h=>(h==null?void 0:h.type)===sI),d.length&&(c=await l.prepareDecryptAll(d,r,Ln.Sync,s))}return{roomEncryption:l,summaryChanges:a,decryptPreparation:c,decryptChanges:null,retryEntries:u}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async r=>{r.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:r,decryptChanges:s,roomEncryption:i,retryEntries:o},a,l){var u;l.set("id",this.id);const c=r.isNewJoin(this._summary.data);c&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:d,updatedEntries:h,newLiveKey:g,memberChanges:v}=await l.wrap("syncWriter",y=>this._syncWriter.writeSync(e,c,r.hasFetchedMembers,a,y),l.level.Detail);if(s){const y=await l.wrap("decryptChanges",T=>s.write(a,T));l.set("decryptionResults",y.results.size),l.set("decryptionErrors",y.errors.size),this._isTimelineOpen&&await y.verifySenders(a),y.applyToEntries(d),o!=null&&o.length&&(y.applyToEntries(o),h.push(...o))}l.set("newEntries",d.length),l.set("updatedEntries",h.length);let S=!1;i&&this.isTrackingMembers&&(v==null?void 0:v.size)&&(S=await i.writeMemberChanges(v,a,l),l.set("shouldFlushKeyShares",S));const f=d.concat(h);r=r.applyTimelineEntries(f,t,!this._isTimelineOpen,this._user.id),r.membership!=="join"?a.roomSummary.remove(this.id):r=this._summary.writeData(r,a),r&&l.set("summaryChanges",r.changedKeys(this._summary.data));let p;r!=null&&r.needsHeroes&&(this._heroes||(this._heroes=new rc(this._roomId)),p=await this._heroes.calculateChanges(r.heroes,v,a));let m;Array.isArray((u=e.timeline)==null?void 0:u.events)&&(m=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,l));const w=this._getPowerLevelsEvent(e);return{summaryChanges:r,roomEncryption:i,newEntries:d,updatedEntries:h,newLiveKey:g,removedPendingEvents:m,memberChanges:v,heroChanges:p,powerLevelsEvent:w,shouldFlushKeyShares:S}}afterSync(e,t){const{summaryChanges:r,newEntries:s,updatedEntries:i,newLiveKey:o,removedPendingEvents:a,memberChanges:l,powerLevelsEvent:u,heroChanges:c,roomEncryption:d}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),l.size){if(this._changedMembersDuringSync)for(const[g,v]of l.entries())this._changedMembersDuringSync.set(g,v.member);if(this._memberList&&this._memberList.afterSync(l),this._observedMembers&&this._updateObservedMembers(l),this._timeline){for(const[g,v]of l.entries())if(g===this._user.id){this._timeline.updateOwnMember(v.member);break}}}let h=!1;if(r&&(this._summary.applyChanges(r),this._summary.data.needsHeroes||(this._heroes=null),h=!0),this._heroes&&c){const g=this.name;this._heroes.applyChanges(c,this._summary.data,t),g!==this.name&&(h=!0)}u&&this._updatePowerLevels(u),h&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(i),this._timeline.addEntries(s)),this._observedEvents&&(this._observedEvents.updateEvents(i),this._observedEvents.updateEvents(s)),a&&this._sendQueue.emitRemovals(a)}_updateObservedMembers(e){for(const[t,r]of e){const s=this._observedMembers.get(t);s&&s.set(r.member)}}_getPowerLevelsEvent(e){var t,r,s;const i=a=>a.state_key===""&&a.type===eI;return(s=(t=e.timeline)==null?void 0:t.events.find(i))!=null?s:(r=e.state)==null?void 0:r.events.find(i)}_updatePowerLevels(e){if(this._powerLevels){const t=new so({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({shouldFlushKeyShares:e}){return e}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){const r=e==null?void 0:e.get("share_room_key");r&&t.wrapDetached("flush room keys",s=>(s.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,r,s)))}this._sendQueue.resumeSending(t)}async load(e,t,r){try{await super.load(e,t,r),await this._syncWriter.load(t,r)}catch(s){throw new Yf(`Could not load room ${this._roomId}`,s)}}async _writeGapFill(e,t,r){return await this._sendQueue.removeRemoteEchos(e,t,r)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,r,s=null){return this._platform.logger.wrapOrRun(s,"send",i=>(i.set("id",this.id),this._sendQueue.enqueueEvent(e,t,r,i)))}sendRedaction(e,t,r=null){return this._platform.logger.wrapOrRun(r,"redact",s=>(s.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,s)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var e;const t=this._syncWriter.lastMessageKey;if(t){const s=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,t);return(e=s==null?void 0:s.event)==null?void 0:e.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let s;try{s=this._summary.writeClearUnread(r)}catch(i){throw r.abort(),i}await r.complete(),this._summary.applyChanges(s),this._emitUpdate();try{const i=await this._getLastEventId();i&&await this._hsApi.receipt(this._roomId,"m.read",i)}catch(i){if(i.name!=="ConnectionError")throw i}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new Hm({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class oI extends zm{constructor(e){super(e);this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const r=await t.roomMembers.get(this.id,e);return r?new Y(r):Y.fromUserId(this.id,e,"join")}async load(e,t,r){const{summary:s,kickDetails:i}=e;return this._kickDetails=i,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(s,t,r)}async writeSync(e,t,r,s,i){if(i.set("id",this.id),r==="leave"){const o=aI(t,this._user.id);if(o||e){const a=o||this._kickDetails;let l;o&&(l=await this._getKickAuthor(o.sender,s));const u=e||this._summary.data;return s.archivedRoomSummary.set({summary:u.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:l,summaryData:u}}}else r==="join"&&s.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:r},s){s.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),r&&(this._kickedBy=r),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const r=this._storage.storeNames,s=await this._storage.readWriteTxn([r.roomState,r.archivedRoomSummary,r.roomMembers,r.timelineEvents,r.timelineFragments,r.timelineRelations,r.pendingEvents,r.inboundGroupSessions,r.groupSessionDecryptions,r.operations]);s.roomState.removeAllForRoom(this.id),s.archivedRoomSummary.remove(this.id),s.roomMembers.removeAllForRoom(this.id),s.timelineEvents.removeAllForRoom(this.id),s.timelineFragments.removeAllForRoom(this.id),s.timelineRelations.removeAllForRoom(this.id),s.pendingEvents.removeAllForRoom(this.id),s.inboundGroupSessions.removeAllForRoom(this.id),s.groupSessionDecryptions.removeAllForRoom(this.id),await s.operations.removeAllForScope(this.id),await s.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function aI(n,e){var t,r;const s=Lm(n,(i,o)=>(o.type===We&&o.state_key===e&&o.sender!==o.state_key&&(i=o),i),null);if(s)return{membership:(t=s.content)==null?void 0:t.membership,reason:(r=s.content)==null?void 0:r.reason,sender:s.sender}}async function lI(n,e,t){const r=await Promise.all(n.map(async s=>{const i=await e.profile(s,{log:t}).response();return new uI(s,i.displayname,i.avatar_url)}));return r.sort((s,i)=>s.name.localeCompare(i.name)),r}class uI{constructor(e,t,r){this.userId=e,this.displayName=t,this.avatarUrl=r}get name(){return this.displayName||this.userId}}class cI{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function dI(n){switch(n){case ft.DirectMessage:case ft.Private:return!0;case ft.Public:return!1}}function hI(n){switch(n){case ft.DirectMessage:return"trusted_private_chat";case ft.Private:return"private_chat";case ft.Public:return"public_chat"}}class pI extends ra{constructor(e,t,r,s,i,o){super();var a;if(this.id=e,this.options=t,this.updateCallback=r,this.mediaRepository=s,this.platform=i,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?dI(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const l={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},u=(t.invites||[]).map(c=>new cI(c));this._calculatedName=jl(u,l,o)}}async create(e,t){try{let r;if(this.options.avatar){const{avatar:o}=this.options,a=new Hm({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),r={info:o.info},a.applyToContent("url",r)}const s={is_direct:this.options.type===ft.DirectMessage,preset:hI(this.options.type),initial_state:[]};this.options.name&&(s.name=this.options.name),this.options.topic&&(s.topic=this.options.topic),this.options.invites&&(s.invite=this.options.invites),this.options.alias&&(s.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(s.creation_content={"m.federate":!1}),this.isEncrypted&&s.initial_state.push(hv()),r&&s.initial_state.push({type:"m.room.avatar",state_key:"",content:r});const i=await e.createRoom(s,{log:t}).response();this._roomId=i.room_id}catch(r){this._error=r}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await lI(this.options.invites,e,t);const r={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=jl(this.profiles,r,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,r;return(r=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?r:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,r,s){if(!this.options.invites||this.options.type!==ft.DirectMessage)return;const i=this.options.invites[0],o="m.direct";await s.wrap("set "+o,async a=>{try{const l=await t.readWriteTxn([t.storeNames.accountData]);let u;try{u=await l.accountData.get(o),u||(u={type:o,content:{}});const c=u.content;let d=c[i];d||(c[i]=d=[]),d.push(this._roomId),l.accountData.set(u),await l.complete()}catch(c){throw l.abort(),c}await r.setAccountData(e.id,o,u.content,{log:a}).response()}catch(l){a.catch(l)}})}}class fI extends ra{constructor({roomId:e,user:t,hsApi:r,mediaRepository:s,emitCollectionRemove:i,emitCollectionUpdate:o,platform:a}){super();this._roomId=e,this._user=t,this._hsApi=r,this._emitCollectionRemove=i,this._emitCollectionUpdate=o,this._mediaRepository=s,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new Y(e.inviter):null}async writeSync(e,t,r,s){var i;if(e==="invite"){s.set("id",this.id),s.set("add",!0);const o=(i=t.invite_state)==null?void 0:i.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let l;!a.name&&!a.canonicalAlias&&(l=await this._createHeroes(o,s));const u=this._getMyInvite(o);if(!u)return null;const c=this._getInviter(u,o),d=this._createData(o,u,c,a,l);return r.invites.set(d),{inviteData:d,inviter:c}}else return s.set("id",this.id),s.set("membership",e),r.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,r,s,i){const o=i?i.roomName:s.name,a=i?i.roomAvatarUrl:s.avatarUrl,l=(i==null?void 0:i.roomAvatarColorId)||this.id;return{roomId:this.id,isEncrypted:!!s.encryption,isDirectMessage:s.isDirectMessage,name:o,avatarUrl:a,avatarColorId:l,canonicalAlias:s.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:r==null?void 0:r.serialize()}}_createSummaryData(e){return e.reduce((t,r)=>Om(t,r,this._user.id),new kt(null,this.id))}async _createHeroes(e,t){const r=e.filter(c=>c.type===We),s=r.filter(c=>c.state_key!==this._user.id),i=s.reduce((c,d)=>{const h=Y.fromMemberEvent(this.id,d);return c.set(h.userId,new am(h,null)),c},new Map),o=s.map(c=>c.state_key),a=new rc(this.id),l=await a.calculateChanges(o,i,null),u=new kt(null,this.id);return u.joinCount=r.reduce((c,d)=>{var h;return c+(((h=d.content)==null?void 0:h.membership)==="join"?1:0)},0),u.inviteCount=r.reduce((c,d)=>{var h;return c+(((h=d.content)==null?void 0:h.membership)==="invite"?1:0)},0),a.applyChanges(l,u,t),a}_getMyInvite(e){return e.find(t=>t.type===We&&t.state_key===this._user.id)}_getInviter(e,t){const r=t.find(s=>s.type===We&&s.state_key===e.sender);if(r)return Y.fromMemberEvent(this.id,r)}_getJoinRule(e){var t;const r=e.find(s=>s.type==="m.room.join_rules");return r?(t=r.content)==null?void 0:t.join_rule:null}}class Tn{constructor(e){this._description=e}static httpPusher(e,t,r,s){return new Tn({kind:"http",append:!0,data:Object.assign({},s,{url:e+"/_matrix/push/v1/notify"}),pushkey:r,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const r=Object.assign({},this._description,{kind:null});await e.setPusher(r,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}function Mr(n,e){return sc(n,e,()=>[],(t,r)=>t.push(r))}function sc(n,e,t,r){return n.reduce((s,i)=>{const o=e(i);let a=s.get(o);return a||(a=t(),s.set(o,a)),r(a,i),s},new Map)}function Lh(n,e){return n.reduce((t,r)=>{const s=e(r);return t[s]?t[s]+=1:t[s]=1,t},{})}class mI{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,r,s){s.set("messageTypes",Lh(e,a=>a.type));const i=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){s.log("can't decrypt, encryption not enabled",s.level.Warn);return}const o=i.filter(a=>{var l;return((l=a.content)==null?void 0:l.algorithm)===Yu});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,r);s.set("decryptedTypes",Lh(a.results,u=>{var c;return(c=u.event)==null?void 0:c.type}));for(const u of a.errors)s.child("decrypt_error").catch(u);const l=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,s);return new _I(a,l)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),(await Promise.all(e.newRoomKeys.map(s=>this._megolmDecryption.writeRoomKey(s,t)))).some(s=>!!s)}}class _I{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=Mr(t,r=>r.roomId)}}const vs=$e+"olmAccount",Wl=$e+"areDeviceKeysUploaded",io=$e+"serverOTKCount";async function Oh(n,e,t,r,s){const i=n.pickle(e),o=await s.readWriteTxn([s.storeNames.session]);try{o.session.add(vs,i),o.session.add(Wl,t),o.session.add(io,r)}catch(a){throw o.abort(),a}await o.complete()}class Vn{static async load({olm:e,pickleKey:t,hsApi:r,userId:s,deviceId:i,olmWorker:o,txn:a}){const l=await a.session.get(vs);if(l){const u=new e.Account,c=await a.session.get(Wl);u.unpickle(t,l);const d=await a.session.get(io);return new Vn({pickleKey:t,hsApi:r,account:u,userId:s,deviceId:i,areDeviceKeysUploaded:c,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:r,hsApi:s,userId:i,olmWorker:o,storage:a}){const l=t.adoptUnpickledOlmAccount(),u=JSON.parse(l.one_time_keys()),d=Object.entries(u.curve25519).length,h=!0;return await Oh(l,r,h,d,a),new Vn({pickleKey:r,hsApi:s,account:l,userId:i,deviceId:t.deviceId,areDeviceKeysUploaded:h,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:r,userId:s,deviceId:i,olmWorker:o,storage:a}){const l=new e.Account;o?await o.createAccountAndOTKs(l,l.max_number_of_one_time_keys()):(l.create(),l.generate_one_time_keys(l.max_number_of_one_time_keys()));const u=!1,c=0;return a&&await Oh(l,t,u,c,a),new Vn({pickleKey:t,hsApi:r,account:l,userId:s,deviceId:i,areDeviceKeysUploaded:u,serverOTKCount:c,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:r,userId:s,deviceId:i,areDeviceKeysUploaded:o,serverOTKCount:a,olm:l,olmWorker:u}){this._olm=l,this._pickleKey=e,this._hsApi=t,this._account=r,this._userId=s,this._deviceId=i,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=u,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,r){var s;const i=JSON.parse(this._account.one_time_keys()),o=Object.entries(i.curve25519);if(o.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){r.set("identity",!0);const c=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(c)}o.length&&(r.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(o));const l=t?this._deviceId:void 0,u=await this._hsApi.uploadKeys(l,a,{log:r}).response();this._serverOTKCount=(s=u==null?void 0:u.one_time_key_counts)==null?void 0:s.signed_curve25519,r.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,c=>{o.length&&(this._account.mark_keys_as_published(),c==null||c.set(vs,this._account.pickle(this._pickleKey)),c==null||c.set(io,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,c==null||c.set(Wl,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const r=this._account.max_number_of_one_time_keys(),s=Math.floor(r/2);if(this._serverOTKCount<s){const i=JSON.parse(this._account.one_time_keys()),a=Object.entries(i.curve25519).length,l=s-a-this._serverOTKCount;return l>0&&await t.wrap("generate otks",u=>{u.set("max",r),u.set("server",this._serverOTKCount),u.set("unpublished",a),u.set("new",l),u.set("limit",s),this._account.generate_one_time_keys(l),this._updateSessionStorage(e,c=>{c.set(vs,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const r=new this._olm.Session;try{return r.create_inbound_from(this._account,e,t),r}catch(s){throw r.free(),s}}async createOutboundOlmSession(e,t){const r=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,r,e,t):r.create_outbound(this._account,e,t),r}catch(s){throw r.free(),s}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(vs,this._account.pickle(this._pickleKey))}writeSync(e,t,r){const s=e.signed_curve25519;if(Number.isSafeInteger(s)&&s!==this._serverOTKCount)return t.session.set(io,s),r.set("otkCount",s),s}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[Yu,yt],keys:{}};for(const[r,s]of Object.entries(e))t.keys[`${r}:${this._deviceId}`]=s;return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[r,s]of e){const i={key:s};this.signObject(i),t[`signed_curve25519:${r}`]=i}return t}async _updateSessionStorage(e,t){if(e){const r=await e.readWriteTxn([e.storeNames.session]);try{await t(r.session)}catch(s){throw r.abort(),s}await r.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},r=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Wf.stringify(e)),e.signatures=t,r!==void 0&&(e.unsigned=r)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class ic{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const r=this._keyDescription;if(r.mac){const s=await gI(e.binaryKey,r.iv,t);return r.mac===s}else if(r.passphrase){const s=e.description._keyDescription;return s.passphrase?r.passphrase.algorithm===s.passphrase.algorithm&&r.passphrase.iterations===s.passphrase.iterations&&r.passphrase.salt===s.passphrase.salt:!1}}return!1}}class di{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new di(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function gI(n,e,t){const{crypto:r,encoding:s}=t,{utf8:i,base64:o}=s,{derive:a,aes:l,hmac:u}=r,c=o.decode(e),d=new Uint8Array(8),h="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",g=i.encode(""),v=await a.hkdf(n,d,g,"SHA-256",512),S=v.slice(0,32),f=v.slice(32),p=await l.encryptCTR({key:S,iv:c,data:i.encode(h)}),m=await u.compute(f,p,"SHA-256");return o.encode(m)}const yI=5e5,vI=256;async function wI(n,e,t){const{passphraseParams:r}=n;if(!r)throw new Error("not a passphrase key");if(r.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${r.algorithm}`);const{utf8:s}=t.encoding,i=await t.crypto.derive.pbkdf2(s.encode(e),r.iterations||yI,s.encode(r.salt),"SHA-512",r.bits||vI);return new di(n,i)}const cs=[139,1];function SI(n,e,t,r){const s=r.encoding.base58.decode(e.replace(/ /g,""));let i=0;for(const a of s)i^=a;if(i!==0)throw new Error("Incorrect parity");for(let a=0;a<cs.length;++a)if(s[a]!==cs[a])throw new Error("Incorrect prefix");if(s.length!==cs.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(s.slice(cs.length,cs.length+t.PRIVATE_KEY_LENGTH));return new di(n,o)}const oc=`${$e}ssssKey`,Uh=`${$e}keyBackupVersion`;var Fh;(function(n){n[n.RecoveryKey=0]="RecoveryKey",n[n.Passphrase=1]="Passphrase"})(Fh||(Fh={}));async function qm(n){var e;const t=await n.readTxn([n.storeNames.accountData]),r=await t.accountData.get("m.secret_storage.default_key"),s=(e=r==null?void 0:r.content)==null?void 0:e.key;if(!s)return;const i=await t.accountData.get(`m.secret_storage.key.${s}`);if(!!i)return new ic(s,i.content)}async function bI(n,e,t){const r=await t.session.get(Uh);return t.session.set(Uh,e),t.session.set(oc,{id:n.id,binaryKey:n.binaryKey}),r}async function EI(n){const e=await n.session.get(oc);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new di(new ic(e.id,t.content),e.binaryKey)}async function II(n){n.session.remove(oc)}async function kI(n,e,t,r,s){const i=await qm(t);if(!i)throw new Error("Could not find a default secret storage key in account data");return await Gm(n,e,i,r,s)}async function Gm(n,e,t,r,s){let i;if(n===1)i=await wI(t,e,r);else if(n===0)i=SI(t,e,s,r);else throw new Error(`Invalid type: ${n}`);return i}async function CI(n,e,t){const r=await qm(e);if(await(r==null?void 0:r.isCompatible(n,t)))return n.withDescription(r)}const Ym="org.matrix.msc2697.v1.olm.libolm_pickle";async function RI(n,e,t,r){try{const s=await n.getDehydratedDevice({log:r}).response();if(s.device_data.algorithm===Ym)return new TI(s,e,t)}catch(s){s.name!=="HomeServerError"&&(r.error=s);return}}async function AI(n,e,t,r,s){var i;const a=(await e.createDehydratedDevice({device_data:{algorithm:Ym,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:((i=t.description)==null?void 0:i.passphraseParams)||{}},initial_device_display_name:r}).response()).device_id;return n.setDeviceId(a),await n.uploadKeys(void 0,!0,s),a}class TI{constructor(e,t,r){this._dehydratedDevice=e,this._olm=t,this._platform=r}async decrypt(e,t){const r=new ic("dehydrated_device",this._dehydratedDevice.device_data.passphrase),s=await Gm(e,t,r,this._platform,this._olm),i=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return i.unpickle(s.binaryKey.slice(),o),new xI(this._dehydratedDevice,i,s)}catch(o){if(i.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class xI{constructor(e,t,r){this._dehydratedDevice=e,this._account=t,this._key=r}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class NI{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class MI{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function Qm(n,e,t,r){return{session:n.pickle(r),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class Bo{constructor(e,t,r,s=!1){this.data=e,this._olm=r,this._pickleKey=t,this.isNew=s,this.isModified=s}static create(e,t,r,s,i){const o=Qm(t,e,i,s);return new Bo(o,s,r,!0)}get id(){return this.data.sessionId}load(){const e=new this._olm.Session;return e.unpickle(this._pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this._pickleKey),this.isModified=!0}}class Jm{constructor(e,t,r){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=r,this._device=null,this._roomTracked=!0}setDevice(e){this._device=e}setRoomNotTrackedYet(){this._roomTracked=!1}get isVerified(){return this._device?this._device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this._device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this._device&&!this._roomTracked}}const Kh=4;function zl(n){return n.type===0}function Xm(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class PI{constructor({account:e,pickleKey:t,now:r,ownUserId:s,storage:i,olm:o,senderKeyLock:a}){this._account=e,this._pickleKey=t,this._now=r,this._ownUserId=s,this._storage=i,this._olm=o,this._senderKeyLock=a}async obtainDecryptionLock(e){var t;const r=new Set;for(const i of e){const o=(t=i.content)==null?void 0:t.sender_key;o&&r.add(o)}const s=await Promise.all(Array.from(r).map(i=>this._senderKeyLock.takeLock(i)));return new MI(s)}async decryptAll(e,t,r){try{const s=Mr(e,c=>{var d;return(d=c.content)==null?void 0:d.sender_key}),i=this._now(),o=await Promise.all(Array.from(s.entries()).map(([c,d])=>this._decryptAllForSenderKey(c,d,i,r))),a=o.reduce((c,d)=>c.concat(d.results),[]),l=o.reduce((c,d)=>c.concat(d.errors),[]),u=o.map(c=>c.senderKeyDecryption);return new LI(u,a,l,this._account,t)}catch(s){throw t.release(),s}}async _decryptAllForSenderKey(e,t,r,s){const i=await this._getSessions(e,s),o=new DI(e,i,this._olm,r),a=[],l=[];for(const u of t)try{const c=this._decryptForSenderKey(o,u,r);a.push(c)}catch(c){l.push(c)}return{results:a,errors:l,senderKeyDecryption:o}}_decryptForSenderKey(e,t,r){const s=e.senderKey,i=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(i)}catch(a){throw new ge("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:s,error:a.message})}if(typeof o!="string"&&zl(i)){let a;try{a=this._createSessionAndDecrypt(s,i,r)}catch(l){throw new ge(`Could not create inbound olm session: ${l.message}`,t,{senderKey:s,error:l})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(l){throw new ge("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:l})}return this._validatePayload(a,t),new Jm(a,s,a.keys.ed25519)}else throw new ge("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,r){let s;const i=this._account.createInboundOlmSession(e,t.body);try{s=i.decrypt(t.type,t.body);const o=Bo.create(e,i,this._olm,this._pickleKey,r);return o.unload(i),{session:o,plaintext:s}}catch(o){throw i.free(),o}}_getMessageAndValidateEvent(e){var t;const r=(t=e.content)==null?void 0:t.ciphertext;if(!r)throw new ge("OLM_MISSING_CIPHERTEXT",e);const s=r==null?void 0:r[this._account.identityKeys.curve25519];if(!s)throw new ge("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const s=(await t.olmSessions.getAll(e)).map(i=>new Bo(i,this._pickleKey,this._olm));return Xm(s),s}_validatePayload(e,t){var r,s,i;if(e.sender!==t.sender)throw new ge("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this._ownUserId)throw new ge("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((r=e.recipient_keys)==null?void 0:r.ed25519)!==this._account.identityKeys.ed25519)throw new ge("OLM_BAD_RECIPIENT_KEY",t,{key:(s=e.recipient_keys)==null?void 0:s.ed25519});if(!e.type)throw new ge("missing type on payload",t,{payload:e});if(typeof((i=e.keys)==null?void 0:i.ed25519)!="string")throw new ge("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class DI{constructor(e,t,r,s){this.senderKey=e,this.sessions=t,this._olm=r,this._timestamp=s}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const r=this._decryptWithSession(t,e);if(typeof r=="string")return Xm(this.sessions),r}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}_decryptWithSession(e,t){const r=e.load();try{if(zl(t)&&!r.matches_inbound(t.body))return;try{const s=r.decrypt(t.type,t.body);return e.save(r),e.lastUsed=this._timestamp,s}catch(s){if(zl(t))throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${s.message}`);return}}finally{e.unload(r)}}}class LI{constructor(e,t,r,s,i){this._senderKeyDecryptions=e,this._account=s,this.results=t,this.errors=r,this._lock=i}get hasNewSessions(){return this._senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this._senderKeyDecryptions){for(const r of t.getModifiedSessions())if(e.olmSessions.set(r.data),r.isNew){const s=r.load();try{this._account.writeRemoveOneTimeKey(s,e)}finally{r.unload(s)}}if(t.sessions.length>Kh){const{senderKey:r,sessions:s}=t;for(let i=s.length-1;i>=Kh;i-=1){const o=s[i];e.olmSessions.remove(r,o.id)}}}}finally{this._lock.release()}}}function OI(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const Bh="signed_curve25519",Vh=20;class UI{constructor({account:e,olm:t,olmUtil:r,ownUserId:s,storage:i,now:o,pickleKey:a,senderKeyLock:l}){this._account=e,this._olm=t,this._olmUtil=r,this._ownUserId=s,this._storage=i,this._now=o,this._pickleKey=a,this._senderKeyLock=l}async encrypt(e,t,r,s,i){let o=[];for(let a=0;a<r.length;a+=Vh){const l=r.slice(a,a+Vh),u=await this._encryptForMaxDevices(e,t,l,s,i);o=o.concat(u)}return o}async _encryptForMaxDevices(e,t,r,s,i){const o=await Promise.all(r.map(a=>this._senderKeyLock.takeLock(a.curve25519Key)));try{const{devicesWithoutSession:a,existingEncryptionTargets:l}=await this._findExistingSessions(r),u=this._now();let c=[];try{if(a.length){const g=await i.wrap("create sessions",v=>this._createNewSessions(a,s,u,v));c=c.concat(g)}await this._loadSessions(l),c=c.concat(l);const d={l:"encrypt",targets:c.length},h=i.wrap(d,()=>c.map(g=>{const v=this._encryptForDevice(e,t,g);return new FI(v,g.device)}));return await this._storeSessions(c,u),h}finally{for(const d of c)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]),r=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),s=e.filter((o,a)=>{const l=r[a];return!(l!=null&&l.length)}),i=e.map((o,a)=>{const l=r[a];if((l==null?void 0:l.length)>0){const u=OI(l);return ni.fromSessionId(o,u)}}).filter(o=>!!o);return{devicesWithoutSession:s,existingEncryptionTargets:i}}_encryptForDevice(e,t,r){const{session:s,device:i}=r,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,i)),a=s.encrypt(o);return{algorithm:Yu,sender_key:this._account.identityKeys.curve25519,ciphertext:{[i.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,r){return{keys:{ed25519:this._account.identityKeys.ed25519},recipient_keys:{ed25519:r.ed25519Key},recipient:r.userId,sender:this._ownUserId,content:t,type:e}}async _createNewSessions(e,t,r,s){const i=await s.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of i){const{device:a,oneTimeKey:l}=o;o.session=await this._account.createOutboundOlmSession(a.curve25519Key,l)}await this._storeSessions(i,r)}catch(o){for(const a of i)a.dispose();throw o}return i}async _claimOneTimeKeys(e,t,r){const s=sc(t,l=>l.userId,()=>new Map,(l,u)=>l.set(u.deviceId,u)),i=Array.from(s.entries()).reduce((l,[u,c])=>(l[u]=Array.from(c.values()).reduce((d,h)=>(d[h.deviceId]=Bh,d),{}),l),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:i},{log:r}).response();Object.keys(o.failures).length&&r.log({l:"failures",servers:Object.keys(o.failures)},r.level.Warn);const a=o==null?void 0:o.one_time_keys;return this._verifyAndCreateOTKTargets(a,s,r)}_verifyAndCreateOTKTargets(e,t,r){var s;const i=[];for(const[o,a]of Object.entries(e))for(const[l,u]of Object.entries(a)){const[c,d]=Object.entries(u)[0],[h]=c.split(":");if(h===Bh){const g=(s=t.get(o))==null?void 0:s.get(l);if(g&&nm(this._olmUtil,o,l,g.ed25519Key,d,r)){const S=ni.fromOTK(g,d.key);i.push(S)}}}return i}async _loadSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]);let r=!1;try{await Promise.all(e.map(async s=>{const i=await t.olmSessions.get(s.device.curve25519Key,s.sessionId);if(i&&!r){const o=new this._olm.Session;o.unpickle(this._pickleKey,i.session),s.session=o}}))}catch(s){r=!0;for(const i of e)i.dispose();throw s}}async _storeSessions(e,t){const r=await this._storage.readWriteTxn([this._storage.storeNames.olmSessions]);try{for(const s of e){const i=Qm(s.session,s.device.curve25519Key,t,this._pickleKey);r.olmSessions.set(i)}}catch(s){throw r.abort(),s}await r.complete()}}class ni{constructor(e,t,r){this.device=e,this.oneTimeKey=t,this.sessionId=r,this.session=null}static fromOTK(e,t){return new ni(e,t,null)}static fromSessionId(e,t){return new ni(e,null,t)}dispose(){this.session&&this.session.free()}}class FI{constructor(e,t){this.content=e,this.device=t}}class KI{constructor(e,t,r,s){this._roomId=e,this._results=t,this._errors=r,this._replayEntries=s}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(r){this._errors.set(t.eventId,r)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,r){const{messageIndex:s,sessionId:i,eventId:o,timestamp:a}=t,l=await r.groupSessionDecryptions.get(e,i,s);if(l&&l.eventId!==o){const c=l.timestamp<a?o:l.eventId;throw this._results.delete(o),new ge("MEGOLM_REPLAYED_INDEX",event,{messageIndex:s,badEventId:c,otherEventId:l.eventId})}l||r.groupSessionDecryptions.set(e,i,s,{eventId:o,timestamp:a})}}function Hl(n,e){if(n)for(const[t,r]of n.entries())e.set(t,r)}class BI{constructor(e,t,r){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=r}async decrypt(){try{const e=this._initialErrors,t=new Map,r=[];return await Promise.all(this._sessionDecryptions.map(async s=>{const i=await s.decryptAll();Hl(i.errors,e),Hl(i.results,t),r.push(...i.replayEntries)})),new KI(this._roomId,t,e,r)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class VI{constructor(e,t,r){this.sessionId=e,this.messageIndex=t,this.event=r}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class $I{constructor(e,t,r,s){this.key=e,this.events=t,this.olmWorker=r,this.keyLoader=s,this.decryptionRequests=r?[]:void 0}async decryptAll(){const e=[],t=new Map;let r;return await this.keyLoader.useKey(this.key,async s=>{for(const i of this.events)try{const o=i.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(s,o);this.decryptionRequests.push(d),a=await d.response()}else a=s.decrypt(o);const{plaintext:l}=a;let u;try{u=JSON.parse(l)}catch(d){throw new ge("PLAINTEXT_NOT_JSON",i,{plaintext:l,err:d})}if(u.room_id!==this.key.roomId)throw new ge("MEGOLM_WRONG_ROOM",i,{encryptedRoomId:u.room_id,eventRoomId:this.key.roomId});e.push(new VI(this.key.sessionId,a.message_index,i));const c=new Jm(u,this.key.senderKey,this.key.claimedEd25519Key);t.set(i.event_id,c)}catch(o){if(o.name==="AbortError")return;r||(r=new Map),r.set(i.event_id,o)}}),{results:t,errors:r,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function ac(n){var e;return(e=n.content)==null?void 0:e.sender_key}function lc(n){var e;return(e=n.content)==null?void 0:e.session_id}function jI(n){var e;return(e=n.content)==null?void 0:e.ciphertext}function WI(n){return typeof ac(n)=="string"&&typeof lc(n)=="string"&&typeof jI(n)=="string"}class zI{constructor(){this.events=[]}get senderKey(){return ac(this.events[0])}get sessionId(){return lc(this.events[0])}}function ql(n){return sc(n,e=>`${ac(e)}|${lc(e)}`,()=>new zI,(e,t)=>e.events.push(t))}class Zm{isForSession(e,t,r){return this.roomId===e&&this.senderKey===t&&this.sessionId===r}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function e_(n,e){return n.first_known_index()<e.first_known_index()}class uc extends Zm{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let r;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(i,o)=>{r=i.pickle(o)},t),this.isBetter===!1)return!1;r||(r=await e.useKey(this,(i,o)=>i.pickle(o)));const s={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:r,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(s),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,r){if(this.isBetter!==void 0)return this.isBetter;let s=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!s){const i=await r_(this.roomId,this.senderKey,this.sessionId,r);i&&(i.hasSession?s=i:i.eventIds&&(this._eventIds=i.eventIds))}if(s){const i=s;await e.useKey(this,async o=>{await e.useKey(i,(a,l)=>{this.isBetter=e_(o,a),i.isBetter=!this.isBetter,this.isBetter&&t&&t(o,l)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Zs.NotBackedUp}}class HI extends uc{constructor(e){super();this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return Tr.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class qI extends uc{constructor(e,t,r){super();this._roomId=e,this.outboundSession=t,this.identityKeys=r,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return Tr.Outbound}loadInto(e){e.create(this.serializationKey)}}class GI extends uc{constructor(e,t,r){super();this._roomId=e,this._sessionId=t,this._backupInfo=r}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return Tr.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Zs.BackedUp}}class t_ extends Zm{constructor(e){super();this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function YI(n){var e;const t=(e=n.event.content)==null?void 0:e.session_key,r=new HI(n);if(typeof r.roomId=="string"&&typeof r.sessionId=="string"&&typeof r.senderKey=="string"&&typeof t=="string")return r}function n_(n,e,t){var r;const s=t.session_key,i=t.sender_key,o=(r=t.sender_claimed_keys)==null?void 0:r.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof i=="string"&&typeof s=="string"&&typeof o=="string")return new GI(n,e,t)}async function r_(n,e,t,r){const s=await r.inboundGroupSessions.get(n,e,t);if(s)return new t_(s)}class QI{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,r,s,i){let o=await i.inboundGroupSessions.get(e,t,r);if(!(o!=null&&o.session)){if(o){const a=new Set(o.eventIds);for(const l of s)a.add(l);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:r,eventIds:s};i.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,r,s){const i=await s.inboundGroupSessions.get(e,t,r);if(i&&!i.session)return i.eventIds}async hasSession(e,t,r,s){const i=await s.inboundGroupSessions.get(e,t,r);return typeof(i==null?void 0:i.session)=="string"}async prepareDecryptAll(e,t,r,s){const i=new Map,o=[];for(const u of t)WI(u)?o.push(u):i.set(u.event_id,new ge("MEGOLM_INVALID_EVENT",u));const a=ql(o),l=[];return await Promise.all(Array.from(a.values()).map(async u=>{const c=await this.getRoomKey(e,u.senderKey,u.sessionId,r,s);if(c)l.push(new $I(c,u.events,this.olmWorker,this.keyLoader));else for(const d of u.events)i.set(d.event_id,new ge("MEGOLM_NO_SESSION",d))})),new BI(e,l,i)}async getRoomKey(e,t,r,s,i){if(s){const l=s.find(u=>u.isForSession(e,t,r));if(l&&await l.checkBetterThanKeyInStorage(this.keyLoader,i))return l}const o=this.keyLoader.getCachedKey(e,t,r);if(o)return o;const a=await r_(e,t,r,i);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var r,s;const i=[];for(const o of e)((r=o.event)==null?void 0:r.type)!=="m.room_key"||((s=o.event.content)==null?void 0:s.algorithm)!==yt||t.wrap("room_key",a=>{const l=YI(o);l?(a.set("roomId",l.roomId),a.set("id",l.sessionId),i.push(l)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return i}roomKeyFromBackup(e,t,r){return n_(e,t,r)}dispose(){this.keyLoader.dispose()}}class JI extends Vm{constructor(e,t,r){super(r);this.pickleKey=t,this.olm=e}getCachedKey(e,t,r){const s=this.findCachedKeyIndex(e,t,r);if(s!==-1)return this._getByIndexAndMoveUp(s).key}async useKey(e,t){const r=await this.allocateOperation(e);try{return await t(r.session,this.pickleKey)}finally{this.releaseOperation(r)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const r=this._getByIndexAndMoveUp(t);return r.isForKey(e)?(r.refCount+=1,r):(r.refCount=1,r.key=e,e.loadInto(r.session,this.pickleKey),r)}else{const r=new this.olm.InboundGroupSession;e.loadInto(r,this.pickleKey);const s=new XI(e,r);return this._set(s),s}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,r){return this._entries.reduce((s,i,o,a)=>{const l=s===-1?void 0:a[s];return i.isBest===!0&&i.isForSameSession(e,t,r)&&(!l||i.isBetter(l))?o:s},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,r,s,i)=>{const o=t===-1?void 0:i[t];return r.refCount===0&&r.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!r.isBetter(o))?s:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class XI{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,r){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===r}isBetter(e){return e_(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const ZI="m.megolm_backup.v1.curve25519-aes-sha2";class cc{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,r){const s=e.public_key,i=new r.PkDecryption,o=new r.PkEncryption;try{const a=i.init_with_private_key(t);if(a!==s)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${s}`);o.set_recipient_key(a)}catch(a){throw i.free(),a}return new cc(o,i)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const r={algorithm:yt,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(r))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const e0=200;class dc{constructor(e,t,r,s,i,o,a=1e4){this.backupInfo=e,this.crypto=t,this.hsApi=r,this.keyLoader=s,this.storage=i,this.platform=o,this.maxDelay=a,this.operationInProgress=new Pt(void 0),this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1}get hasStopped(){return this._stopped}get error(){return this._error}get version(){return this.backupInfo.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}async getRoomKey(e,t,r){const s=await this.hsApi.roomKeyForRoomAndSession(this.backupInfo.version,e,t,{log:r}).response();if(!s.session_data)return;const i=this.crypto.decryptRoomKey(s.session_data);if((i==null?void 0:i.algorithm)===yt)return n_(e,t,i);i!=null&&i.algorithm&&r.set("unknown algorithm",i.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}flush(e){this.operationInProgress.get()||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const r=this._runFlushOperation(t);this.operationInProgress.set(r);try{await r.result,this._hasBackedUpAllKeys=!0}catch(s){this._stopped=!0,s.name==="HomeServerError"&&(s.errcode==="M_WRONG_ROOM_KEYS_VERSION"||s.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(s.name!=="AbortError"||s.name==="StorageError"&&s.errcode==="AbortError")&&(this._error=s),t.catch(s)}this.operationInProgress.set(void 0)})}_runFlushOperation(e){return new Nm(async(t,r)=>{let s=0,i=0;for(;;){const o=this.platform.random()*this.maxDelay,a=this.platform.clock.createTimeout(o);t(a),await a.elapsed();const l=await this.storage.readTxn([G.inboundGroupSessions]);t(l),s=i+await l.inboundGroupSessions.countNonBackedUpSessions(),r(new $h(s,i));const u=(await l.inboundGroupSessions.getFirstNonBackedUpSessions(e0)).map(h=>new t_(h));if(u.length===0){e.set("total",s);return}const c=await this.encodeKeysForBackup(u),d=this.hsApi.uploadRoomKeysToBackup(this.backupInfo.version,c,{log:e});t(d),await d.response(),await this.markKeysAsBackedUp(u,t),i+=u.length,r(new $h(s,i))}})}async encodeKeysForBackup(e){const t={rooms:{}},r=t.rooms;for(const s of e){let i=r[s.roomId];i||(i=r[s.roomId]={sessions:{}}),i.sessions[s.sessionId]=await this.encodeRoomKey(s)}return t}async markKeysAsBackedUp(e,t){const r=await this.storage.readWriteTxn([G.inboundGroupSessions]);t(r);try{await Promise.all(e.map(s=>r.inboundGroupSessions.markAsBackedUp(s.roomId,s.senderKey,s.sessionId)))}catch(s){throw r.abort(),s}await r.complete()}async encodeRoomKey(e){return await this.keyLoader.useKey(e,t=>{const r=t.first_known_index(),s=t.export_session(r);return{first_message_index:r,forwarded_count:0,is_verified:!1,session_data:this.crypto.encryptRoomKey(e,s)}})}dispose(){this.crypto.dispose()}static async fromSecretStorage(e,t,r,s,i,o,a){const l=await r.readSecret("m.megolm_backup.v1",a);if(l){const u=new Uint8Array(e.encoding.base64.decode(l)),c=await s.roomKeysVersion().response();if(c.algorithm===ZI){const d=cc.fromAuthData(c.auth_data,u,t);return new dc(c,d,s,i,o,e)}else throw new Error(`Unknown backup algorithm: ${c.algorithm}`)}}}class $h{constructor(e,t){this.total=e,this.finished=t}}class t0{constructor({pickleKey:e,olm:t,account:r,keyLoader:s,storage:i,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=r,this._keyLoader=s,this._storage=i,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let r=await t.outboundGroupSessions.get(e);if(r){const s=new this._olm.OutboundGroupSession;try{return s.unpickle(this._pickleKey,r.session),this._createRoomKeyMessage(s,e)}finally{s.free()}}}createWithheldMessage(e,t,r){return{algorithm:e.algorithm,code:t,reason:r,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let r=new this._olm.OutboundGroupSession;try{const s=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let i;try{let o=await s.outboundGroupSessions.get(e);i=await this._readOrCreateSession(r,o,e,t,s),i&&this._writeSession(this._now(),r,e,s)}catch(o){throw s.abort(),o}return await s.complete(),i}finally{r.free()}}async _readOrCreateSession(e,t,r,s,i){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,s)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,r);return await new qI(r,e,this._account.identityKeys).write(this._keyLoader,i),o}}_writeSession(e,t,r,s){s.outboundGroupSessions.set({roomId:r,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,r,s){let i=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,l;try{let u=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(i,u,e,s,o),l=this._encryptContent(e,i,t,r);const c=a?this._now():u.createdAt;this._writeSession(c,i,e,o)}catch(u){throw o.abort(),u}return await o.complete(),new n0(l,a)}finally{i&&i.free()}}_needsToRotate(e,t,r){let s=6048e5;Number.isSafeInteger(r==null?void 0:r.rotation_period_ms)&&(s=r==null?void 0:r.rotation_period_ms);let i=100;if(Number.isSafeInteger(r==null?void 0:r.rotation_period_msgs)&&(i=r==null?void 0:r.rotation_period_msgs),this._now()>t+s||e.message_index()>=i)return!0}_encryptContent(e,t,r,s){const i=JSON.stringify({room_id:e,type:r,content:s}),o=t.encrypt(i);return{algorithm:yt,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:yt,chain_index:e.message_index()}}}class n0{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const jh="m.room.encrypted",r0=60*1e3;class s0{constructor({room:e,deviceTracker:t,olmEncryption:r,megolmEncryption:s,megolmDecryption:i,encryptionParams:o,storage:a,keyBackup:l,notifyMissingMegolmSession:u,clock:c}){this._room=e,this._deviceTracker=t,this._olmEncryption=r,this._megolmEncryption=s,this._megolmDecryption=i,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=l,this._notifyMissingMegolmSession=u,this._clock=c,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const r=e.filter(c=>c.isEncrypted&&!c.isDecrypted&&c.event).map(c=>c.event),s=ql(r),i=Array.from(s.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(i.map(async c=>this._megolmDecryption.hasSession(this._room.id,c.senderKey,c.sessionId,o))),l=i.filter((c,d)=>!a[d]);if(l.length)for(var u=l.length-1;u>=0;u--){const c=l[u];await t.wrap("session",d=>this._requestMissingSessionFromBackup(c.senderKey,c.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeMemberChanges(e,t,r){let s=!1;const i=Array.from(e.values());return i.some(o=>o.hasLeft)&&(r.log({l:"discardOutboundSession",leftUsers:i.filter(o=>o.hasLeft).map(o=>o.userId)}),this._megolmEncryption.discardOutboundSession(this._room.id,t)),i.some(o=>o.hasJoined)&&(s=await this._addShareRoomKeyOperationForNewMembers(i,t,r)),await this._deviceTracker.writeMemberChanges(this._room,e,t),s}async prepareDecryptAll(e,t,r,s){var i,o,a;const l=new Map,u=[];for(const d of e)d.redacted_because||((i=d.unsigned)==null?void 0:i.redacted_because)||(((o=d.content)==null?void 0:o.algorithm)!==yt&&l.set(d.event_id,new Error("Unsupported algorithm: "+((a=d.content)==null?void 0:a.algorithm))),u.push(d));const c=await this._megolmDecryption.prepareDecryptAll(this._room.id,u,t,s);return new i0(c,l,r,this,e)}async _processDecryptionResults(e,t,r,s,i,o){const a=e.filter(u=>{const c=r.get(u.event_id);return(c==null?void 0:c.code)==="MEGOLM_NO_SESSION"});if(!a.length)return;const l=ql(a);s===Ln.Sync&&await Promise.all(Array.from(l.values()).map(async u=>{const c=u.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,u.senderKey,u.sessionId,c,i)})),this._keyBackup&&o.wrapDetached("check key backup",async u=>{if(u.set("source",s),u.set("events",a.length),u.set("sessions",l.size),s===Ln.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const c=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(l).map(async([d,h])=>{await this._megolmDecryption.hasSession(this._room.id,h.senderKey,h.sessionId,c)&&l.delete(d)}))}await Promise.all(Array.from(l.values()).map(c=>u.wrap("session",d=>this._requestMissingSessionFromBackup(c.senderKey,c.sessionId,d))))})}async _verifyDecryptionResult(e,t){let r=this._senderDeviceCache.get(e.senderCurve25519Key);r||(r=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,r)),r?e.setDevice(r):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,r){if(!this._keyBackup){r.set("enabled",!1),this._notifyMissingMegolmSession();return}r.set("id",t),r.set("senderKey",e);try{const s=await this._keyBackup.getRoomKey(this._room.id,t,r);if(s){if(s.senderKey!==e){r.set("wrong_sender_key",s.senderKey),r.logLevel=r.level.Warn;return}let i=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{i=await this._megolmDecryption.writeRoomKey(s,a),r.set("isBetter",i),i&&(o=s.eventIds)}catch(l){throw a.abort(),l}await a.complete(),i&&await r.wrap("retryDecryption",l=>this._room.notifyRoomKey(s,o||[],l))}}catch(s){s.name==="HomeServerError"&&s.errcode==="M_NOT_FOUND"?(r.error=s,r.logLevel=r.level.Error):r.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var r;if(!(((r=this._lastKeyPreShareTime)==null?void 0:r.measure())<r0)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var s;const i=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);i&&((s=this._keyBackup)==null||s.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(i,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,r,s){var i;this._keySharePromise&&(s.set("waitForRunningKeyShare",!0),await this._keySharePromise);const o=await s.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return o.roomKeyMessage&&((i=this._keyBackup)==null||i.flush(s),await s.wrap("share key",a=>this._shareNewRoomKey(o.roomKeyMessage,r,a))),{type:jh,content:o.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,r){let s=await this._storage.readWriteTxn([this._storage.storeNames.operations]),i;try{i=this._writeRoomKeyShareOperation(e,null,s)}catch(o){throw s.abort(),o}await this._processShareRoomKeyOperation(i,t,r)}async _addShareRoomKeyOperationForNewMembers(e,t,r){const s=e.filter(o=>o.hasJoined).map(o=>o.userId),i=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return i?(r.log({l:"share key for new members",userIds:s,id:i.session_id,chain_index:i.chain_index}),this._writeRoomKeyShareOperation(i,s,t),!0):!1}async flushPendingRoomKeyShares(e,t,r){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const s of t)s.type==="share_room_key"&&await r.wrap("operation",i=>this._processShareRoomKeyOperation(s,e,i))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,r){const i={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return r.operations.add(i),i}async _processShareRoomKeyOperation(e,t,r){r.set("id",e.id),await this._deviceTracker.trackRoom(this._room,r);let s;if(e.userIds===null){s=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,r);const a=Array.from(s.reduce((l,u)=>l.add(u.userId),new Set));e.userIds=a,await this._updateOperationsStore(l=>l.update(e))}else s=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,r);const i=await r.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,s,t,a)),o=s.filter(a=>!i.some(l=>l.device===a));await r.wrap("send",a=>this._sendMessagesToDevices(jh,i,t,a)),o.length&&await r.wrap("missingDevices",async a=>{a.set("devices",o.map(c=>c.deviceId));const l=e.userIds.filter(c=>o.some(d=>d.userId===c));a.set("unsentUserIds",l),e.userIds=l,await this._updateOperationsStore(c=>c.update(e));const u=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",u,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(r){throw t.abort(),r}await t.complete()}async _sendSharedMessageToDevices(e,t,r,s,i){const o=Mr(r,u=>u.userId),a={messages:Array.from(o.entries()).reduce((u,[c,d])=>(u[c]=d.reduce((h,g)=>(h[g.deviceId]=t,h),{}),u),{})},l=Ko();await s.sendToDevice(e,a,l,{log:i}).response()}async _sendMessagesToDevices(e,t,r,s){s.set("messages",t.length);const i=Mr(t,l=>l.device.userId),o={messages:Array.from(i.entries()).reduce((l,[u,c])=>(l[u]=c.reduce((d,h)=>(d[h.device.deviceId]=h.content,d),{}),l),{})},a=Ko();await r.sendToDevice(e,o,a,{log:s}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(r=>{var s,i;if(r.isEncrypted&&!r.isDecrypted){const{event:o}=r;if(o){const a=(s=o.content)==null?void 0:s.sender_key,l=(i=o.content)==null?void 0:i.session_id;return t.some(u=>a===u.senderKey&&l===u.sessionId)}}return!1})}dispose(){this._disposed=!0}}class i0{constructor(e,t,r,s,i){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=r,this._roomEncryption=s,this._events=i}async decrypt(){return new o0(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class o0{constructor(e,t,r,s,i){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=r,this._roomEncryption=s,this._events=i}async write(e,t){const{results:r,errors:s}=await this._megolmDecryptionChanges.write(e);return Hl(this._extraErrors,s),await this._roomEncryption._processDecryptionResults(this._events,r,s,this._source,e,t),new a0(r,s,this._roomEncryption)}}class a0{constructor(e,t,r){this.results=e,this.errors=t,this._roomEncryption=r}applyToEntries(e){for(const t of e){const r=this.results.get(t.id);if(r)t.setDecryptionResult(r);else{const s=this.errors.get(t.id);s&&t.setDecryptionError(s)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map(t=>this._roomEncryption._verifyDecryptionResult(t,e)))}}class l0{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new NI,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class u0{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){var r,s;const i=await t.accountData.get(e);if(!i)return;const o=(s=(r=i==null?void 0:i.content)==null?void 0:r.encrypted)==null?void 0:s[this._key.id];if(!o)throw new Error(`Secret ${i.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(i.type,o);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:r,utf8:s}=this._platform.encoding,i=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,s.encode(e),"SHA-256",512),o=i.slice(0,32),a=i.slice(32),l=r.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,r.decode(t.mac),l,"SHA-256"))throw new Error("Bad MAC");const c=await this._platform.crypto.aes.decryptCTR({key:o,iv:r.decode(t.iv),data:l});return s.decode(c)}}const kn="DEFAULT_KEY",ds="pusher";class c0{constructor({storage:e,hsApi:t,sessionInfo:r,olm:s,olmWorker:i,platform:o,mediaRepository:a}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._syncInfo=null,this._sessionInfo=r,this._rooms=new Os,this._roomUpdateCallback=(l,u)=>this._rooms.update(l.id,u),this._activeArchivedRooms=new Map,this._invites=new Os,this._inviteUpdateCallback=(l,u)=>this._invites.update(l.id,u),this._roomsBeingCreatedUpdateCallback=(l,u)=>{l.isCancelled?this._roomsBeingCreated.remove(l.id):this._roomsBeingCreated.update(l.id,u)},this._roomsBeingCreated=new Os,this._user=new $E(r.userId),this._deviceMessageHandler=new mI({storage:e}),this._olm=s,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=i,this._keyBackup=new Pt(void 0),this._observedRoomStatus=new Map,s&&(this._olmUtil=new s.Utility,this._deviceTracker=new Bv({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:r.userId,ownDeviceId:r.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new Pt(!1)}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}_setupEncryption(){const e=new l0,t=new PI({account:this._e2eeAccount,pickleKey:kn,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,senderKeyLock:e});this._olmEncryption=new UI({account:this._e2eeAccount,pickleKey:kn,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,olmUtil:this._olmUtil,senderKeyLock:e}),this._keyLoader=new JI(this._olm,kn,20),this._megolmEncryption=new t0({account:this._e2eeAccount,pickleKey:kn,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new QI(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){var r;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==yt?null:new s0({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(r=this._keyBackup)==null?void 0:r.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,r=void 0){return this._platform.logger.wrapOrRun(r,"enable secret storage",async s=>{if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(null));const i=await kI(e,t,this._storage,this._platform,this._olm),o=await this._storage.readTxn([this._storage.storeNames.accountData]);if(await this._createKeyBackup(i,o,s))return await this._writeSSSSKey(i,s),this._keyBackup.get().flush(s),i;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const r=this._keyBackup.get();if(!r)return;const s=r.version,i=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await bI(e,s,i);if(t.set("previousBackupVersion",o),t.set("backupVersion",s),!!o&&o!==s){const a=await r.markAllForBackup(i);t.set("amountMarkedForBackup",a)}}catch(o){throw i.abort(),o}await i.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{II(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._keyBackup.get()){for(const t of this._rooms.values())t.isEncrypted&&t.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(null)}}_createKeyBackup(e,t,r){return r.wrap("enable key backup",async s=>{try{const i=new u0({key:e,platform:this._platform}),o=await dc.fromSecretStorage(this._platform,this._olm,i,this._hsApi,this._keyLoader,this._storage,t);if(o){for(const a of this._rooms.values())a.isEncrypted&&a.enableKeyBackup(o);return this._keyBackup.set(o),!0}}catch(i){s.catch(i)}return!1})}get keyBackup(){return this._keyBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await Vn.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:kn,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return Vn.create({hsApi:this._hsApi,olm:this._olm,pickleKey:kn,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async r=>{const s=await this._createNewAccount("temp-device-id");try{const i=await AI(s,this._hsApi,e,"Dehydrated device",r);return r.set("deviceId",i),i}finally{s.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await Vn.load({hsApi:this._hsApi,olm:this._olm,pickleKey:kn,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const r=await this._getPendingEventsByRoom(t),s=await t.invites.getAll(),i=Promise.all(s.map(async l=>{const u=this.createInvite(l.roomId);e.wrap("invite",c=>u.load(l,c)),this._invites.add(u.id,u)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async l=>{const u=this.createJoinedRoom(l.roomId,r.get(l.roomId));await e.wrap("room",c=>u.load(l,t,c)),this._rooms.add(u.id,u)}));await Promise.all([i,a]);for(const[l,u]of this.invites){const c=this.rooms.get(l);c&&c.setInvite(u)}}dispose(){var e,t,r,s;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(r=this._megolmDecryption)==null||r.dispose(),this._megolmDecryption=void 0,(s=this._e2eeAccount)==null||s.dispose(),this._e2eeAccount=void 0;for(const i of this._rooms.values())i.dispose();this._rooms=void 0}async start(e,t,r){var s;if(e){const l=await this._storage.readWriteTxn([this._storage.storeNames.session]);l.session.set("serverVersions",e),await l.complete()}if(!this._keyBackup.get()){t&&await r.wrap("SSSSKeyFromDehydratedDeviceKey",async c=>{const d=await CI(t.key,this._storage,this._platform);d&&(c.set("success",!0),await this._writeSSSSKey(d))});const l=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),u=await EI(l);u&&await this._createKeyBackup(u,l,r)&&((s=this._keyBackup.get())==null||s.flush(r)),this._keyBackup.get()||this._keyBackup.set(null)}const o=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),a=Mr(o,l=>l.scope);for(const l of this._rooms.values()){let u;const c=a.get(l.id);c&&(u=Mr(c,d=>d.type)),l.start(u,r)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((r,s)=>{const i=r.get(s.roomId);return i?i.push(s):r.set(s.roomId,[s]),r},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new iI({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){const t=new oI({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new fI({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async r=>{const s=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new pI(s,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,r),this._roomsBeingCreated.set(s,t);const i=[t.create(this._hsApi,r)];e.loadProfiles!==!1&&i.push(t.loadProfiles(this._hsApi,r)),await Promise.all(i),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,r),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,r))}),t}async obtainSyncLock(e){var t;const r=(t=e.to_device)==null?void 0:t.events;if(Array.isArray(r)&&r.length)return await this._deviceMessageHandler.obtainSyncLock(r)}async prepareSync(e,t,r,s){var i;const o=(i=e.to_device)==null?void 0:i.events;if(Array.isArray(o)&&o.length)return await s.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(o,t,r,a))}async writeSync(e,t,r,s,i){const o={syncInfo:null,e2eeAccountChanges:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};s.session.set("sync",d),o.syncInfo=d}const l=e.device_one_time_keys_count;this._e2eeAccount&&l&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(l,s,i));const u=e.device_lists;this._deviceTracker&&Array.isArray(u==null?void 0:u.changed)&&u.changed.length&&await i.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(u.changed,s,d)),r&&(o.hasNewRoomKeys=await i.wrap("deviceMsgs",d=>this._deviceMessageHandler.writeSync(r,s,d)));const c=e.account_data;if(Array.isArray(c==null?void 0:c.events))for(const d of c.events)typeof d.type=="string"&&s.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,r){var s;t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,r)&&await r.wrap("uploadKeys",o=>this._e2eeAccount.uploadKeys(this._storage,!1,o)),e.hasNewRoomKeys&&((s=this._keyBackup.get())==null||s.flush(r))}_tryReplaceRoomBeingCreated(e,t){for(const[,r]of this._roomsBeingCreated)if(r.roomId===e){const s=this._observedRoomStatus.get(r.id);s&&(t.log("replacing room being created").set("localId",r.id).set("roomId",r.roomId),s.set(s.get()|_e.Replaced)),r.dispose(),this._roomsBeingCreated.remove(r.id);return}}applyRoomCollectionChangesAfterSync(e,t,r,s){var i,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,s)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of r)a.shouldAdd&&((i=this._observedRoomStatus.get(a.id))==null||i.set(_e.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(_e.Joined));for(const a of e){const l=this._observedRoomStatus.get(a.id);if(l){const u=l.get()|_e.Invited;if(a.shouldAdd)l.set(u);else if(a.shouldRemove){const c=u^_e.Invited;l.set(c)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|_e.Archived)^_e.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=Tn.createDefaultPayload(this._sessionInfo.id),r=await this._platform.notificationService.enablePush(Tn,t);if(!r)return e.set("no_pusher",!0),!1;await r.enable(this._hsApi,e);const s=await this._storage.readWriteTxn([this._storage.storeNames.session]);return s.session.set(ds,r.serialize()),await s.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const r=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ds);if(!r)return!0;await new Tn(r).disable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.remove(ds),await i.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ds):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ds);if(!t)return!1;const r=new Tn(t),s=await this._hsApi.getPushers().response();return((s==null?void 0:s.pushers)||[]).map(o=>new Tn(o)).some(o=>o.equals(r))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return _e.BeingCreated;if(!!this._rooms.get(e))return _e.Joined;{const s=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return s&&o?_e.Invited|_e.Archived:s?_e.Invited:o?_e.Archived:_e.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){const r=await this.getRoomStatus(e);t=new Ll(r,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async r=>{r.set("id",e);const s=this._activeArchivedRooms.get(e);if(s)return s.retain(),s;const i=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await i.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,i,r),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async r=>(await this._hsApi.joinIdOrAlias(e,{log:r}).response()).room_id)}}class d0{constructor({username:e,password:t,homeserver:r}){this._username=e,this._password=t,this.homeserver=r}async login(e,t,r){return await e.passwordLogin(this._username,this._password,t,{log:r}).response()}}class h0{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,r){return await e.tokenLogin(this._loginToken,Ko(),t,{log:r}).response()}}class p0{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}}class hc{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class f0 extends hc{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class m0 extends hc{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class _0 extends hc{constructor(e,t,r){super(e,t);this._type=r}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class g0{constructor(e,t,r){this._hsApi=e,this._accountDetails=t,this._flowSelector=r!=null?r:s=>s[0]}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:r,password:s,initialDeviceDisplayName:i,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(r,s,i,t,o),l=await a.response(),u=await a.responseCode(),c=Qy(Dl({},l),{status:u});return this.parseRegistrationResponse(c,e)}parseStagesFromResponse(e){const{session:t,params:r}=e,s=this._flowSelector(e.flows);if(!s)throw new Error("flowSelector did not return any flow!");let i,o;for(const a of s.stages){const l=this._createRegistrationStage(a,t,r);i?(o.setNextStage(l),o=l):(i=l,o=l)}return i}async parseRegistrationResponse(e,t){var r;switch(e.status){case 200:this._sessionInfo=e;return;case 401:if((r=e.completed)!=null&&r.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,r){switch(e){case"m.login.dummy":return new f0(t,r==null?void 0:r[e]);case"m.login.terms":return new m0(t,r==null?void 0:r[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new _0(t,r==null?void 0:r[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get sessionInfo(){return this._sessionInfo}}const re=Ut("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Ha=Ut("Connection","Credentials","Unknown");class bk{constructor(e){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new Pt(re.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===re.NotLoading&&(this._status.set(re.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const r=await this._platform.sessionInfoStorage.get(e);if(!r)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(r,null,t),t.set("status",this._status.get())}catch(r){t.catch(r),this._error=r,this._status.set(re.Error)}}))}_parseLoginOptions(e,t){const r=e.flows,s={homeserver:t};for(const i of r)i.type==="m.login.password"?s.password=(o,a)=>new d0({homeserver:t,username:o,password:a}):i.type==="m.login.sso"&&r.find(o=>o.type==="m.login.token")?s.sso=new p0(t):i.type==="m.login.token"&&(s.token=o=>new h0({homeserver:t,loginToken:o}));return s}queryLogin(e){return new Nm(async t=>{e=await kb(e,(i,o)=>t(this._platform.request(i,o)));const r=new Rn({homeserver:e,request:this._platform.request}),s=await t(r.getLoginFlows()).response();return this._parseLoginOptions(s,e)})}async startRegistration(e,t,r,s){const i=this._platform.request,o=new Rn({homeserver:e,request:i});return new g0(o,{username:t,password:r,initialDeviceDisplayName:s})}async startWithLogin(e,{inspectAccountSetup:t}={}){const r=this._status.get();r!==re.LoginFailed&&r!==re.NotLoading&&r!==re.Error||(this._resetStatus(),await this._platform.logger.run("login",async s=>{this._status.set(re.Login);const i=this._platform.clock;let o;try{const l=this._platform.request,u=new Rn({homeserver:e.homeserver,request:l}),c=await e.login(u,"Hydrogen",s),d=this.createNewSessionId();o={id:d,deviceId:c.device_id,userId:c.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:c.access_token,lastUsed:i.now()},s.set("id",d)}catch(l){this._error=l,l.name==="HomeServerError"?(l.errcode==="M_FORBIDDEN"?this._loginFailure=Ha.Credentials:this._loginFailure=Ha.Unknown,s.set("loginFailure",this._loginFailure),this._status.set(re.LoginFailed)):l.name==="ConnectionError"?(this._loginFailure=Ha.Connection,this._status.set(re.LoginFailed)):this._status.set(re.Error);return}let a;t&&(a=await this._inspectAccountAfterLogin(o,s),a&&(o.deviceId=a.deviceId)),await this._platform.sessionInfoStorage.add(o);try{await this._loadSessionInfo(o,a,s),s.set("status",this._status.get())}catch(l){s.catch(l),a==null||a.dispose(),this._error=l,this._status.set(re.Error)}}))}async _loadSessionInfo(e,t,r){r.set("appVersion",this._platform.version);const s=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(re.Loading),this._reconnector=new Tb({onlineStatus:this._platform.onlineStatus,retryDelay:new Pm(s.createTimeout),createMeasure:s.createMeasure});const i=new Rn({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,r);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},a=await this._olmPromise;let l=null;this._workerPromise&&(l=await this._workerPromise),this._requestScheduler=new Db({hsApi:i,clock:s}),this._requestScheduler.start();const u=new Mb({homeserver:e.homeServer,platform:this._platform});if(this._session=new c0({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:l,mediaRepository:u,platform:this._platform}),await this._session.load(r),t?(await r.wrap("dehydrateIdentity",c=>this._session.dehydrateIdentity(t,c)),await this._session.setupDehydratedDevice(t.key,r)):this._session.hasIdentity||(this._status.set(re.SessionSetup),await r.wrap("createIdentity",c=>this._session.createIdentity(c))),this._sync=new Ub({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(c=>{c===Vl.Online&&this._platform.logger.runDetached("reconnect",async d=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const h=t;t=void 0,await d.wrap("session start",g=>this._session.start(this._reconnector.lastVersionsResponse,h,g))})}),await r.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(re.Ready),!this._sessionStartedByReconnector)){const c=await i.versions({timeout:1e4,log:r}).response();if(this._isDisposed)return;const d=t;t=void 0,await r.wrap("session start",h=>this._session.start(c,d,h))}}async _waitForFirstSync(){this._sync.start(),this._status.set(re.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===se.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===se.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===se.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async r=>{var s;this._status.set(re.QueryAccount);const i=new Rn({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),o=await this._olmPromise;let a;try{a=await RI(i,o,this._platform,r)}catch(l){if(l.name==="HomeServerError")r.set("not_supported",!0);else throw l}if(a){let l;const u=new Promise(d=>l=d);this._accountSetup=new y0(a,l),this._status.set(re.AccountSetup),await u;const c=(s=this._accountSetup)==null?void 0:s._dehydratedDevice;return this._accountSetup=null,c}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const r=await this._platform.sessionInfoStorage.get(this._sessionId);if(!r)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new Rn({homeserver:r.homeServer,accessToken:r.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(re.NotLoading),this._error=null,this._loginFailure=null}}class y0{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class Ek{constructor(e){this._allowsChild=e,this._path=new Ct([],e),this._observables=new Map,this._pathObservable=new Pt(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,t=void 0){return this.applyPath(this.path.with(new Ke(e,t)))}applyPath(e){const t=this._path;this._path=e;for(let r=t.segments.length-1;r>=0;r-=1){const s=t.segments[r];if(!this._path.get(s.type)){const i=this._observables.get(s.type);i==null||i.emitIfChanged()}}for(const r of this._path.segments){const s=this._observables.get(r.type);s==null||s.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new w0(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,r;for(r=0;r<e.length;r+=1){if(!this._allowsChild(t,e[r]))return new Ct(e.slice(0,r),this._allowsChild);t=e[r]}return new Ct(e,this._allowsChild)}segment(e,t){return new Ke(e,t)}}function v0(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let r=0;r<t;r+=1)if(n[r]!==e[r])return!1;return!0}return!1}class Ke{constructor(e,t){this.type=e,this.value=t===void 0?!0:t}}class Ct{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new Ct(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const r=this._segments.slice(0,t+1);return r.push(e),new Ct(r,this._allowsChild)}t-=1}while(t>=-1);return null}until(e){const t=this._segments.findIndex(r=>r.type===e);return t!==-1?new Ct(this._segments.slice(0,t+1),this._allowsChild):new Ct([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(r=>r.type===e.type);if(t!==-1){const r=this._segments[t-1];if(this._allowsChild(r,e)){const s=this._segments[t+1];if(!s||this._allowsChild(e,s)){const i=this._segments.slice();return i[t]=e,new Ct(i,this._allowsChild)}}}return null}get segments(){return this._segments}}class w0 extends Vr{constructor(e,t){super();var r;this._navigation=e,this._type=t,this._lastSetValue=(r=e.path.get(t))==null?void 0:r.value}get(){const t=this._navigation.path.get(this._type);return t==null?void 0:t.value}emitIfChanged(){const e=this.get();v0(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class S0{constructor({history:e,navigation:t,parseUrlPath:r,stringifyPath:s}){this._history=e,this._navigation=t,this._parseUrlPath=r,this._stringifyPath=s,this._subscription=null,this._pathSubscription=null,this._isApplyingUrl=!1,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var e;const r=(e=this._urlAsNavPath(this._history.getLastUrl()||"").get("session"))==null?void 0:e.value;return typeof r=="string"?r:null}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription=this._subscription(),this._pathSubscription=this._pathSubscription()}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const r of e)if(t=t.with(r),!t)return;return this.urlForPath(t)}urlForSegment(e,t){return this.urlForSegments([this._navigation.segment(e,t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}}function Ik({history:n,navigation:e}){return new S0({history:n,navigation:e,stringifyPath:I0,parseUrlPath:E0})}function b0(n,e,t){if(n.value.includes(e))return n;{const r=t.get("empty-grid-tile"),s=t.get("room");let i=0;r?i=r.value:s&&(i=n.value.indexOf(s.value));const o=n.value.slice();return o[i]=e,new Ke("rooms",o)}}function Wh(n,e,t=!0){n.push(new Ke("right-panel")),n.push(new Ke(e,t))}function E0(n,e,t){const r=n.substr(1).split("/"),s=r[Symbol.iterator](),i=[];let o;for(;!(o=s.next()).done;){const a=o.value;if(a==="rooms"){const l=s.next().value;if(l===void 0)break;const u=l.split(",");i.push(new Ke(a,u));const c=parseInt(s.next().value||"0",10),d=u[c];d?i.push(new Ke("room",d)):i.push(new Ke("empty-grid-tile",c))}else if(a==="open-room"){const l=s.next().value;if(!l)break;const u=e.get("rooms");if(u&&i.push(b0(u,l,e)),i.push(new Ke("room",l)),r.findIndex(h=>h==="open-room")>=r.length-2){const h=e.segments,g=h.findIndex(v=>v.type==="right-panel");g!==-1&&i.push(...h.slice(g))}}else if(a==="last-session"){let l=e.get("session");typeof(l==null?void 0:l.value)!="string"&&t&&(l=new Ke("session",t)),l&&i.push(l)}else if(a==="details"||a==="members")Wh(i,a);else if(a==="member"){const l=s.next().value;if(!l)break;Wh(i,a,l)}else if(a.includes("loginToken")){const l=a.split("=").pop();i.push(new Ke("sso",l))}else{const l=s.next().value;i.push(new Ke(a,l))}}return i}function I0(n){let e="",t;for(const r of n.segments){switch(r.type){case"rooms":e+=`/rooms/${r.value.join(",")}`;break;case"empty-grid-tile":e+=`/${r.value}`;break;case"room":(t==null?void 0:t.type)==="rooms"?e+=`/${t.value.indexOf(r.value)}`:e+=`/${r.type}/${r.value}`;break;case"right-panel":case"sso":continue;default:e+=`/${r.type}`,r.value&&r.value!==!0&&(e+=`/${r.value}`)}t=r}return e}class hi extends ra{constructor(e){super();this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}track(e){return this.disposables||(this.disposables=new ec),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let r="";for(let s=0;s<e.length;++s)r=r+e[s],s<t.length&&(r=r+t[s]);return r}updateOptions(e){this._options=Object.assign(this._options,e)}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}}function pc(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function k0(n){let e=0,t,r;if(n.length===0)return e;for(t=0;t<n.length;t++)r=n.charCodeAt(t),e=(e<<5)-e+r,e|=0;return Math.abs(e)}function fc(n){return k0(n)%8+1}function s_(n,e,t,r){if(n){const s=e*t.devicePixelRatio;return r.mxcUrlThumbnail(n,s,s,"crop")}return null}class ct{constructor(e,t,r,s){this._remove=e,this._update=t,this._replace=r,this._updateParams=s}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new ct(!0,!1,!1,null)}static Update(e){return new ct(!1,!0,!1,e)}static Nothing(){return new ct(!1,!1,!1,null)}static Replace(e){return new ct(!1,!1,!0,e)}}class C0 extends jr{constructor(e,t){super();this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileCreator=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_emitSpontanousUpdate(e,t){const r=e.lowerEntry,s=this._findTileIdx(r);this.emitUpdate(s,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let r of this._entries)(!e||!e.tryIncludeEntry(r))&&(e=this._tileCreator(r),e&&this._tiles.push(e));let t=null;for(let r of this._tiles)t&&t.updateNextSibling(r),r.updatePreviousSibling(t),t=r;t&&t.updateNextSibling(null);for(const r of this._tiles)r.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return un(this._tiles,e,(t,r)=>-r.compareEntry(t))}_findTileAtIdx(e,t){const r=this._getTileAtIdx(t);if(r&&r.compareEntry(e)===0)return r}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const r=this._findTileIdx(t),s=this._getTileAtIdx(r-1);if(s&&s.tryIncludeEntry(t)){this.emitUpdate(r-1,s);return}const i=this._getTileAtIdx(r);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(r,i);return}const o=this._tileCreator(t);o&&(s&&(s.updateNextSibling(o),o.updatePreviousSibling(s)),i&&(o.updateNextSibling(i),i.updatePreviousSibling(o)),this._tiles.splice(r,0,o),this.emitAdd(r,o),o.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,r){if(!this._tiles)return;const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);if(i){const o=i.updateEntry(t,r,this._tileCreator);if(o.shouldReplace){const a=this._tileCreator(t);a?(this._replaceTile(s,i,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(s,i)}o.shouldRemove&&this._removeTile(s,i),o.shouldUpdate&&this.emitUpdate(s,i,o.updateParams)}}_replaceTile(e,t,r,s){t.dispose();const i=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=r,i==null||i.updateNextSibling(r),r.updatePreviousSibling(i),r.updateNextSibling(o),o==null||o.updatePreviousSibling(r),this.emitUpdate(e,r,s)}_removeTile(e,t){const r=this._getTileAtIdx(e-1),s=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),r==null||r.updateNextSibling(s),s==null||s.updatePreviousSibling(r)}onRemove(e,t){const r=this._findTileIdx(t),s=this._findTileAtIdx(t,r);s&&(s.removeEntry(t)?this._removeTile(r,s):this.emitUpdate(r,s))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=un(this._tiles,e,(s,i)=>s.compare(i)),r=this._tiles[t];return(r==null?void 0:r.compare(e))===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class R0 extends hi{constructor(e){super(e);const{timeline:t,tilesCreator:r}=e;this._timeline=this.track(t),this._tiles=new C0(t.entries,r),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let r;if(e&&t){this._startTile=e,this._endTile=t;const s=this._tiles.getTileIndex(this._startTile),i=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(s,i+1))o.notifyVisible();r=s<10,this._setShowJumpDown(i<this._tiles.length-1)}else r=!0,this._setShowJumpDown(!1);r&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(s=>{this._topLoadingPromise=null,s||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class A0 extends hi{constructor(e){super(e.options);this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var t;(new Boolean(e)!==new Boolean(this._replyVM)||!((t=this._replyVM)!=null&&t.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}class pi extends hi{constructor(e){super(e);this._entry=e.entry}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==W.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){var e;(e=this._entry.pendingEvent)==null||e.abort()}setUpdateEmit(e){this.updateOptions({emitChange:t=>{e&&e(this,t)}})}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const r=this.shape==="redacted";return!e.isGap&&e.isRedacted!==r?ct.Replace("shape"):(this._entry=e,ct.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}}class T0 extends pi{constructor(e){super(e);this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:
${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t,r){return super.updateEntry(e,t,r),e.isGap?ct.Nothing():ct.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){return this._error?`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`:null}}class x0{constructor(e){this._parentTile=e,this._map=new Os,this._reactions=this._map.sortValues((t,r)=>t._compare(r))}update(e,t){if(e){for(const r in e)if(e.hasOwnProperty(r)){const s=e[r],i=this._map.get(r);i?i._tryUpdate(s)&&this._map.update(r):this._map.add(r,new zh(r,s,null,this._parentTile))}}if(t)for(const[r,s]of t.entries()){const i=this._map.get(r);i?(i._tryUpdatePending(s),this._map.update(r)):this._map.add(r,new zh(r,null,s,this._parentTile))}for(const r of this._map.keys()){const s=t==null?void 0:t.has(r),i=e==null?void 0:e.hasOwnProperty(r);!i&&!s?this._map.remove(r):i?s||this._map.get(r)._tryUpdatePending(null)&&this._map.update(r):this._map.get(r)._tryUpdate(null)&&this._map.update(r)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class zh{constructor(e,t,r,s){this._key=e,this._annotation=t,this._pending=r,this._parentTile=s,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,s=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||s?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class yn extends pi{constructor(e){super(e);this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(e.tilesCreator,void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return fc(this._entry.sender)}avatarUrl(e){return s_(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return pc(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof yn&&e.sender===this.sender){const r=this._entry.timestamp,s=e._entry.timestamp;t=r-s<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t,r){const s=super.updateEntry(e,t,r);return s.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(r,t),s}_updateReplyTileIfNeeded(e,t){var r,s;const i=this._entry.contextEntry;if(i){const o=(r=this._replyTile)==null?void 0:r.updateEntry(i,t,e);((o==null?void 0:o.shouldReplace)||!this._replyTile)&&(this.disposeTracked(this._replyTile),this._replyTile=e(i)),o!=null&&o.shouldUpdate&&((s=this._replyTile)==null||s.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,r=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,r)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async r=>{var s,i;if(!this.canReact){r.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){r.set("already_reacted",!0);return}const o=(i=(s=this._entry.pendingAnnotations)==null?void 0:s.get(e))==null?void 0:i.redactionEntry;o&&!o.pendingEvent.hasStartedSending?(r.set("abort_redaction",!0),await o.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,r)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async r=>{var s,i;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){r.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){r.set("not_yet_reacted",!0);return}let o=(i=(s=this._entry.pendingAnnotations)==null?void 0:s.get(e))==null?void 0:i.annotationEntry;o||(o=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),o?await this._room.sendRedaction(o.id,null,r):r.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async r=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,r):await this.react(e,r)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new x0(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const N0="(?:https|http|ftp):\\/\\/",i_="[^\\s.,?!)]",Hh="[a-zA-Z0-9:.\\[\\]-]",M0=`${Hh}*(?=${Hh})${i_}`,P0=`(?:[\\/#](?:[^\\s]*${i_})?)`,D0=`${N0}${M0}${P0}?`,L0=new RegExp(D0,"gi");function o_(n,e){const t=n.matchAll(L0);let r=0;for(let i of t){const o=n.slice(r,i.index);e(o,!1),e(i[0],!0);const a=i[0].length;r=i.index+a}const s=n.slice(r);e(s,!1)}function O0(n){const e=[],t=n.split(`
`),r=(s,i)=>{i?e.push(new Gl(s,[new Pr(s)])):e.push(new Pr(s))};for(let s=0;s<t.length;s+=1){const i=t[s];i.length&&o_(i,r),s>=t.length-1||e.push(new a_)}return new mc(n,e)}function U0(n){return new mc(n,[new Pr(n)])}class F0{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class qh{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class K0{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class B0{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class V0{get type(){return"rule"}}class a_{get type(){return"newline"}}class zi{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class $0{constructor(e,t,r,s,i){this.src=e,this.width=t,this.height=r,this.alt=s,this.title=i}get type(){return"image"}}class j0{constructor(e,t,r){this.id=e,this.href=t,this.children=r}get type(){return"pill"}get avatarColorNumber(){return fc(this.id)}get avatarInitials(){return pc(this.id)}}class Gl{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class Pr{constructor(e){this.text=e}get type(){return"text"}}function W0(n){return n.type==="format"&&n.format==="blockquote"}class mc{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&W0(this.parts[t]);t++);this.parts.splice(t,0,new Pr(e))}}const ws=Ut("Plain","Html");class l_ extends yn{constructor(e){super(e);this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return U0(e)}_getBodyFormat(){return ws.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const z0=["EM","STRONG","CODE","DEL","SPAN"],H0=["DIV","BLOCKQUOTE"],q0=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),G0="https://matrix.to",Gh=`${G0}/#/`;class Y0{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(Gh))return null;const t=e.substring(Gh.length);return t[0]==="@"?t:null}parseLink(e,t){const r=this.result.getAttributeValue(e,"href"),s=r==null?void 0:r.toLowerCase();if(!s||!q0.some(o=>s.startsWith(o)))return new zi("span",t);const i=this.parsePillLink(r);return i?new j0(i,r,t):new Gl(r,t)}parseList(e){const t=this.result;let r=null;t.getNodeElementName(e)==="OL"&&(r=parseInt(t.getAttributeValue(e,"start"))||1);const s=[];for(const i of t.getChildNodes(e)){if(t.getNodeElementName(i)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(i));s.push(o)}return new K0(r,s)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let r;for(const o of t.getChildNodes(e)){r=o;break}let s=null;if(!this._ensureElement(r,"CODE"))return new qh(s,this.result.getNodeText(e));const i=t.getAttributeValue(r,"class")||"";for(const o of i.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){s=o.substring(9);break}return new qh(s,this.result.getNodeText(r))}parseImage(e){const t=this.result,r=t.getAttributeValue(e,"src")||"",s=this.mediaRepository.mxcUrl(r);if(!s)return null;const i=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),l=t.getAttributeValue(e,"title");return new $0(s,i,o,a,l)}parseTableRow(e,t){const r=[];for(const s of this.result.getChildNodes(e)){if(!this._ensureElement(s,t))continue;const i=this.result.getChildNodes(s),o=this.parseInlineNodes(i);r.push(o)}return r}parseTableHead(e){let t=null;for(const r of this.result.getChildNodes(e)){t=r;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const r of this.result.getChildNodes(e))!this._ensureElement(r,"TR")||t.push(this.parseTableRow(r,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let r,s;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(r=this.parseTableHead(t[0]),s=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(r=null,s=this.parseTableBody(t[0])),new B0(r,s)}parseInlineElement(e){const t=this.result,r=t.getNodeElementName(e),s=t.getChildNodes(e);switch(r){case"A":{const i=this.parseInlineNodes(s);return this.parseLink(e,i)}case"BR":return new a_;default:{if(!z0.includes(r))return null;const i=this.parseInlineNodes(s);return new zi(r,i)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,r=t.getNodeElementName(e),s=t.getChildNodes(e);switch(r){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const i=this.parseInlineNodes(s);return new F0(parseInt(r[1]),i)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new V0;case"IMG":return this.parseImage(e);case"P":{const i=this.parseInlineNodes(s);return new zi(r,i)}case"TABLE":return this.parseTable(e);default:{if(!H0.includes(r))return null;const i=this.parseAnyNodes(s);return new zi(r,i)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const r=(s,i)=>{i?t.push(new Gl(s,[new Pr(s)])):t.push(new Pr(s))};return o_(this.result.getNodeText(e),r),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const r of e){if(this._parseTextParts(r,t))continue;const s=this.parseInlineNode(r);if(s){t.push(s);continue}this._isAllowedNode(r)&&this._parseInlineNodes(this.result.getChildNodes(r),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const r of e){if(this._parseTextParts(r,t))continue;const s=this.parseInlineNode(r)||this.parseBlockNode(r);if(s){t.push(s);continue}this._isAllowedNode(r)&&this._parseAnyNodes(this.result.getChildNodes(r),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function Q0(n,e,t){const r=n.parseHTML(t),i=new Y0(r,e).parseAnyNodes(r.rootNodes);return new mc(t,i)}class J0 extends l_{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===ws.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?ws.Html:ws.Plain}_parseBody(e,t){var r;let s;return t===ws.Html?s=Q0(this.platform,this._mediaRepository,e):s=O0(e),((r=this._getContent())==null?void 0:r.msgtype)==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class Yh extends yn{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const X0=300,Z0=400;class u_ extends yn{constructor(e){super(e);this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===W.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get sendStatus(){const{pendingEvent:e}=this._entry;switch(e==null?void 0:e.status){case W.Waiting:return this.i18n`Waiting…`;case W.EncryptingAttachments:case W.Encrypting:return this.i18n`Encrypting…`;case W.UploadingAttachments:return this.i18n`Uploading…`;case W.Sending:return this.i18n`Sending…`;case W.Error:return this.i18n`Error: ${e.error.message}`;default:return""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const r=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(r)return this._mediaRepository.mxcUrlThumbnail(r,this.width,this.height,"scale")}if(this._entry.isPending){const r=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return r&&r.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const r=(t=this._getContent())==null?void 0:t.url;if(typeof r=="string")return this._mediaRepository.mxcUrlThumbnail(r,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round((t==null?void 0:t.w)*this._scaleFactor())}get height(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round((t==null?void 0:t.h)*this._scaleFactor())}get mimeType(){var e;const t=(e=this._getContent())==null?void 0:e.info;return t==null?void 0:t.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,r=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):r&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(r),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var e;const t=(e=this._getContent())==null?void 0:e.info,r=X0/(t==null?void 0:t.h),s=Z0/(t==null?void 0:t.w);return Math.min(s,r,1)}_isMainResourceImage(){return!0}}class ek extends u_{constructor(e){super(e);this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class tk extends u_{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var e;if(this._decryptedFile)return this._decryptedFile.url;const t=(e=this._getContent())==null?void 0:e.url;return typeof t=="string"?this._mediaRepository.mxcUrl(t):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function nk(n,e=2){if(Number.isSafeInteger(n)){const t=Math.min(3,Math.floor(Math.log(n)/Math.log(1024))),r=Math.round(n/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${r} bytes`;case 1:return`${r} KB`;case 2:return`${r} MB`;case 3:return`${r} GB`}}return""}class rk extends yn{constructor(e){super(e);this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let r;try{r=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(r,t)}catch(s){this._downloadError=s}finally{r==null||r.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var e;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const r=this._getContent().body;if(this._entry.isPending){const{pendingEvent:s}=this._entry;switch(s==null?void 0:s.status){case W.Waiting:return this.i18n`Waiting to send ${r}…`;case W.EncryptingAttachments:case W.Encrypting:return this.i18n`Encrypting ${r}…`;case W.UploadingAttachments:{const i=Math.round(s.attachmentsSentBytes/s.attachmentsTotalBytes*100);return this.i18n`Uploading ${r}: ${i}%`}case W.Sending:case W.Sent:return this.i18n`Sending ${r}…`;case W.Error:return this.i18n`Error: could not send ${r}: ${s.error.message}`;default:return`Unknown send status for ${r}`}}else{const s=nk((e=this._getContent().info)==null?void 0:e.size);return this._downloading?this.i18n`Downloading ${r} (${s})…`:this.i18n`Download ${r} (${s})`}}get shape(){return"file"}}class sk extends yn{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...r]=e.pathname.split(";"),[s,i]=t.split(","),o=parseFloat(s),a=parseFloat(i);let l;for(const u of r){const[c,d]=u.split("=");c==="u"&&(l=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let u=`geo:${o},${a}`;return l&&(u=u+`;u=${l}`),u}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class ik extends pi{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e==null?void 0:e.name}"`}}class ok extends pi{get shape(){return"announcement"}get announcement(){var e,t;const{sender:r,content:s,prevContent:i,stateKey:o}=this._entry,a=this._entry.displayName||r,l=r===o?a:((e=this._entry.content)==null?void 0:e.displayname)||o,u=s&&s.membership,c=i&&i.membership;if(c==="join"&&u==="join"){if(s.avatar_url!==i.avatar_url)return`${a} changed their avatar`;if(s.displayname!==i.displayname)return s.displayname?`${(t=i.displayname)!=null?t:o} changed their name to ${s.displayname}`:`${o} removed their name (${i.displayname})`}else{if(u==="join")return`${l} joined the room`;if(u==="invite")return`${l} was invited to the room by ${a}`;if(c==="invite"){if(u==="join")return`${l} accepted the invitation to join the room`;if(u==="leave")return`${l} declined the invitation to join the room`}else if(u==="leave"){if(o===r)return`${l} left the room`;{const d=s.reason;return`${l} was kicked from the room by ${a}${d?`: ${d}`:""}`}}else if(u==="ban")return`${l} was banned from the room by ${a}`}return`${r} membership changed to ${s.membership}`}}class ak extends l_{updateEntry(e,t,r){const s=super.updateEntry(e,t,r);return e.eventType!=="m.room.encrypted"?ct.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e==null?void 0:e.code;let r;return t==="MEGOLM_NO_SESSION"?r=this.i18n`The sender hasn't sent us the key for this message yet.`:r=(e==null?void 0:e.message)||this.i18n`Could not decrypt message because of unknown reason.`,r}}class lk extends pi{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class uk extends yn{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}function ck(n){return function t(r,s){const i=Object.assign({entry:r,emitUpdate:s,tilesCreator:t},n);if(r.isGap)return new T0(i);if(r.isPending&&r.pendingEvent.isMissingAttachments)return new uk(i);if(r.eventType)switch(r.eventType){case"m.room.message":{if(r.isRedacted)return new Yh(i);const o=r.content;switch(o&&o.msgtype){case"m.text":case"m.notice":case"m.emote":return new J0(i);case"m.image":return new ek(i);case"m.video":return new tk(i);case"m.file":return new rk(i);case"m.location":return new sk(i);default:return null}}case"m.room.name":return new ik(i);case"m.room.member":return new ok(i);case"m.room.encrypted":return r.isRedacted?new Yh(i):new ak(i);case"m.room.encryption":return new lk(i);default:return null}}}function oo(n){return{w:n.width,h:n.height,mimetype:n.blob.mimeType,size:n.blob.size}}class kk extends hi{constructor(e){super(e);const{room:t}=e;this._room=t,this._timelineVM=null,this._tilesCreator=null,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=new hk(this.childOptions({archivedRoom:t})):this._composerVM=new A0(this),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{const e=await this._room.openTimeline();this._tilesCreator=ck(this.childOptions({roomVM:this,timeline:e})),this._timelineVM=this.track(new R0(this.childOptions({tilesCreator:this._tilesCreator,timeline:e}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:
${e.stack}`),this._timelineError=e,this.emitChange("error")}this._clearUnreadAfterDelay()}async _clearUnreadAfterDelay(){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if(e.name!=="AbortError")throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return pc(this.name)}get avatarColorNumber(){return fc(this._room.avatarColorId)}avatarUrl(e){return s_(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){return this._tilesCreator(e)}async _sendMessage(e,t){if(!this._room.isArchived&&e){try{let r="m.text";e.startsWith("/me ")&&(e=e.substr(4).trim(),r="m.emote"),t?await t.reply(r,e):await this._room.sendEvent("m.room.message",{msgtype:r,body:e})}catch(r){return console.error(`room.sendMessage(): ${r.message}:
${r.stack}`),this._sendError=r,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{const e=await this.platform.openFile();return e?this._sendFile(e):void 0}catch(e){console.error(e)}}async _sendFile(e){const t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(l){throw l instanceof window.MediaError&&l.code===4?new Error(`this browser does not support videos of type ${e==null?void 0:e.blob.mimeType}.`):l}const r={body:e.name,msgtype:"m.video",info:dk(t)},s={url:this._room.createAttachment(t.blob,e.name)},o=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),a=await t.scale(o);r.info.thumbnail_info=oo(a),s["info.thumbnail_url"]=this._room.createAttachment(a.blob,e.name),await this._room.sendEvent("m.room.message",r,s)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob);const r=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(r&&t.maxDimension>r){const o=await t.scale(r);t.dispose(),t=o}const s={body:e.name,msgtype:"m.image",info:oo(t)},i={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){const o=await t.scale(400);s.info.thumbnail_info=oo(o),i["info.thumbnail_url"]=this._room.createAttachment(o.blob,e.name)}await this._room.sendEvent("m.room.message",s,i)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}}function dk(n){const e=oo(n);return e.duration=n.duration,e}class hk extends hi{constructor(e){super(e);this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"archived"}}Ut("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");Ut("Enabled","SetupKey","SetupPhrase","Pending","NewVersionAvailable");Ut("Writing","Stopped","Done","Pending");var Ck="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sPgogICAgPGhlYWQ+CiAgICAgICAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogICAgPC9oZWFkPgogICAgPGJvZHk+CiAgICAgICAgPGEgaWQ9ImxpbmsiIGhyZWY9IiMiPkRvd25sb2FkPC9hPgogICAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0Ij4KICAgICAgICAgICAgdmFyIGxpbmsgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGluayIpOwoKICAgICAgICAgICAgZnVuY3Rpb24gZG93bmxvYWRCbG9iKGJsb2IsIGZpbGVuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICAgICAgICAgIGxpbmsuaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgIGxpbmsuZG93bmxvYWQgPSBmaWxlbmFtZTsKICAgICAgICAgICAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gdG9CYXNlNjQoYnVmZmVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICAgICAgICAgICAgICBsZXQgYmluYXJ5U3RyID0gIiI7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVzLmJ5dGVMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGJpbmFyeVN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBidG9hKGJpbmFyeVN0cik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRvd25sb2FkQnVmZmVyKGJ1ZmZlciwgbWltZVR5cGUsIGZpbGVuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gImRhdGE6IiArIG1pbWVUeXBlICsgIjtiYXNlNjQsIiArIHRvQmFzZTY0KGJ1ZmZlcik7CiAgICAgICAgICAgICAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICAgICAgICAgICAgICBsaW5rLmRvd25sb2FkID0gZmlsZW5hbWU7CiAgICAgICAgICAgICAgICBsaW5rLmNsaWNrKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgYXN5bmMgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgIGlmIChldmVudC5vcmlnaW4gPT09IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS50eXBlID09PSAiZG93bmxvYWRCdWZmZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvd25sb2FkQnVmZmVyKGV2ZW50LmRhdGEuYnVmZmVyLCBldmVudC5kYXRhLm1pbWVUeXBlLCBldmVudC5kYXRhLmZpbGVuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmRhdGEudHlwZSA9PT0gImRvd25sb2FkQmxvYiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZG93bmxvYWRCbG9iKGV2ZW50LmRhdGEuYmxvYiwgZXZlbnQuZGF0YS5maWxlbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICA8L3NjcmlwdD4KICAgIDwvYm9keT4KPC9odG1sPgo=",Rk="/assets/main.bdb9a925.js",Ak="/assets/olm.531f328e.wasm",Tk="/assets/olm.364714ee.js",xk="/assets/olm_legacy.658f14ac.js",pk={exports:{}},fi={};/** @license React v17.0.2
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var fk=Vo.exports,c_=60103;fi.Fragment=60107;if(typeof Symbol=="function"&&Symbol.for){var Qh=Symbol.for;c_=Qh("react.element"),fi.Fragment=Qh("react.fragment")}var mk=fk.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,_k=Object.prototype.hasOwnProperty,gk={key:!0,ref:!0,__self:!0,__source:!0};function d_(n,e,t){var r,s={},i=null,o=null;t!==void 0&&(i=""+t),e.key!==void 0&&(i=""+e.key),e.ref!==void 0&&(o=e.ref);for(r in e)_k.call(e,r)&&!gk.hasOwnProperty(r)&&(s[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)s[r]===void 0&&(s[r]=e[r]);return{$$typeof:c_,type:n,key:i,ref:o,props:s,_owner:mk.current}}fi.jsx=d_;fi.jsxs=d_;pk.exports=fi;export{bk as C,Ek as N,Sk as P,kk as R,sS as T,hi as V,Ck as _,Rk as a,xk as b,Tk as c,vk as d,Ik as e,wk as f,pk as j,Ak as o,Vo as r};
